

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>Semantic Analysis &#8212; The Flang Compiler</title>
    <link rel="stylesheet" href="_static/llvm-theme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/llvm.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="OpenMP Semantic Analysis" href="OpenMP-semantics.html" />
    <link rel="prev" title="Module Files" href="ModFiles.html" />
<style type="text/css">
  table.right { float: right; margin-left: 20px; }
  table.right td { border: 1px solid #ccc; }
</style>

  </head><body>
<div class="logo">
  <a href="index.html">
    <img src="_static/logo.png"
         alt="LLVM Logo" width="250" height="88"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="OpenMP-semantics.html" title="OpenMP Semantic Analysis"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ModFiles.html" title="Module Files"
             accesskey="P">previous</a> |</li>
<! TODO: Change the webpage  >
  <li><a href="https://flang.llvm.org">Flang Home</a>&nbsp;|&nbsp;</li>
  <li><a href="index.html">Documentation</a>&raquo;</li>
 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">

<h3>Documentation</h3>

<ul class="want-points">
    <li><a href="https://github.com/llvm/llvm-project/blob/master/flang/README.md#getting-started">Getting Started</a></li>
</ul>

<h3>Getting Involved</h3>
<! TODO: Point links to website(flang.llvm.org) and not github once webpage comes up.>
<ul class="want-points">
    <li><a href="https://github.com/llvm/llvm-project/blob/master/flang/docs/GettingInvolved.md#mailing-lists">Mailing Lists</a></li>
    <li><a href="https://github.com/llvm/llvm-project/blob/master/flang/docs/GettingInvolved.md#chat">Slack</a></li>
    <li><a href="https://github.com/llvm/llvm-project/blob/master/flang/docs/GettingInvolved.md#calls">Calls</a></li>
</ul>

<h3>Additional Links</h3>

<ul class="want-points">
    <li><a href="https://github.com/llvm/llvm-project/tree/master/flang/">Github Repository</a></li>
    <li><a href="https://bugs.llvm.org/">Bug Reports</a></li>
    <li><a href="https://reviews.llvm.org/">Code Review</a></li>
<! TODO: Have the bots setup first>
    <li><a href="#">Doxygen API</a></li>
</ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="semantic-analysis">
<span id="semantic-analysis"></span><h1>Semantic Analysis<a class="headerlink" href="#semantic-analysis" title="Permalink to this headline">¶</a></h1>
<p>The semantic analysis pass determines if a syntactically correct Fortran
program is is legal by enforcing the constraints of the language.</p>
<p>The input is a parse tree with a <code class="docutils literal notranslate"><span class="pre">Program</span></code> node at the root;
and a “cooked” character stream, a contiguous stream of characters
containing a normalized form of the Fortran source.</p>
<p>The semantic analysis pass takes a parse tree for a syntactically
correct Fortran program and determines whether it is legal by enforcing
the constraints of the language.</p>
<p>If the program is not legal, the results of the semantic pass will be a list of
errors associated with the program.</p>
<p>If the program is legal, the semantic pass will produce a (possibly modified)
parse tree for the semantically correct program with each name mapped to a symbol
and each expression fully analyzed.</p>
<p>All user errors are detected either prior to or during semantic analysis.
After it completes successfully the program should compile with no error messages.
There may still be warnings or informational messages.</p>
<div class="section" id="phases-of-semantic-analysis">
<span id="phases-of-semantic-analysis"></span><h2>Phases of Semantic Analysis<a class="headerlink" href="#phases-of-semantic-analysis" title="Permalink to this headline">¶</a></h2>
<ol class="simple">
<li><p><a class="reference external" href="#validate-labels">Validate labels</a> -
Check all constraints on labels and branches</p></li>
<li><p><a class="reference external" href="#rewrite-do-loops">Rewrite DO loops</a> -
Convert all occurrences of <code class="docutils literal notranslate"><span class="pre">LabelDoStmt</span></code> to <code class="docutils literal notranslate"><span class="pre">DoConstruct</span></code>.</p></li>
<li><p><a class="reference external" href="#name-resolution">Name resolution</a> -
Analyze names and declarations, build a tree of Scopes containing Symbols,
and fill in the <code class="docutils literal notranslate"><span class="pre">Name::symbol</span></code> data member in the parse tree</p></li>
<li><p><a class="reference external" href="#rewrite-parse-tree">Rewrite parse tree</a> -
Fix incorrect parses based on symbol information</p></li>
<li><p><a class="reference external" href="#expression-analysis">Expression analysis</a> -
Analyze all expressions in the parse tree and fill in <code class="docutils literal notranslate"><span class="pre">Expr::typedExpr</span></code> and
<code class="docutils literal notranslate"><span class="pre">Variable::typedExpr</span></code> with analyzed expressions; fix incorrect parses
based on the result of this analysis</p></li>
<li><p><a class="reference external" href="#statement-semantics">Statement semantics</a> -
Perform remaining semantic checks on the execution parts of subprograms</p></li>
<li><p><a class="reference external" href="#write-module-files">Write module files</a> -
If no errors have occurred, write out <code class="docutils literal notranslate"><span class="pre">.mod</span></code> files for modules and submodules</p></li>
</ol>
<p>If phase 1 or phase 2 encounter an error on any of the program units,
compilation terminates. Otherwise, phases 3-6 are all performed even if
errors occur.
Module files are written (phase 7) only if there are no errors.</p>
<div class="section" id="validate-labels">
<span id="validate-labels"></span><h3>Validate labels<a class="headerlink" href="#validate-labels" title="Permalink to this headline">¶</a></h3>
<p>Perform semantic checks related to labels and branches:</p>
<ul class="simple">
<li><p>check that any labels that are referenced are defined and in scope</p></li>
<li><p>check branches into loop bodies</p></li>
<li><p>check that labeled <code class="docutils literal notranslate"><span class="pre">DO</span></code> loops are properly nested</p></li>
<li><p>check labels in data transfer statements</p></li>
</ul>
</div>
<div class="section" id="rewrite-do-loops">
<span id="rewrite-do-loops"></span><h3>Rewrite DO loops<a class="headerlink" href="#rewrite-do-loops" title="Permalink to this headline">¶</a></h3>
<p>This phase normalizes the parse tree by removing all unstructured <code class="docutils literal notranslate"><span class="pre">DO</span></code> loops
and replacing them with <code class="docutils literal notranslate"><span class="pre">DO</span></code> constructs.</p>
</div>
<div class="section" id="name-resolution">
<span id="name-resolution"></span><h3>Name resolution<a class="headerlink" href="#name-resolution" title="Permalink to this headline">¶</a></h3>
<p>The name resolution phase walks the parse tree and constructs the symbol table.</p>
<p>The symbol table consists of a tree of <code class="docutils literal notranslate"><span class="pre">Scope</span></code> objects rooted at the global scope.
The global scope is owned by the <code class="docutils literal notranslate"><span class="pre">SemanticsContext</span></code> object.
It contains a <code class="docutils literal notranslate"><span class="pre">Scope</span></code> for each program unit in the compilation.</p>
<p>Each <code class="docutils literal notranslate"><span class="pre">Scope</span></code> in the scope tree contains child scopes representing other scopes
lexically nested in it.
Each <code class="docutils literal notranslate"><span class="pre">Scope</span></code> also contains a map of <code class="docutils literal notranslate"><span class="pre">CharBlock</span></code> to <code class="docutils literal notranslate"><span class="pre">Symbol</span></code> representing names
declared in that scope. (All names in the symbol table are represented as
<code class="docutils literal notranslate"><span class="pre">CharBlock</span></code> objects, i.e. as substrings of the cooked character stream.)</p>
<p>All <code class="docutils literal notranslate"><span class="pre">Symbol</span></code> objects are owned by the symbol table data structures.
They should be accessed as <code class="docutils literal notranslate"><span class="pre">Symbol</span> <span class="pre">*</span></code> or <code class="docutils literal notranslate"><span class="pre">Symbol</span> <span class="pre">&amp;</span></code> outside of the symbol
table classes as they can’t be created, copied, or moved.
The <code class="docutils literal notranslate"><span class="pre">Symbol</span></code> class has functions and data common across all symbols, and a
<code class="docutils literal notranslate"><span class="pre">details</span></code> field that contains more information specific to that type of symbol.
Many symbols also have types, represented by <code class="docutils literal notranslate"><span class="pre">DeclTypeSpec</span></code>.
Types are also owned by scopes.</p>
<p>Name resolution happens on the parse tree in this order:</p>
<ol class="simple">
<li><p>Process the specification of a program unit:</p>
<ol class="simple">
<li><p>Create a new scope for the unit</p></li>
<li><p>Create a symbol for each contained subprogram containing just the name</p></li>
<li><p>Process the opening statement of the unit (<code class="docutils literal notranslate"><span class="pre">ModuleStmt</span></code>, <code class="docutils literal notranslate"><span class="pre">FunctionStmt</span></code>, etc.)</p></li>
<li><p>Process the specification part of the unit</p></li>
</ol>
</li>
<li><p>Apply the same process recursively to nested subprograms</p></li>
<li><p>Process the execution part of the program unit</p></li>
<li><p>Process the execution parts of nested subprograms recursively</p></li>
</ol>
<p>After the completion of this phase, every <code class="docutils literal notranslate"><span class="pre">Name</span></code> corresponds to a <code class="docutils literal notranslate"><span class="pre">Symbol</span></code>
unless an error occurred.</p>
</div>
<div class="section" id="rewrite-parse-tree">
<span id="rewrite-parse-tree"></span><h3>Rewrite parse tree<a class="headerlink" href="#rewrite-parse-tree" title="Permalink to this headline">¶</a></h3>
<p>The parser cannot build a completely correct parse tree without symbol information.
This phase corrects mis-parses based on symbols:</p>
<ul class="simple">
<li><p>Array element assignments may be parsed as statement functions: <code class="docutils literal notranslate"><span class="pre">a(i)</span> <span class="pre">=</span> <span class="pre">...</span></code></p></li>
<li><p>Namelist group names without <code class="docutils literal notranslate"><span class="pre">NML=</span></code> may be parsed as format expressions</p></li>
<li><p>A file unit number expression may be parsed as a character variable</p></li>
</ul>
<p>This phase also produces an internal error if it finds a <code class="docutils literal notranslate"><span class="pre">Name</span></code> that does not
have its <code class="docutils literal notranslate"><span class="pre">symbol</span></code> data member filled in. This error is suppressed if other
errors have occurred because in that case a <code class="docutils literal notranslate"><span class="pre">Name</span></code> corresponding to an erroneous
symbol may not be resolved.</p>
</div>
<div class="section" id="expression-analysis">
<span id="expression-analysis"></span><h3>Expression analysis<a class="headerlink" href="#expression-analysis" title="Permalink to this headline">¶</a></h3>
<p>Expressions that occur in the specification part are analyzed during name
resolution, for example, initial values, array bounds, type parameters.
Any remaining expressions are analyzed in this phase.</p>
<p>For each <code class="docutils literal notranslate"><span class="pre">Variable</span></code> and top-level <code class="docutils literal notranslate"><span class="pre">Expr</span></code> (i.e. one that is not nested below
another <code class="docutils literal notranslate"><span class="pre">Expr</span></code> in the parse tree) the analyzed form of the expression is saved
in the <code class="docutils literal notranslate"><span class="pre">typedExpr</span></code> data member. After this phase has completed, the analyzed
expression can be accessed using <code class="docutils literal notranslate"><span class="pre">semantics::GetExpr()</span></code>.</p>
<p>This phase also corrects mis-parses based on the result of expression analysis:</p>
<ul class="simple">
<li><p>An expression like <code class="docutils literal notranslate"><span class="pre">a(b)</span></code> is parsed as a function reference but may need
to be rewritten to an array element reference (if <code class="docutils literal notranslate"><span class="pre">a</span></code> is an object entity)
or to a structure constructor (if <code class="docutils literal notranslate"><span class="pre">a</span></code> is a derive type)</p></li>
<li><p>An expression like <code class="docutils literal notranslate"><span class="pre">a(b:c)</span></code> is parsed as an array section but may need to be
rewritten as a substring if <code class="docutils literal notranslate"><span class="pre">a</span></code> is an object with type CHARACTER</p></li>
</ul>
</div>
<div class="section" id="statement-semantics">
<span id="statement-semantics"></span><h3>Statement semantics<a class="headerlink" href="#statement-semantics" title="Permalink to this headline">¶</a></h3>
<p>Multiple independent checkers driven by the <code class="docutils literal notranslate"><span class="pre">SemanticsVisitor</span></code> framework
perform the remaining semantic checks.
By this phase, all names and expressions that can be successfully resolved
have been. But there may be names without symbols or expressions without
analyzed form if errors occurred earlier.</p>
</div>
<div class="section" id="write-module-files">
<span id="write-module-files"></span><h3>Write module files<a class="headerlink" href="#write-module-files" title="Permalink to this headline">¶</a></h3>
<p>Separate compilation information is written out on successful compilation
of modules and submodules. These are used as input to name resolution
in program units that <code class="docutils literal notranslate"><span class="pre">USE</span></code> the modules.</p>
<p>Module files are stripped down Fortran source for the module.
Parts that aren’t needed to compile dependent program units (e.g. action statements)
are omitted.</p>
<p>The module file for module <code class="docutils literal notranslate"><span class="pre">m</span></code> is named <code class="docutils literal notranslate"><span class="pre">m.mod</span></code> and the module file for
submodule <code class="docutils literal notranslate"><span class="pre">s</span></code> of module <code class="docutils literal notranslate"><span class="pre">m</span></code> is named <code class="docutils literal notranslate"><span class="pre">m-s.mod</span></code>.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="OpenMP-semantics.html" title="OpenMP Semantic Analysis"
             >next</a> |</li>
        <li class="right" >
          <a href="ModFiles.html" title="Module Files"
             >previous</a> |</li>
<! TODO: Change the webpage  >
  <li><a href="https://flang.llvm.org">Flang Home</a>&nbsp;|&nbsp;</li>
  <li><a href="index.html">Documentation</a>&raquo;</li>
 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017-2020, The Flang Team.
      Last updated on Oct 12, 2020.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.3.
    </div>
  </body>
</html>