
<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Lightweight Fault Isolation (LFI) in LLVM &#8212; LLVM 22.1.0-rc2 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="_static/llvm-theme.css?v=96924833" />
    <script src="_static/documentation_options.js?v=106f770c"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="LLVM Link Time Optimization: Design and Implementation" href="LinkTimeOptimization.html" />
    <link rel="prev" title="Key Instructions debug info in LLVM and Clang" href="KeyInstructionsDebugInfo.html" />
<style type="text/css">
  table.right { float: right; margin-left: 20px; }
  table.right td { border: 1px solid #ccc; }
</style>

  </head><body>
<div class="logo">
  <a href="index.html">
    <img src="_static/logo.png"
         alt="LLVM Logo" width="250" height="88"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="LinkTimeOptimization.html" title="LLVM Link Time Optimization: Design and Implementation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="KeyInstructionsDebugInfo.html" title="Key Instructions debug info in LLVM and Clang"
             accesskey="P">previous</a> |</li>
  <li><a href="https://llvm.org/">LLVM Home</a>&nbsp;|&nbsp;</li>
  <li><a href="index.html">Documentation</a>&raquo;</li>

          <li class="nav-item nav-item-1"><a href="UserGuides.html" accesskey="U">User Guides</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Lightweight Fault Isolation (LFI) in LLVM</a></li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">

<h3>Documentation</h3>

<ul class="want-points">
    <li><a href="https://llvm.org/docs/GettingStartedTutorials.html">Getting Started/Tutorials</a></li>
    <li><a href="https://llvm.org/docs/UserGuides.html">User Guides</a></li>
    <li><a href="https://llvm.org/docs/Reference.html">Reference</a></li>
</ul>

<h3>Getting Involved</h3>

<ul class="want-points">
    <li><a href="https://llvm.org/docs/Contributing.html">Contributing to LLVM</a></li>
    <li><a href="https://llvm.org/docs/HowToSubmitABug.html">Submitting Bug Reports</a></li>
    <li><a href="https://llvm.org/docs/GettingInvolved.html#mailing-lists">Mailing Lists</a></li>
    <li><a href="https://llvm.org/docs/GettingInvolved.html#discord">Discord</a></li>
    <li><a href="https://llvm.org/docs/GettingInvolved.html#meetups-and-social-events">Meetups and Social Events</a></li>
</ul>

<h3>Additional Links</h3>

<ul class="want-points">
    <li><a href="https://llvm.org/docs/FAQ.html">FAQ</a></li>
    <li><a href="https://llvm.org/docs/Lexicon.html">Glossary</a></li>
    <li><a href="https://llvm.org/pubs">Publications</a></li>
    <li><a href="https://github.com/llvm/llvm-project/">Github Repository</a></li>
</ul>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/LFI.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="lightweight-fault-isolation-lfi-in-llvm">
<h1>Lightweight Fault Isolation (LFI) in LLVM<a class="headerlink" href="#lightweight-fault-isolation-lfi-in-llvm" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id1">Introduction</a></p></li>
<li><p><a class="reference internal" href="#compiler-requirements" id="id2">Compiler Requirements</a></p>
<ul>
<li><p><a class="reference internal" href="#compiler-options" id="id3">Compiler Options</a></p></li>
<li><p><a class="reference internal" href="#reserved-registers" id="id4">Reserved Registers</a></p></li>
<li><p><a class="reference internal" href="#linker-support" id="id5">Linker Support</a></p></li>
<li><p><a class="reference internal" href="#assembly-rewrites" id="id6">Assembly Rewrites</a></p>
<ul>
<li><p><a class="reference internal" href="#terminology" id="id7">Terminology</a></p></li>
<li><p><a class="reference internal" href="#control-flow" id="id8">Control flow</a></p></li>
<li><p><a class="reference internal" href="#memory-accesses" id="id9">Memory accesses</a></p></li>
<li><p><a class="reference internal" href="#stack-pointer-modification" id="id10">Stack pointer modification</a></p></li>
<li><p><a class="reference internal" href="#link-register-modification" id="id11">Link register modification</a></p></li>
<li><p><a class="reference internal" href="#system-instructions" id="id12">System instructions</a></p></li>
<li><p><a class="reference internal" href="#thread-local-storage" id="id13">Thread-local storage</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#optimizations" id="id14">Optimizations</a></p>
<ul>
<li><p><a class="reference internal" href="#basic-guard-elimination" id="id15">Basic guard elimination</a></p></li>
<li><p><a class="reference internal" href="#address-generation" id="id16">Address generation</a></p></li>
<li><p><a class="reference internal" href="#stack-guard-elimination" id="id17">Stack guard elimination</a></p></li>
<li><p><a class="reference internal" href="#guard-hoisting" id="id18">Guard hoisting</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#references" id="id19">References</a></p></li>
</ul>
</nav>
<section id="introduction">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Introduction</a><a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p>Lightweight Fault Isolation (LFI) is a compiler-based sandboxing technology for
native code. Like WebAssembly and Native Client, LFI isolates sandboxed code in-process
(i.e., in the same address space as a host application).</p>
<p>LFI is designed from the ground up to sandbox existing code, such as C/C++
libraries (including assembly code) and device drivers.</p>
<p>LFI aims for the following goals:</p>
<ul class="simple">
<li><p>Compatibility: LFI can be used to sandbox nearly all existing C/C++/assembly
libraries unmodified (they just need to be recompiled). Sandboxed libraries
work with existing system call interfaces, and are compatible with existing
development tools such as profilers, debuggers, and sanitizers.</p></li>
<li><p>Performance: LFI aims for minimal overhead vs. unsandboxed code.</p></li>
<li><p>Security: The LFI runtime and compiler elements aim to be simple and
verifiable when possible.</p></li>
<li><p>Usability: LFI aims to make it as easy as possible to retrofit sandboxing,
i.e., to migrate from unsandboxed to sandboxed libraries with minimal effort.</p></li>
</ul>
<p>When building a program for the LFI target the compiler is designed to ensure
that the program will only be able to access memory within a limited region of
the virtual address space, starting from where the program is loaded (the
current design sets this region to a size of 4GiB of virtual memory). Programs
built for the LFI target are restricted to using a subset of the instruction
set, designed so that the programs can be soundly confined to their sandbox
region. LFI programs must run inside of an “emulator” (usually called the LFI
runtime), responsible for initializing the sandbox region, loading the program,
and servicing system call requests, or other forms of runtime calls.</p>
<p>LFI uses an architecture-specific sandboxing scheme based on the general
technique of Software-Based Fault Isolation (SFI). Initial support for LFI in
LLVM is focused on the AArch64 platform, with x86-64 support planned for the
future. The initial version of LFI for AArch64 is designed to support the
Armv8.1 AArch64 architecture.</p>
<p>See <a class="reference external" href="https://github.com/lfi-project/">https://github.com/lfi-project</a> for
details about the LFI project and additional software needed to run LFI
programs.</p>
</section>
<section id="compiler-requirements">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Compiler Requirements</a><a class="headerlink" href="#compiler-requirements" title="Link to this heading">¶</a></h2>
<p>When building for the <code class="docutils literal notranslate"><span class="pre">aarch64_lfi</span></code> target, the compiler must restrict use of
the instruction set to a subset of instructions, which are known to be safe
from a sandboxing perspective. To do this, we apply a set of simple rewrites at
the assembly language level to transform standard native AArch64 assembly into
LFI-compatible AArch64 assembly.</p>
<p>These rewrites (also called “expansions”) are applied at the very end of the
LLVM compilation pipeline (during the assembler step). This allows the rewrites
to be applied to hand-written assembly, including inline assembly.</p>
<section id="compiler-options">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">Compiler Options</a><a class="headerlink" href="#compiler-options" title="Link to this heading">¶</a></h3>
<p>The LFI target has several configuration options.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">+lfi-loads</span></code>: enable sandboxing for loads (default: true).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">+lfi-stores</span></code>: enable sandboxing for stores (default: true).</p></li>
</ul>
<p>Use <code class="docutils literal notranslate"><span class="pre">+nolfi-loads</span></code> to create a “stores-only” sandbox that may read, but not
write, outside the sandbox region.</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">+nolfi-loads+nolfi-stores</span></code> to create a “jumps-only” sandbox that may
read/write outside the sandbox region but may not transfer control outside
(e.g., may not execute system calls directly). This is primarily useful in
combination with some other form of memory sandboxing, such as Intel MPK.</p>
</section>
<section id="reserved-registers">
<h3><a class="toc-backref" href="#id4" role="doc-backlink">Reserved Registers</a><a class="headerlink" href="#reserved-registers" title="Link to this heading">¶</a></h3>
<p>The LFI target uses a custom ABI that reserves additional registers for the
platform. The registers are listed below, along with the security invariant
that must be maintained.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">x27</span></code>: always holds the sandbox base address.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">x28</span></code>: always holds an address within the sandbox.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">sp</span></code>: always holds an address within the sandbox.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">x30</span></code>: always holds an address within the sandbox.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">x26</span></code>: scratch register.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">x25</span></code>: points to a thread-local virtual register file for storing runtime context information.</p></li>
</ul>
</section>
<section id="linker-support">
<h3><a class="toc-backref" href="#id5" role="doc-backlink">Linker Support</a><a class="headerlink" href="#linker-support" title="Link to this heading">¶</a></h3>
<p>In the initial version, LFI only supports static linking, and only supports
creating <code class="docutils literal notranslate"><span class="pre">static-pie</span></code> binaries. There is nothing that fundamentally precludes
support for dynamic linking on the LFI target, but such support would require
that the code generated by the linker for PLT entries be slightly modified in
order to conform to the LFI architecture subset.</p>
</section>
<section id="assembly-rewrites">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">Assembly Rewrites</a><a class="headerlink" href="#assembly-rewrites" title="Link to this heading">¶</a></h3>
<section id="terminology">
<h4><a class="toc-backref" href="#id7" role="doc-backlink">Terminology</a><a class="headerlink" href="#terminology" title="Link to this heading">¶</a></h4>
<p>In the following assembly rewrites, some shorthand is used.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">xN</span></code> or <code class="docutils literal notranslate"><span class="pre">wN</span></code>: refers to any general-purpose non-reserved register.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{a,b,c}</span></code>: matches any of <code class="docutils literal notranslate"><span class="pre">a</span></code>, <code class="docutils literal notranslate"><span class="pre">b</span></code>, or <code class="docutils literal notranslate"><span class="pre">c</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LDSTr</span></code>: a load/store instruction that supports register-register addressing modes, with one source/destination register.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LDSTx</span></code>: a load/store instruction not matched by <code class="docutils literal notranslate"><span class="pre">LDSTr</span></code>.</p></li>
</ul>
</section>
<section id="control-flow">
<h4><a class="toc-backref" href="#id8" role="doc-backlink">Control flow</a><a class="headerlink" href="#control-flow" title="Link to this heading">¶</a></h4>
<p>Indirect branches get rewritten to branch through register <code class="docutils literal notranslate"><span class="pre">x28</span></code>, which must
always contain an address within the sandbox. An <code class="docutils literal notranslate"><span class="pre">add</span></code> is used to safely
update <code class="docutils literal notranslate"><span class="pre">x28</span></code> with the destination address. Since <code class="docutils literal notranslate"><span class="pre">ret</span></code> uses <code class="docutils literal notranslate"><span class="pre">x30</span></code> by
default, which already must contain an address within the sandbox, it does not
require any rewrite.</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Original</p></td>
<td><p>Rewritten</p></td>
</tr>
<tr class="row-even"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">br</span><span class="p">,</span><span class="n">blr</span><span class="p">,</span><span class="n">ret</span><span class="p">}</span> <span class="n">xN</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">add</span> <span class="n">x28</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="n">wN</span><span class="p">,</span> <span class="n">uxtw</span>
<span class="p">{</span><span class="n">br</span><span class="p">,</span><span class="n">blr</span><span class="p">,</span><span class="n">ret</span><span class="p">}</span> <span class="n">x28</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ret</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ret</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
<section id="memory-accesses">
<h4><a class="toc-backref" href="#id9" role="doc-backlink">Memory accesses</a><a class="headerlink" href="#memory-accesses" title="Link to this heading">¶</a></h4>
<p>Memory accesses are rewritten to use the <code class="docutils literal notranslate"><span class="pre">[x27,</span> <span class="pre">wM,</span> <span class="pre">uxtw]</span></code> addressing mode if
it is available, which is automatically safe. Otherwise, rewrites fall back to
using <code class="docutils literal notranslate"><span class="pre">x28</span></code> along with an instruction to safely load it with the target
address.</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Original</p></td>
<td><p>Rewritten</p></td>
</tr>
<tr class="row-even"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LDSTr</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">xM</span><span class="p">]</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LDSTr</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">x27</span><span class="p">,</span> <span class="n">wM</span><span class="p">,</span> <span class="n">uxtw</span><span class="p">]</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LDSTr</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">xM</span><span class="p">,</span> <span class="c1">#I]</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">add</span> <span class="n">x28</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="n">wM</span><span class="p">,</span> <span class="n">uxtw</span>
<span class="n">LDSTr</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">x28</span><span class="p">,</span> <span class="c1">#I]</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LDSTr</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">xM</span><span class="p">,</span> <span class="c1">#I]!</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">add</span> <span class="n">xM</span><span class="p">,</span> <span class="n">xM</span><span class="p">,</span> <span class="c1">#I</span>
<span class="n">LDSTr</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">x27</span><span class="p">,</span> <span class="n">wM</span><span class="p">,</span> <span class="n">uxtw</span><span class="p">]</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LDSTr</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">xM</span><span class="p">],</span> <span class="c1">#I</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LDSTr</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">x27</span><span class="p">,</span> <span class="n">wM</span><span class="p">,</span> <span class="n">uxtw</span><span class="p">]</span>
<span class="n">add</span> <span class="n">xM</span><span class="p">,</span> <span class="n">xM</span><span class="p">,</span> <span class="c1">#I</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LDSTr</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">xM1</span><span class="p">,</span> <span class="n">xM2</span><span class="p">]</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">add</span> <span class="n">x26</span><span class="p">,</span> <span class="n">xM1</span><span class="p">,</span> <span class="n">xM2</span>
<span class="n">LDSTr</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">x27</span><span class="p">,</span> <span class="n">w26</span><span class="p">,</span> <span class="n">uxtw</span><span class="p">]</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LDSTr</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">xM1</span><span class="p">,</span> <span class="n">xM2</span><span class="p">,</span> <span class="n">MOD</span> <span class="c1">#I]</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">add</span> <span class="n">x26</span><span class="p">,</span> <span class="n">xM1</span><span class="p">,</span> <span class="n">xM2</span><span class="p">,</span> <span class="n">MOD</span> <span class="c1">#I</span>
<span class="n">LDSTr</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">x27</span><span class="p">,</span> <span class="n">w26</span><span class="p">,</span> <span class="n">uxtw</span><span class="p">]</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LDSTx</span> <span class="o">...</span><span class="p">,</span> <span class="p">[</span><span class="n">xM</span><span class="p">]</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">add</span> <span class="n">x28</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="n">wM</span><span class="p">,</span> <span class="n">uxtw</span>
<span class="n">LDSTx</span> <span class="o">...</span><span class="p">,</span> <span class="p">[</span><span class="n">x28</span><span class="p">]</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LDSTx</span> <span class="o">...</span><span class="p">,</span> <span class="p">[</span><span class="n">xM</span><span class="p">,</span> <span class="c1">#I]</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">add</span> <span class="n">x28</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="n">wM</span><span class="p">,</span> <span class="n">uxtw</span>
<span class="n">LDSTx</span> <span class="o">...</span><span class="p">,</span> <span class="p">[</span><span class="n">x28</span><span class="p">,</span> <span class="c1">#I]</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LDSTx</span> <span class="o">...</span><span class="p">,</span> <span class="p">[</span><span class="n">xM</span><span class="p">,</span> <span class="c1">#I]!</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">add</span> <span class="n">x28</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="n">wM</span><span class="p">,</span> <span class="n">uxtw</span>
<span class="n">LDSTx</span> <span class="o">...</span><span class="p">,</span> <span class="p">[</span><span class="n">x28</span><span class="p">,</span> <span class="c1">#I]</span>
<span class="n">add</span> <span class="n">xM</span><span class="p">,</span> <span class="n">xM</span><span class="p">,</span> <span class="c1">#I</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LDSTx</span> <span class="o">...</span><span class="p">,</span> <span class="p">[</span><span class="n">xM</span><span class="p">],</span> <span class="c1">#I</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">add</span> <span class="n">x28</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="n">wM</span><span class="p">,</span> <span class="n">uxtw</span>
<span class="n">LDSTx</span> <span class="o">...</span><span class="p">,</span> <span class="p">[</span><span class="n">x28</span><span class="p">]</span>
<span class="n">add</span> <span class="n">xM</span><span class="p">,</span> <span class="n">xM</span><span class="p">,</span> <span class="c1">#I</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LDSTx</span> <span class="o">...</span><span class="p">,</span> <span class="p">[</span><span class="n">xM1</span><span class="p">],</span> <span class="n">xM2</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">add</span> <span class="n">x28</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="n">wM1</span><span class="p">,</span> <span class="n">uxtw</span>
<span class="n">LDSTx</span> <span class="o">...</span><span class="p">,</span> <span class="p">[</span><span class="n">x28</span><span class="p">]</span>
<span class="n">add</span> <span class="n">xM1</span><span class="p">,</span> <span class="n">xM1</span><span class="p">,</span> <span class="n">xM2</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
<section id="stack-pointer-modification">
<h4><a class="toc-backref" href="#id10" role="doc-backlink">Stack pointer modification</a><a class="headerlink" href="#stack-pointer-modification" title="Link to this heading">¶</a></h4>
<p>When the stack pointer is modified, we write the modified value to a temporary,
before moving it back into <code class="docutils literal notranslate"><span class="pre">sp</span></code> with a safe <code class="docutils literal notranslate"><span class="pre">add</span></code>.</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Original</p></td>
<td><p>Rewritten</p></td>
</tr>
<tr class="row-even"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mov</span> <span class="n">sp</span><span class="p">,</span> <span class="n">xN</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">add</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="n">wN</span><span class="p">,</span> <span class="n">uxtw</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">add</span><span class="p">,</span><span class="n">sub</span><span class="p">}</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="p">{</span><span class="c1">#I,xN}</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">add</span><span class="p">,</span><span class="n">sub</span><span class="p">}</span> <span class="n">x26</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="p">{</span><span class="c1">#I,xN}</span>
<span class="n">add</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="n">w26</span><span class="p">,</span> <span class="n">uxtw</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
<section id="link-register-modification">
<h4><a class="toc-backref" href="#id11" role="doc-backlink">Link register modification</a><a class="headerlink" href="#link-register-modification" title="Link to this heading">¶</a></h4>
<p>When the link register is modified, we write the modified value to a
temporary, before loading it back into <code class="docutils literal notranslate"><span class="pre">x30</span></code> with a safe <code class="docutils literal notranslate"><span class="pre">add</span></code>.</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Original</p></td>
<td><p>Rewritten</p></td>
</tr>
<tr class="row-even"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldr</span> <span class="n">x30</span><span class="p">,</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldr</span> <span class="n">x26</span><span class="p">,</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="n">add</span> <span class="n">x30</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="n">w26</span><span class="p">,</span> <span class="n">uxtw</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldp</span> <span class="n">xN</span><span class="p">,</span> <span class="n">x30</span><span class="p">,</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldp</span> <span class="n">xN</span><span class="p">,</span> <span class="n">x26</span><span class="p">,</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="n">add</span> <span class="n">x30</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="n">w26</span><span class="p">,</span> <span class="n">uxtw</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldp</span> <span class="n">x30</span><span class="p">,</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldp</span> <span class="n">x26</span><span class="p">,</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>
<span class="n">add</span> <span class="n">x30</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="n">w26</span><span class="p">,</span> <span class="n">uxtw</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
<section id="system-instructions">
<h4><a class="toc-backref" href="#id12" role="doc-backlink">System instructions</a><a class="headerlink" href="#system-instructions" title="Link to this heading">¶</a></h4>
<p>System calls are rewritten into a sequence that loads the address of the first
runtime call entrypoint and jumps to it. The runtime call entrypoint table is
stored at the start of the sandbox, so it can be referenced by <code class="docutils literal notranslate"><span class="pre">x27</span></code>. The
rewrite also saves and restores the link register, since it is used for
branching into the runtime.</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Original</p></td>
<td><p>Rewritten</p></td>
</tr>
<tr class="row-even"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">svc</span> <span class="c1">#0</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mov</span> <span class="n">w26</span><span class="p">,</span> <span class="n">w30</span>
<span class="n">ldr</span> <span class="n">x30</span><span class="p">,</span> <span class="p">[</span><span class="n">x27</span><span class="p">]</span>
<span class="n">blr</span> <span class="n">x30</span>
<span class="n">add</span> <span class="n">x30</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="n">w26</span><span class="p">,</span> <span class="n">uxtw</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
<section id="thread-local-storage">
<h4><a class="toc-backref" href="#id13" role="doc-backlink">Thread-local storage</a><a class="headerlink" href="#thread-local-storage" title="Link to this heading">¶</a></h4>
<p>TLS accesses are rewritten into accesses offset from <code class="docutils literal notranslate"><span class="pre">x25</span></code>, which is a
reserved register that points to a virtual register file, with a location for
storing the sandbox’s thread pointer. <code class="docutils literal notranslate"><span class="pre">TP</span></code> is the offset into that virtual
register file where the thread pointer is stored.</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Original</p></td>
<td><p>Rewritten</p></td>
</tr>
<tr class="row-even"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mrs</span> <span class="n">xN</span><span class="p">,</span> <span class="n">tpidr_el0</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ldr</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">x25</span><span class="p">,</span> <span class="c1">#TP]</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mrs</span> <span class="n">tpidr_el0</span><span class="p">,</span> <span class="n">xN</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">str</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">x25</span><span class="p">,</span> <span class="c1">#TP]</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="optimizations">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">Optimizations</a><a class="headerlink" href="#optimizations" title="Link to this heading">¶</a></h3>
<section id="basic-guard-elimination">
<h4><a class="toc-backref" href="#id15" role="doc-backlink">Basic guard elimination</a><a class="headerlink" href="#basic-guard-elimination" title="Link to this heading">¶</a></h4>
<p>If a register is guarded multiple times in the same basic block without any
modifications to it during the intervening instructions, then subsequent guards
can be removed.</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Original</p></td>
<td><p>Rewritten</p></td>
</tr>
<tr class="row-even"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">add</span> <span class="n">x28</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="n">wN</span><span class="p">,</span> <span class="n">uxtw</span>
<span class="n">ldur</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">x28</span><span class="p">]</span>
<span class="n">add</span> <span class="n">x28</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="n">wN</span><span class="p">,</span> <span class="n">uxtw</span>
<span class="n">ldur</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">x28</span><span class="p">,</span> <span class="c1">#8]</span>
<span class="n">add</span> <span class="n">x28</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="n">wN</span><span class="p">,</span> <span class="n">uxtw</span>
<span class="n">ldur</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">x28</span><span class="p">,</span> <span class="c1">#16]</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">add</span> <span class="n">x28</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="n">wN</span><span class="p">,</span> <span class="n">uxtw</span>
<span class="n">ldur</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">x28</span><span class="p">]</span>
<span class="n">ldur</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">x28</span><span class="p">,</span> <span class="c1">#8]</span>
<span class="n">ldur</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">x28</span><span class="p">,</span> <span class="c1">#16]</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
<section id="address-generation">
<h4><a class="toc-backref" href="#id16" role="doc-backlink">Address generation</a><a class="headerlink" href="#address-generation" title="Link to this heading">¶</a></h4>
<p>Addresses to global symbols in position-independent executables are frequently
generated via <code class="docutils literal notranslate"><span class="pre">adrp</span></code> followed by <code class="docutils literal notranslate"><span class="pre">ldr</span></code>. Since the address generated by
<code class="docutils literal notranslate"><span class="pre">adrp</span></code> can be statically guaranteed to be within the sandbox, it is safe to
directly target <code class="docutils literal notranslate"><span class="pre">x28</span></code> for these sequences. This allows the omission of a
guard instruction before the <code class="docutils literal notranslate"><span class="pre">ldr</span></code>.</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Original</p></td>
<td><p>Rewritten</p></td>
</tr>
<tr class="row-even"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">adrp</span> <span class="n">xN</span><span class="p">,</span> <span class="n">target</span>
<span class="n">ldr</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">xN</span><span class="p">,</span> <span class="n">imm</span><span class="p">]</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">adrp</span> <span class="n">x28</span><span class="p">,</span> <span class="n">target</span>
<span class="n">ldr</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">x28</span><span class="p">,</span> <span class="n">imm</span><span class="p">]</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
<section id="stack-guard-elimination">
<h4><a class="toc-backref" href="#id17" role="doc-backlink">Stack guard elimination</a><a class="headerlink" href="#stack-guard-elimination" title="Link to this heading">¶</a></h4>
<p><strong>Note</strong>: this optimization has not been implemented.</p>
<p>If the stack pointer is modified by adding/subtracting a small immediate, and
then later used to perform a memory access without any intervening jumps, then
the guard on the stack pointer modification can be removed. This is because the
load/store is guaranteed to trap if the stack pointer has been moved outside of
the sandbox region.</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Original</p></td>
<td><p>Rewritten</p></td>
</tr>
<tr class="row-even"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">add</span> <span class="n">x26</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="c1">#8</span>
<span class="n">add</span> <span class="n">sp</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="n">w26</span><span class="p">,</span> <span class="n">uxtw</span>
<span class="o">...</span> <span class="p">(</span><span class="n">same</span> <span class="n">basic</span> <span class="n">block</span><span class="p">)</span>
<span class="n">ldr</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">]</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">add</span> <span class="n">sp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="c1">#8</span>
<span class="o">...</span> <span class="p">(</span><span class="n">same</span> <span class="n">basic</span> <span class="n">block</span><span class="p">)</span>
<span class="n">ldr</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">]</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
<section id="guard-hoisting">
<h4><a class="toc-backref" href="#id18" role="doc-backlink">Guard hoisting</a><a class="headerlink" href="#guard-hoisting" title="Link to this heading">¶</a></h4>
<p><strong>Note</strong>: this optimization has not been implemented.</p>
<p>In certain cases, guards may be hoisted outside of loops.</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Original</p></td>
<td><p>Rewritten</p></td>
</tr>
<tr class="row-even"><td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">mov</span> <span class="n">w8</span><span class="p">,</span> <span class="c1">#10</span>
    <span class="n">mov</span> <span class="n">w9</span><span class="p">,</span> <span class="c1">#0</span>
<span class="o">.</span><span class="n">loop</span><span class="p">:</span>
    <span class="n">add</span> <span class="n">w9</span><span class="p">,</span> <span class="n">w9</span><span class="p">,</span> <span class="c1">#1</span>
    <span class="n">ldr</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">xM</span><span class="p">]</span>
    <span class="n">cmp</span> <span class="n">w9</span><span class="p">,</span> <span class="n">w8</span>
    <span class="n">b</span><span class="o">.</span><span class="n">lt</span> <span class="o">.</span><span class="n">loop</span>
<span class="o">.</span><span class="n">end</span><span class="p">:</span>
</pre></div>
</div>
</td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">mov</span> <span class="n">w8</span><span class="p">,</span> <span class="c1">#10</span>
    <span class="n">mov</span> <span class="n">w9</span><span class="p">,</span> <span class="c1">#0</span>
    <span class="n">add</span> <span class="n">x28</span><span class="p">,</span> <span class="n">x27</span><span class="p">,</span> <span class="n">wM</span><span class="p">,</span> <span class="n">uxtw</span>
<span class="o">.</span><span class="n">loop</span><span class="p">:</span>
    <span class="n">add</span> <span class="n">w9</span><span class="p">,</span> <span class="n">w9</span><span class="p">,</span> <span class="c1">#1</span>
    <span class="n">ldr</span> <span class="n">xN</span><span class="p">,</span> <span class="p">[</span><span class="n">x28</span><span class="p">]</span>
    <span class="n">cmp</span> <span class="n">w9</span><span class="p">,</span> <span class="n">w8</span>
    <span class="n">b</span><span class="o">.</span><span class="n">lt</span> <span class="o">.</span><span class="n">loop</span>
<span class="o">.</span><span class="n">end</span><span class="p">:</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</section>
</section>
</section>
<section id="references">
<h2><a class="toc-backref" href="#id19" role="doc-backlink">References</a><a class="headerlink" href="#references" title="Link to this heading">¶</a></h2>
<p>For more information, please see the following resources:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/lfi-project/">LFI project page</a></p></li>
<li><p><a class="reference external" href="https://discourse.llvm.org/t/rfc-lightweight-fault-isolation-lfi-efficient-native-code-sandboxing-upstream-lfi-target-and-compiler-changes/88380">LFI RFC</a></p></li>
<li><p><a class="reference external" href="https://zyedidia.github.io/papers/lfi_asplos24.pdf">LFI paper</a></p></li>
</ul>
<p>Contact info:</p>
<ul class="simple">
<li><p>Zachary Yedidia - <a class="reference external" href="mailto:zyedidia&#37;&#52;&#48;cs&#46;stanford&#46;edu">zyedidia<span>&#64;</span>cs<span>&#46;</span>stanford<span>&#46;</span>edu</a></p></li>
<li><p>Tal Garfinkel - <a class="reference external" href="mailto:tgarfinkel&#37;&#52;&#48;google&#46;com">tgarfinkel<span>&#64;</span>google<span>&#46;</span>com</a></p></li>
<li><p>Sharjeel Khan - <a class="reference external" href="mailto:sharjeelkhan&#37;&#52;&#48;google&#46;com">sharjeelkhan<span>&#64;</span>google<span>&#46;</span>com</a></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="LinkTimeOptimization.html" title="LLVM Link Time Optimization: Design and Implementation"
             >next</a> |</li>
        <li class="right" >
          <a href="KeyInstructionsDebugInfo.html" title="Key Instructions debug info in LLVM and Clang"
             >previous</a> |</li>
  <li><a href="https://llvm.org/">LLVM Home</a>&nbsp;|&nbsp;</li>
  <li><a href="index.html">Documentation</a>&raquo;</li>

          <li class="nav-item nav-item-1"><a href="UserGuides.html" >User Guides</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Lightweight Fault Isolation (LFI) in LLVM</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2003-2026, LLVM Project.
      Last updated on 2026-01-27.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>