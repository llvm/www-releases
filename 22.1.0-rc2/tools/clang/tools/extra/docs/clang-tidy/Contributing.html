<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Getting Involved &#8212; Extra Clang Tools 22.1.0-rc2 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="../_static/haiku.css?v=e491ac2d" />
    <link rel="stylesheet" href="../_static/clang-tools-extra-styles.css" type="text/css" />
    <script src="../_static/documentation_options.js?v=106f770c"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="External Clang-Tidy Examples" href="ExternalClang-TidyExamples.html" />
    <link rel="prev" title="Clang-tidy IDE/Editor Integrations" href="Integrations.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../index.html">
          <span>Extra Clang Tools 22.1.0-rc2 documentation</span></a></h1>
        <h2 class="heading"><span>Getting Involved</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="Integrations.html">Clang-tidy IDE/Editor Integrations</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="ExternalClang-TidyExamples.html">External Clang-Tidy Examples</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="getting-involved">
<h1>Getting Involved<a class="headerlink" href="#getting-involved" title="Link to this heading">¶</a></h1>
<p><strong class="program">clang-tidy</strong> has several own checks and can run Clang static analyzer
checks, but its power is in the ability to easily write custom checks.</p>
<p>Checks are organized in modules, which can be linked into <strong class="program">clang-tidy</strong>
with minimal or no code changes in <strong class="program">clang-tidy</strong>.</p>
<p>Checks can plug into the analysis on the preprocessor level using
<a class="reference external" href="https://clang.llvm.org/doxygen/classclang_1_1PPCallbacks.html">PPCallbacks</a> or on the AST level using <a class="reference external" href="https://clang.llvm.org/docs/LibASTMatchers.html">AST Matchers</a>. When an error is
found, checks can report them in a way similar to how Clang diagnostics work.
A fix-it hint can be attached to a diagnostic message.</p>
<p>The interface provided by <strong class="program">clang-tidy</strong> makes it easy to write useful
and precise checks in just a few lines of code. If you have an idea for a good
check, the rest of this document explains how to do this.</p>
<dl class="simple">
<dt>There are a few tools particularly useful when developing clang-tidy checks:</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">add_new_check.py</span></code> is a script to automate the process of adding a new
check; it will create the check, update the CMake file and create a test.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rename_check.py</span></code> does what the script name suggests, renames an existing
check.</p></li>
<li><p><strong class="program">pp-trace</strong> logs method calls on <cite>PPCallbacks</cite> for a source file
and is invaluable in understanding the preprocessor mechanism.</p></li>
<li><p><strong class="program">clang-query</strong> is invaluable for interactive prototyping of AST
matchers and exploration of the Clang AST;</p></li>
<li><p><a class="reference external" href="https://clang.llvm.org/docs/ClangCheck.html">clang-check</a> with the <code class="docutils literal notranslate"><span class="pre">-ast-dump</span></code> (and optionally <code class="docutils literal notranslate"><span class="pre">-ast-dump-filter</span></code>)
provides a convenient way to dump AST of a C++ program.</p></li>
</ul>
</dd>
</dl>
<p>If CMake is configured with <code class="docutils literal notranslate"><span class="pre">CLANG_TIDY_ENABLE_STATIC_ANALYZER=NO</span></code>,
<strong class="program">clang-tidy</strong> will not be built with support for the
<code class="docutils literal notranslate"><span class="pre">clang-analyzer-*</span></code> checks or the <code class="docutils literal notranslate"><span class="pre">mpi-*</span></code> checks.</p>
<p>If CMake is configured with <code class="docutils literal notranslate"><span class="pre">CLANG_TIDY_ENABLE_QUERY_BASED_CUSTOM_CHECKS=NO</span></code>,
<strong class="program">clang-tidy</strong> will not be built with support for query based checks.</p>
<section id="choosing-the-right-place-for-your-check">
<h2>Choosing the Right Place for your Check<a class="headerlink" href="#choosing-the-right-place-for-your-check" title="Link to this heading">¶</a></h2>
<p>If you have an idea of a check, you should decide whether it should be
implemented as a:</p>
<ul class="simple">
<li><p><em>Clang diagnostic</em>: if the check is generic enough, targets code patterns that
most probably are bugs (rather than style or readability issues), can be
implemented effectively and with extremely low false-positive rate, it may
make a good Clang diagnostic.</p></li>
<li><p><em>Clang static analyzer check</em>: if the check requires some sort of control flow
analysis, it should probably be implemented as a static analyzer check.</p></li>
<li><p><em>clang-tidy check</em> is a good choice for linter-style checks, checks that are
related to a certain coding style, checks that address code readability, etc.</p></li>
</ul>
</section>
<section id="preparing-your-workspace">
<h2>Preparing your Workspace<a class="headerlink" href="#preparing-your-workspace" title="Link to this heading">¶</a></h2>
<p>If you are new to LLVM development, you should read the <a class="reference external" href="https://llvm.org/docs/GettingStarted.html">Getting Started with
the LLVM System</a>, <a class="reference external" href="https://clang.llvm.org/docs/ClangTools.html">Using Clang Tools</a> and <a class="reference external" href="https://clang.llvm.org/docs/HowToSetupToolingForLLVM.html">How To Setup Clang Tooling For
LLVM</a> documents to check out and build LLVM, Clang and Clang Extra Tools with
CMake.</p>
<p>Once you are done, change to the <code class="docutils literal notranslate"><span class="pre">llvm/clang-tools-extra</span></code> directory, and
let’s start!</p>
<p>When you <a class="reference external" href="https://llvm.org/docs/GettingStarted.html#local-llvm-configuration">configure the CMake build</a>,
make sure that you enable the <code class="docutils literal notranslate"><span class="pre">clang</span></code> and <code class="docutils literal notranslate"><span class="pre">clang-tools-extra</span></code> projects to
build <strong class="program">clang-tidy</strong>.
Because your new check will have associated documentation, you will also want
to install <a class="reference external" href="https://www.sphinx-doc.org/en/master/">Sphinx</a> and enable it in
the CMake configuration. To save build time of the core Clang libraries, you
may want to only enable the <code class="docutils literal notranslate"><span class="pre">X86</span></code> target in the CMake configuration.</p>
</section>
<section id="the-directory-structure">
<h2>The Directory Structure<a class="headerlink" href="#the-directory-structure" title="Link to this heading">¶</a></h2>
<p><strong class="program">clang-tidy</strong> source code resides in the
<code class="docutils literal notranslate"><span class="pre">llvm/clang-tools-extra</span></code> directory and is structured as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">clang</span><span class="o">-</span><span class="n">tidy</span><span class="o">/</span>                       <span class="c1"># Clang-tidy core.</span>
<span class="o">|--</span> <span class="n">ClangTidy</span><span class="o">.</span><span class="n">h</span>                   <span class="c1"># Interfaces for users.</span>
<span class="o">|--</span> <span class="n">ClangTidyCheck</span><span class="o">.</span><span class="n">h</span>              <span class="c1"># Interfaces for checks.</span>
<span class="o">|--</span> <span class="n">ClangTidyModule</span><span class="o">.</span><span class="n">h</span>             <span class="c1"># Interface for clang-tidy modules.</span>
   <span class="o">...</span>
<span class="o">|--</span> <span class="n">google</span><span class="o">/</span>                       <span class="c1"># Google clang-tidy module.</span>
<span class="o">|-+</span>
  <span class="o">|--</span> <span class="n">GoogleTidyModule</span><span class="o">.</span><span class="n">cpp</span>
  <span class="o">|--</span> <span class="n">GoogleTidyModule</span><span class="o">.</span><span class="n">h</span>
        <span class="o">...</span>
<span class="o">|--</span> <span class="n">llvm</span><span class="o">/</span>                         <span class="c1"># LLVM clang-tidy module.</span>
<span class="o">|-+</span>
  <span class="o">|--</span> <span class="n">LLVMTidyModule</span><span class="o">.</span><span class="n">cpp</span>
  <span class="o">|--</span> <span class="n">LLVMTidyModule</span><span class="o">.</span><span class="n">h</span>
        <span class="o">...</span>
<span class="o">|--</span> <span class="n">objc</span><span class="o">/</span>                         <span class="c1"># Objective-C clang-tidy module.</span>
<span class="o">|-+</span>
  <span class="o">|--</span> <span class="n">ObjCTidyModule</span><span class="o">.</span><span class="n">cpp</span>
  <span class="o">|--</span> <span class="n">ObjCTidyModule</span><span class="o">.</span><span class="n">h</span>
        <span class="o">...</span>
<span class="o">|--</span> <span class="n">tool</span><span class="o">/</span>                         <span class="c1"># Sources of the clang-tidy binary.</span>
        <span class="o">...</span>
<span class="n">test</span><span class="o">/</span><span class="n">clang</span><span class="o">-</span><span class="n">tidy</span><span class="o">/</span>                  <span class="c1"># Integration tests.</span>
    <span class="o">...</span>
<span class="n">unittests</span><span class="o">/</span><span class="n">clang</span><span class="o">-</span><span class="n">tidy</span><span class="o">/</span>             <span class="c1"># Unit tests.</span>
<span class="o">|--</span> <span class="n">ClangTidyTest</span><span class="o">.</span><span class="n">h</span>
<span class="o">|--</span> <span class="n">GoogleModuleTest</span><span class="o">.</span><span class="n">cpp</span>
<span class="o">|--</span> <span class="n">LLVMModuleTest</span><span class="o">.</span><span class="n">cpp</span>
<span class="o">|--</span> <span class="n">ObjCModuleTest</span><span class="o">.</span><span class="n">cpp</span>
    <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="writing-a-clang-tidy-check">
<h2>Writing a clang-tidy Check<a class="headerlink" href="#writing-a-clang-tidy-check" title="Link to this heading">¶</a></h2>
<p>So you have an idea of a useful check for <strong class="program">clang-tidy</strong>.</p>
<p>First, if you’re not familiar with LLVM development, read through the <a class="reference external" href="https://llvm.org/docs/GettingStarted.html">Getting
Started with the LLVM System</a> document for instructions on setting up your
workflow and the <a class="reference external" href="https://llvm.org/docs/CodingStandards.html">LLVM Coding Standards</a> document to familiarize yourself
with the coding style used in the project. For code reviews, we currently
use <a class="reference external" href="https://github.com/llvm/llvm-project">LLVM Github</a>, though historically we used Phabricator.</p>
<p>Next, you need to decide which module the check belongs to. Modules
are located in subdirectories of <a class="reference external" href="https://github.com/llvm/llvm-project/tree/main/clang-tools-extra/clang-tidy/">clang-tidy/</a>
and contain checks targeting a certain aspect of code quality (performance,
readability, etc.), a certain coding style or standard (Google, LLVM, CERT,
etc.) or a widely used API (e.g. MPI). Their names are the same as the
user-facing check group names described <a class="reference internal" href="index.html#checks-groups-table"><span class="std std-ref">above</span></a>.</p>
<p>After choosing the module and the name for the check, run the
<code class="docutils literal notranslate"><span class="pre">clang-tidy/add_new_check.py</span></code> script to create the skeleton of the check and
plug it to <strong class="program">clang-tidy</strong>. It’s the recommended way of adding new
checks.</p>
<p>By default, the new check will apply only to C++ code. If it should apply under
different language options, use the <code class="docutils literal notranslate"><span class="pre">--language</span></code> script’s parameter.</p>
<p>If we want to create a <cite>readability-awesome-function-names</cite>, we would run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>clang-tidy/add_new_check.py<span class="w"> </span>readability<span class="w"> </span>awesome-function-names
</pre></div>
</div>
<dl class="simple">
<dt>The <code class="docutils literal notranslate"><span class="pre">add_new_check.py</span></code> script will:</dt><dd><ul class="simple">
<li><p>create the class for your check inside the specified module’s directory and
register it in the module and in the build system;</p></li>
<li><p>create a lit test file in the <code class="docutils literal notranslate"><span class="pre">test/clang-tidy/</span></code> directory;</p></li>
<li><p>create a documentation file and include it into the
<code class="docutils literal notranslate"><span class="pre">docs/clang-tidy/checks/list.rst</span></code>.</p></li>
</ul>
</dd>
</dl>
<p>Let’s look at the check class definition in more detail:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="p">...</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;../ClangTidyCheck.h&quot;</span>

<span class="k">namespace</span><span class="w"> </span><span class="nn">clang</span><span class="o">::</span><span class="nn">tidy</span><span class="o">::</span><span class="nn">readability</span><span class="w"> </span><span class="p">{</span>

<span class="p">...</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AwesomeFunctionNamesCheck</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ClangTidyCheck</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">AwesomeFunctionNamesCheck</span><span class="p">(</span><span class="n">StringRef</span><span class="w"> </span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">ClangTidyContext</span><span class="w"> </span><span class="o">*</span><span class="n">Context</span><span class="p">)</span>
<span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="n">ClangTidyCheck</span><span class="p">(</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">registerMatchers</span><span class="p">(</span><span class="n">ast_matchers</span><span class="o">::</span><span class="n">MatchFinder</span><span class="w"> </span><span class="o">*</span><span class="n">Finder</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">check</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ast_matchers</span><span class="o">::</span><span class="n">MatchFinder</span><span class="o">::</span><span class="n">MatchResult</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Result</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="p">;</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">isLanguageVersionSupported</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">LangOptions</span><span class="w"> </span><span class="o">&amp;</span><span class="n">LangOpts</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">LangOpts</span><span class="p">.</span><span class="n">CPlusPlus</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>

<span class="p">}</span><span class="w"> </span><span class="c1">// namespace clang::tidy::readability</span>

<span class="p">...</span>
</pre></div>
</div>
<p>Constructor of the check receives the <code class="docutils literal notranslate"><span class="pre">Name</span></code> and <code class="docutils literal notranslate"><span class="pre">Context</span></code> parameters, and
must forward them to the <code class="docutils literal notranslate"><span class="pre">ClangTidyCheck</span></code> constructor.</p>
<p>In our case the check needs to operate on the AST level and it overrides the
<code class="docutils literal notranslate"><span class="pre">registerMatchers</span></code> and <code class="docutils literal notranslate"><span class="pre">check</span></code> methods. If we wanted to analyze code on the
preprocessor level, we’d need instead to override the <code class="docutils literal notranslate"><span class="pre">registerPPCallbacks</span></code>
method.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">registerMatchers</span></code> method, we create an AST Matcher (see <a class="reference external" href="https://clang.llvm.org/docs/LibASTMatchers.html">AST
Matchers</a> for more information) that will find the pattern in the AST that we
want to inspect. The results of the matching are passed to the <code class="docutils literal notranslate"><span class="pre">check</span></code> method,
which can further inspect them and report diagnostics.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">ast_matchers</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">AwesomeFunctionNamesCheck::registerMatchers</span><span class="p">(</span><span class="n">MatchFinder</span><span class="w"> </span><span class="o">*</span><span class="n">Finder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Finder</span><span class="o">-&gt;</span><span class="n">addMatcher</span><span class="p">(</span><span class="n">functionDecl</span><span class="p">().</span><span class="n">bind</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">),</span><span class="w"> </span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">AwesomeFunctionNamesCheck::check</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">MatchFinder</span><span class="o">::</span><span class="n">MatchResult</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">MatchedDecl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Result</span><span class="p">.</span><span class="n">Nodes</span><span class="p">.</span><span class="n">getNodeAs</span><span class="o">&lt;</span><span class="n">FunctionDecl</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">MatchedDecl</span><span class="o">-&gt;</span><span class="n">getIdentifier</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">MatchedDecl</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">().</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;awesome_&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="w">  </span><span class="n">diag</span><span class="p">(</span><span class="n">MatchedDecl</span><span class="o">-&gt;</span><span class="n">getLocation</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;function %0 is insufficiently awesome&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">MatchedDecl</span>
<span class="w">      </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">FixItHint</span><span class="o">::</span><span class="n">CreateInsertion</span><span class="p">(</span><span class="n">MatchedDecl</span><span class="o">-&gt;</span><span class="n">getLocation</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;awesome_&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>(If you want to see an example of a useful check, look at
<a class="reference external" href="https://github.com/llvm/llvm-project/blob/main/clang-tools-extra/clang-tidy/google/ExplicitConstructorCheck.h">clang-tidy/google/ExplicitConstructorCheck.h</a>
and <a class="reference external" href="https://reviews.llvm.org/diffusion/L/browse/clang-tools-extra/trunk/clang-tidy/google/ExplicitConstructorCheck.cpp">clang-tidy/google/ExplicitConstructorCheck.cpp</a>).</p>
<p>If you need to interact with macros or preprocessor directives, you will want
to override the method <code class="docutils literal notranslate"><span class="pre">registerPPCallbacks</span></code>. The <code class="docutils literal notranslate"><span class="pre">add_new_check.py</span></code>
script does not generate an override for this method in the starting point for
your new check.</p>
</section>
<section id="check-development-tips">
<h2>Check development tips<a class="headerlink" href="#check-development-tips" title="Link to this heading">¶</a></h2>
<p>Writing your first check can be a daunting task, particularly if you are
unfamiliar with the LLVM and Clang code bases. Here are some suggestions for
orienting yourself in the codebase and working on your check incrementally.</p>
<section id="guide-to-useful-documentation">
<h3>Guide to useful documentation<a class="headerlink" href="#guide-to-useful-documentation" title="Link to this heading">¶</a></h3>
<p>Many of the support classes created for LLVM are used by Clang, such as <a class="reference external" href="https://llvm.org/docs/ProgrammersManual.html#the-stringref-class">StringRef</a>
and <a class="reference external" href="https://llvm.org/docs/ProgrammersManual.html#llvm-adt-smallvector-h">SmallVector</a>.
These and other commonly used classes are described in the <a class="reference external" href="https://llvm.org/docs/ProgrammersManual.html#important-and-useful-llvm-apis">Important and
useful LLVM APIs</a>
and <a class="reference external" href="https://llvm.org/docs/ProgrammersManual.html#picking-the-right-data-structure-for-a-task">Picking the Right Data Structure for the Task</a>
sections of the <cite>LLVM Programmer’s Manual
&lt;https://llvm.org/docs/ProgrammersManual.html&gt;</cite>. You don’t need to memorize all the
details of these classes; the generated <a class="reference external" href="https://llvm.org/doxygen/">doxygen documentation</a>
has everything if you need it. In the header <a class="reference external" href="https://llvm.org/doxygen/STLExtras_8h.html">LLVM/ADT/STLExtras.h</a> you’ll find useful versions of the STL
algorithms that operate on LLVM containers, such as <a class="reference external" href="https://llvm.org/doxygen/STLExtras_8h.html#func-members">llvm::all_of</a>.</p>
<p>Clang is implemented on top of LLVM and introduces its own set of classes that
you will interact with while writing your check. When a check issues
diagnostics and fix-its, these are associated with locations in the source
code. Source code locations, source files, ranges of source locations and the
<a class="reference external" href="https://clang.llvm.org/doxygen/classclang_1_1SourceManager.html">SourceManager</a>
class provide the mechanisms for describing such locations. These and
other topics are described in the <a class="reference external" href="https://clang.llvm.org/docs/InternalsManual.html">“Clang” CFE Internals Manual</a>. Whereas the doxygen generated
documentation serves as a reference to the internals of Clang, this document
serves as a guide to other developers. Topics in that manual of interest to a
check developer are:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://clang.llvm.org/docs/InternalsManual.html#the-clang-basic-library">The Clang “Basic” Library</a> for
information about diagnostics, fix-it hints and source locations.</p></li>
<li><p><a class="reference external" href="https://clang.llvm.org/docs/InternalsManual.html#the-lexer-and-preprocessor-library">The Lexer and Preprocessor Library</a>
for information about tokens, lexing (transforming characters into tokens)
and the preprocessor.</p></li>
<li><p><a class="reference external" href="https://clang.llvm.org/docs/InternalsManual.html#the-ast-library">The AST Library</a>
for information about how C++ source statements are represented as an
abstract syntax tree (AST).</p></li>
</ul>
<p>Most checks will interact with C++ source code via the AST. Some checks will
interact with the preprocessor. The input source file is lexed and preprocessed
and then parsed into the AST. Once the AST is fully constructed, the check is
run by applying the check’s registered AST matchers against the AST and
invoking the check with the set of matched nodes from the AST. Monitoring the
actions of the preprocessor is detached from the AST construction, but a check
can collect information during preprocessing for later use by the check when
nodes are matched by the AST.</p>
<p>Every syntactic (and sometimes semantic) element of the C++ source code is
represented by different classes in the AST. You select the portions of the
AST you’re interested in by composing AST matcher functions. You will want
to study carefully the <a class="reference external" href="https://clang.llvm.org/docs/LibASTMatchersReference.html">AST Matcher Reference</a>
to understand the relationship between the different matcher functions.</p>
</section>
<section id="using-the-transformer-library">
<h3>Using the Transformer library<a class="headerlink" href="#using-the-transformer-library" title="Link to this heading">¶</a></h3>
<p>The Transformer library allows you to write a check that transforms source code
by expressing the transformation as a <code class="docutils literal notranslate"><span class="pre">RewriteRule</span></code>. The Transformer library
provides functions for composing edits to source code to create rewrite rules.
Unless you need to perform low-level source location manipulation, you may want
to consider writing your check with the Transformer library. The <a class="reference external" href="https://clang.llvm.org/docs/ClangTransformerTutorial.html">Clang
Transformer Tutorial</a>
describes the Transformer library in detail.</p>
<p>To use the Transformer library, make the following changes to the code
generated by the <code class="docutils literal notranslate"><span class="pre">add_new_check.py</span></code> script:</p>
<ul class="simple">
<li><p>Include <code class="docutils literal notranslate"><span class="pre">../utils/TransformerClangTidyCheck.h</span></code> instead of
<code class="docutils literal notranslate"><span class="pre">../ClangTidyCheck.h</span></code></p></li>
<li><p>Change the base class of your check from <code class="docutils literal notranslate"><span class="pre">ClangTidyCheck</span></code> to
<code class="docutils literal notranslate"><span class="pre">TransformerClangTidyCheck</span></code></p></li>
<li><p>Delete the override of the <code class="docutils literal notranslate"><span class="pre">registerMatchers</span></code> and <code class="docutils literal notranslate"><span class="pre">check</span></code> methods in
your check class.</p></li>
<li><p>Write a function that creates the <code class="docutils literal notranslate"><span class="pre">RewriteRule</span></code> for your check.</p></li>
<li><p>Call the function in your check’s constructor to pass the rewrite rule to
<code class="docutils literal notranslate"><span class="pre">TransformerClangTidyCheck</span></code>’s constructor.</p></li>
</ul>
</section>
<section id="developing-your-check-incrementally">
<h3>Developing your check incrementally<a class="headerlink" href="#developing-your-check-incrementally" title="Link to this heading">¶</a></h3>
<p>The best way to develop your check is to start with simple test cases and
increase complexity incrementally. The test file created by the
<code class="docutils literal notranslate"><span class="pre">add_new_check.py</span></code> script is a starting point for your test cases.
A rough outline of the process looks like this:</p>
<ul class="simple">
<li><p>Write a test case for your check.</p></li>
<li><p>Prototype matchers on the test file using <strong class="program">clang-query</strong>.</p></li>
<li><p>Capture the working matchers in the <code class="docutils literal notranslate"><span class="pre">registerMatchers</span></code> method.</p></li>
<li><p>Issue the necessary diagnostics and fix-its in the <code class="docutils literal notranslate"><span class="pre">check</span></code> method.</p></li>
<li><p>Add the necessary <code class="docutils literal notranslate"><span class="pre">CHECK-MESSAGES</span></code> and <code class="docutils literal notranslate"><span class="pre">CHECK-FIXES</span></code> annotations to your
test case to validate the diagnostics and fix-its.</p></li>
<li><p>Build the target <code class="docutils literal notranslate"><span class="pre">check-clang-tools</span></code> to confirm the test passes.</p></li>
<li><p>Repeat the process until all aspects of your check are covered by tests.</p></li>
</ul>
<p>The quickest way to prototype your matcher is to use <strong class="program">clang-query</strong> to
interactively build up your matcher. For complicated matchers, build up a
matching expression incrementally and use <strong class="program">clang-query</strong>’s <code class="docutils literal notranslate"><span class="pre">let</span></code>
command to save named matching expressions to simplify your matcher.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">clang-query&gt; let c1 cxxRecordDecl()</span>
<span class="go">clang-query&gt; match c1</span>
</pre></div>
</div>
<p>Alternatively, pressing the tab key after a previous matcher’s open parentheses
would also show which matchers can be chained with the previous matcher,
though some matchers that work may not be listed. Note that tab completion
does not currently work on Windows.</p>
<p>Just like breaking up a huge function into smaller chunks with
intention-revealing names can help you understand a complex algorithm, breaking
up a matcher into smaller matchers with intention-revealing names can help
you understand a complicated matcher.</p>
<p>Once you have a working <strong class="program">clang-query</strong> matcher, the C++ API matchers
will be the same or similar to your interactively constructed matcher (there
can be cases where they differ slightly). You can use local variables to
preserve your intention-revealing names that you applied to nested matchers.</p>
</section>
<section id="creating-private-matchers">
<h3>Creating private matchers<a class="headerlink" href="#creating-private-matchers" title="Link to this heading">¶</a></h3>
<p>Sometimes you want to match a specific aspect of the AST that isn’t provided
by the existing AST matchers. You can create your own private matcher using
the same infrastructure as the public matchers. A private matcher can
simplify the processing in your <code class="docutils literal notranslate"><span class="pre">check</span></code> method by eliminating complex
hand-crafted AST traversal of the matched nodes. Using the private matcher
allows you to select the desired portions of the AST directly in the matcher
and refer to it by a bound name in the <code class="docutils literal notranslate"><span class="pre">check</span></code> method.</p>
</section>
<section id="unit-testing-helper-code">
<h3>Unit testing helper code<a class="headerlink" href="#unit-testing-helper-code" title="Link to this heading">¶</a></h3>
<p>Private custom matchers are a good example of auxiliary support code for your
check that can be tested with a unit test. It will be easier to test your
matchers or other support classes by writing a unit test than by writing a
<code class="docutils literal notranslate"><span class="pre">FileCheck</span></code> integration test. The <code class="docutils literal notranslate"><span class="pre">ASTMatchersTests</span></code> target contains unit
tests for the public AST matcher classes and is a good source of testing
idioms for matchers.</p>
<p>You can build the Clang-Tidy unit tests by building the <code class="docutils literal notranslate"><span class="pre">ClangTidyTests</span></code>
target. Test targets in LLVM and Clang are excluded from the “build all” style
action of IDE-based CMake generators, so you need to explicitly build the
target for the unit tests to be built.</p>
</section>
<section id="making-your-check-robust">
<h3>Making your check robust<a class="headerlink" href="#making-your-check-robust" title="Link to this heading">¶</a></h3>
<p>Once you’ve covered your check with the basic “happy path” scenarios, you’ll
want to torture your check with as many edge cases as you can cover in order to
ensure your check is robust. Running your check on a large code base, such as
Clang/LLVM, is a good way to catch things you forgot to account for in your
matchers. However, the LLVM code base may be insufficient for testing purposes
as it was developed against a particular set of coding styles and quality
measures. The larger the corpus of code the check is tested against, the
higher confidence the community will have in the check’s efficacy and
false-positive rate.</p>
<p>Some suggestions to ensure your check is robust:</p>
<ul class="simple">
<li><p>Create header files that contain code matched by your check.</p></li>
<li><p>Validate that fix-its are properly applied to test header files with
<strong class="program">clang-tidy</strong>. You will need to perform this test manually until
automated support for checking messages and fix-its is added to the
<code class="docutils literal notranslate"><span class="pre">check_clang_tidy.py</span></code> script.</p></li>
<li><p>Define macros that contain code matched by your check.</p></li>
<li><p>Define template classes that contain code matched by your check.</p></li>
<li><p>Define template specializations that contain code matched by your check.</p></li>
<li><p>Test your check under both Windows and Linux environments.</p></li>
<li><p>Watch out for high false-positive rates. Ideally, a check would have no
false positives, but given that matching against an AST is not control-
or data flow- sensitive, a number of false positives are expected. The
higher the false-positive rate, the less likely the check will be adopted
in practice. Mechanisms should be put in place to help the user manage
false positives.</p></li>
<li><p>There are two primary mechanisms for managing false positives: supporting a
code pattern which allows the programmer to silence the diagnostic in an ad
hoc manner and check configuration options to control the behavior of the
check.</p></li>
<li><p>Consider supporting a code pattern to allow the programmer to silence the
diagnostic whenever such a code pattern can clearly express the programmer’s
intent. For example, allowing an explicit cast to <code class="docutils literal notranslate"><span class="pre">void</span></code> to silence an
unused variable diagnostic.</p></li>
<li><p>Consider adding check configuration options to allow the user to opt into
more aggressive checking behavior without burdening users for the common
high-confidence cases.</p></li>
</ul>
</section>
<section id="documenting-your-check">
<h3>Documenting your check<a class="headerlink" href="#documenting-your-check" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">add_new_check.py</span></code> script creates entries in the
<a class="reference external" href="https://clang.llvm.org/extra/ReleaseNotes.html">release notes</a>, the list of</p>
<p>checks and a new file for the check documentation itself. It is recommended
that you have a concise summary of what your check does in a single sentence
that is repeated in the release notes, as the first sentence in the doxygen
comments in the header file for your check class and as the first sentence of
the check documentation. Avoid the phrase “this check” in your check summary
and check documentation.</p>
<p>If your check relates to a published coding guideline (C++ Core Guidelines,
SEI CERT, etc.) or style guide, provide links to the relevant guideline or
style guide sections in your check documentation.</p>
<p>Provide enough examples of the diagnostics and fix-its provided by the check so
that a user can easily understand what will happen to their code when the check
is run. If there are exceptions or limitations to your check, document them
thoroughly. This will help users understand the scope of the diagnostics and
fix-its provided by the check.</p>
<p>Building the target <code class="docutils literal notranslate"><span class="pre">docs-clang-tools-html</span></code> will run the Sphinx documentation
generator and create HTML documentation files in the
<code class="docutils literal notranslate"><span class="pre">tools/clang/tools/extra/docs/html</span></code> directory in your build tree.
Make sure that your check is correctly shown in the release notes and the list
of checks. Make sure that the formatting and structure of your check’s
documentation look correct: there is no trailing whitespaces and lines are no
longer than 80 characters.</p>
<p>To validate your files, please use <code class="docutils literal notranslate"><span class="pre">doc8</span></code> as described below.</p>
<p>Clang-Tidy uses <a class="reference external" href="https://pypi.org/project/doc8/">doc8</a> to check <code class="docutils literal notranslate"><span class="pre">.rst</span></code>
files for formatting consistency. You can install <code class="docutils literal notranslate"><span class="pre">doc8</span></code> with <code class="docutils literal notranslate"><span class="pre">pip</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>pip<span class="w"> </span>install<span class="w"> </span>doc8
</pre></div>
</div>
<p>To run <code class="docutils literal notranslate"><span class="pre">doc8</span></code> on the modified documentations:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>diff<span class="w"> </span>--name-only<span class="w"> </span>HEAD<span class="w"> </span>--<span class="w"> </span>clang-tools-extra/docs/clang-tidy/<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;\.rst</span>$<span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>-r<span class="w"> </span>doc8
</pre></div>
</div>
</section>
</section>
<section id="registering-your-check">
<h2>Registering your Check<a class="headerlink" href="#registering-your-check" title="Link to this heading">¶</a></h2>
<p>(The <code class="docutils literal notranslate"><span class="pre">add_new_check.py</span></code> script takes care of registering the check in an
existing module. If you want to create a new module or know the details,
read on.)</p>
<p>The check should be registered in the corresponding module with a distinct
name:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyModule</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ClangTidyModule</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">addCheckFactories</span><span class="p">(</span><span class="n">ClangTidyCheckFactories</span><span class="w"> </span><span class="o">&amp;</span><span class="n">CheckFactories</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">CheckFactories</span><span class="p">.</span><span class="n">registerCheck</span><span class="o">&lt;</span><span class="n">ExplicitConstructorCheck</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;my-explicit-constructor&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Now we need to register the module in the <code class="docutils literal notranslate"><span class="pre">ClangTidyModuleRegistry</span></code> using a
statically initialized variable:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">ClangTidyModuleRegistry</span><span class="o">::</span><span class="n">Add</span><span class="o">&lt;</span><span class="n">MyModule</span><span class="o">&gt;</span><span class="w"> </span><span class="n">X</span><span class="p">(</span><span class="s">&quot;my-module&quot;</span><span class="p">,</span>
<span class="w">                                                </span><span class="s">&quot;Adds my lint checks.&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>When using LLVM build system, we need to use the following hack to ensure the
module is linked into the <strong class="program">clang-tidy</strong> binary:</p>
<p>Add this near the <code class="docutils literal notranslate"><span class="pre">ClangTidyModuleRegistry::Add&lt;MyModule&gt;</span></code> variable:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// This anchor is used to force the linker to link in the generated object file</span>
<span class="c1">// and thus register the MyModule.</span>
<span class="k">volatile</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MyModuleAnchorSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>And this to the main translation unit of the <strong class="program">clang-tidy</strong> binary (or
the binary you link the <code class="docutils literal notranslate"><span class="pre">clang-tidy</span></code> library in)
<code class="docutils literal notranslate"><span class="pre">clang-tidy/ClangTidyForceLinker.h</span></code>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// This anchor is used to force the linker to link the MyModule.</span>
<span class="k">extern</span><span class="w"> </span><span class="k">volatile</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MyModuleAnchorSource</span><span class="p">;</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">MyModuleAnchorDestination</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyModuleAnchorSource</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="configuring-checks">
<h2>Configuring Checks<a class="headerlink" href="#configuring-checks" title="Link to this heading">¶</a></h2>
<p>If a check needs configuration options, it can access check-specific options
using the <code class="docutils literal notranslate"><span class="pre">Options.get&lt;Type&gt;(&quot;SomeOption&quot;,</span> <span class="pre">DefaultValue)</span></code> call in the check
constructor. In this case, the check should also override the
<code class="docutils literal notranslate"><span class="pre">ClangTidyCheck::storeOptions</span></code> method to make the options provided by the
check discoverable. This method lets <strong class="program">clang-tidy</strong> know which options
the check implements and what the current values are (e.g. for the
<code class="docutils literal notranslate"><span class="pre">-dump-config</span></code> command-line option).</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyCheck</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ClangTidyCheck</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">SomeOption1</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">SomeOption2</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">MyCheck</span><span class="p">(</span><span class="n">StringRef</span><span class="w"> </span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">ClangTidyContext</span><span class="w"> </span><span class="o">*</span><span class="n">Context</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">ClangTidyCheck</span><span class="p">(</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="p">),</span>
<span class="w">      </span><span class="n">SomeOption1</span><span class="p">(</span><span class="n">Options</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;SomeOption1&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">-1U</span><span class="p">)),</span>
<span class="w">      </span><span class="n">SomeOption2</span><span class="p">(</span><span class="n">Options</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;SomeOption2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;some default&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{}</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">storeOptions</span><span class="p">(</span><span class="n">ClangTidyOptions</span><span class="o">::</span><span class="n">OptionMap</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Opts</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Options</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">Opts</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SomeOption1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SomeOption1</span><span class="p">);</span>
<span class="w">    </span><span class="n">Options</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">Opts</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SomeOption2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SomeOption2</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="p">...</span>
</pre></div>
</div>
<p>Assuming the check is registered with the name “my-check”, the option can then
be set in a <code class="docutils literal notranslate"><span class="pre">.clang-tidy</span></code> file in the following way:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">CheckOptions</span><span class="p">:</span>
<span class="w">  </span><span class="nt">my-check.SomeOption1</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">123</span>
<span class="w">  </span><span class="nt">my-check.SomeOption2</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;some</span><span class="nv"> </span><span class="s">other</span><span class="nv"> </span><span class="s">value&#39;</span>
</pre></div>
</div>
<p>If you need to specify check options on a command line, you can use the inline
YAML format:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>clang-tidy<span class="w"> </span>-config<span class="o">=</span><span class="s2">&quot;{CheckOptions: {a: b, x: y}}&quot;</span><span class="w"> </span>...
</pre></div>
</div>
</section>
<section id="testing-checks">
<h2>Testing Checks<a class="headerlink" href="#testing-checks" title="Link to this heading">¶</a></h2>
<p>To run tests for <strong class="program">clang-tidy</strong>, build the <code class="docutils literal notranslate"><span class="pre">check-clang-tools</span></code>
target. For instance, if you configured your CMake build with the ninja project
generator, use the command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ninja<span class="w"> </span>check-clang-tools
</pre></div>
</div>
<p><strong class="program">clang-tidy</strong> checks can be tested using either unit tests or
<a class="reference external" href="https://llvm.org/docs/CommandGuide/lit.html">lit</a> tests. Unit tests may be more convenient to test complex replacements
with strict checks. <a class="reference external" href="https://llvm.org/docs/CommandGuide/lit.html">Lit</a> tests allow using partial text matching and regular
expressions which makes them more suitable for writing compact tests for
diagnostic messages.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">check_clang_tidy.py</span></code> script provides an easy way to test both
diagnostic messages and fix-its. It filters out <code class="docutils literal notranslate"><span class="pre">CHECK</span></code> lines from the test
file, runs <strong class="program">clang-tidy</strong> and verifies messages and fixes with two
separate <a class="reference external" href="https://llvm.org/docs/CommandGuide/FileCheck.html">FileCheck</a> invocations: once with FileCheck’s directive
prefix set to <code class="docutils literal notranslate"><span class="pre">CHECK-MESSAGES</span></code>, validating the diagnostic messages,
and once with the directive prefix set to <code class="docutils literal notranslate"><span class="pre">CHECK-FIXES</span></code>, running
against the fixed code (i.e., the code after generated fix-its are
applied). In particular, <code class="docutils literal notranslate"><span class="pre">CHECK-FIXES:</span></code> can be used to check
that code was not modified by fix-its, by checking that it is present
unchanged in the fixed code. The full set of <a class="reference external" href="https://llvm.org/docs/CommandGuide/FileCheck.html">FileCheck</a> directives
is available (e.g., <code class="docutils literal notranslate"><span class="pre">CHECK-MESSAGES-SAME:</span></code>, <code class="docutils literal notranslate"><span class="pre">CHECK-MESSAGES-NOT:</span></code>), though
typically the basic <code class="docutils literal notranslate"><span class="pre">CHECK</span></code> forms (<code class="docutils literal notranslate"><span class="pre">CHECK-MESSAGES</span></code> and <code class="docutils literal notranslate"><span class="pre">CHECK-FIXES</span></code>)
are sufficient for clang-tidy tests. Note that the <a class="reference external" href="https://llvm.org/docs/CommandGuide/FileCheck.html">FileCheck</a>
documentation mostly assumes the default prefix (<code class="docutils literal notranslate"><span class="pre">CHECK</span></code>), and hence
describes the directive as <code class="docutils literal notranslate"><span class="pre">CHECK:</span></code>, <code class="docutils literal notranslate"><span class="pre">CHECK-SAME:</span></code>, <code class="docutils literal notranslate"><span class="pre">CHECK-NOT:</span></code>, etc.
Replace <code class="docutils literal notranslate"><span class="pre">CHECK</span></code> with either <code class="docutils literal notranslate"><span class="pre">CHECK-FIXES</span></code> or <code class="docutils literal notranslate"><span class="pre">CHECK-MESSAGES</span></code> for
clang-tidy tests.</p>
<p>An additional check enabled by <code class="docutils literal notranslate"><span class="pre">check_clang_tidy.py</span></code> ensures that
if <cite>CHECK-MESSAGES:</cite> is used in a file then every warning or error
must have an associated CHECK in that file. Or, you can use <code class="docutils literal notranslate"><span class="pre">CHECK-NOTES:</span></code>
instead, if you want to <strong>also</strong> ensure that all the notes are checked.</p>
<p>To use the <code class="docutils literal notranslate"><span class="pre">check_clang_tidy.py</span></code> script, put a .cpp file with the
appropriate <code class="docutils literal notranslate"><span class="pre">RUN</span></code> line in the <code class="docutils literal notranslate"><span class="pre">test/clang-tidy</span></code> directory. Use
<code class="docutils literal notranslate"><span class="pre">CHECK-MESSAGES:</span></code> and <code class="docutils literal notranslate"><span class="pre">CHECK-FIXES:</span></code> lines to write checks against
diagnostic messages and fixed code.</p>
<p>It’s advised to make the checks as specific as possible to avoid checks
matching incorrect parts of the input. Use <code class="docutils literal notranslate"><span class="pre">[[&#64;LINE+X]]</span></code>/<code class="docutils literal notranslate"><span class="pre">[[&#64;LINE-X]]</span></code>
substitutions and distinct function and variable names in the test code.</p>
<p>Here’s an example of a test using the <code class="docutils literal notranslate"><span class="pre">check_clang_tidy.py</span></code> script (the full
source code is at <a class="reference external" href="https://github.com/llvm/llvm-project/blob/main/clang-tools-extra/test/clang-tidy/checkers/google/readability-casting.cpp">test/clang-tidy/checkers/google/readability-casting.cpp</a>):</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// RUN: %check_clang_tidy %s google-readability-casting %t</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">a</span><span class="p">;</span>
<span class="w">  </span><span class="c1">// CHECK-MESSAGES: :[[@LINE-1]]:11: warning: redundant cast to the same type [google-readability-casting]</span>
<span class="w">  </span><span class="c1">// CHECK-FIXES: int b = a;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To check more than one scenario in the same test file, use
<code class="docutils literal notranslate"><span class="pre">-check-suffix=SUFFIX-NAME</span></code> on <code class="docutils literal notranslate"><span class="pre">check_clang_tidy.py</span></code> command line or
<code class="docutils literal notranslate"><span class="pre">-check-suffixes=SUFFIX-NAME-1,SUFFIX-NAME-2,...</span></code>.
With <code class="docutils literal notranslate"><span class="pre">-check-suffix[es]=SUFFIX-NAME</span></code> you need to replace your <code class="docutils literal notranslate"><span class="pre">CHECK-*</span></code>
directives with <code class="docutils literal notranslate"><span class="pre">CHECK-MESSAGES-SUFFIX-NAME</span></code> and <code class="docutils literal notranslate"><span class="pre">CHECK-FIXES-SUFFIX-NAME</span></code>.</p>
<p>Here’s an example:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// RUN: %check_clang_tidy -check-suffix=USING-A %s misc-unused-using-decls %t -- -- -DUSING_A</span>
<span class="c1">// RUN: %check_clang_tidy -check-suffix=USING-B %s misc-unused-using-decls %t -- -- -DUSING_B</span>
<span class="c1">// RUN: %check_clang_tidy %s misc-unused-using-decls %t</span>
<span class="p">...</span>
<span class="c1">// CHECK-MESSAGES-USING-A: :[[@LINE-8]]:10: warning: using decl &#39;A&#39; {{.*}}</span>
<span class="c1">// CHECK-MESSAGES-USING-B: :[[@LINE-7]]:10: warning: using decl &#39;B&#39; {{.*}}</span>
<span class="c1">// CHECK-MESSAGES: :[[@LINE-6]]:10: warning: using decl &#39;C&#39; {{.*}}</span>
<span class="c1">// CHECK-FIXES-USING-A-NOT: using a::A;$</span>
<span class="c1">// CHECK-FIXES-USING-B-NOT: using a::B;$</span>
<span class="c1">// CHECK-FIXES-NOT: using a::C;$</span>
</pre></div>
</div>
<p>There are many dark corners in the C++ language, and it may be difficult to
make your check work perfectly in all cases, especially if it issues fix-it
hints. The most frequent pitfalls are macros and templates:</p>
<ol class="arabic simple">
<li><p>Code written in a macro body/template definition may have a different
meaning depending on the macro expansion/template instantiation.</p></li>
<li><p>Multiple macro expansions/template instantiations may result in the
same code being inspected by the check multiple times (possibly, with
different meanings, see 1), and the same warning (or a slightly different
one) may be issued by the check multiple times; <strong class="program">clang-tidy</strong> will
deduplicate _identical_ warnings, but if the warnings are slightly
different, all of them will be shown to the user (and used for applying
fixes, if any).</p></li>
<li><p>Making replacements to a macro body/template definition may be fine for
some macro expansions/template instantiations, but easily break some other
expansions/instantiations.</p></li>
</ol>
<p>If you need multiple files to exercise all the aspects of your check, it is
recommended you place them in a subdirectory named for the check under the
<code class="docutils literal notranslate"><span class="pre">Inputs</span></code> directory for the module containing your check. This keeps the
test directory from getting cluttered.</p>
<p>If you need to validate how your check interacts with system header files, a
set of simulated system header files is located in the
<code class="docutils literal notranslate"><span class="pre">checkers/Inputs/Headers</span></code> directory. The path to this directory is
available in a lit test with the variable <code class="docutils literal notranslate"><span class="pre">%clang_tidy_headers</span></code>.</p>
</section>
<section id="submitting-a-pull-request">
<h2>Submitting a Pull Request<a class="headerlink" href="#submitting-a-pull-request" title="Link to this heading">¶</a></h2>
<p>Before submitting a pull request, contributors are encouraged to run
<strong class="program">clang-tidy</strong> and <strong class="program">clang-format</strong> on their changes to ensure
code quality and catch potential issues. While <strong class="program">clang-tidy</strong> is not
currently enforced in CI, following this practice helps maintain code
consistency and prevent common errors.</p>
<p>Here’s a useful command to check your staged changes:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>diff<span class="w"> </span>--staged<span class="w"> </span>-U0<span class="w"> </span><span class="p">|</span><span class="w"> </span>./clang-tools-extra/clang-tidy/tool/clang-tidy-diff.py<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-j<span class="w"> </span><span class="k">$(</span>nproc<span class="k">)</span><span class="w"> </span>-path<span class="w"> </span>build/<span class="w"> </span>-p1<span class="w"> </span>-only-check-in-db
<span class="gp">$ </span>git<span class="w"> </span>clang-format
</pre></div>
</div>
<p>Note that some warnings may be false positives or require careful consideration
before fixing. Use your judgment and feel free to discuss in the pull request
if you’re unsure about a particular warning.</p>
</section>
<section id="out-of-tree-check-plugins">
<h2>Out-of-tree check plugins<a class="headerlink" href="#out-of-tree-check-plugins" title="Link to this heading">¶</a></h2>
<p>Developing an out-of-tree check as a plugin largely follows the steps
outlined above, including creating a new module and doing the hacks to
register the module. The plugin is a shared library whose code lives outside
the clang-tidy build system. Build and link this shared library against
LLVM as done for other kinds of Clang plugins. If using CMake, use the keyword
<code class="docutils literal notranslate"><span class="pre">MODULE</span></code> while invoking <code class="docutils literal notranslate"><span class="pre">add_library</span></code> or <code class="docutils literal notranslate"><span class="pre">llvm_add_library</span></code>.</p>
<p>The plugin can be loaded by passing <cite>-load</cite> to <cite>clang-tidy</cite> in addition to the
names of the checks to enable.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>clang-tidy<span class="w"> </span>--checks<span class="o">=</span>-*,my-explicit-constructor<span class="w"> </span>-list-checks<span class="w"> </span>-load<span class="w"> </span>myplugin.so
</pre></div>
</div>
<p>There are no expectations regarding ABI and API stability, so the plugin must
be compiled against the version of clang-tidy that will be loading the plugin.</p>
<p>The plugins can use threads, TLS, or any other facilities available to in-tree
code which is accessible from the external headers.</p>
<p>Note that testing out-of-tree checks might involve getting <code class="docutils literal notranslate"><span class="pre">llvm-lit</span></code> from an
LLVM installation compiled from source. See <a class="reference external" href="https://llvm.org/docs/GettingStarted.html">Getting Started with the LLVM
System</a> for ways to do so.</p>
<p>Alternatively, get <a class="reference external" href="https://llvm.org/docs/CommandGuide/lit.html">lit</a> following the <a class="reference external" href="https://llvm.org/docs/TestSuiteGuide.html">test-suite guide</a> and get the
<a class="reference external" href="https://llvm.org/docs/CommandGuide/FileCheck.html">FileCheck</a> binary, and write a version of <a class="reference external" href="https://github.com/llvm/llvm-project/blob/main/clang-tools-extra/test/clang-tidy/check_clang_tidy.py">check_clang_tidy.py</a> to suit your
needs.</p>
</section>
<section id="running-clang-tidy-on-llvm">
<h2>Running clang-tidy on LLVM<a class="headerlink" href="#running-clang-tidy-on-llvm" title="Link to this heading">¶</a></h2>
<p>To test a check, it’s best to try it out on a larger code base. LLVM and Clang
are the natural targets as you already have the source code around. The most
convenient way to run <strong class="program">clang-tidy</strong> is with a compile command database;
CMake can automatically generate one; for a description of how to enable it,
see <a class="reference external" href="https://clang.llvm.org/docs/HowToSetupToolingForLLVM.html">How To Setup Clang Tooling For LLVM</a>. Once <code class="docutils literal notranslate"><span class="pre">compile_commands.json</span></code> is
in place and a working version of <strong class="program">clang-tidy</strong> is in <code class="docutils literal notranslate"><span class="pre">PATH</span></code> the
entire code base can be analyzed with <code class="docutils literal notranslate"><span class="pre">clang-tidy/tool/run-clang-tidy.py</span></code>.
The script executes <strong class="program">clang-tidy</strong> with the default set of checks on
every translation unit in the compile command database and displays the
resulting warnings and errors. The script provides multiple configuration
flags.</p>
<ul class="simple">
<li><p>The default set of checks can be overridden using the <code class="docutils literal notranslate"><span class="pre">-checks</span></code> argument,
taking the identical format as <strong class="program">clang-tidy</strong> does. For example,
<code class="docutils literal notranslate"><span class="pre">-checks=-*,modernize-use-override</span></code> will run the <code class="docutils literal notranslate"><span class="pre">modernize-use-override</span></code>
check only.</p></li>
<li><p>To restrict the files examined, you can provide one or more regex arguments
that the file names are matched against.
<code class="docutils literal notranslate"><span class="pre">run-clang-tidy.py</span> <span class="pre">clang-tidy/.*Check\.cpp</span></code> will only analyze <cite>clang-tidy</cite>
checks. It may also be necessary to restrict the header files that warnings
are displayed from by using the <code class="docutils literal notranslate"><span class="pre">-header-filter</span></code> and
<code class="docutils literal notranslate"><span class="pre">-exclude-header-filter</span></code> flags. They have the same behavior as the
corresponding <strong class="program">clang-tidy</strong> flags.</p></li>
<li><p>To apply suggested fixes, <code class="docutils literal notranslate"><span class="pre">-fix</span></code> can be passed as an argument. This gathers
all changes in a temporary directory and applies them. Passing <code class="docutils literal notranslate"><span class="pre">-format</span></code>
will run clang-format over changed lines.</p></li>
</ul>
</section>
<section id="on-checks-profiling">
<h2>On checks profiling<a class="headerlink" href="#on-checks-profiling" title="Link to this heading">¶</a></h2>
<p><strong class="program">clang-tidy</strong> can collect per-check profiling info, and output it
for each processed source file (translation unit).</p>
<p>To enable profiling info collection, use the <code class="docutils literal notranslate"><span class="pre">-enable-check-profile</span></code>
argument. The timings will be output to <code class="docutils literal notranslate"><span class="pre">stderr</span></code> as a table.
Example output:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>clang-tidy<span class="w"> </span>-enable-check-profile<span class="w"> </span>-checks<span class="o">=</span>-*,readability-function-size<span class="w"> </span>source.cpp
<span class="go">===-------------------------------------------------------------------------===</span>
<span class="go">                          clang-tidy checks profiling</span>
<span class="go">===-------------------------------------------------------------------------===</span>
<span class="go">  Total Execution Time: 1.0282 seconds (1.0258 wall clock)</span>

<span class="go">   ---User Time---   --System Time--   --User+System--   ---Wall Time---  --- Name ---</span>
<span class="go">   0.9136 (100.0%)   0.1146 (100.0%)   1.0282 (100.0%)   1.0258 (100.0%)  readability-function-size</span>
<span class="go">   0.9136 (100.0%)   0.1146 (100.0%)   1.0282 (100.0%)   1.0258 (100.0%)  Total</span>
</pre></div>
</div>
<p>It can also store that data as JSON files for further processing.
Example output:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>clang-tidy<span class="w"> </span>-enable-check-profile<span class="w"> </span>-store-check-profile<span class="o">=</span>.<span class="w"> </span>-checks<span class="o">=</span>-*,readability-function-size<span class="w"> </span>source.cpp
<span class="gp">$ </span><span class="c1"># Note that there won&#39;t be timings table printed to the console.</span>
<span class="gp">$ </span>ls<span class="w"> </span>/tmp/out/
<span class="go">20180516161318717446360-source.cpp.json</span>
<span class="gp">$ </span>cat<span class="w"> </span><span class="m">20180516161318717446360</span>-source.cpp.json
<span class="go">{</span>
<span class="go">&quot;file&quot;: &quot;/path/to/source.cpp&quot;,</span>
<span class="go">&quot;timestamp&quot;: &quot;2018-05-16 16:13:18.717446360&quot;,</span>
<span class="go">&quot;profile&quot;: {</span>
<span class="go">  &quot;time.clang-tidy.readability-function-size.wall&quot;: 1.0421266555786133e+00,</span>
<span class="go">  &quot;time.clang-tidy.readability-function-size.user&quot;: 9.2088400000005421e-01,</span>
<span class="go">  &quot;time.clang-tidy.readability-function-size.sys&quot;: 1.2418899999999974e-01</span>
<span class="go">}</span>
<span class="go">}</span>
</pre></div>
</div>
<p>There is only one argument that controls profile storage:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">-store-check-profile=&lt;prefix&gt;</span></code></p>
<p>By default, reports are printed in tabulated format to stderr. When this
option is passed, these per-TU profiles are instead stored as JSON.
If the prefix is not an absolute path, it is considered to be relative to the
directory from where you have run <strong class="program">clang-tidy</strong>. All <code class="docutils literal notranslate"><span class="pre">.</span></code> and <code class="docutils literal notranslate"><span class="pre">..</span></code>
patterns in the path are collapsed, and symlinks are resolved.</p>
<p>Example:
Let’s suppose you have a source file named <code class="docutils literal notranslate"><span class="pre">example.cpp</span></code>, located in the
<code class="docutils literal notranslate"><span class="pre">/source</span></code> directory. Only the input filename is used, not the full path
to the source file. Additionally, it is prefixed with the current timestamp.</p>
<ul class="simple">
<li><p>If you specify <code class="docutils literal notranslate"><span class="pre">-store-check-profile=/tmp</span></code>, then the profile will be
saved to <code class="docutils literal notranslate"><span class="pre">/tmp/&lt;ISO8601-like</span> <span class="pre">timestamp&gt;-example.cpp.json</span></code></p></li>
<li><p>If you run <strong class="program">clang-tidy</strong> from within <code class="docutils literal notranslate"><span class="pre">/foo</span></code> directory, and
specify <code class="docutils literal notranslate"><span class="pre">-store-check-profile=.</span></code>, then the profile will still be
saved to <code class="docutils literal notranslate"><span class="pre">/foo/&lt;ISO8601-like</span> <span class="pre">timestamp&gt;-example.cpp.json</span></code></p></li>
</ul>
</li>
</ul>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="Integrations.html">Clang-tidy IDE/Editor Integrations</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="ExternalClang-TidyExamples.html">External Clang-Tidy Examples</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
    &#169; Copyright 2007-2026, The Clang Team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>