
<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>RISC-V Vector Extension &#8212; LLVM 20.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="../_static/llvm-theme.css?v=96924833" />
    <script src="../_static/documentation_options.js?v=383a7952"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Source Level Debugging with LLVM" href="../SourceLevelDebugging.html" />
    <link rel="prev" title="User Guide for RISC-V Target" href="../RISCVUsage.html" />
<style type="text/css">
  table.right { float: right; margin-left: 20px; }
  table.right td { border: 1px solid #ccc; }
</style>

  </head><body>
<div class="logo">
  <a href="../index.html">
    <img src="../_static/logo.png"
         alt="LLVM Logo" width="250" height="88"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../SourceLevelDebugging.html" title="Source Level Debugging with LLVM"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../RISCVUsage.html" title="User Guide for RISC-V Target"
             accesskey="P">previous</a> |</li>
  <li><a href="https://llvm.org/">LLVM Home</a>&nbsp;|&nbsp;</li>
  <li><a href="../index.html">Documentation</a>&raquo;</li>

          <li class="nav-item nav-item-1"><a href="../UserGuides.html" accesskey="U">User Guides</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">RISC-V Vector Extension</a></li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">

<h3>Documentation</h3>

<ul class="want-points">
    <li><a href="https://llvm.org/docs/GettingStartedTutorials.html">Getting Started/Tutorials</a></li>
    <li><a href="https://llvm.org/docs/UserGuides.html">User Guides</a></li>
    <li><a href="https://llvm.org/docs/Reference.html">Reference</a></li>
</ul>

<h3>Getting Involved</h3>

<ul class="want-points">
    <li><a href="https://llvm.org/docs/Contributing.html">Contributing to LLVM</a></li>
    <li><a href="https://llvm.org/docs/HowToSubmitABug.html">Submitting Bug Reports</a></li>
    <li><a href="https://llvm.org/docs/GettingInvolved.html#mailing-lists">Mailing Lists</a></li>
    <li><a href="https://llvm.org/docs/GettingInvolved.html#discord">Discord</a></li>
    <li><a href="https://llvm.org/docs/GettingInvolved.html#meetups-and-social-events">Meetups and Social Events</a></li>
</ul>

<h3>Additional Links</h3>

<ul class="want-points">
    <li><a href="https://llvm.org/docs/FAQ.html">FAQ</a></li>
    <li><a href="https://llvm.org/docs/Lexicon.html">Glossary</a></li>
    <li><a href="https://llvm.org/pubs">Publications</a></li>
    <li><a href="https://github.com/llvm/llvm-project/">Github Repository</a></li>
</ul>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/RISCV/RISCVVectorExtension.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="risc-v-vector-extension">
<h1>RISC-V Vector Extension<a class="headerlink" href="#risc-v-vector-extension" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#mapping-to-llvm-ir-types" id="id2">Mapping to LLVM IR types</a></p>
<ul>
<li><p><a class="reference internal" href="#mask-vector-types" id="id3">Mask vector types</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#representation-in-llvm-ir" id="id4">Representation in LLVM IR</a></p></li>
<li><p><a class="reference internal" href="#selectiondag-lowering" id="id5">SelectionDAG lowering</a></p>
<ul>
<li><p><a class="reference internal" href="#fixed-length-vectors" id="id6">Fixed-length vectors</a></p></li>
<li><p><a class="reference internal" href="#vector-predication-intrinsics" id="id7">Vector predication intrinsics</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#instruction-selection" id="id8">Instruction selection</a></p>
<ul>
<li><p><a class="reference internal" href="#mask-patterns" id="id9">Mask patterns</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#register-allocation" id="id10">Register allocation</a></p></li>
<li><p><a class="reference internal" href="#riscvinsertvsetvli" id="id11">RISCVInsertVSETVLI</a></p></li>
<li><p><a class="reference internal" href="#pseudo-expansion-and-printing" id="id12">Pseudo expansion and printing</a></p></li>
<li><p><a class="reference internal" href="#see-also" id="id13">See also</a></p></li>
</ul>
</nav>
<p>The RISC-V target supports the 1.0 version of the <a class="reference external" href="https://github.com/riscv/riscv-v-spec/blob/v1.0/v-spec.adoc">RISC-V Vector Extension (RVV)</a>.
This guide gives an overview of how it’s modelled in LLVM IR and how the backend generates code for it.</p>
<section id="mapping-to-llvm-ir-types">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Mapping to LLVM IR types</a><a class="headerlink" href="#mapping-to-llvm-ir-types" title="Link to this heading">¶</a></h2>
<p>RVV adds 32 VLEN sized registers, where VLEN is an unknown constant to the compiler. To be able to represent VLEN sized values, the RISC-V backend takes the same approach as AArch64’s SVE and uses <a class="reference external" href="https://llvm.org/docs/LangRef.html#t-vector">scalable vector types</a>.</p>
<p>Scalable vector types are of the form <code class="docutils literal notranslate"><span class="pre">&lt;vscale</span> <span class="pre">x</span> <span class="pre">n</span> <span class="pre">x</span> <span class="pre">ty&gt;</span></code>, which indicates a vector with a multiple of <code class="docutils literal notranslate"><span class="pre">n</span></code> elements of type <code class="docutils literal notranslate"><span class="pre">ty</span></code>.
On RISC-V <code class="docutils literal notranslate"><span class="pre">n</span></code> and <code class="docutils literal notranslate"><span class="pre">ty</span></code> control LMUL and SEW respectively.</p>
<p>LLVM only supports ELEN=32 or ELEN=64, so <code class="docutils literal notranslate"><span class="pre">vscale</span></code> is defined as VLEN/64 (see <code class="docutils literal notranslate"><span class="pre">RISCV::RVVBitsPerBlock</span></code>).
Note this means that VLEN must be at least 64, so VLEN=32 isn’t currently supported.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"><p>LMUL=⅛</p></th>
<th class="head"><p>LMUL=¼</p></th>
<th class="head"><p>LMUL=½</p></th>
<th class="head"><p>LMUL=1</p></th>
<th class="head"><p>LMUL=2</p></th>
<th class="head"><p>LMUL=4</p></th>
<th class="head"><p>LMUL=8</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>i64 (ELEN=64)</p></td>
<td><p>N/A</p></td>
<td><p>N/A</p></td>
<td><p>N/A</p></td>
<td><p>&lt;v x 1 x i64&gt;</p></td>
<td><p>&lt;v x 2 x i64&gt;</p></td>
<td><p>&lt;v x 4 x i64&gt;</p></td>
<td><p>&lt;v x 8 x i64&gt;</p></td>
</tr>
<tr class="row-odd"><td><p>i32</p></td>
<td><p>N/A</p></td>
<td><p>N/A</p></td>
<td><p>&lt;v x 1 x i32&gt;</p></td>
<td><p>&lt;v x 2 x i32&gt;</p></td>
<td><p>&lt;v x 4 x i32&gt;</p></td>
<td><p>&lt;v x 8 x i32&gt;</p></td>
<td><p>&lt;v x 16 x i32&gt;</p></td>
</tr>
<tr class="row-even"><td><p>i16</p></td>
<td><p>N/A</p></td>
<td><p>&lt;v x 1 x i16&gt;</p></td>
<td><p>&lt;v x 2 x i16&gt;</p></td>
<td><p>&lt;v x 4 x i16&gt;</p></td>
<td><p>&lt;v x 8 x i16&gt;</p></td>
<td><p>&lt;v x 16 x i16&gt;</p></td>
<td><p>&lt;v x 32 x i16&gt;</p></td>
</tr>
<tr class="row-odd"><td><p>i8</p></td>
<td><p>&lt;v x 1 x i8&gt;</p></td>
<td><p>&lt;v x 2 x i8&gt;</p></td>
<td><p>&lt;v x 4 x i8&gt;</p></td>
<td><p>&lt;v x 8 x i8&gt;</p></td>
<td><p>&lt;v x 16 x i8&gt;</p></td>
<td><p>&lt;v x 32 x i8&gt;</p></td>
<td><p>&lt;v x 64 x i8&gt;</p></td>
</tr>
<tr class="row-even"><td><p>double (ELEN=64)</p></td>
<td><p>N/A</p></td>
<td><p>N/A</p></td>
<td><p>N/A</p></td>
<td><p>&lt;v x 1 x double&gt;</p></td>
<td><p>&lt;v x 2 x double&gt;</p></td>
<td><p>&lt;v x 4 x double&gt;</p></td>
<td><p>&lt;v x 8 x double&gt;</p></td>
</tr>
<tr class="row-odd"><td><p>float</p></td>
<td><p>N/A</p></td>
<td><p>N/A</p></td>
<td><p>&lt;v x 1 x float&gt;</p></td>
<td><p>&lt;v x 2 x float&gt;</p></td>
<td><p>&lt;v x 4 x float&gt;</p></td>
<td><p>&lt;v x 8 x float&gt;</p></td>
<td><p>&lt;v x 16 x float&gt;</p></td>
</tr>
<tr class="row-even"><td><p>half</p></td>
<td><p>N/A</p></td>
<td><p>&lt;v x 1 x half&gt;</p></td>
<td><p>&lt;v x 2 x half&gt;</p></td>
<td><p>&lt;v x 4 x half&gt;</p></td>
<td><p>&lt;v x 8 x half&gt;</p></td>
<td><p>&lt;v x 16 x half&gt;</p></td>
<td><p>&lt;v x 32 x half&gt;</p></td>
</tr>
</tbody>
</table>
<p>(Read <code class="docutils literal notranslate"><span class="pre">&lt;v</span> <span class="pre">x</span> <span class="pre">k</span> <span class="pre">x</span> <span class="pre">ty&gt;</span></code> as <code class="docutils literal notranslate"><span class="pre">&lt;vscale</span> <span class="pre">x</span> <span class="pre">k</span> <span class="pre">x</span> <span class="pre">ty&gt;</span></code>)</p>
<section id="mask-vector-types">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">Mask vector types</a><a class="headerlink" href="#mask-vector-types" title="Link to this heading">¶</a></h3>
<p>Mask vectors are physically represented using a layout of densely packed bits in a vector register.
They are mapped to the following LLVM IR types:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;vscale</span> <span class="pre">x</span> <span class="pre">1</span> <span class="pre">x</span> <span class="pre">i1&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;vscale</span> <span class="pre">x</span> <span class="pre">2</span> <span class="pre">x</span> <span class="pre">i1&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;vscale</span> <span class="pre">x</span> <span class="pre">4</span> <span class="pre">x</span> <span class="pre">i1&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;vscale</span> <span class="pre">x</span> <span class="pre">8</span> <span class="pre">x</span> <span class="pre">i1&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;vscale</span> <span class="pre">x</span> <span class="pre">16</span> <span class="pre">x</span> <span class="pre">i1&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;vscale</span> <span class="pre">x</span> <span class="pre">32</span> <span class="pre">x</span> <span class="pre">i1&gt;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;vscale</span> <span class="pre">x</span> <span class="pre">64</span> <span class="pre">x</span> <span class="pre">i1&gt;</span></code></p></li>
</ul>
<p>Two types with the same SEW/LMUL ratio will have the same related mask type.
For instance, two different comparisons one under SEW=64, LMUL=2 and the other under SEW=32, LMUL=1 will both generate a mask <code class="docutils literal notranslate"><span class="pre">&lt;vscale</span> <span class="pre">x</span> <span class="pre">2</span> <span class="pre">x</span> <span class="pre">i1&gt;</span></code>.</p>
</section>
</section>
<section id="representation-in-llvm-ir">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Representation in LLVM IR</a><a class="headerlink" href="#representation-in-llvm-ir" title="Link to this heading">¶</a></h2>
<p>Vector instructions can be represented in three main ways in LLVM IR:</p>
<ol class="arabic">
<li><p>Regular instructions on both scalable and fixed-length vector types</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="nv">%c</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="p">&lt;</span><span class="k">vscale</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span><span class="w"> </span><span class="nv">%b</span>
<span class="nv">%f</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="p">&lt;</span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;</span><span class="w"> </span><span class="nv">%d</span><span class="p">,</span><span class="w"> </span><span class="nv">%e</span>
</pre></div>
</div>
</li>
<li><p>RISC-V vector intrinsics, which mirror the <a class="reference external" href="https://github.com/riscv-non-isa/rvv-intrinsic-doc">C intrinsics specification</a></p>
<p>These come in unmasked variants:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="nv">%c</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="vg">@llvm.riscv.vadd.nxv4i32.nxv4i32</span><span class="p">(</span>
<span class="w">       </span><span class="p">&lt;</span><span class="k">vscale</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;</span><span class="w"> </span><span class="nv">%passthru</span><span class="p">,</span>
<span class="w">       </span><span class="p">&lt;</span><span class="k">vscale</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span>
<span class="w">       </span><span class="p">&lt;</span><span class="k">vscale</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;</span><span class="w"> </span><span class="nv">%b</span><span class="p">,</span>
<span class="w">       </span><span class="kt">i64</span><span class="w"> </span><span class="nv">%avl</span>
<span class="w">     </span><span class="p">)</span>
</pre></div>
</div>
<p>As well as masked variants:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="nv">%c</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="vg">@llvm.riscv.vadd.mask.nxv4i32.nxv4i32</span><span class="p">(</span>
<span class="w">       </span><span class="p">&lt;</span><span class="k">vscale</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;</span><span class="w"> </span><span class="nv">%passthru</span><span class="p">,</span>
<span class="w">       </span><span class="p">&lt;</span><span class="k">vscale</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span>
<span class="w">       </span><span class="p">&lt;</span><span class="k">vscale</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;</span><span class="w"> </span><span class="nv">%b</span><span class="p">,</span>
<span class="w">       </span><span class="p">&lt;</span><span class="k">vscale</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i1</span><span class="p">&gt;</span><span class="w"> </span><span class="nv">%mask</span><span class="p">,</span>
<span class="w">       </span><span class="kt">i64</span><span class="w"> </span><span class="nv">%avl</span><span class="p">,</span>
<span class="w">       </span><span class="kt">i64</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c">; policy (must be an immediate)</span>
<span class="w">     </span><span class="p">)</span>
</pre></div>
</div>
<p>Both allow setting the AVL as well as controlling the inactive/tail elements via the passthru operand, but the masked variant also provides operands for the mask and <code class="docutils literal notranslate"><span class="pre">vta</span></code>/<code class="docutils literal notranslate"><span class="pre">vma</span></code> policy bits.</p>
<p>The only valid types are scalable vector types.</p>
</li>
<li><p><a class="reference internal" href="../LangRef.html#int-vp"><span class="std std-ref">Vector predication (VP) intrinsics</span></a></p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="nv">%c</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="vg">@llvm.vp.add.nxv4i32</span><span class="p">(</span>
<span class="w">       </span><span class="p">&lt;</span><span class="k">vscale</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;</span><span class="w"> </span><span class="nv">%a</span><span class="p">,</span>
<span class="w">       </span><span class="p">&lt;</span><span class="k">vscale</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i32</span><span class="p">&gt;</span><span class="w"> </span><span class="nv">%b</span><span class="p">,</span>
<span class="w">       </span><span class="p">&lt;</span><span class="k">vscale</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="k">x</span><span class="w"> </span><span class="kt">i1</span><span class="p">&gt;</span><span class="w"> </span><span class="nv">%m</span>
<span class="w">       </span><span class="kt">i32</span><span class="w"> </span><span class="nv">%evl</span>
<span class="w">     </span><span class="p">)</span>
</pre></div>
</div>
<p>Unlike RISC-V intrinsics, VP intrinsics are target agnostic so they can be emitted from other optimisation passes in the middle-end (like the loop vectorizer). They also support fixed-length vector types.</p>
<p>VP intrinsics also don’t have passthru operands, but tail/mask undisturbed behaviour can be emulated by using the output in a <code class="docutils literal notranslate"><span class="pre">&#64;llvm.vp.merge</span></code>.
It will get lowered as a <code class="docutils literal notranslate"><span class="pre">vmerge</span></code>, but will be merged back into the underlying instruction’s mask via <code class="docutils literal notranslate"><span class="pre">RISCVDAGToDAGISel::performCombineVMergeAndVOps</span></code>.</p>
</li>
</ol>
<p>The different properties of the above representations are summarized below:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"><p>AVL</p></th>
<th class="head"><p>Masking</p></th>
<th class="head"><p>Passthru</p></th>
<th class="head"><p>Scalable vectors</p></th>
<th class="head"><p>Fixed-length vectors</p></th>
<th class="head"><p>Target agnostic</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>LLVM IR instructions</p></td>
<td><p>Always VLMAX</p></td>
<td><p>No</p></td>
<td><p>None</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
</tr>
<tr class="row-odd"><td><p>RVV intrinsics</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>No</p></td>
<td><p>No</p></td>
</tr>
<tr class="row-even"><td><p>VP intrinsics</p></td>
<td><p>Yes (EVL)</p></td>
<td><p>Yes</p></td>
<td><p>No</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
<td><p>Yes</p></td>
</tr>
</tbody>
</table>
</section>
<section id="selectiondag-lowering">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">SelectionDAG lowering</a><a class="headerlink" href="#selectiondag-lowering" title="Link to this heading">¶</a></h2>
<p>For most regular <strong>scalable</strong> vector LLVM IR instructions, their corresponding SelectionDAG nodes are legal on RISC-V and don’t require any custom lowering.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">t5</span><span class="p">:</span> <span class="n">nxv4i32</span> <span class="o">=</span> <span class="n">add</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t4</span>
</pre></div>
</div>
<p>RISC-V vector intrinsics also don’t require any custom lowering.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">t12</span><span class="p">:</span> <span class="n">nxv4i32</span> <span class="o">=</span> <span class="n">llvm</span><span class="o">.</span><span class="n">riscv</span><span class="o">.</span><span class="n">vadd</span> <span class="n">TargetConstant</span><span class="p">:</span><span class="n">i64</span><span class="o">&lt;</span><span class="mi">10056</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">undef</span><span class="p">:</span><span class="n">nxv4i32</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t4</span><span class="p">,</span> <span class="n">t6</span>
</pre></div>
</div>
<section id="fixed-length-vectors">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">Fixed-length vectors</a><a class="headerlink" href="#fixed-length-vectors" title="Link to this heading">¶</a></h3>
<p>Because there are no fixed-length vector patterns, fixed-length vectors need to be custom lowered and performed in a scalable “container” type:</p>
<ol class="arabic simple">
<li><p>The fixed-length vector operands are inserted into scalable containers with <code class="docutils literal notranslate"><span class="pre">insert_subvector</span></code> nodes. The container type is chosen such that its minimum size will fit the fixed-length vector (see <code class="docutils literal notranslate"><span class="pre">getContainerForFixedLengthVector</span></code>).</p></li>
<li><p>The operation is then performed on the container type via a <strong>VL (vector length) node</strong>. These are custom nodes defined in <code class="docutils literal notranslate"><span class="pre">RISCVInstrInfoVVLPatterns.td</span></code> that mirror target agnostic SelectionDAG nodes, as well as some RVV instructions. They contain an AVL operand, which is set to the number of elements in the fixed-length vector.
Some nodes also have a passthru or mask operand, which will usually be set to <code class="docutils literal notranslate"><span class="pre">undef</span></code> and all ones when lowering fixed-length vectors.</p></li>
<li><p>The result is put back into a fixed-length vector via <code class="docutils literal notranslate"><span class="pre">extract_subvector</span></code>.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">t2</span><span class="p">:</span> <span class="n">nxv2i32</span><span class="p">,</span><span class="n">ch</span> <span class="o">=</span> <span class="n">CopyFromReg</span> <span class="n">t0</span><span class="p">,</span> <span class="n">Register</span><span class="p">:</span><span class="n">nxv2i32</span> <span class="o">%</span><span class="mi">0</span>
    <span class="n">t6</span><span class="p">:</span> <span class="n">nxv2i32</span><span class="p">,</span><span class="n">ch</span> <span class="o">=</span> <span class="n">CopyFromReg</span> <span class="n">t0</span><span class="p">,</span> <span class="n">Register</span><span class="p">:</span><span class="n">nxv2i32</span> <span class="o">%</span><span class="mi">1</span>
  <span class="n">t4</span><span class="p">:</span> <span class="n">v4i32</span> <span class="o">=</span> <span class="n">extract_subvector</span> <span class="n">t2</span><span class="p">,</span> <span class="n">Constant</span><span class="p">:</span><span class="n">i64</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span>
  <span class="n">t7</span><span class="p">:</span> <span class="n">v4i32</span> <span class="o">=</span> <span class="n">extract_subvector</span> <span class="n">t6</span><span class="p">,</span> <span class="n">Constant</span><span class="p">:</span><span class="n">i64</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span>
<span class="n">t8</span><span class="p">:</span> <span class="n">v4i32</span> <span class="o">=</span> <span class="n">add</span> <span class="n">t4</span><span class="p">,</span> <span class="n">t7</span>

<span class="o">//</span> <span class="ow">is</span> <span class="n">custom</span> <span class="n">lowered</span> <span class="n">to</span><span class="p">:</span>

    <span class="n">t2</span><span class="p">:</span> <span class="n">nxv2i32</span><span class="p">,</span><span class="n">ch</span> <span class="o">=</span> <span class="n">CopyFromReg</span> <span class="n">t0</span><span class="p">,</span> <span class="n">Register</span><span class="p">:</span><span class="n">nxv2i32</span> <span class="o">%</span><span class="mi">0</span>
    <span class="n">t6</span><span class="p">:</span> <span class="n">nxv2i32</span><span class="p">,</span><span class="n">ch</span> <span class="o">=</span> <span class="n">CopyFromReg</span> <span class="n">t0</span><span class="p">,</span> <span class="n">Register</span><span class="p">:</span><span class="n">nxv2i32</span> <span class="o">%</span><span class="mi">1</span>
    <span class="n">t15</span><span class="p">:</span> <span class="n">nxv2i1</span> <span class="o">=</span> <span class="n">RISCVISD</span><span class="p">::</span><span class="n">VMSET_VL</span> <span class="n">Constant</span><span class="p">:</span><span class="n">i64</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span>
  <span class="n">t16</span><span class="p">:</span> <span class="n">nxv2i32</span> <span class="o">=</span> <span class="n">RISCVISD</span><span class="p">::</span><span class="n">ADD_VL</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t6</span><span class="p">,</span> <span class="n">undef</span><span class="p">:</span><span class="n">nxv2i32</span><span class="p">,</span> <span class="n">t15</span><span class="p">,</span> <span class="n">Constant</span><span class="p">:</span><span class="n">i64</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span>
<span class="n">t17</span><span class="p">:</span> <span class="n">v4i32</span> <span class="o">=</span> <span class="n">extract_subvector</span> <span class="n">t16</span><span class="p">,</span> <span class="n">Constant</span><span class="p">:</span><span class="n">i64</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>VL nodes often have a passthru or mask operand, which are usually set to <code class="docutils literal notranslate"><span class="pre">undef</span></code> and all ones for fixed-length vectors.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">insert_subvector</span></code> and <code class="docutils literal notranslate"><span class="pre">extract_subvector</span></code> nodes responsible for wrapping and unwrapping will get combined away, and eventually we will lower all fixed-length vector types to scalable. Note that fixed-length vectors at the interface of a function are passed in a scalable vector container.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The only <code class="docutils literal notranslate"><span class="pre">insert_subvector</span></code> and <code class="docutils literal notranslate"><span class="pre">extract_subvector</span></code> nodes that make it through lowering are those that can be performed as an exact subregister insert or extract. This means that any fixed-length vector <code class="docutils literal notranslate"><span class="pre">insert_subvector</span></code> and <code class="docutils literal notranslate"><span class="pre">extract_subvector</span></code> nodes that aren’t legalized must lie on a register group boundary, so the exact VLEN must be known at compile time (i.e., compiled with <code class="docutils literal notranslate"><span class="pre">-mrvv-vector-bits=zvl</span></code> or <code class="docutils literal notranslate"><span class="pre">-mllvm</span> <span class="pre">-riscv-v-vector-bits-max=VLEN</span></code>, or have an exact <code class="docutils literal notranslate"><span class="pre">vscale_range</span></code> attribute).</p>
</div>
</section>
<section id="vector-predication-intrinsics">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">Vector predication intrinsics</a><a class="headerlink" href="#vector-predication-intrinsics" title="Link to this heading">¶</a></h3>
<p>VP intrinsics also get custom lowered via VL nodes.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">t12</span><span class="p">:</span> <span class="n">nxv2i32</span> <span class="o">=</span> <span class="n">vp_add</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t4</span><span class="p">,</span> <span class="n">t6</span><span class="p">,</span> <span class="n">Constant</span><span class="p">:</span><span class="n">i64</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span>

<span class="o">//</span> <span class="ow">is</span> <span class="n">custom</span> <span class="n">lowered</span> <span class="n">to</span><span class="p">:</span>

<span class="n">t18</span><span class="p">:</span> <span class="n">nxv2i32</span> <span class="o">=</span> <span class="n">RISCVISD</span><span class="p">::</span><span class="n">ADD_VL</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t4</span><span class="p">,</span> <span class="n">undef</span><span class="p">:</span><span class="n">nxv2i32</span><span class="p">,</span> <span class="n">t6</span><span class="p">,</span> <span class="n">Constant</span><span class="p">:</span><span class="n">i64</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The VP EVL and mask are used for the VL node’s AVL and mask respectively, whilst the passthru is set to <code class="docutils literal notranslate"><span class="pre">undef</span></code>.</p>
</section>
</section>
<section id="instruction-selection">
<h2><a class="toc-backref" href="#id8" role="doc-backlink">Instruction selection</a><a class="headerlink" href="#instruction-selection" title="Link to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">vl</span></code> and <code class="docutils literal notranslate"><span class="pre">vtype</span></code> need to be configured correctly, so we can’t just directly select the underlying vector <code class="docutils literal notranslate"><span class="pre">MachineInstr</span></code>. Instead pseudo instructions are selected, which carry the extra information needed to emit the necessary <code class="docutils literal notranslate"><span class="pre">vsetvli</span></code>s later.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">c</span><span class="p">:</span><span class="n">vrm2</span> <span class="o">=</span> <span class="n">PseudoVADD_VV_M2</span> <span class="o">%</span><span class="n">passthru</span><span class="p">:</span><span class="n">vrm2</span><span class="p">(</span><span class="n">tied</span><span class="o">-</span><span class="k">def</span> <span class="mi">0</span><span class="p">),</span> <span class="o">%</span><span class="n">a</span><span class="p">:</span><span class="n">vrm2</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="p">:</span><span class="n">vrm2</span><span class="p">,</span> <span class="o">%</span><span class="n">vl</span><span class="p">:</span><span class="n">gpr</span><span class="p">,</span> <span class="mi">5</span> <span class="o">/*</span><span class="n">sew</span><span class="o">*/</span><span class="p">,</span> <span class="mi">3</span> <span class="o">/*</span><span class="n">policy</span><span class="o">*/</span>
</pre></div>
</div>
<p>Each vector instruction has multiple pseudo instructions defined in <code class="docutils literal notranslate"><span class="pre">RISCVInstrInfoVPseudos.td</span></code>.
There is a variant of each pseudo for each possible LMUL, as well as a masked variant. So a typical instruction like <code class="docutils literal notranslate"><span class="pre">vadd.vv</span></code> would have the following pseudos:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>%rd:vr = PseudoVADD_VV_MF8 %passthru:vr(tied-def 0), %rs2:vr, %rs1:vr, %avl:gpr, sew:imm, policy:imm
%rd:vr = PseudoVADD_VV_MF4 %passthru:vr(tied-def 0), %rs2:vr, %rs1:vr, %avl:gpr, sew:imm, policy:imm
%rd:vr = PseudoVADD_VV_MF2 %passthru:vr(tied-def 0), %rs2:vr, %rs1:vr, %avl:gpr, sew:imm, policy:imm
%rd:vr = PseudoVADD_VV_M1 %passthru:vr(tied-def 0), %rs2:vr, %rs1:vr, %avl:gpr, sew:imm, policy:imm
%rd:vrm2 = PseudoVADD_VV_M2 %passthru:vrm2(tied-def 0), %rs2:vrm2, %rs1:vrm2, %avl:gpr, sew:imm, policy:imm
%rd:vrm4 = PseudoVADD_VV_M4 %passthru:vrm4(tied-def 0), %rs2:vrm4, %rs1:vrm4, %avl:gpr, sew:imm, policy:imm
%rd:vrm8 = PseudoVADD_VV_M8 %passthru:vrm8(tied-def 0), %rs2:vrm8, %rs1:vrm8, %avl:gpr, sew:imm, policy:imm
%rd:vr = PseudoVADD_VV_MF8_MASK %passthru:vr(tied-def 0), %rs2:vr, %rs1:vr, mask:$v0, %avl:gpr, sew:imm, policy:imm
%rd:vr = PseudoVADD_VV_MF4_MASK %passthru:vr(tied-def 0), %rs2:vr, %rs1:vr, mask:$v0, %avl:gpr, sew:imm, policy:imm
%rd:vr = PseudoVADD_VV_MF2_MASK %passthru:vr(tied-def 0), %rs2:vr, %rs1:vr, mask:$v0, %avl:gpr, sew:imm, policy:imm
%rd:vr = PseudoVADD_VV_M1_MASK %passthru:vr(tied-def 0), %rs2:vr, %rs1:vr, mask:$v0, %avl:gpr, sew:imm, policy:imm
%rd:vrm2 = PseudoVADD_VV_M2_MASK %passthru:vrm2(tied-def 0), %rs2:vrm2, %%rs1:vrm2, mask:$v0, %avl:gpr, sew:imm, policy:imm
%rd:vrm4 = PseudoVADD_VV_M4_MASK %passthru:vrm4(tied-def 0), %rs2:vrm4, %rs1:vrm4, mask:$v0, %avl:gpr, sew:imm, policy:imm
%rd:vrm8 = PseudoVADD_VV_M8_MASK %passthru:vrm8(tied-def 0), %rs2:vrm8, %rs1:vrm8, mask:$v0, %avl:gpr, sew:imm, policy:imm
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Whilst the SEW can be encoded in an operand, we need to use separate pseudos for each LMUL since different register groups will require different register classes: see <a class="reference internal" href="#rvv-register-allocation"><span class="std std-ref">Register allocation</span></a>.</p>
</div>
<p>Pseudos have operands for the AVL and SEW (encoded as a power of 2), as well as potentially the mask, policy or rounding mode if applicable.
The passthru operand is tied to the destination register which will determine the inactive/tail elements.</p>
<p>For scalable vectors that should use VLMAX, the AVL is set to a sentinel value of <code class="docutils literal notranslate"><span class="pre">-1</span></code>.</p>
<p>There are patterns for target agnostic SelectionDAG nodes in <code class="docutils literal notranslate"><span class="pre">RISCVInstrInfoVSDPatterns.td</span></code>, VL nodes in <code class="docutils literal notranslate"><span class="pre">RISCVInstrInfoVVLPatterns.td</span></code> and RVV intrinsics in <code class="docutils literal notranslate"><span class="pre">RISCVInstrInfoVPseudos.td</span></code>.</p>
<p>Instructions that operate only on masks like VMAND or VMSBF uses pseudo instructions suffixed with B1, B2, B4, B8, B16, B32, or B64 where the number is SEW/LMUL representing
the ratio between SEW and LMUL needed in vtype. These instructions always operate as if EEW=1 and always use a value of 0 as their SEW operand.</p>
<section id="mask-patterns">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">Mask patterns</a><a class="headerlink" href="#mask-patterns" title="Link to this heading">¶</a></h3>
<p>For masked pseudos the mask operand is copied to the physical <code class="docutils literal notranslate"><span class="pre">$v0</span></code> register during instruction selection with a glued <code class="docutils literal notranslate"><span class="pre">CopyToReg</span></code> node:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  t23: ch,glue = CopyToReg t0, Register:nxv4i1 $v0, t6
t25: nxv4i32 = PseudoVADD_VV_M2_MASK Register:nxv4i32 $noreg, t2, t4, Register:nxv4i1 $v0, TargetConstant:i64&lt;8&gt;, TargetConstant:i64&lt;5&gt;, TargetConstant:i64&lt;1&gt;, t23:1
</pre></div>
</div>
<p>The patterns in <code class="docutils literal notranslate"><span class="pre">RISCVInstrInfoVVLPatterns.td</span></code> only match masked pseudos to reduce the size of the match table, even if the node’s mask is all ones and could be an unmasked pseudo.
<code class="docutils literal notranslate"><span class="pre">RISCVFoldMasks::convertToUnmasked</span></code> will detect if the mask is all ones and convert it into its unmasked form.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$v0 = PseudoVMSET_M_B16 -1, 32
%rd:vrm2 = PseudoVADD_VV_M2_MASK %passthru:vrm2(tied-def 0), %rs2:vrm2, %rs1:vrm2, $v0, %avl:gpr, sew:imm, policy:imm

// gets optimized to:

%rd:vrm2 = PseudoVADD_VV_M2 %passthru:vrm2(tied-def 0), %rs2:vrm2, %rs1:vrm2, %avl:gpr, sew:imm, policy:imm
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Any <code class="docutils literal notranslate"><span class="pre">vmset.m</span></code> can be treated as an all ones mask since the tail elements past AVL are <code class="docutils literal notranslate"><span class="pre">undef</span></code> and can be replaced with ones.</p>
</div>
</section>
</section>
<section id="register-allocation">
<span id="rvv-register-allocation"></span><h2><a class="toc-backref" href="#id10" role="doc-backlink">Register allocation</a><a class="headerlink" href="#register-allocation" title="Link to this heading">¶</a></h2>
<p>Register allocation is split between vector and scalar registers, with vector allocation running first:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$v8m2 = PseudoVADD_VV_M2 $v8m2(tied-def 0), $v8m2, $v10m2, %vl:gpr, 5, 3
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Register allocation is split so that <a class="reference internal" href="#riscvinsertvsetvli"><span class="std std-ref">RISCVInsertVSETVLI</span></a> can run after vector register allocation, but before scalar register allocation. It needs to be run before scalar register allocation as it may need to create a new virtual register to set the AVL to VLMAX.</p>
<p>Performing <code class="docutils literal notranslate"><span class="pre">RISCVInsertVSETVLI</span></code> after vector register allocation imposes fewer constraints on the machine scheduler since it cannot schedule instructions past <code class="docutils literal notranslate"><span class="pre">vsetvli</span></code>s, and it allows us to emit further vector pseudos during spilling or constant rematerialization.</p>
</div>
<p>There are four register classes for vectors:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">VR</span></code> for vector registers (<code class="docutils literal notranslate"><span class="pre">v0</span></code>, <code class="docutils literal notranslate"><span class="pre">v1,</span></code>, …, <code class="docutils literal notranslate"><span class="pre">v32</span></code>). Used when <span class="math notranslate nohighlight">\(\text{LMUL} \leq 1\)</span> and mask registers.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VRM2</span></code> for vector groups of length 2 i.e., <span class="math notranslate nohighlight">\(\text{LMUL}=2\)</span> (<code class="docutils literal notranslate"><span class="pre">v0m2</span></code>, <code class="docutils literal notranslate"><span class="pre">v2m2</span></code>, …, <code class="docutils literal notranslate"><span class="pre">v30m2</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VRM4</span></code> for vector groups of length 4 i.e., <span class="math notranslate nohighlight">\(\text{LMUL}=4\)</span> (<code class="docutils literal notranslate"><span class="pre">v0m4</span></code>, <code class="docutils literal notranslate"><span class="pre">v4m4</span></code>, …, <code class="docutils literal notranslate"><span class="pre">v28m4</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VRM8</span></code> for vector groups of length 8 i.e., <span class="math notranslate nohighlight">\(\text{LMUL}=8\)</span> (<code class="docutils literal notranslate"><span class="pre">v0m8</span></code>, <code class="docutils literal notranslate"><span class="pre">v8m8</span></code>, …, <code class="docutils literal notranslate"><span class="pre">v24m8</span></code>)</p></li>
</ul>
<p><span class="math notranslate nohighlight">\(\text{LMUL} \lt 1\)</span> types and mask types do not benefit from having a dedicated class, so <code class="docutils literal notranslate"><span class="pre">VR</span></code> is used in their case.</p>
<p>Some instructions have a constraint that a register operand cannot be <code class="docutils literal notranslate"><span class="pre">V0</span></code> or overlap with <code class="docutils literal notranslate"><span class="pre">V0</span></code>, so for these cases we also have <code class="docutils literal notranslate"><span class="pre">VRNoV0</span></code> variants.</p>
</section>
<section id="riscvinsertvsetvli">
<span id="id1"></span><h2><a class="toc-backref" href="#id11" role="doc-backlink">RISCVInsertVSETVLI</a><a class="headerlink" href="#riscvinsertvsetvli" title="Link to this heading">¶</a></h2>
<p>After vector registers are allocated, the <code class="docutils literal notranslate"><span class="pre">RISCVInsertVSETVLI</span></code> pass will insert the necessary <code class="docutils literal notranslate"><span class="pre">vsetvli</span></code>s for the pseudos.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>dead $x0 = PseudoVSETVLI %vl:gpr, 209, implicit-def $vl, implicit-def $vtype
$v8m2 = PseudoVADD_VV_M2 $v8m2(tied-def 0), $v8m2, $v10m2, $noreg, 5, implicit $vl, implicit $vtype
</pre></div>
</div>
<p>The physical <code class="docutils literal notranslate"><span class="pre">$vl</span></code> and <code class="docutils literal notranslate"><span class="pre">$vtype</span></code> registers are implicitly defined by the <code class="docutils literal notranslate"><span class="pre">PseudoVSETVLI</span></code>, and are implicitly used by the <code class="docutils literal notranslate"><span class="pre">PseudoVADD</span></code>.
The <code class="docutils literal notranslate"><span class="pre">vtype</span></code> operand (<code class="docutils literal notranslate"><span class="pre">209</span></code> in this example) is encoded as per the specification via <code class="docutils literal notranslate"><span class="pre">RISCVVType::encodeVTYPE</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">RISCVInsertVSETVLI</span></code> performs dataflow analysis to emit as few <code class="docutils literal notranslate"><span class="pre">vsetvli</span></code>s as possible. It will also try to minimize the number of <code class="docutils literal notranslate"><span class="pre">vsetvli</span></code>s that set VL, i.e., it will emit <code class="docutils literal notranslate"><span class="pre">vsetvli</span> <span class="pre">x0,</span> <span class="pre">x0</span></code> if only <code class="docutils literal notranslate"><span class="pre">vtype</span></code> needs changed but <code class="docutils literal notranslate"><span class="pre">vl</span></code> doesn’t.</p>
</section>
<section id="pseudo-expansion-and-printing">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">Pseudo expansion and printing</a><a class="headerlink" href="#pseudo-expansion-and-printing" title="Link to this heading">¶</a></h2>
<p>After scalar register allocation, the <code class="docutils literal notranslate"><span class="pre">RISCVExpandPseudoInsts.cpp</span></code> pass expands the <code class="docutils literal notranslate"><span class="pre">PseudoVSETVLI</span></code> instructions.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>dead $x0 = VSETVLI $x1, 209, implicit-def $vtype, implicit-def $vl
renamable $v8m2 = PseudoVADD_VV_M2 $v8m2(tied-def 0), $v8m2, $v10m2, $noreg, 5, implicit $vl, implicit $vtype
</pre></div>
</div>
<p>Note that the vector pseudo remains as it’s needed to encode the register class for the LMUL. Its AVL and SEW operands are no longer used.</p>
<p><code class="docutils literal notranslate"><span class="pre">RISCVAsmPrinter</span></code> will then lower the pseudo instructions into real <code class="docutils literal notranslate"><span class="pre">MCInst</span></code>s.</p>
<div class="highlight-nasm notranslate"><div class="highlight"><pre><span></span><span class="nf">vsetvli</span><span class="w"> </span><span class="nv">a0</span><span class="p">,</span><span class="w"> </span><span class="nv">zero</span><span class="p">,</span><span class="w"> </span><span class="nv">e32</span><span class="p">,</span><span class="w"> </span><span class="nv">m2</span><span class="p">,</span><span class="w"> </span><span class="nv">ta</span><span class="p">,</span><span class="w"> </span><span class="nv">ma</span>
<span class="nf">vadd.vv</span><span class="w"> </span><span class="nv">v8</span><span class="p">,</span><span class="w"> </span><span class="nv">v8</span><span class="p">,</span><span class="w"> </span><span class="nv">v10</span>
</pre></div>
</div>
</section>
<section id="see-also">
<h2><a class="toc-backref" href="#id13" role="doc-backlink">See also</a><a class="headerlink" href="#see-also" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://lists.llvm.org/pipermail/llvm-dev/2020-October/145850.html">[llvm-dev] [RFC] Code generation for RISC-V V-extension</a></p></li>
<li><p><a class="reference external" href="https://youtu.be/-ox8iJmbp0c?feature=shared">2023 LLVM Dev Mtg - Vector codegen in the RISC-V backend</a></p></li>
<li><p><a class="reference external" href="https://youtu.be/t17O_bU1jks?feature=shared">2023 LLVM Dev Mtg - How to add an C intrinsic and code-gen it, using the RISC-V vector C intrinsics</a></p></li>
<li><p><a class="reference external" href="https://youtu.be/daWLCyhwrZ8?feature=shared">2021 LLVM Dev Mtg “Optimizing code for scalable vector architectures”</a></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../SourceLevelDebugging.html" title="Source Level Debugging with LLVM"
             >next</a> |</li>
        <li class="right" >
          <a href="../RISCVUsage.html" title="User Guide for RISC-V Target"
             >previous</a> |</li>
  <li><a href="https://llvm.org/">LLVM Home</a>&nbsp;|&nbsp;</li>
  <li><a href="../index.html">Documentation</a>&raquo;</li>

          <li class="nav-item nav-item-1"><a href="../UserGuides.html" >User Guides</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">RISC-V Vector Extension</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2003-2025, LLVM Project.
      Last updated on 2025-03-04.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>