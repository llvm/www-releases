
<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Instrumentation Profile Format &#8212; LLVM 20.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="_static/llvm-theme.css?v=96924833" />
    <script src="_static/documentation_options.js?v=383a7952"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Instruction referencing for debug info" href="InstrRefDebugInfo.html" />
    <link rel="prev" title="InstCombine contributor guide" href="InstCombineContributorGuide.html" />
<style type="text/css">
  table.right { float: right; margin-left: 20px; }
  table.right td { border: 1px solid #ccc; }
</style>

  </head><body>
<div class="logo">
  <a href="index.html">
    <img src="_static/logo.png"
         alt="LLVM Logo" width="250" height="88"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="InstrRefDebugInfo.html" title="Instruction referencing for debug info"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="InstCombineContributorGuide.html" title="InstCombine contributor guide"
             accesskey="P">previous</a> |</li>
  <li><a href="https://llvm.org/">LLVM Home</a>&nbsp;|&nbsp;</li>
  <li><a href="index.html">Documentation</a>&raquo;</li>

          <li class="nav-item nav-item-1"><a href="UserGuides.html" accesskey="U">User Guides</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Instrumentation Profile Format</a></li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">

<h3>Documentation</h3>

<ul class="want-points">
    <li><a href="https://llvm.org/docs/GettingStartedTutorials.html">Getting Started/Tutorials</a></li>
    <li><a href="https://llvm.org/docs/UserGuides.html">User Guides</a></li>
    <li><a href="https://llvm.org/docs/Reference.html">Reference</a></li>
</ul>

<h3>Getting Involved</h3>

<ul class="want-points">
    <li><a href="https://llvm.org/docs/Contributing.html">Contributing to LLVM</a></li>
    <li><a href="https://llvm.org/docs/HowToSubmitABug.html">Submitting Bug Reports</a></li>
    <li><a href="https://llvm.org/docs/GettingInvolved.html#mailing-lists">Mailing Lists</a></li>
    <li><a href="https://llvm.org/docs/GettingInvolved.html#discord">Discord</a></li>
    <li><a href="https://llvm.org/docs/GettingInvolved.html#meetups-and-social-events">Meetups and Social Events</a></li>
</ul>

<h3>Additional Links</h3>

<ul class="want-points">
    <li><a href="https://llvm.org/docs/FAQ.html">FAQ</a></li>
    <li><a href="https://llvm.org/docs/Lexicon.html">Glossary</a></li>
    <li><a href="https://llvm.org/pubs">Publications</a></li>
    <li><a href="https://github.com/llvm/llvm-project/">Github Repository</a></li>
</ul>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/InstrProfileFormat.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="instrumentation-profile-format">
<h1>Instrumentation Profile Format<a class="headerlink" href="#instrumentation-profile-format" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id19">Overview</a></p></li>
<li><p><a class="reference internal" href="#raw-profile-format" id="id20">Raw Profile Format</a></p>
<ul>
<li><p><a class="reference internal" href="#general-storage-layout" id="id21">General Storage Layout</a></p></li>
<li><p><a class="reference internal" href="#header" id="id22">Header</a></p></li>
<li><p><a class="reference internal" href="#payload-sections" id="id23">Payload Sections</a></p>
<ul>
<li><p><a class="reference internal" href="#binary-ids" id="id24">Binary Ids</a></p></li>
<li><p><a class="reference internal" href="#profile-metadata" id="id25">Profile Metadata</a></p></li>
<li><p><a class="reference internal" href="#profile-counters" id="id26">Profile Counters</a></p></li>
<li><p><a class="reference internal" href="#bitmap" id="id27">Bitmap</a></p></li>
<li><p><a class="reference internal" href="#names" id="id28">Names</a></p></li>
<li><p><a class="reference internal" href="#virtual-table-profile-data" id="id29">Virtual Table Profile Data</a></p></li>
<li><p><a class="reference internal" href="#virtual-table-names" id="id30">Virtual Table Names</a></p></li>
<li><p><a class="reference internal" href="#value-profile-data" id="id31">Value Profile Data</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#indexed-profile-format" id="id32">Indexed Profile Format</a></p>
<ul>
<li><p><a class="reference internal" href="#id8" id="id33">General Storage Layout</a></p></li>
<li><p><a class="reference internal" href="#id9" id="id34">Header</a></p></li>
<li><p><a class="reference internal" href="#id10" id="id35">Payload Sections</a></p>
<ul>
<li><p><a class="reference internal" href="#cs-profile-summary" id="id36">(CS) Profile Summary</a></p></li>
<li><p><a class="reference internal" href="#function-data" id="id37">Function data</a></p></li>
<li><p><a class="reference internal" href="#memprof-profile-data" id="id38">MemProf Profile data</a></p></li>
<li><p><a class="reference internal" href="#id12" id="id39">Binary Ids</a></p></li>
<li><p><a class="reference internal" href="#temporal-profile-traces" id="id40">Temporal Profile Traces</a></p></li>
<li><p><a class="reference internal" href="#id13" id="id41">Virtual Table Names</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#profile-data-usage" id="id42">Profile Data Usage</a></p></li>
</ul>
</nav>
<section id="overview">
<h2><a class="toc-backref" href="#id19" role="doc-backlink">Overview</a><a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>Clang supports two types of profiling via instrumentation <a class="footnote-reference brackets" href="#id14" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>: frontend-based
and IR-based, and both could support a variety of use cases <a class="footnote-reference brackets" href="#id15" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a> .
This document describes two binary serialization formats (raw and indexed) to
store instrumented profiles with a specific emphasis on IRPGO use case, in the
sense that when specific header fields and payload sections have different ways
of interpretation across use cases, the documentation is based on IRPGO.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Frontend-generated profiles are used together with coverage mapping for
<a class="reference external" href="https://clang.llvm.org/docs/SourceBasedCodeCoverage.html">source-based code coverage</a>. The <a class="reference external" href="https://llvm.org/docs/CoverageMappingFormat.html">coverage mapping format</a> is different from
profile format.</p>
</div>
</section>
<section id="raw-profile-format">
<h2><a class="toc-backref" href="#id20" role="doc-backlink">Raw Profile Format</a><a class="headerlink" href="#raw-profile-format" title="Link to this heading">¶</a></h2>
<p>The raw profile is generated by running the instrumented binary. The raw profile
data from an executable or a shared library <a class="footnote-reference brackets" href="#id16" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a> consists of a header and
multiple sections, with each section as a memory dump. The raw profile data needs
to be reasonably compact and fast to generate.</p>
<p>There are no backward or forward version compatiblity guarantees for the raw profile
format. That is, compilers and tools <a class="reference external" href="https://github.com/llvm/llvm-project/blob/bffdde8b8e5d9a76a47949cd0f574f3ce656e181/llvm/lib/ProfileData/InstrProfReader.cpp#L551-L558">require</a> a specific raw profile version
to parse the profiles.</p>
<p>To feed profiles back into compilers for an optimized build (e.g., via
<code class="docutils literal notranslate"><span class="pre">-fprofile-use</span></code> for IR instrumentation), a raw profile must to be converted into
indexed format.</p>
<section id="general-storage-layout">
<h3><a class="toc-backref" href="#id21" role="doc-backlink">General Storage Layout</a><a class="headerlink" href="#general-storage-layout" title="Link to this heading">¶</a></h3>
<p>The storage layout of raw profile data format is illustrated below. Basically,
when the raw profile is read into an memory buffer, the actual byte offset of a
section is inferred from the section’s order in the layout and size information
of all the sections ahead of it.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+----+-----------------------+</span>
<span class="o">|</span>    <span class="o">|</span>        <span class="n">Magic</span>          <span class="o">|</span>
<span class="o">|</span>    <span class="o">+-----------------------+</span>
<span class="o">|</span>    <span class="o">|</span>        <span class="n">Version</span>        <span class="o">|</span>
<span class="o">|</span>    <span class="o">+-----------------------+</span>
<span class="n">H</span>    <span class="o">|</span>   <span class="n">Size</span> <span class="n">Info</span> <span class="k">for</span>       <span class="o">|</span>
<span class="n">E</span>    <span class="o">|</span>      <span class="n">Section</span> <span class="mi">1</span>        <span class="o">|</span>
<span class="n">A</span>    <span class="o">+-----------------------+</span>
<span class="n">D</span>    <span class="o">|</span>   <span class="n">Size</span> <span class="n">Info</span> <span class="k">for</span>       <span class="o">|</span>
<span class="n">E</span>    <span class="o">|</span>      <span class="n">Section</span> <span class="mi">2</span>        <span class="o">|</span>
<span class="n">R</span>    <span class="o">+-----------------------+</span>
<span class="o">|</span>    <span class="o">|</span>          <span class="o">...</span>          <span class="o">|</span>
<span class="o">|</span>    <span class="o">+-----------------------+</span>
<span class="o">|</span>    <span class="o">|</span>   <span class="n">Size</span> <span class="n">Info</span> <span class="k">for</span>       <span class="o">|</span>
<span class="o">|</span>    <span class="o">|</span>      <span class="n">Section</span> <span class="n">N</span>        <span class="o">|</span>
<span class="o">+----+-----------------------+</span>
<span class="n">P</span>    <span class="o">|</span>       <span class="n">Section</span> <span class="mi">1</span>       <span class="o">|</span>
<span class="n">A</span>    <span class="o">+-----------------------+</span>
<span class="n">Y</span>    <span class="o">|</span>       <span class="n">Section</span> <span class="mi">2</span>       <span class="o">|</span>
<span class="n">L</span>    <span class="o">+-----------------------+</span>
<span class="n">O</span>    <span class="o">|</span>          <span class="o">...</span>          <span class="o">|</span>
<span class="n">A</span>    <span class="o">+-----------------------+</span>
<span class="n">D</span>    <span class="o">|</span>       <span class="n">Section</span> <span class="n">N</span>       <span class="o">|</span>
<span class="o">+----+-----------------------+</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Sections might be padded to meet specific alignment requirements. For
simplicity, header fields and data sections solely for padding purpose are
omitted in the data layout graph above and the rest of this document.</p>
</div>
</section>
<section id="header">
<h3><a class="toc-backref" href="#id22" role="doc-backlink">Header</a><a class="headerlink" href="#header" title="Link to this heading">¶</a></h3>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">Magic</span></code></dt><dd><p>Magic number encodes profile format (raw, indexed or text). For the raw format,
the magic number also encodes the endianness (big or little) and C pointer
size (4 or 8 bytes) of the platform on which the profile is generated.</p>
<p>A factory method reads the magic number to construct reader properly and returns
error upon unrecognized format. Specifically, the factory method and raw profile
reader implementation make sure that a raw profile file could be read back on
a platform with the opposite endianness and/or the other C pointer size.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">Version</span></code></dt><dd><p>The lower 32 bits specify the actual version and the most significant 32 bits
specify the variant types of the profile. IR-based instrumentation PGO and
context-sensitive IR-based instrumentation PGO are two variant types.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">BinaryIdsSize</span></code></dt><dd><p>The byte size of <a class="reference external" href="https://lists.llvm.org/pipermail/llvm-dev/2021-June/151154.html">binary id</a> section.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">NumData</span></code></dt><dd><p>The number of profile metadata. The byte size of <a class="reference internal" href="#profile-metadata">profile metadata</a> section
could be computed with this field.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">NumCounter</span></code></dt><dd><p>The number of entries in the profile counter section. The byte size of <a class="reference internal" href="#counter">counter</a>
section could be computed with this field.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">NumBitmapBytes</span></code></dt><dd><p>The number of bytes in the profile <a class="reference internal" href="#bitmap">bitmap</a> section.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">NamesSize</span></code></dt><dd><p>The number of bytes in the name section.</p>
</dd>
</dl>
<dl id="countersdelta">
<dt><code class="docutils literal notranslate"><span class="pre">CountersDelta</span></code></dt><dd><p>This field records the in-memory address difference between the <a class="reference internal" href="#profile-metadata">profile metadata</a>
and counter section in the instrumented binary, i.e., <code class="docutils literal notranslate"><span class="pre">start(__llvm_prf_cnts)</span> <span class="pre">-</span> <span class="pre">start(__llvm_prf_data)</span></code>.</p>
<p>It’s used jointly with the <a class="reference internal" href="#counterptr">CounterPtr</a> field to compute the counter offset
relative to <code class="docutils literal notranslate"><span class="pre">start(__llvm_prf_cnts)</span></code>. Check out <a class="reference internal" href="#calculation-of-counter-offset">calculation-of-counter-offset</a>
for a visualized explanation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">__llvm_prf_data</span></code> object file section might not be loaded into memory
when instrumented binary runs or might not get generated in the instrumented
binary in the first place. In those cases, <code class="docutils literal notranslate"><span class="pre">CountersDelta</span></code> is not used and
other mechanisms are used to match counters with instrumented code. See
<a class="reference external" href="https://groups.google.com/g/llvm-dev/c/r03Z6JoN7d4">lightweight instrumentation</a> and <a class="reference external" href="https://discourse.llvm.org/t/rfc-add-binary-profile-correlation-to-not-load-profile-metadata-sections-into-memory-at-runtime/74565">binary profile correlation</a> for examples.</p>
</div>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">BitmapDelta</span></code></dt><dd><p>This field records the in-memory address difference between the <a class="reference internal" href="#profile-metadata">profile metadata</a>
and bitmap section in the instrumented binary, i.e., <code class="docutils literal notranslate"><span class="pre">start(__llvm_prf_bits)</span> <span class="pre">-</span> <span class="pre">start(__llvm_prf_data)</span></code>.</p>
<p>It’s used jointly with the <a class="reference internal" href="#bitmapptr">BitmapPtr</a> to find the bitmap of a profile data
record, in a similar way to how counters are referenced as explained by
<a class="reference internal" href="#calculation-of-counter-offset">calculation-of-counter-offset</a> .</p>
<p>Similar to <a class="reference internal" href="#countersdelta">CountersDelta</a> field, this field may not be used in non-PGO variants
of profiles.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">NamesDelta</span></code></dt><dd><p>Records the in-memory address of name section. Not used except for raw profile
reader error checking.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">NumVTables</span></code></dt><dd><p>Records the number of instrumented vtable entries in the binary. Used for
<a class="reference external" href="https://discourse.llvm.org/t/rfc-dynamic-type-profiling-and-optimizations-in-llvm/74600">type profiling</a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">VNamesSize</span></code></dt><dd><p>Records the byte size in the virtual table names section. Used for <a class="reference external" href="https://discourse.llvm.org/t/rfc-dynamic-type-profiling-and-optimizations-in-llvm/74600">type profiling</a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ValueKindLast</span></code></dt><dd><p>Records the number of value kinds. Macro <a class="reference external" href="https://github.com/llvm/llvm-project/blob/7e405eb722e40c79b7726201d0f76b5dab34ba0f/compiler-rt/include/profile/InstrProfData.inc#L184-L186">VALUE_PROF_KIND</a> defines the value
kinds with a description of the kind.</p>
</dd>
</dl>
</section>
<section id="payload-sections">
<h3><a class="toc-backref" href="#id23" role="doc-backlink">Payload Sections</a><a class="headerlink" href="#payload-sections" title="Link to this heading">¶</a></h3>
<section id="binary-ids">
<h4><a class="toc-backref" href="#id24" role="doc-backlink">Binary Ids</a><a class="headerlink" href="#binary-ids" title="Link to this heading">¶</a></h4>
<p>Stores the binary ids of the instrumented binaries to associate binaries with
profiles for source code coverage. See <a class="reference external" href="https://lists.llvm.org/pipermail/llvm-dev/2021-June/151154.html">binary id</a> RFC for the design.</p>
</section>
<section id="profile-metadata">
<span id="id4"></span><h4><a class="toc-backref" href="#id25" role="doc-backlink">Profile Metadata</a><a class="headerlink" href="#profile-metadata" title="Link to this heading">¶</a></h4>
<p>This section stores the metadata to map counters and value profiles back to
instrumented code regions (e.g., LLVM IR for IRPGO).</p>
<p>The in-memory representation of the metadata is <a class="reference external" href="https://github.com/llvm/llvm-project/blob/7c3b67d2038cfb48a80299089f6a1308eee1df7f/compiler-rt/include/profile/InstrProfData.inc#L65-L95">__llvm_profile_data</a>.
Some fields are used to reference data from other sections in the profile.
The fields are documented as follows:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">NameRef</span></code></dt><dd><p>The MD5 of the function’s PGO name. PGO name has the format
<code class="docutils literal notranslate"><span class="pre">[&lt;filepath&gt;&lt;delimiter&gt;]&lt;mangled-name&gt;</span></code> where <code class="docutils literal notranslate"><span class="pre">&lt;filepath&gt;</span></code> and
<code class="docutils literal notranslate"><span class="pre">&lt;delimiter&gt;</span></code> are provided for local-linkage functions to tell possibly
identical functions.</p>
</dd>
</dl>
<dl class="simple" id="funchash">
<dt><code class="docutils literal notranslate"><span class="pre">FuncHash</span></code></dt><dd><p>A checksum of the function’s IR, taking control flow graph and instrumented
value sites into accounts. See <a class="reference external" href="https://github.com/llvm/llvm-project/blob/7c3b67d2038cfb48a80299089f6a1308eee1df7f/llvm/lib/Transforms/Instrumentation/PGOInstrumentation.cpp#L616-L685">computeCFGHash</a> for details.</p>
</dd>
</dl>
<dl class="simple" id="counterptr">
<dt><code class="docutils literal notranslate"><span class="pre">CounterPtr</span></code></dt><dd><p>The in-memory address difference between profile data and the start of corresponding
counters. Counter position is stored this way (as a link-time constant) to reduce
instrumented binary size compared with snapshotting the address of symbols directly.
See <a class="reference external" href="https://github.com/llvm/llvm-project/commit/a1532ed27582038e2d9588108ba0fe8237f01844">commit a1532ed</a> for further information.</p>
</dd>
</dl>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">CounterPtr</span></code> might represent a different value for non-IRPGO use case. For
example, for <a class="reference external" href="https://discourse.llvm.org/t/rfc-add-binary-profile-correlation-to-not-load-profile-metadata-sections-into-memory-at-runtime/74565">binary profile correlation</a>, it represents the absolute address of counter.
When in doubt, check source code.</p>
</div>
</div></blockquote>
<dl id="bitmapptr">
<dt><code class="docutils literal notranslate"><span class="pre">BitmapPtr</span></code></dt><dd><p>The in-memory address difference between profile data and the start address of
corresponding bitmap.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Similar to <a class="reference internal" href="#counterptr">CounterPtr</a>, this field may represent a different value for non-IRPGO use case.</p>
</div>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">FunctionPointer</span></code></dt><dd><p>Records the function address when instrumented binary runs. This is used to
map the profiled callee address of indirect calls to the <code class="docutils literal notranslate"><span class="pre">NameRef</span></code> during
conversion from raw to indexed profiles.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">Values</span></code></dt><dd><p>Represents value profiles in a two dimensional array. The number of elements
in the first dimension is the number of instrumented value sites across all
kinds. Each element in the first dimension is the head of a linked list, and
the each element in the second dimension is linked list element, carrying
<code class="docutils literal notranslate"><span class="pre">&lt;profiled-value,</span> <span class="pre">count&gt;</span></code> as payload. This is used by compiler runtime when
writing out value profiles.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Value profiling is supported by frontend and IR PGO instrumentation,
but it’s not supported in all cases (e.g., <a class="reference external" href="https://groups.google.com/g/llvm-dev/c/r03Z6JoN7d4">lightweight instrumentation</a>).</p>
</div>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">NumCounters</span></code></dt><dd><p>The number of counters for the instrumented function.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">NumValueSites</span></code></dt><dd><p>This is an array of counters, and each counter represents the number of
instrumented sites for a kind of value in the function.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">NumBitmapBytes</span></code></dt><dd><p>The number of bitmap bytes for the function.</p>
</dd>
</dl>
</section>
<section id="profile-counters">
<span id="counter"></span><h4><a class="toc-backref" href="#id26" role="doc-backlink">Profile Counters</a><a class="headerlink" href="#profile-counters" title="Link to this heading">¶</a></h4>
<p>For PGO <a class="footnote-reference brackets" href="#id17" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a>, the counters within an instrumented function of a specific <a class="reference internal" href="#funchash">FuncHash</a>
are stored contiguously and in an order that is consistent with instrumentation points selection.</p>
<p id="calculation-of-counter-offset">As mentioned above, the recorded counter offset is relative to the profile metadata.
So how are function counters located in the raw profile data?</p>
<p>Basically, the profile reader iterates profile metadata (from the <a class="reference internal" href="#profile-metadata">profile metadata</a>
section) and makes use of the recorded relative distances, as illustrated below.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>       <span class="o">+</span> <span class="o">--&gt;</span> <span class="n">start</span><span class="p">(</span><span class="n">__llvm_prf_data</span><span class="p">)</span> <span class="o">--&gt;</span> <span class="o">+---------------------+</span> <span class="o">------------+</span>
       <span class="o">|</span>                                <span class="o">|</span>       <span class="n">Data</span> <span class="mi">1</span>        <span class="o">|</span>             <span class="o">|</span>
       <span class="o">|</span>                                <span class="o">+---------------------+</span>  <span class="o">=====||</span>    <span class="o">|</span>
       <span class="o">|</span>                                <span class="o">|</span>       <span class="n">Data</span> <span class="mi">2</span>        <span class="o">|</span>       <span class="o">||</span>    <span class="o">|</span>
       <span class="o">|</span>                                <span class="o">+---------------------+</span>       <span class="o">||</span>    <span class="o">|</span>
       <span class="o">|</span>                                <span class="o">|</span>        <span class="o">...</span>          <span class="o">|</span>       <span class="o">||</span>    <span class="o">|</span>
<span class="n">Counter</span><span class="o">|</span>                                <span class="o">+---------------------+</span>       <span class="o">||</span>    <span class="o">|</span>
 <span class="n">Delta</span> <span class="o">|</span>                                <span class="o">|</span>       <span class="n">Data</span> <span class="n">N</span>        <span class="o">|</span>       <span class="o">||</span>    <span class="o">|</span>
       <span class="o">|</span>                                <span class="o">+---------------------+</span>       <span class="o">||</span>    <span class="o">|</span>   <span class="n">CounterPtr1</span>
       <span class="o">|</span>                                                              <span class="o">||</span>    <span class="o">|</span>
       <span class="o">|</span>                                              <span class="n">CounterPtr2</span>     <span class="o">||</span>    <span class="o">|</span>
       <span class="o">|</span>                                                              <span class="o">||</span>    <span class="o">|</span>
       <span class="o">|</span>                                                              <span class="o">||</span>    <span class="o">|</span>
       <span class="o">+</span> <span class="o">--&gt;</span> <span class="n">start</span><span class="p">(</span><span class="n">__llvm_prf_cnts</span><span class="p">)</span> <span class="o">--&gt;</span> <span class="o">+---------------------+</span>       <span class="o">||</span>    <span class="o">|</span>
                                        <span class="o">|</span>        <span class="o">...</span>          <span class="o">|</span>       <span class="o">||</span>    <span class="o">|</span>
                                        <span class="o">+---------------------+</span>  <span class="o">-----||----+</span>
                                        <span class="o">|</span>    <span class="n">Counter</span> <span class="k">for</span>      <span class="o">|</span>       <span class="o">||</span>
                                        <span class="o">|</span>       <span class="n">Data</span> <span class="mi">1</span>        <span class="o">|</span>       <span class="o">||</span>
                                        <span class="o">+---------------------+</span>       <span class="o">||</span>
                                        <span class="o">|</span>        <span class="o">...</span>          <span class="o">|</span>       <span class="o">||</span>
                                        <span class="o">+---------------------+</span>  <span class="o">=====||</span>
                                        <span class="o">|</span>    <span class="n">Counter</span> <span class="k">for</span>      <span class="o">|</span>
                                        <span class="o">|</span>       <span class="n">Data</span> <span class="mi">2</span>        <span class="o">|</span>
                                        <span class="o">+---------------------+</span>
                                        <span class="o">|</span>        <span class="o">...</span>          <span class="o">|</span>
                                        <span class="o">+---------------------+</span>
                                        <span class="o">|</span>    <span class="n">Counter</span> <span class="k">for</span>      <span class="o">|</span>
                                        <span class="o">|</span>       <span class="n">Data</span> <span class="n">N</span>        <span class="o">|</span>
                                        <span class="o">+---------------------+</span>
</pre></div>
</div>
<p>In the graph,</p>
<ul class="simple">
<li><p>The profile header records <code class="docutils literal notranslate"><span class="pre">CounterDelta</span></code> with the value as <code class="docutils literal notranslate"><span class="pre">start(__llvm_prf_cnts)</span> <span class="pre">-</span> <span class="pre">start(__llvm_prf_data)</span></code>.
We will call it <code class="docutils literal notranslate"><span class="pre">CounterDeltaInitVal</span></code> below for convenience.</p></li>
<li><p>For each profile data record <code class="docutils literal notranslate"><span class="pre">ProfileDataN</span></code>, <code class="docutils literal notranslate"><span class="pre">CounterPtr</span></code> is recorded as
<code class="docutils literal notranslate"><span class="pre">start(CounterN)</span> <span class="pre">-</span> <span class="pre">start(ProfileDataN)</span></code>, where <code class="docutils literal notranslate"><span class="pre">ProfileDataN</span></code> is the N-th
entry in <code class="docutils literal notranslate"><span class="pre">__llvm_prf_data</span></code>, and <code class="docutils literal notranslate"><span class="pre">CounterN</span></code> represents the corresponding
profile counters.</p></li>
</ul>
<p>Each time the reader advances to the next data record, it <a class="reference external" href="https://github.com/llvm/llvm-project/blob/17ff25a58ee4f29816d932fdb75f0d305718069f/llvm/include/llvm/ProfileData/InstrProfReader.h#L439-L444">updates</a> <code class="docutils literal notranslate"><span class="pre">CounterDelta</span></code>
to minus the size of one <code class="docutils literal notranslate"><span class="pre">ProfileData</span></code>.</p>
<p>For the counter corresponding to the first data record, the byte offset
relative to the start of the counter section is calculated as <code class="docutils literal notranslate"><span class="pre">CounterPtr1</span> <span class="pre">-</span> <span class="pre">CounterDeltaInitVal</span></code>.
When profile reader advances to the second data record, note <code class="docutils literal notranslate"><span class="pre">CounterDelta</span></code>
is updated to <code class="docutils literal notranslate"><span class="pre">CounterDeltaInitVal</span> <span class="pre">-</span> <span class="pre">sizeof(ProfileData)</span></code>.
Thus the byte offset relative to the start of the counter section is calculated
as <code class="docutils literal notranslate"><span class="pre">CounterPtr2</span> <span class="pre">-</span> <span class="pre">(CounterDeltaInitVal</span> <span class="pre">-</span> <span class="pre">sizeof(ProfileData))</span></code>.</p>
</section>
<section id="bitmap">
<span id="id6"></span><h4><a class="toc-backref" href="#id27" role="doc-backlink">Bitmap</a><a class="headerlink" href="#bitmap" title="Link to this heading">¶</a></h4>
<p>This section is used for source-based <a class="reference external" href="https://en.wikipedia.org/wiki/Modified_condition/decision_coverage">Modified Condition/Decision Coverage</a> code coverage. Check out <a class="reference external" href="https://discourse.llvm.org/t/rfc-source-based-mc-dc-code-coverage/59244">Bitmap RFC</a>
for the design.</p>
</section>
<section id="names">
<span id="function-names"></span><h4><a class="toc-backref" href="#id28" role="doc-backlink">Names</a><a class="headerlink" href="#names" title="Link to this heading">¶</a></h4>
<p>This section contains possibly compressed concatenated string of functions’ PGO
names. If compressed, zlib library is used.</p>
<p>Function names serve as keys in the PGO data hash table when raw profiles are
converted into indexed profiles. They are also crucial for <code class="docutils literal notranslate"><span class="pre">llvm-profdata</span></code> to
show the profiles in a human-readable way.</p>
</section>
<section id="virtual-table-profile-data">
<h4><a class="toc-backref" href="#id29" role="doc-backlink">Virtual Table Profile Data</a><a class="headerlink" href="#virtual-table-profile-data" title="Link to this heading">¶</a></h4>
<p>This section is used for <a class="reference external" href="https://discourse.llvm.org/t/rfc-dynamic-type-profiling-and-optimizations-in-llvm/74600">type profiling</a>. Each entry corresponds to one virtual
table and is defined by the following C++ struct</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">VTableProfData</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// The start address of the vtable, collected at runtime.</span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">StartAddress</span><span class="p">;</span>
<span class="w">  </span><span class="c1">// The byte size of the vtable. `StartAddress` and `ByteSize` specifies an address range to look up.</span>
<span class="w">  </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">ByteSize</span><span class="p">;</span>
<span class="w">  </span><span class="c1">// The hash of vtable&#39;s (PGO) name</span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">MD5HashOfName</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>At profile use time, the compiler looks up a profiled address in the sorted vtable
address ranges and maps the address to a specific vtable through hashed name.</p>
</section>
<section id="virtual-table-names">
<h4><a class="toc-backref" href="#id30" role="doc-backlink">Virtual Table Names</a><a class="headerlink" href="#virtual-table-names" title="Link to this heading">¶</a></h4>
<p>This section is similar to <a class="reference internal" href="#function-names">function names</a> section above, except it contains the PGO
names of profiled virtual tables. It’s a standalone section such that raw profile
readers could directly find each name set by accessing the corresponding profile
data section.</p>
<p>This section is stored in raw profiles such that <cite>llvm-profdata</cite> could show the
profiles in a human-readable way.</p>
</section>
<section id="value-profile-data">
<h4><a class="toc-backref" href="#id31" role="doc-backlink">Value Profile Data</a><a class="headerlink" href="#value-profile-data" title="Link to this heading">¶</a></h4>
<p>This section contains the profile data for value profiling.</p>
<p>The value profiles corresponding to a profile metadata are serialized contiguously
as one record, and value profile records are stored in the same order as the
respective profile data, such that a raw profile reader <a class="reference external" href="https://github.com/llvm/llvm-project/blob/7e15fa9161eda7497a5d6abf0d951a1d12d86550/llvm/include/llvm/ProfileData/InstrProfReader.h#L456-L457">advances</a> the pointer to
profile data and the pointer to value profile records simutaneously <a class="footnote-reference brackets" href="#id18" id="id7" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a> to find
value profiles for a per function, per <a class="reference internal" href="#funchash">FuncHash</a> profile data.</p>
</section>
</section>
</section>
<section id="indexed-profile-format">
<h2><a class="toc-backref" href="#id32" role="doc-backlink">Indexed Profile Format</a><a class="headerlink" href="#indexed-profile-format" title="Link to this heading">¶</a></h2>
<p>Indexed profiles are generated from <code class="docutils literal notranslate"><span class="pre">llvm-profdata</span></code>. In the indexed profiles,
function data are organized as on-disk hash table such that compilers can
look up profile data for functions in an IR module.</p>
<p>Compilers and tools must retain backward compatibility with indexed profiles.
That is, a tool or a compiler built at newer versions of code must understand
profiles generated by older tools or compilers.</p>
<section id="id8">
<h3><a class="toc-backref" href="#id33" role="doc-backlink">General Storage Layout</a><a class="headerlink" href="#id8" title="Link to this heading">¶</a></h3>
<p>The ASCII art depicts the general storage layout of indexed profiles.
Specifically, the indexed profile header describes the byte offset of individual
payload sections.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                <span class="o">+-----------------------+---+</span>
                <span class="o">|</span>        <span class="n">Magic</span>          <span class="o">|</span>   <span class="o">|</span>
                <span class="o">+-----------------------+</span>   <span class="o">|</span>
                <span class="o">|</span>        <span class="n">Version</span>        <span class="o">|</span>   <span class="o">|</span>
                <span class="o">+-----------------------+</span>   <span class="o">|</span>
                <span class="o">|</span>        <span class="n">HashType</span>       <span class="o">|</span>   <span class="n">H</span>
                <span class="o">+-----------------------+</span>   <span class="n">E</span>
                <span class="o">|</span>       <span class="n">Byte</span> <span class="n">Offset</span>     <span class="o">|</span>   <span class="n">A</span>
        <span class="o">+------</span> <span class="o">|</span>      <span class="n">of</span> <span class="n">section</span> <span class="n">A</span>     <span class="o">|</span>   <span class="n">D</span>
        <span class="o">|</span>       <span class="o">+-----------------------+</span>   <span class="n">E</span>
        <span class="o">|</span>       <span class="o">|</span>       <span class="n">Byte</span> <span class="n">Of</span> <span class="n">fset</span>    <span class="o">|</span>   <span class="n">R</span>
    <span class="o">+-----------|</span>      <span class="n">of</span> <span class="n">section</span> <span class="n">B</span>     <span class="o">|</span>   <span class="o">|</span>
    <span class="o">|</span>   <span class="o">|</span>       <span class="o">+-----------------------+</span>   <span class="o">|</span>
    <span class="o">|</span>   <span class="o">|</span>       <span class="o">|</span>         <span class="o">...</span>           <span class="o">|</span>   <span class="o">|</span>
    <span class="o">|</span>   <span class="o">|</span>       <span class="o">+-----------------------+</span>   <span class="o">|</span>
    <span class="o">|</span>   <span class="o">|</span>       <span class="o">|</span>      <span class="n">Byte</span> <span class="n">Offset</span>      <span class="o">|</span>   <span class="o">|</span>
<span class="o">+---------------|</span>     <span class="n">of</span> <span class="n">section</span> <span class="n">Z</span>      <span class="o">|</span>   <span class="o">|</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="o">|</span>       <span class="o">+-----------------------+---+</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="o">|</span>       <span class="o">|</span>    <span class="n">Profile</span> <span class="n">Summary</span>    <span class="o">|</span>   <span class="o">|</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="o">|</span>       <span class="o">+-----------------------+</span>   <span class="n">P</span>
<span class="o">|</span>   <span class="o">|</span>   <span class="o">+------&gt;|</span>      <span class="n">Section</span> <span class="n">A</span>        <span class="o">|</span>   <span class="n">A</span>
<span class="o">|</span>   <span class="o">|</span>           <span class="o">+-----------------------+</span>   <span class="n">Y</span>
<span class="o">|</span>   <span class="o">+----------&gt;|</span>      <span class="n">Section</span> <span class="n">B</span>        <span class="o">|</span>   <span class="n">L</span>
<span class="o">|</span>               <span class="o">+-----------------------+</span>   <span class="n">O</span>
<span class="o">|</span>               <span class="o">|</span>         <span class="o">...</span>           <span class="o">|</span>   <span class="n">A</span>
<span class="o">|</span>               <span class="o">+-----------------------+</span>   <span class="n">D</span>
<span class="o">+--------------&gt;|</span>      <span class="n">Section</span> <span class="n">Z</span>        <span class="o">|</span>   <span class="o">|</span>
                <span class="o">+-----------------------+---+</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Profile summary section is at the beginning of payload. It’s right after the
header so its position is implicitly known after reading the header.</p>
</div>
</section>
<section id="id9">
<h3><a class="toc-backref" href="#id34" role="doc-backlink">Header</a><a class="headerlink" href="#id9" title="Link to this heading">¶</a></h3>
<p>The <a class="reference external" href="https://github.com/llvm/llvm-project/blob/1a2960bab6381f2b288328e2371829b460ac020c/llvm/include/llvm/ProfileData/InstrProf.h#L1053-L1080">Header struct</a> is the source of truth and struct fields should explain
what’s in the header. At a high level, <cite>*Offset</cite> fields record section byte
offsets, which are used by readers to locate interesting sections and skip
uninteresting ones.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To maintain backward compatibility of the indexed profiles, existing fields
shouldn’t be deleted from struct definition; the field order shouldn’t be
modified. New fields should be appended.</p>
</div>
</section>
<section id="id10">
<h3><a class="toc-backref" href="#id35" role="doc-backlink">Payload Sections</a><a class="headerlink" href="#id10" title="Link to this heading">¶</a></h3>
<section id="cs-profile-summary">
<h4><a class="toc-backref" href="#id36" role="doc-backlink">(CS) Profile Summary</a><a class="headerlink" href="#cs-profile-summary" title="Link to this heading">¶</a></h4>
<p>This section is right after profile header. It stores the serialized profile
summary. For context-sensitive IR-based instrumentation PGO, this section stores
an additional profile summary corresponding to the context-sensitive profiles.</p>
</section>
<section id="function-data">
<span id="id11"></span><h4><a class="toc-backref" href="#id37" role="doc-backlink">Function data</a><a class="headerlink" href="#function-data" title="Link to this heading">¶</a></h4>
<p>This section stores functions and their profiling data as an on-disk hash table.
Profile data for functions with the same name are grouped together and share one
hash table entry (the functions may come from different shared libraries for
instance). The profile data for them are organized as a sequence of key-value
pair where the key is <a class="reference internal" href="#funchash">FuncHash</a>, and the value is profiled information (represented
by <a class="reference external" href="https://github.com/llvm/llvm-project/blob/7e405eb722e40c79b7726201d0f76b5dab34ba0f/llvm/include/llvm/ProfileData/InstrProf.h#L693">InstrProfRecord</a>) for the function.</p>
</section>
<section id="memprof-profile-data">
<h4><a class="toc-backref" href="#id38" role="doc-backlink">MemProf Profile data</a><a class="headerlink" href="#memprof-profile-data" title="Link to this heading">¶</a></h4>
<p>This section stores function’s memory profiling data. See
<a class="reference external" href="https://lists.llvm.org/pipermail/llvm-dev/2021-September/153007.html">MemProf binary serialization format RFC</a> for the design.</p>
</section>
<section id="id12">
<h4><a class="toc-backref" href="#id39" role="doc-backlink">Binary Ids</a><a class="headerlink" href="#id12" title="Link to this heading">¶</a></h4>
<p>The section is used to carry on <a class="reference external" href="https://lists.llvm.org/pipermail/llvm-dev/2021-June/151154.html">binary id</a> information from raw profiles.</p>
</section>
<section id="temporal-profile-traces">
<h4><a class="toc-backref" href="#id40" role="doc-backlink">Temporal Profile Traces</a><a class="headerlink" href="#temporal-profile-traces" title="Link to this heading">¶</a></h4>
<p>The section is used to carry on temporal profile information from raw profiles.
See <a class="reference external" href="https://discourse.llvm.org/t/rfc-temporal-profiling-extension-for-irpgo/68068">temporal profiling</a> for the design.</p>
</section>
<section id="id13">
<h4><a class="toc-backref" href="#id41" role="doc-backlink">Virtual Table Names</a><a class="headerlink" href="#id13" title="Link to this heading">¶</a></h4>
<p>This section is used to store the names of vtables from raw profile in the indexed
profile.</p>
<p>Unlike function names which are stored as keys of <a class="reference internal" href="#function-data">function data</a> hash table,
vtable names need to be stored in a standalone section in indexed profiles.
This way, <cite>llvm-profdata</cite> could show the profiled vtable information in a
human-readable way.</p>
</section>
</section>
</section>
<section id="profile-data-usage">
<h2><a class="toc-backref" href="#id42" role="doc-backlink">Profile Data Usage</a><a class="headerlink" href="#profile-data-usage" title="Link to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">llvm-profdata</span></code> is the command line tool to display and process instrumentation-
based profile data. For supported usages, check out <a class="reference external" href="https://llvm.org/docs/CommandGuide/llvm-profdata.html">llvm-profdata documentation</a>.</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id14" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>For usage, see <a class="reference external" href="https://clang.llvm.org/docs/UsersManual.html#profiling-with-instrumentation">https://clang.llvm.org/docs/UsersManual.html#profiling-with-instrumentation</a></p>
</aside>
<aside class="footnote brackets" id="id15" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">2</a><span class="fn-bracket">]</span></span>
<p>For example, IR-based instrumentation supports <a class="reference external" href="https://groups.google.com/g/llvm-dev/c/r03Z6JoN7d4">lightweight instrumentation</a>
and <a class="reference external" href="https://discourse.llvm.org/t/rfc-temporal-profiling-extension-for-irpgo/68068">temporal profiling</a>. Frontend instrumentation could support <a class="reference external" href="https://discourse.llvm.org/t/rfc-single-byte-counters-for-source-based-code-coverage/75685">single-byte counters</a>.</p>
</aside>
<aside class="footnote brackets" id="id16" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">3</a><span class="fn-bracket">]</span></span>
<p>A raw profile file could contain the concatenation of multiple raw
profiles, for example, from an executable and its shared libraries. Raw
profile reader could parse all raw profiles from the file correctly.</p>
</aside>
<aside class="footnote brackets" id="id17" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">4</a><span class="fn-bracket">]</span></span>
<p>The counter section is used by a few variant types (like temporal
profiling) and might have different semantics there.</p>
</aside>
<aside class="footnote brackets" id="id18" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id7">5</a><span class="fn-bracket">]</span></span>
<p>The step size of data pointer is the <code class="docutils literal notranslate"><span class="pre">sizeof(ProfileData)</span></code>, and the step
size of value profile pointer is calcuated based on the number of collected
values.</p>
</aside>
</aside>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="InstrRefDebugInfo.html" title="Instruction referencing for debug info"
             >next</a> |</li>
        <li class="right" >
          <a href="InstCombineContributorGuide.html" title="InstCombine contributor guide"
             >previous</a> |</li>
  <li><a href="https://llvm.org/">LLVM Home</a>&nbsp;|&nbsp;</li>
  <li><a href="index.html">Documentation</a>&raquo;</li>

          <li class="nav-item nav-item-1"><a href="UserGuides.html" >User Guides</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Instrumentation Profile Format</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2003-2025, LLVM Project.
      Last updated on 2025-03-04.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>