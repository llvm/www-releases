
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Misexpect &#8212; Clang 15.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/haiku.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="OpenCL Support" href="OpenCLSupport.html" />
    <link rel="prev" title="MSVC compatibility" href="MSVCCompatibility.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="index.html">
          <span>Clang 15.0.0 documentation</span></a></h1>
        <h2 class="heading"><span>Misexpect</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="MSVCCompatibility.html">MSVC compatibility</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="OpenCLSupport.html">OpenCL Support</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <div class="section" id="misexpect">
<h1><a class="toc-backref" href="#id1">Misexpect</a><a class="headerlink" href="#misexpect" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#misexpect" id="id1">Misexpect</a></p></li>
</ul>
</div>
<div class="toctree-wrapper compound">
</div>
<p>When developers use <code class="docutils literal notranslate"><span class="pre">llvm.expect</span></code> intrinsics, i.e., through use of
<code class="docutils literal notranslate"><span class="pre">__builtin_expect(...)</span></code>, they are trying to communicate how their code is
expected to behave at runtime to the optimizer. These annotations, however, can
be incorrect for a variety of reasons: changes to the code base invalidate them
silently, the developer mis-annotated them (e.g., using <code class="docutils literal notranslate"><span class="pre">LIKELY</span></code> instead of
<code class="docutils literal notranslate"><span class="pre">UNLIKELY</span></code>), or perhaps they assumed something incorrectly when they wrote
the annotation. Regardless of why, it is useful to detect these situations so
that the optimizer can make more useful decisions about the code.</p>
<p>MisExpect diagnostics are intended to help developers identify and address
these situations, by comparing the branch weights added by the <code class="docutils literal notranslate"><span class="pre">llvm.expect</span></code>
intrinsic to those collected through profiling. Whenever these values are
mismatched, a diagnostic is surfaced to the user. Details on how the checks
operate in the LLVM backed can be found in LLVM’s documentation.</p>
<p>By default MisExpect checking is quite strict, because the use of the
<code class="docutils literal notranslate"><span class="pre">llvm.expect</span></code> intrinsic is designed for specialized cases, where the outcome
of a condition is severely skewed. As a result, the optimizer can be extremely
aggressive, which can result in performance degradation if the outcome is less
predictable than the annotation suggests. Even when the annotation is correct
90% of the time, it may be beneficial to either remove the annotation or to use
a different intrinsic that can communicate the probability more directly.</p>
<p>Because this may be too strict, MisExpect diagnostics are not enabled by
default, and support an additional flag to tolerate some deviation from the
exact thresholds. The <code class="docutils literal notranslate"><span class="pre">-fdiagnostic-misexpect-tolerance=N</span></code> accepts
deviations when comparing branch weights within <code class="docutils literal notranslate"><span class="pre">N%</span></code> of the expected values.
So passing <code class="docutils literal notranslate"><span class="pre">-fdiagnostic-misexpect-tolerance=5</span></code> will not report diagnostic messages
if the branch weight from the profile is within 5% of the weight added by
the <code class="docutils literal notranslate"><span class="pre">llvm.expect</span></code> intrinsic.</p>
<p>MisExpect diagnostics are also available in the form of optimization remarks,
which can be serialized and processed through the <code class="docutils literal notranslate"><span class="pre">opt-viewer.py</span></code>
scripts in LLVM.</p>
<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-Rpass">
<span id="cmdoption-rpass"></span><span class="sig-name descname"><span class="pre">-Rpass</span></span><span class="sig-prename descclassname"><span class="pre">=misexpect</span></span><a class="headerlink" href="#cmdoption-Rpass" title="Permalink to this definition">¶</a></dt>
<dd><p>Enables optimization remarks for misexpect when profiling data conflicts with
use of <code class="docutils literal notranslate"><span class="pre">llvm.expect</span></code> intrinsics.</p>
</dd></dl>

<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-Wmisexpect">
<span id="cmdoption-wmisexpect"></span><span class="sig-name descname"><span class="pre">-Wmisexpect</span></span><span class="sig-prename descclassname"></span><a class="headerlink" href="#cmdoption-Wmisexpect" title="Permalink to this definition">¶</a></dt>
<dd><p>Enables misexpect warnings when profiling data conflicts with use of
<code class="docutils literal notranslate"><span class="pre">llvm.expect</span></code> intrinsics.</p>
</dd></dl>

<dl class="std option">
<dt class="sig sig-object std" id="cmdoption-fdiagnostic-misexpect-tolerance">
<span class="sig-name descname"><span class="pre">-fdiagnostic-misexpect-tolerance</span></span><span class="sig-prename descclassname"><span class="pre">=N</span></span><a class="headerlink" href="#cmdoption-fdiagnostic-misexpect-tolerance" title="Permalink to this definition">¶</a></dt>
<dd><p>Relaxes misexpect checking to tolerate profiling values within N% of the
expected branch weight. e.g., a value of <code class="docutils literal notranslate"><span class="pre">N=5</span></code> allows misexpect to check against
<code class="docutils literal notranslate"><span class="pre">0.95</span> <span class="pre">*</span> <span class="pre">Threshold</span></code></p>
</dd></dl>

<p>LLVM supports 4 types of profile formats: Frontend, IR, CS-IR, and
Sampling. MisExpect Diagnostics are compatible with all Profiling formats.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 16%" />
<col style="width: 84%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Profile Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Frontend</p></td>
<td><p>Profiling instrumentation added during compilation by the frontend, i.e. <code class="docutils literal notranslate"><span class="pre">clang</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>IR</p></td>
<td><p>Profiling instrumentation added during by the LLVM backend</p></td>
</tr>
<tr class="row-even"><td><p>CS-IR</p></td>
<td><p>Context Sensitive IR based profiles</p></td>
</tr>
<tr class="row-odd"><td><p>Sampling</p></td>
<td><p>Profiles collected through sampling with external tools, such as <code class="docutils literal notranslate"><span class="pre">perf</span></code> on Linux</p></td>
</tr>
</tbody>
</table>
</div>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="MSVCCompatibility.html">MSVC compatibility</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="OpenCLSupport.html">OpenCL Support</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2007-2022, The Clang Team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
  </body>
</html>