
<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>The Sandbox Vectorizer &#8212; LLVM 21.1.2 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="_static/llvm-theme.css?v=96924833" />
    <script src="_static/documentation_options.js?v=56ca4867"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Writing an LLVM Pass (legacy PM version)" href="WritingAnLLVMPass.html" />
    <link rel="prev" title="Vectorization Plan" href="VectorizationPlan.html" />
<style type="text/css">
  table.right { float: right; margin-left: 20px; }
  table.right td { border: 1px solid #ccc; }
</style>

  </head><body>
<div class="logo">
  <a href="index.html">
    <img src="_static/logo.png"
         alt="LLVM Logo" width="250" height="88"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="WritingAnLLVMPass.html" title="Writing an LLVM Pass (legacy PM version)"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="VectorizationPlan.html" title="Vectorization Plan"
             accesskey="P">previous</a> |</li>
  <li><a href="https://llvm.org/">LLVM Home</a>&nbsp;|&nbsp;</li>
  <li><a href="index.html">Documentation</a>&raquo;</li>

          <li class="nav-item nav-item-1"><a href="UserGuides.html" >User Guides</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="Vectorizers.html" accesskey="U">Auto-Vectorization in LLVM</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">The Sandbox Vectorizer</a></li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">

<h3>Documentation</h3>

<ul class="want-points">
    <li><a href="https://llvm.org/docs/GettingStartedTutorials.html">Getting Started/Tutorials</a></li>
    <li><a href="https://llvm.org/docs/UserGuides.html">User Guides</a></li>
    <li><a href="https://llvm.org/docs/Reference.html">Reference</a></li>
</ul>

<h3>Getting Involved</h3>

<ul class="want-points">
    <li><a href="https://llvm.org/docs/Contributing.html">Contributing to LLVM</a></li>
    <li><a href="https://llvm.org/docs/HowToSubmitABug.html">Submitting Bug Reports</a></li>
    <li><a href="https://llvm.org/docs/GettingInvolved.html#mailing-lists">Mailing Lists</a></li>
    <li><a href="https://llvm.org/docs/GettingInvolved.html#discord">Discord</a></li>
    <li><a href="https://llvm.org/docs/GettingInvolved.html#meetups-and-social-events">Meetups and Social Events</a></li>
</ul>

<h3>Additional Links</h3>

<ul class="want-points">
    <li><a href="https://llvm.org/docs/FAQ.html">FAQ</a></li>
    <li><a href="https://llvm.org/docs/Lexicon.html">Glossary</a></li>
    <li><a href="https://llvm.org/pubs">Publications</a></li>
    <li><a href="https://github.com/llvm/llvm-project/">Github Repository</a></li>
</ul>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/SandboxVectorizer.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="the-sandbox-vectorizer">
<h1><a class="toc-backref" href="#id1" role="doc-backlink">The Sandbox Vectorizer</a><a class="headerlink" href="#the-sandbox-vectorizer" title="Link to this heading">¶</a></h1>
<nav class="contents" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#the-sandbox-vectorizer" id="id1">The Sandbox Vectorizer</a></p>
<ul>
<li><p><a class="reference internal" href="#usage" id="id2">Usage</a></p></li>
<li><p><a class="reference internal" href="#internal-pass-pipeline" id="id3">Internal Pass Pipeline</a></p></li>
<li><p><a class="reference internal" href="#sandbox-vectorizer-passes" id="id4">Sandbox Vectorizer Passes</a></p>
<ul>
<li><p><a class="reference internal" href="#transformation-passes" id="id5">Transformation Passes</a></p></li>
<li><p><a class="reference internal" href="#helper-passes" id="id6">Helper Passes</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#region" id="id7">Region</a></p>
<ul>
<li><p><a class="reference internal" href="#adding-instructions-to-the-region" id="id8">Adding Instructions to the Region</a></p></li>
<li><p><a class="reference internal" href="#region-example" id="id9">Region Example</a></p></li>
<li><p><a class="reference internal" href="#region-auxiliary-vector" id="id10">Region Auxiliary Vector</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#testing-sandbox-vectorizer-passes-in-isolation" id="id11">Testing Sandbox Vectorizer Passes In Isolation</a></p></li>
<li><p><a class="reference internal" href="#stress-testing-a-region-pass-in-isolation" id="id12">Stress-testing a Region Pass in Isolation</a></p></li>
<li><p><a class="reference internal" href="#components" id="id13">Components</a></p>
<ul>
<li><p><a class="reference internal" href="#legality-analysis" id="id14">Legality Analysis</a></p></li>
<li><p><a class="reference internal" href="#scheduler" id="id15">Scheduler</a></p></li>
<li><p><a class="reference internal" href="#dependency-graph" id="id16">Dependency Graph</a></p></li>
<li><p><a class="reference internal" href="#instrmaps" id="id17">InstrMaps</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#debugging" id="id18">Debugging</a></p></li>
</ul>
</li>
</ul>
</nav>
<p>The Sandbox Vectorizer is a framework for building modular vectorization pipelines on top of <a class="reference internal" href="SandboxIR.html"><span class="doc std std-doc">Sandbox IR</span></a> transactional IR, with a focus on ease of development and testing.
The default pipeline currently implements a simple SLP-style bottom-up vectorization pipeline.</p>
<p>The transactional IR helps in several ways:</p>
<ul class="simple">
<li><p>It enables a modular design where:</p>
<ul>
<li><p>Each vectorization transformation/optimization can be implemented as a separate internal pass that uses actual IR as its input and output.</p></li>
<li><p>You can still make end-to-end profitability decisions (i.e., across multiple internal passes), even when the transformations are implemented as separate internal passes.</p></li>
<li><p>Each transformation/optimization internal pass can be tested in isolation with lit-tests, as opposed to end-to-end tests.</p></li>
</ul>
</li>
<li><p>It enables a simpler design by enabling each internal pass commit its state to the IR itself rather than updating helper data-structures that live across the pipeline.</p></li>
<li><p>Its extensive callback interface helps remove the burden of manually maintaining the vectorizer’s components while the IR is being modified.</p></li>
</ul>
<section id="usage">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Usage</a><a class="headerlink" href="#usage" title="Link to this heading">¶</a></h2>
<p>The Sandbox Vectorizer is currently under development and is not enabled by default.
So in order to use it you have to explicitly run the pass with <code class="docutils literal notranslate"><span class="pre">opt</span></code> like so:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>opt<span class="w"> </span>-p<span class="o">=</span>sandbox-vectorizer<span class="w"> </span>file.ll
</pre></div>
</div>
</section>
<section id="internal-pass-pipeline">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Internal Pass Pipeline</a><a class="headerlink" href="#internal-pass-pipeline" title="Link to this heading">¶</a></h2>
<p>The Sandbox Vectorizer is designed to be modular and as such it has its own internal pass-pipeline that operates on Sandbox IR.
Each vectorization phase is implemented as a separate internal pass that runs by the Sandbox Vectorizer’s internal pass manager.
The Sandbox Vectorizer pass itself is an LLVM Function pass.</p>
<p>The following figure shows the basic structure of the Sandbox Vectorizer LLVM Function pass.
The first component is the conversion of <code class="docutils literal notranslate"><span class="pre">LLVM</span> <span class="pre">IR</span> <span class="pre">to</span> <span class="pre">Sandbox</span> <span class="pre">IR</span></code> which converts the LLVM Function to a <code class="docutils literal notranslate"><span class="pre">sandboxir::Function</span></code>.
From this point on the pass operates on Sandbox IR.
The main entry point to the internal pass pipeline is the <code class="docutils literal notranslate"><span class="pre">Sandbox</span> <span class="pre">IR</span> <span class="pre">Function</span> <span class="pre">Pass</span> <span class="pre">Manger</span></code>, which runs all registered function passes.
The following figure lists only a single Sandbox IR function pass, the <code class="docutils literal notranslate"><span class="pre">Seed</span> <span class="pre">Collection</span> <span class="pre">Pass</span></code> which goes over the instructions in the function and collects vectorization candidates, like Stores to consecutive memory addresses, and forms a <a class="reference internal" href="#region">Region</a>.
The <code class="docutils literal notranslate"><span class="pre">Seed</span> <span class="pre">Collection</span> <span class="pre">Pass</span></code> itself contains its own Region pass pipeline, which in the following example contains a <code class="docutils literal notranslate"><span class="pre">Transaction</span> <span class="pre">Save</span></code> pass, a <code class="docutils literal notranslate"><span class="pre">Bottom-Up</span> <span class="pre">Vectorization</span></code> pass, a <code class="docutils literal notranslate"><span class="pre">Pack</span> <span class="pre">Reuse</span></code> pass and a <code class="docutils literal notranslate"><span class="pre">Transaction</span> <span class="pre">Accept/Revert</span></code> pass.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>┌────────────────────────────────── Sandbox Vectorizer LLVM Function Pass ─────────────────────────────┐
│                                                                                                      │
│ ┌───────┐ ┌────────────────────────── sandboxir::Function Pass Manager ────────────────────────────┐ │
│ │       │ │                                                                                        │ │
│ │       │ │ ┌────────────────────────────── Seed Collection Pass ──────────────────────────────┐   │ │
│ │       │ │ │                                                                                  │   │ │
│ │       │ │ │ ┌───────┐  For   ┌─────────────── sanboxir::Region Pass Manager ───────────────┐ │   │ │
│ │LLVM IR│ │ │ │Collect│  each  │ ┌───────────┐ ┌────────────────┐ ┌───────┐ ┌──────────────┐ │ │   │ │
│ │  to   │ │ │ │ Seeds │ Region │ │Transaction│ │   Bottom─Up    │ │ Pack  │ │ Transaction  │ │ │   │ │
│ │Sandbox│ │ │ │Create │ ─────&gt; │ │   Save    │ │ Vectorization  │ │ Reuse │ │Accept/Revert │ │ │   │ │
│ │  IR   │ │ │ │Regions│        │ └───────────┘ └────────────────┘ └───────┘ └──────────────┘ │ │   │ │
│ │       │ │ │ └───────┘        └─────────────────────────────────────────────────────────────┘ │   │ │
│ │       │ │ │                                                                                  │...│ │
│ │       │ │ └──────────────────────────────────────────────────────────────────────────────────┘   │ │
│ │       │ │                                                                                        │ │
│ └───────┘ └────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                      │
└──────────────────────────────────────────────────────────────────────────────────────────────────────┘
</pre></div>
</div>
<p>You can specify your own custom pipeline with the <code class="docutils literal notranslate"><span class="pre">-sbvec-passes=</span></code> argument to <code class="docutils literal notranslate"><span class="pre">opt</span></code>.
The pipeline shown above is equivalent to this:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>opt<span class="w"> </span>-p<span class="o">=</span>sandbox-vectorizer<span class="w"> </span>-sbvec-passes<span class="o">=</span><span class="s1">&#39;seed-collection&lt;tr-save,bottom-up-vec,pack-reuse,tr-accept&gt;&#39;</span><span class="w"> </span>file.ll
</pre></div>
</div>
<p>If the user does not define a pipeline, the Sandbox Vectorizer will run its default pass-pipeline, which is set in the constructor of the <code class="docutils literal notranslate"><span class="pre">SandboxVectorizerPass</span></code>.</p>
</section>
<section id="sandbox-vectorizer-passes">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Sandbox Vectorizer Passes</a><a class="headerlink" href="#sandbox-vectorizer-passes" title="Link to this heading">¶</a></h2>
<p>The passes in the vectorization pipeline can be found in <code class="docutils literal notranslate"><span class="pre">Transforms/Vectorize/SandboxVectorizer/Passes</span></code> and they are registered in <code class="docutils literal notranslate"><span class="pre">lib/Transforms/Vectorize/SandboxVectorizer/Passes/PassRegistry.def</span></code>.</p>
<p>There are two types of passes: <a class="reference internal" href="#transformation-passes">Transformation Passes</a> that do the actual vectorization-related transformations and optimizations, and <a class="reference internal" href="#helper-passes">Helper Passes</a> that are helping with things like managing the IR transactions, and test-specific things like building regions.</p>
<section id="transformation-passes">
<h3><a class="toc-backref" href="#id5" role="doc-backlink">Transformation Passes</a><a class="headerlink" href="#transformation-passes" title="Link to this heading">¶</a></h3>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Pass Name</strong></p></th>
<th class="head"><p><strong>File Name</strong></p></th>
<th class="head"><p><strong>Type</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">seed-collection</span></code></p></td>
<td><p>SeedCollection.h</p></td>
<td><p>Function</p></td>
<td><p>Collects the instructions to start vectorizing from, creates a region and runs the region-pass pipeline</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">bottom-up-vec</span></code></p></td>
<td><p>BottomUpVec.h</p></td>
<td><p>Region</p></td>
<td><p>An SLP-style bottom-up vectorizer. It can vectorize both scalars and vectors</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">pack-reuse</span></code></p></td>
<td><p>PackReuse.h</p></td>
<td><p>Region</p></td>
<td><p>A pass that de-duplicates packs</p></td>
</tr>
</tbody>
</table>
</section>
<section id="helper-passes">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">Helper Passes</a><a class="headerlink" href="#helper-passes" title="Link to this heading">¶</a></h3>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Pass Name</strong></p></th>
<th class="head"><p><strong>File Name</strong></p></th>
<th class="head"><p><strong>Type</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">tr-save</span></code></p></td>
<td><p>TransactionSave.h</p></td>
<td><p>Region</p></td>
<td><p>Creates a checkpoint of the IR (i.e., saves state)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">tr-accept</span></code></p></td>
<td><p>TransactionAlwaysAccept.h</p></td>
<td><p>Region</p></td>
<td><p>Unconditionally accepts the IR state</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">tr-revert</span></code></p></td>
<td><p>TransactionAlwaysRevert.h</p></td>
<td><p>Region</p></td>
<td><p>Unconditionally rejects the IR state</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">tr-accept-or-revert</span></code></p></td>
<td><p>TransactionAcceptOrRevert.h</p></td>
<td><p>Region</p></td>
<td><p>Checks cost model and either accepts or reverts the IR</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">null</span></code></p></td>
<td><p>NullPass.h</p></td>
<td><p>Region</p></td>
<td><p>A dummy test pass that just returns</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">print-region</span></code></p></td>
<td><p>PrintRegion.h</p></td>
<td><p>Region</p></td>
<td><p>A test pass that prints the region’s IR</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">print-instruction-count</span></code></p></td>
<td><p>PrintInstructionCount.h</p></td>
<td><p>Region</p></td>
<td><p>A test pass that counts instructions</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">regions-from-metadata</span></code></p></td>
<td><p>RegionsFromMetadata.h</p></td>
<td><p>Function</p></td>
<td><p>Builds regions from IR metadata and runs a pipeline of region passes for each one of them. Used in lit tests for testing region passes in isolation</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">regions-from-bbs</span></code></p></td>
<td><p>RegionsFromBBs.h</p></td>
<td><p>Function</p></td>
<td><p>Builds a region for each BB, adding all BB instructions into each region. Used in lit tests for stress-testing region passes in isolation</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="region">
<h2><a class="toc-backref" href="#id7" role="doc-backlink">Region</a><a class="headerlink" href="#region" title="Link to this heading">¶</a></h2>
<p>In a traditional compiler pass pipeline, transformations usually operate at a function level with function passes.
This introduces an issue in passes like the vectorizer that operate on small sections of a function (that we refer to as “Regions”) but apply a pipeline of transformations on each section horizontally, and evaluate profitability end-to-end on each region as shown below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span> Function
┌─────────┐    Transform    Transform  ...    Transform
│         │        A            B                 Z
│┌───────┐│    ┌───────┐    ┌───────┐         ┌───────┐     Evaluate
││Region1││ ─&gt; │       │ ─&gt; │       │  ... ─&gt; │       │   Profitability
│└───────┘│    └───────┘    └───────┘         └───────┘
│         │
│┌───────┐│    ┌───────┐    ┌───────┐         ┌───────┐     Evaluate
││Region2││ ─&gt; │       │ ─&gt; │       │  ... ─&gt; │       │   Profitability
│└───────┘│    └───────┘    └───────┘         └───────┘
│         │
│         │
└─────────┘
</pre></div>
</div>
<p>If transformations like <code class="docutils literal notranslate"><span class="pre">A</span></code>, <code class="docutils literal notranslate"><span class="pre">B</span></code>, etc. are implemented as function passes, then they will apply their transformations across the whole function, spanning multiple regions, as they have not been designed to stay within a region.
The problem is that profitability evaluation will average out the profitability across all regions within the function, leading to a sub-optimal outcome.</p>
<p>This is the problem that the “Region” structure is solving.
It provides a way of tagging the instructions within a Region with metadata and also provides the necessary APIs for iterating through the Region instructions and operating on them.</p>
<p>The Region allows us to implement the vectorization pipeline as a pipeline of Region passes, each one operating on a specific code section.
At the end of the region pass pipeline we can evaluate profitability across multiple region passes in the pipeline (if needed) but within a Region, and either accept or revert the transformations.</p>
<section id="adding-instructions-to-the-region">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Adding Instructions to the Region</a><a class="headerlink" href="#adding-instructions-to-the-region" title="Link to this heading">¶</a></h3>
<p>The Region grows automatically and is maintained transparently:
Whenever you create a new instruction it is automatically added to the Region, and whenever an instruction is deleted it gets removed from the Region.
The reasoning is that vectorization passes work: (i) by creating new vector instructions, (ii) by adding necessary packing/unpacking instructions, or (iii) by deleting the original instructions that got replaced by the vectorized ones.</p>
<p>Internally this is done with the help of the callback API of Sandbox IR.
The current Region gets notified that either an instruction got created or removed and the Region is maintained accordingly.</p>
</section>
<section id="region-example">
<h3><a class="toc-backref" href="#id9" role="doc-backlink">Region Example</a><a class="headerlink" href="#region-example" title="Link to this heading">¶</a></h3>
<p>The following example defines a Region (with <code class="docutils literal notranslate"><span class="pre">!0</span> <span class="pre">=</span> <span class="pre">distinct</span> <span class="pre">!{!&quot;sandboxregion&quot;}</span></code>), containing two instructions: <code class="docutils literal notranslate"><span class="pre">%i1</span> <span class="pre">=</span> <span class="pre">add</span> <span class="pre">i8</span> <span class="pre">%v,</span> <span class="pre">1</span></code> and <code class="docutils literal notranslate"><span class="pre">%i2</span> <span class="pre">=</span> <span class="pre">add</span> <span class="pre">i8</span> <span class="pre">%v,</span> <span class="pre">2</span></code> in no particular order.</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="k">define</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@region_example</span><span class="p">(</span><span class="kt">i8</span><span class="w"> </span><span class="nv">%v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="nv">%i0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="nv">%v</span><span class="p">,</span><span class="w"> </span><span class="m">0</span>
<span class="w">     </span><span class="nv">%i1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="nv">%v</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="nv">!sandboxvec</span><span class="w"> </span><span class="nv nv-Anonymous">!0</span>
<span class="w">     </span><span class="nv">%i2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="nv">%v</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="nv">!sandboxvec</span><span class="w"> </span><span class="nv nv-Anonymous">!0</span>
<span class="w">     </span><span class="k">ret</span><span class="w"> </span><span class="k">void</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nv nv-Anonymous">!0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="p">!{</span><span class="nv">!&quot;sandboxregion&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>The Region class API allows you to iterate through the region instructions like with a range loop:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">I</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Rgn</span><span class="p">)</span>
<span class="w">     </span><span class="c1">// Do something with `I`</span>
</pre></div>
</div>
</section>
<section id="region-auxiliary-vector">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">Region Auxiliary Vector</a><a class="headerlink" href="#region-auxiliary-vector" title="Link to this heading">¶</a></h3>
<p>On top of tagging instructions the Region has a second functionality: it also supports a way of defining an ordered list of instructions.
This helps passes communicate such instruction lists from one pass to another, if needed, in an explicit way that is encoded in IR metadata.
This removes the need for sharing helper data-structures across passes.
The end result is that you can fully describe such ordered list of instructions in IR and can reproduce the pass behavior using just IR as input, allowing you to test it with lit tests.</p>
<p>The Region API for the auxiliary vector is straightforward.
It provides the <code class="docutils literal notranslate"><span class="pre">getAux()</span></code> getter method that simply returns the auxiliary vector.</p>
<p>The auxiliary vector instructions are marked with <code class="docutils literal notranslate"><span class="pre">!sandboxaux</span></code> followed by an index, which in the following example are <code class="docutils literal notranslate"><span class="pre">!1</span></code>and <code class="docutils literal notranslate"><span class="pre">!2</span></code> which correspond to 0 and 1 respectively.
So the following example defines one region (region <code class="docutils literal notranslate"><span class="pre">!0</span></code>) containing all three <code class="docutils literal notranslate"><span class="pre">add</span></code> instructions, two of which belong to the auxiliary vector: <code class="docutils literal notranslate"><span class="pre">[%i1</span> <span class="pre">=</span> <span class="pre">add</span> <span class="pre">i8</span> <span class="pre">%v,</span> <span class="pre">1,</span> <span class="pre">%i2</span> <span class="pre">=</span> <span class="pre">add</span> <span class="pre">i8</span> <span class="pre">%v,</span> <span class="pre">2]</span></code>.</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="k">define</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="vg">@region_aux_example</span><span class="p">(</span><span class="kt">i8</span><span class="w"> </span><span class="nv">%v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="nv">%i0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="nv">%v</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="w">  </span><span class="nv">!sandboxvec</span><span class="w"> </span><span class="nv nv-Anonymous">!0</span>
<span class="w">     </span><span class="nv">%i1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="nv">%v</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="nv">!sandboxvec</span><span class="w"> </span><span class="nv nv-Anonymous">!0</span><span class="p">,</span><span class="w"> </span><span class="nv">!sandboxaux</span><span class="w"> </span><span class="nv nv-Anonymous">!1</span>
<span class="w">     </span><span class="nv">%i2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="nv">%v</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="nv">!sandboxvec</span><span class="w"> </span><span class="nv nv-Anonymous">!0</span><span class="p">,</span><span class="w"> </span><span class="nv">!sandboxaux</span><span class="w"> </span><span class="nv nv-Anonymous">!2</span>
<span class="w">     </span><span class="k">ret</span><span class="w"> </span><span class="k">void</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="nv nv-Anonymous">!0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="p">!{</span><span class="nv">!&quot;sandboxregion&quot;</span><span class="p">}</span>
<span class="w">   </span><span class="nv nv-Anonymous">!1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">!{</span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span><span class="p">}</span>
<span class="w">   </span><span class="nv nv-Anonymous">!2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">!{</span><span class="kt">i32</span><span class="w"> </span><span class="m">1</span><span class="p">}</span>
</pre></div>
</div>
<p>The auxiliary vector is currently used by the Seed Collection pass to communicate a group of seed instructions to the Bottom-Up-Vectorizer pass.</p>
</section>
</section>
<section id="testing-sandbox-vectorizer-passes-in-isolation">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">Testing Sandbox Vectorizer Passes In Isolation</a><a class="headerlink" href="#testing-sandbox-vectorizer-passes-in-isolation" title="Link to this heading">¶</a></h2>
<p>One of the great things about the Sandbox Vectorizer is that it allows you to test each internal pass in isolation with lit-tests.</p>
<p>Testing Function passes is straightforward, just run <code class="docutils literal notranslate"><span class="pre">FUNCTION_PASS</span></code> in isolation with <code class="docutils literal notranslate"><span class="pre">-sbvec-passes</span></code>, like so:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>opt<span class="w"> </span>-p<span class="o">=</span>sandbox-vectorizer<span class="w"> </span>-sbvec-passes<span class="o">=</span><span class="s1">&#39;FUNCTION_PASS&#39;</span>
</pre></div>
</div>
<p>Testing <a class="reference internal" href="#region">Region</a> passes is also possible, since a Region can be defined with IR using metadata, as described in <a class="reference internal" href="#region-example">Region Example</a>.
We need to run the <code class="docutils literal notranslate"><span class="pre">regions-from-metadata</span></code> helper pass before the Region pass to be tested.
This helper pass parses the IR metadata looking for Region metadata, then it creates the corresponding Regions and finally runs a Region pass pipeline on each Region.</p>
<p>So here is what we need to do for a working lit-test of a Region pass:</p>
<ol class="arabic simple">
<li><p>Define the region with metadata as explained in <a class="reference internal" href="#region-example">Region Example</a>.</p></li>
<li><p>Define the pass pipeline which should include the following passes:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">regions-from-metadata</span></code> pass that will form a region and will build a Region pass-manager.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">REGION_PASS</span></code> being tested enclosed in <code class="docutils literal notranslate"><span class="pre">&lt;</span> <span class="pre">&gt;</span></code>, as the only pass in the region pass pipeline owned by the <code class="docutils literal notranslate"><span class="pre">regions-from-metadata</span></code> pass.</p></li>
</ul>
</li>
</ol>
<p>So overall the pipeline looks like:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>opt<span class="w"> </span>-p<span class="o">=</span>sandbox-vectorizer<span class="w"> </span>-sbvec-passes<span class="o">=</span><span class="s1">&#39;regions-from-metadata&lt;REGION_PASS&gt;&#39;</span>
</pre></div>
</div>
<p>The reason for enclosing the pass in <code class="docutils literal notranslate"><span class="pre">&lt;</span> <span class="pre">&gt;</span></code> is that <code class="docutils literal notranslate"><span class="pre">regions-from-metadata</span></code> is a Region pass manager function pass that accepts string arguments within <code class="docutils literal notranslate"><span class="pre">&lt;</span> <span class="pre">&gt;</span></code>.
It will parse the string argument, looking for a comma-separated list of Region pass names, and will populate the pipeline with these passes.
So in this case <code class="docutils literal notranslate"><span class="pre">REGION_PASS</span></code> is the only pass name found, so it will be the only pass added to the region pass pipeline.</p>
<p>For example, <code class="docutils literal notranslate"><span class="pre">'regions-from-metadata&lt;region_pass1,region_pass2&gt;'</span></code> would create regions from metadata, and for each one of them it would run the pipeline: <code class="docutils literal notranslate"><span class="pre">region_pass1</span></code> followed by <code class="docutils literal notranslate"><span class="pre">region_pass2</span></code>.</p>
</section>
<section id="stress-testing-a-region-pass-in-isolation">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">Stress-testing a Region Pass in Isolation</a><a class="headerlink" href="#stress-testing-a-region-pass-in-isolation" title="Link to this heading">¶</a></h2>
<p>A region pass can be stress-tested in isolation using with BB-sized Regions, using the <code class="docutils literal notranslate"><span class="pre">regions-from-bbs</span></code> helper pass.
The pass will go through the BBs in the function, create a region including all BB instructions for each one of them.
Then it will run the region pass pipeline for each BB-sized Region.</p>
<p>For example:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>opt<span class="w"> </span>-p<span class="o">=</span>sandbox-vectorizer<span class="w"> </span>-sbvec-passes<span class="o">=</span><span class="s1">&#39;regions-from-bbs&lt;REGION_PASS&gt;&#39;</span>
</pre></div>
</div>
</section>
<section id="components">
<h2><a class="toc-backref" href="#id13" role="doc-backlink">Components</a><a class="headerlink" href="#components" title="Link to this heading">¶</a></h2>
<p>The Sandbox Vectorizer implements several components that are used by one or more internal passes.
These components are designed as standalone components, which makes them easy to use when needed.
They are the building blocks for the vectorization passes, providing things like vectorization legality checks.</p>
<section id="legality-analysis">
<h3><a class="toc-backref" href="#id14" role="doc-backlink">Legality Analysis</a><a class="headerlink" href="#legality-analysis" title="Link to this heading">¶</a></h3>
<p>This is the main entry point for vectorization legality checks.
It checks if a bundle of instructions is legal to vectorize and returns how the vectorizer should generate code for it, i.e., whether it should trivially widen it, whether it should reuse an existing vector, whether it should pack scalars into vectors and so on.
Legality testing includes tests like checking the instruction types, the opcodes etc. but it also checks for dependency violations by querying the <a class="reference internal" href="#scheduler">Scheduler</a>.</p>
<p>The main API function is <code class="docutils literal notranslate"><span class="pre">LegalityAnalysis::canVectorize()</span></code>.</p>
</section>
<section id="scheduler">
<h3><a class="toc-backref" href="#id15" role="doc-backlink">Scheduler</a><a class="headerlink" href="#scheduler" title="Link to this heading">¶</a></h3>
<p>This component is an lazy list-scheduler that relies on a <a class="reference internal" href="#dependency-graph">Dependency Graph (DAG)</a> for representing the dependencies.
It is “lazy” in the sense that it does not operate on a whole BB, but instead only on the instructions spanning the bundle we are attempting to schedule.
The main interface to the scheduler is <code class="docutils literal notranslate"><span class="pre">Scheduler::trySchedule()</span></code>.</p>
<p>Please note that the current implementation does not use a separate “staging” instruction list for the scheduled instructions.
Instead it physically moves the instructions in the IR chain, which is fine since we are working with a transactional IR.
This is not a requirement though for correct operation.
A more traditional scheduler with a separate instruction list would also work fine.</p>
</section>
<section id="dependency-graph">
<h3><a class="toc-backref" href="#id16" role="doc-backlink">Dependency Graph</a><a class="headerlink" href="#dependency-graph" title="Link to this heading">¶</a></h3>
<p>This is a lazily-built Directed Acyclic Graph (DAG) that encodes both memory and def-use dependencies.
Each node of the graph points to a Sandbox IR Instruction.
An edge between two nodes <code class="docutils literal notranslate"><span class="pre">A-&gt;B</span></code> suggests that <code class="docutils literal notranslate"><span class="pre">A</span></code>’s instruction should come before <code class="docutils literal notranslate"><span class="pre">B</span></code>’s instruction in the program.
The DAG uses <a class="reference internal" href="AliasAnalysis.html"><span class="doc std std-doc">Alias Analysis</span></a> for finding the memory dependencies.
Note that even though the DAG Node provides an API for iterating over both memory and use-def dependencies, it actually relies on the LLVM IR use-def edges internally and won’t replicate them to save memory.</p>
<p>The graph is built lazily, meaning that it won’t be built for the whole BB in one go.
Instead it will span only the range of instruction needed by the scheduler.
As we keep scheduling more instructions, the graph will grow on-demand following the needs of the scheduler.
The main interface function for the Dependency Graph is <code class="docutils literal notranslate"><span class="pre">DependencyGraph::extend()</span></code>.</p>
</section>
<section id="instrmaps">
<h3><a class="toc-backref" href="#id17" role="doc-backlink">InstrMaps</a><a class="headerlink" href="#instrmaps" title="Link to this heading">¶</a></h3>
<p>Instruction Maps is a helper data structure that maintains a mapping between the original (often scalar) instructions and their corresponding vector instructions and the reverse.
It is used by the <code class="docutils literal notranslate"><span class="pre">bottom-up-vec</span></code> region pass for tracing vector instructions back to the original instructions and the reverse.</p>
</section>
</section>
<section id="debugging">
<h2><a class="toc-backref" href="#id18" role="doc-backlink">Debugging</a><a class="headerlink" href="#debugging" title="Link to this heading">¶</a></h2>
<p>There are a couple of useful <code class="docutils literal notranslate"><span class="pre">cl::opt</span></code> options for debugging the vectorizer, that are particularly useful for bisection debugging:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Option</strong></p></th>
<th class="head"><p><strong>Description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">-sbvec-allow-files=&lt;regex&gt;</span></code></p></td>
<td><p>Enables the Sandbox Vectorizer as a whole only for source files matching the comma-separated list of regular expressions.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">-sbvec-passes=&lt;pass-pipeline&gt;</span></code></p></td>
<td><p>Allows you to change the internal pass pipeline and skip any potentially broken passes.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">-sbvec-stop-at=&lt;num&gt;</span></code></p></td>
<td><p>Will stop invoking the bottom-up-vectorizer if the invocation count is greater or equal to <code class="docutils literal notranslate"><span class="pre">&lt;num&gt;</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">-sbvec-stop-bndl=&lt;num&gt;</span></code></p></td>
<td><p>Limits the vectorization depth of the bottom-up vectorizer to <code class="docutils literal notranslate"><span class="pre">&lt;num&gt;</span></code>. This means that the vectorizer will emit a pack and stop vectorizing further.</p></td>
</tr>
</tbody>
</table>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="WritingAnLLVMPass.html" title="Writing an LLVM Pass (legacy PM version)"
             >next</a> |</li>
        <li class="right" >
          <a href="VectorizationPlan.html" title="Vectorization Plan"
             >previous</a> |</li>
  <li><a href="https://llvm.org/">LLVM Home</a>&nbsp;|&nbsp;</li>
  <li><a href="index.html">Documentation</a>&raquo;</li>

          <li class="nav-item nav-item-1"><a href="UserGuides.html" >User Guides</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="Vectorizers.html" >Auto-Vectorization in LLVM</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">The Sandbox Vectorizer</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2003-2025, LLVM Project.
      Last updated on 2025-09-23.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>