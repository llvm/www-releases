<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>2.6. Cross Translation Unit (CTU) Analysis &#8212; Clang 21.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="../../_static/haiku.css?v=e491ac2d" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=eafc0fe6" />
    <script src="../../_static/documentation_options.js?v=c54a4614"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="2.7. Taint Analysis Configuration" href="TaintAnalysisConfiguration.html" />
    <link rel="prev" title="2.5. Filing Bugs and Feature Requests" href="FilingBugs.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../index.html">
          <span>Clang 21.1.0 documentation</span></a></h1>
        <h2 class="heading"><span>2.6. Cross Translation Unit (CTU) Analysis</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="FilingBugs.html"><span class="section-number">2.5. </span>Filing Bugs and Feature Requests</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="TaintAnalysisConfiguration.html"><span class="section-number">2.7. </span>Taint Analysis Configuration</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="cross-translation-unit-ctu-analysis">
<h1><span class="section-number">2.6. </span>Cross Translation Unit (CTU) Analysis<a class="headerlink" href="#cross-translation-unit-ctu-analysis" title="Link to this heading">¶</a></h1>
<p>Normally, static analysis works in the boundary of one translation unit (TU).
However, with additional steps and configuration we can enable the analysis to inline the definition of a function from
another TU.</p>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id6">Overview</a></p></li>
<li><p><a class="reference internal" href="#pch-based-analysis" id="id7">PCH-based analysis</a></p>
<ul>
<li><p><a class="reference internal" href="#manual-ctu-analysis" id="id8">Manual CTU Analysis</a></p></li>
<li><p><a class="reference internal" href="#automated-ctu-analysis-with-codechecker" id="id9">Automated CTU Analysis with CodeChecker</a></p></li>
<li><p><a class="reference internal" href="#automated-ctu-analysis-with-scan-build-py-don-t-do-it" id="id10">Automated CTU Analysis with scan-build-py (don’t do it)</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#on-demand-analysis" id="id11">On-demand analysis</a></p>
<ul>
<li><p><a class="reference internal" href="#id2" id="id12">Manual CTU Analysis</a></p></li>
<li><p><a class="reference internal" href="#id3" id="id13">Automated CTU Analysis with CodeChecker</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id14">Automated CTU Analysis with scan-build-py (don’t do it)</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="overview">
<h2><a class="toc-backref" href="#id6" role="doc-backlink"><span class="section-number">2.6.1. </span>Overview</a><a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>CTU analysis can be used in a variety of ways. The importing of external TU definitions can work with pre-dumped PCH
files or generating the necessary AST structure on-demand, during the analysis of the main TU. Driving the static
analysis can also be implemented in multiple ways. The most direct way is to specify the necessary commandline options
of the Clang frontend manually (and generate the prerequisite dependencies of the specific import method by hand). This
process can be automated by other tools, like <a class="reference external" href="https://github.com/Ericsson/codechecker">CodeChecker</a> and scan-build-py
(preference for the former).</p>
</section>
<section id="pch-based-analysis">
<h2><a class="toc-backref" href="#id7" role="doc-backlink"><span class="section-number">2.6.2. </span>PCH-based analysis</a><a class="headerlink" href="#pch-based-analysis" title="Link to this heading">¶</a></h2>
<p>The analysis needs the PCH dumps of all the translations units used in the project.
These can be generated by the Clang Frontend itself, and must be arranged in a specific way in the filesystem.
The index, which maps symbols’ USR names to PCH dumps containing them must also be generated by the
<cite>clang-extdef-mapping</cite>. Entries in the index <em>must</em> have an <cite>.ast</cite> suffix if the goal
is to use PCH-based analysis, as the lack of that extension signals that the entry is to be used as a source-file, and parsed on-demand.
This tool uses a <a class="reference internal" href="../../JSONCompilationDatabase.html"><span class="doc">compilation database</span></a> to
determine the compilation flags used.
The analysis invocation must be provided with the directory which contains the dumps and the mapping files.</p>
<section id="manual-ctu-analysis">
<h3><a class="toc-backref" href="#id8" role="doc-backlink"><span class="section-number">2.6.2.1. </span>Manual CTU Analysis</a><a class="headerlink" href="#manual-ctu-analysis" title="Link to this heading">¶</a></h3>
<p>Let’s consider these source files in our minimal example:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// main.cpp</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">foo</span><span class="p">();</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">foo</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// foo.cpp</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And a compilation database:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>
<span class="w">  </span><span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;directory&quot;</span>:<span class="w"> </span><span class="s2">&quot;/path/to/your/project&quot;</span>,
<span class="w">    </span><span class="s2">&quot;command&quot;</span>:<span class="w"> </span><span class="s2">&quot;clang++ -c foo.cpp -o foo.o&quot;</span>,
<span class="w">    </span><span class="s2">&quot;file&quot;</span>:<span class="w"> </span><span class="s2">&quot;foo.cpp&quot;</span>
<span class="w">  </span><span class="o">}</span>,
<span class="w">  </span><span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;directory&quot;</span>:<span class="w"> </span><span class="s2">&quot;/path/to/your/project&quot;</span>,
<span class="w">    </span><span class="s2">&quot;command&quot;</span>:<span class="w"> </span><span class="s2">&quot;clang++ -c main.cpp -o main.o&quot;</span>,
<span class="w">    </span><span class="s2">&quot;file&quot;</span>:<span class="w"> </span><span class="s2">&quot;main.cpp&quot;</span>
<span class="w">  </span><span class="o">}</span>
<span class="o">]</span>
</pre></div>
</div>
<p>We’d like to analyze <cite>main.cpp</cite> and discover the division by zero bug.
In order to be able to inline the definition of <cite>foo</cite> from <cite>foo.cpp</cite> first we have to generate the <cite>AST</cite> (or <cite>PCH</cite>) file
of <cite>foo.cpp</cite>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nb">pwd</span><span class="w"> </span>$<span class="w"> </span>/path/to/your/project
$<span class="w"> </span>clang++<span class="w"> </span>-emit-ast<span class="w"> </span>-o<span class="w"> </span>foo.cpp.ast<span class="w"> </span>foo.cpp
$<span class="w"> </span><span class="c1"># Check that the .ast file is generated:</span>
$<span class="w"> </span>ls
compile_commands.json<span class="w">  </span>foo.cpp.ast<span class="w">  </span>foo.cpp<span class="w">  </span>main.cpp
$
</pre></div>
</div>
<p>The next step is to create a CTU index file which holds the <cite>USR</cite> name and location of external definitions in the
source files in format <cite>&lt;USR-Length&gt;:&lt;USR&gt; &lt;File-Path&gt;</cite>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>clang-extdef-mapping<span class="w"> </span>-p<span class="w"> </span>.<span class="w"> </span>foo.cpp
<span class="m">9</span>:c:@F@foo#<span class="w"> </span>/path/to/your/project/foo.cpp
$<span class="w"> </span>clang-extdef-mapping<span class="w"> </span>-p<span class="w"> </span>.<span class="w"> </span>foo.cpp<span class="w"> </span>&gt;<span class="w"> </span>externalDefMap.txt
</pre></div>
</div>
<p>We have to modify <cite>externalDefMap.txt</cite> to contain the name of the <cite>.ast</cite> files instead of the source files:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;s/.cpp/.cpp.ast/g&quot;</span><span class="w"> </span>externalDefMap.txt
</pre></div>
</div>
<p>We still have to further modify the <cite>externalDefMap.txt</cite> file to contain relative paths:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sed<span class="w"> </span>-i<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;s|</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">/||g&quot;</span><span class="w"> </span>externalDefMap.txt
</pre></div>
</div>
<p>Now everything is available for the CTU analysis.
We have to feed Clang with CTU specific extra arguments:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nb">pwd</span>
/path/to/your/project
$<span class="w"> </span>clang++<span class="w"> </span>--analyze<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-Xclang<span class="w"> </span>-analyzer-config<span class="w"> </span>-Xclang<span class="w"> </span>experimental-enable-naive-ctu-analysis<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-Xclang<span class="w"> </span>-analyzer-config<span class="w"> </span>-Xclang<span class="w"> </span>ctu-dir<span class="o">=</span>.<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-Xclang<span class="w"> </span>-analyzer-output<span class="o">=</span>plist-multi-file<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>main.cpp
main.cpp:5:12:<span class="w"> </span>warning:<span class="w"> </span>Division<span class="w"> </span>by<span class="w"> </span>zero
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="m">3</span><span class="w"> </span>/<span class="w"> </span>foo<span class="o">()</span><span class="p">;</span>
<span class="w">         </span>~~^~~~~~~
<span class="m">1</span><span class="w"> </span>warning<span class="w"> </span>generated.
$<span class="w"> </span><span class="c1"># The plist file with the result is generated.</span>
$<span class="w"> </span>ls<span class="w"> </span>-F
compile_commands.json<span class="w">  </span>externalDefMap.txt<span class="w">  </span>foo.ast<span class="w">  </span>foo.cpp<span class="w">  </span>foo.cpp.ast<span class="w">  </span>main.cpp<span class="w">  </span>main.plist
$
</pre></div>
</div>
<p>This manual procedure is error-prone and not scalable, therefore to analyze real projects it is recommended to use
<cite>CodeChecker</cite> or <cite>scan-build-py</cite>.</p>
</section>
<section id="automated-ctu-analysis-with-codechecker">
<h3><a class="toc-backref" href="#id9" role="doc-backlink"><span class="section-number">2.6.2.2. </span>Automated CTU Analysis with CodeChecker</a><a class="headerlink" href="#automated-ctu-analysis-with-codechecker" title="Link to this heading">¶</a></h3>
<p>The <a class="reference external" href="https://github.com/Ericsson/codechecker">CodeChecker</a> project fully supports automated CTU analysis with Clang.
Once we have set up the <cite>PATH</cite> environment variable and we activated the python <cite>venv</cite> then it is all it takes:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>CodeChecker<span class="w"> </span>analyze<span class="w"> </span>--ctu<span class="w"> </span>compile_commands.json<span class="w"> </span>-o<span class="w"> </span>reports
$<span class="w"> </span>ls<span class="w"> </span>-F
compile_commands.json<span class="w">  </span>foo.cpp<span class="w">  </span>foo.cpp.ast<span class="w">  </span>main.cpp<span class="w">  </span>reports/
$<span class="w"> </span>tree<span class="w"> </span>reports
reports
├──<span class="w"> </span>compile_cmd.json
├──<span class="w"> </span>compiler_info.json
├──<span class="w"> </span>foo.cpp_53f6fbf7ab7ec9931301524b551959e2.plist
├──<span class="w"> </span>main.cpp_23db3d8df52ff0812e6e5a03071c8337.plist
├──<span class="w"> </span>metadata.json
└──<span class="w"> </span>unique_compile_commands.json

<span class="m">0</span><span class="w"> </span>directories,<span class="w"> </span><span class="m">6</span><span class="w"> </span>files
$
</pre></div>
</div>
<p>The <cite>plist</cite> files contain the results of the analysis, which may be viewed with the regular analysis tools.
E.g. one may use <cite>CodeChecker parse</cite> to view the results in command line:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>CodeChecker<span class="w"> </span>parse<span class="w"> </span>reports
<span class="o">[</span>HIGH<span class="o">]</span><span class="w"> </span>/home/egbomrt/ctu_mini_raw_project/main.cpp:5:12:<span class="w"> </span>Division<span class="w"> </span>by<span class="w"> </span>zero<span class="w"> </span><span class="o">[</span>core.DivideZero<span class="o">]</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="m">3</span><span class="w"> </span>/<span class="w"> </span>foo<span class="o">()</span><span class="p">;</span>
<span class="w">           </span>^

Found<span class="w"> </span><span class="m">1</span><span class="w"> </span>defect<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>main.cpp


----<span class="o">====</span><span class="w"> </span><span class="nv">Summary</span><span class="w"> </span><span class="o">====</span>----
-----------------------
Filename<span class="w"> </span><span class="p">|</span><span class="w"> </span>Report<span class="w"> </span>count
-----------------------
main.cpp<span class="w"> </span><span class="p">|</span><span class="w">            </span><span class="m">1</span>
-----------------------
-----------------------
Severity<span class="w"> </span><span class="p">|</span><span class="w"> </span>Report<span class="w"> </span>count
-----------------------
HIGH<span class="w">     </span><span class="p">|</span><span class="w">            </span><span class="m">1</span>
-----------------------
----<span class="o">=================</span>----
Total<span class="w"> </span>number<span class="w"> </span>of<span class="w"> </span>reports:<span class="w"> </span><span class="m">1</span>
----<span class="o">=================</span>----
</pre></div>
</div>
<p>Or we can use <cite>CodeChecker parse -e html</cite> to export the results into HTML format:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>CodeChecker<span class="w"> </span>parse<span class="w"> </span>-e<span class="w"> </span>html<span class="w"> </span>-o<span class="w"> </span>html_out<span class="w"> </span>reports
$<span class="w"> </span>firefox<span class="w"> </span>html_out/index.html
</pre></div>
</div>
</section>
<section id="automated-ctu-analysis-with-scan-build-py-don-t-do-it">
<h3><a class="toc-backref" href="#id10" role="doc-backlink"><span class="section-number">2.6.2.3. </span>Automated CTU Analysis with scan-build-py (don’t do it)</a><a class="headerlink" href="#automated-ctu-analysis-with-scan-build-py-don-t-do-it" title="Link to this heading">¶</a></h3>
<p>We actively develop CTU with CodeChecker as the driver for this feature, <cite>scan-build-py</cite> is not actively developed for CTU.
<cite>scan-build-py</cite> has various errors and issues, expect it to work only with the very basic projects only.</p>
<p>Example usage of scan-build-py:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>/your/path/to/llvm-project/clang/tools/scan-build-py/bin/analyze-build<span class="w"> </span>--ctu
analyze-build:<span class="w"> </span>Run<span class="w"> </span><span class="s1">&#39;scan-view /tmp/scan-build-2019-07-17-17-53-33-810365-7fqgWk&#39;</span><span class="w"> </span>to<span class="w"> </span>examine<span class="w"> </span>bug<span class="w"> </span>reports.
$<span class="w"> </span>/your/path/to/llvm-project/clang/tools/scan-view/bin/scan-view<span class="w"> </span>/tmp/scan-build-2019-07-17-17-53-33-810365-7fqgWk
Starting<span class="w"> </span>scan-view<span class="w"> </span>at:<span class="w"> </span>http://127.0.0.1:8181
<span class="w">  </span>Use<span class="w"> </span>Ctrl-C<span class="w"> </span>to<span class="w"> </span>exit.
<span class="o">[</span><span class="m">6336</span>:6431:0717/175357.633914:ERROR:browser_process_sub_thread.cc<span class="o">(</span><span class="m">209</span><span class="o">)]</span><span class="w"> </span>Waited<span class="w"> </span><span class="m">5</span><span class="w"> </span>ms<span class="w"> </span><span class="k">for</span><span class="w"> </span>network<span class="w"> </span>service
Opening<span class="w"> </span><span class="k">in</span><span class="w"> </span>existing<span class="w"> </span>browser<span class="w"> </span>session.
^C
$
</pre></div>
</div>
</section>
</section>
<section id="on-demand-analysis">
<span id="ctu-on-demand"></span><h2><a class="toc-backref" href="#id11" role="doc-backlink"><span class="section-number">2.6.3. </span>On-demand analysis</a><a class="headerlink" href="#on-demand-analysis" title="Link to this heading">¶</a></h2>
<p>The analysis produces the necessary AST structure of external TUs during analysis. This requires the
exact compiler invocations for each TU, which can be generated by hand, or by tools driving the analyzer.
The compiler invocation is a shell command that could be used to compile the TU-s main source file.
The mapping from absolute source file paths of a TU to lists of compilation command segments used to
compile said TU are given in YAML format referred to as <cite>invocation list</cite>, and must be passed as an
analyzer-config argument.
The index, which maps function USR names to source files containing them must also be generated by the
<cite>clang-extdef-mapping</cite>. Entries in the index must <em>not</em> have an <cite>.ast</cite> suffix if the goal
is to use On-demand analysis, as that extension signals that the entry is to be used as an PCH-dump.
The mapping of external definitions implicitly uses a
<a class="reference internal" href="../../JSONCompilationDatabase.html"><span class="doc">compilation database</span></a> to determine the compilation flags used.
The analysis invocation must be provided with the directory which contains the mapping
files, and the <cite>invocation list</cite> which is used to determine compiler flags.</p>
<section id="id2">
<h3><a class="toc-backref" href="#id12" role="doc-backlink"><span class="section-number">2.6.3.1. </span>Manual CTU Analysis</a><a class="headerlink" href="#id2" title="Link to this heading">¶</a></h3>
<p>Let’s consider these source files in our minimal example:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// main.cpp</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">foo</span><span class="p">();</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">foo</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// foo.cpp</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">foo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The compilation database:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>
<span class="w">  </span><span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;directory&quot;</span>:<span class="w"> </span><span class="s2">&quot;/path/to/your/project&quot;</span>,
<span class="w">    </span><span class="s2">&quot;command&quot;</span>:<span class="w"> </span><span class="s2">&quot;clang++ -c foo.cpp -o foo.o&quot;</span>,
<span class="w">    </span><span class="s2">&quot;file&quot;</span>:<span class="w"> </span><span class="s2">&quot;foo.cpp&quot;</span>
<span class="w">  </span><span class="o">}</span>,
<span class="w">  </span><span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;directory&quot;</span>:<span class="w"> </span><span class="s2">&quot;/path/to/your/project&quot;</span>,
<span class="w">    </span><span class="s2">&quot;command&quot;</span>:<span class="w"> </span><span class="s2">&quot;clang++ -c main.cpp -o main.o&quot;</span>,
<span class="w">    </span><span class="s2">&quot;file&quot;</span>:<span class="w"> </span><span class="s2">&quot;main.cpp&quot;</span>
<span class="w">  </span><span class="o">}</span>
<span class="o">]</span>
</pre></div>
</div>
<p>The <cite>invocation list</cite>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;/path/to/your/project/foo.cpp&quot;</span>:
<span class="w">  </span>-<span class="w"> </span><span class="s2">&quot;clang++&quot;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s2">&quot;-c&quot;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s2">&quot;/path/to/your/project/foo.cpp&quot;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s2">&quot;-o&quot;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s2">&quot;/path/to/your/project/foo.o&quot;</span>

<span class="s2">&quot;/path/to/your/project/main.cpp&quot;</span>:
<span class="w">  </span>-<span class="w"> </span><span class="s2">&quot;clang++&quot;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s2">&quot;-c&quot;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s2">&quot;/path/to/your/project/main.cpp&quot;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s2">&quot;-o&quot;</span>
<span class="w">  </span>-<span class="w"> </span><span class="s2">&quot;/path/to/your/project/main.o&quot;</span>
</pre></div>
</div>
<p>We’d like to analyze <cite>main.cpp</cite> and discover the division by zero bug.
As we are using On-demand mode, we only need to create a CTU index file which holds the <cite>USR</cite> name and location of
external definitions in the source files in format <cite>&lt;USR-Length&gt;:&lt;USR&gt; &lt;File-Path&gt;</cite>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>clang-extdef-mapping<span class="w"> </span>-p<span class="w"> </span>.<span class="w"> </span>foo.cpp
<span class="m">9</span>:c:@F@foo#<span class="w"> </span>/path/to/your/project/foo.cpp
$<span class="w"> </span>clang-extdef-mapping<span class="w"> </span>-p<span class="w"> </span>.<span class="w"> </span>foo.cpp<span class="w"> </span>&gt;<span class="w"> </span>externalDefMap.txt
</pre></div>
</div>
<p>Now everything is available for the CTU analysis.
We have to feed Clang with CTU specific extra arguments:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nb">pwd</span>
/path/to/your/project
$<span class="w"> </span>clang++<span class="w"> </span>--analyze<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-Xclang<span class="w"> </span>-analyzer-config<span class="w"> </span>-Xclang<span class="w"> </span>experimental-enable-naive-ctu-analysis<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-Xclang<span class="w"> </span>-analyzer-config<span class="w"> </span>-Xclang<span class="w"> </span>ctu-dir<span class="o">=</span>.<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-Xclang<span class="w"> </span>-analyzer-config<span class="w"> </span>-Xclang<span class="w"> </span>ctu-invocation-list<span class="o">=</span>invocations.yaml<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>-Xclang<span class="w"> </span>-analyzer-output<span class="o">=</span>plist-multi-file<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>main.cpp
main.cpp:5:12:<span class="w"> </span>warning:<span class="w"> </span>Division<span class="w"> </span>by<span class="w"> </span>zero
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="m">3</span><span class="w"> </span>/<span class="w"> </span>foo<span class="o">()</span><span class="p">;</span>
<span class="w">         </span>~~^~~~~~~
<span class="m">1</span><span class="w"> </span>warning<span class="w"> </span>generated.
$<span class="w"> </span><span class="c1"># The plist file with the result is generated.</span>
$<span class="w"> </span>ls<span class="w"> </span>-F
compile_commands.json<span class="w">  </span>externalDefMap.txt<span class="w">  </span>foo.cpp<span class="w">  </span>main.cpp<span class="w">  </span>main.plist
$
</pre></div>
</div>
<p>This manual procedure is error-prone and not scalable, therefore to analyze real projects it is recommended to use
<cite>CodeChecker</cite> or <cite>scan-build-py</cite>.</p>
</section>
<section id="id3">
<h3><a class="toc-backref" href="#id13" role="doc-backlink"><span class="section-number">2.6.3.2. </span>Automated CTU Analysis with CodeChecker</a><a class="headerlink" href="#id3" title="Link to this heading">¶</a></h3>
<p>The <a class="reference external" href="https://github.com/Ericsson/codechecker">CodeChecker</a> project fully supports automated CTU analysis with Clang.
Once we have set up the <cite>PATH</cite> environment variable and we activated the python <cite>venv</cite> then it is all it takes:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>CodeChecker<span class="w"> </span>analyze<span class="w"> </span>--ctu<span class="w"> </span>--ctu-ast-loading-mode<span class="w"> </span>on-demand<span class="w"> </span>compile_commands.json<span class="w"> </span>-o<span class="w"> </span>reports
$<span class="w"> </span>ls<span class="w"> </span>-F
compile_commands.json<span class="w">  </span>foo.cpp<span class="w"> </span>main.cpp<span class="w">  </span>reports/
$<span class="w"> </span>tree<span class="w"> </span>reports
reports
├──<span class="w"> </span>compile_cmd.json
├──<span class="w"> </span>compiler_info.json
├──<span class="w"> </span>foo.cpp_53f6fbf7ab7ec9931301524b551959e2.plist
├──<span class="w"> </span>main.cpp_23db3d8df52ff0812e6e5a03071c8337.plist
├──<span class="w"> </span>metadata.json
└──<span class="w"> </span>unique_compile_commands.json

<span class="m">0</span><span class="w"> </span>directories,<span class="w"> </span><span class="m">6</span><span class="w"> </span>files
$
</pre></div>
</div>
<p>The <cite>plist</cite> files contain the results of the analysis, which may be viewed with the regular analysis tools.
E.g. one may use <cite>CodeChecker parse</cite> to view the results in command line:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>CodeChecker<span class="w"> </span>parse<span class="w"> </span>reports
<span class="o">[</span>HIGH<span class="o">]</span><span class="w"> </span>/home/egbomrt/ctu_mini_raw_project/main.cpp:5:12:<span class="w"> </span>Division<span class="w"> </span>by<span class="w"> </span>zero<span class="w"> </span><span class="o">[</span>core.DivideZero<span class="o">]</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="m">3</span><span class="w"> </span>/<span class="w"> </span>foo<span class="o">()</span><span class="p">;</span>
<span class="w">           </span>^

Found<span class="w"> </span><span class="m">1</span><span class="w"> </span>defect<span class="o">(</span>s<span class="o">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span>main.cpp


----<span class="o">====</span><span class="w"> </span><span class="nv">Summary</span><span class="w"> </span><span class="o">====</span>----
-----------------------
Filename<span class="w"> </span><span class="p">|</span><span class="w"> </span>Report<span class="w"> </span>count
-----------------------
main.cpp<span class="w"> </span><span class="p">|</span><span class="w">            </span><span class="m">1</span>
-----------------------
-----------------------
Severity<span class="w"> </span><span class="p">|</span><span class="w"> </span>Report<span class="w"> </span>count
-----------------------
HIGH<span class="w">     </span><span class="p">|</span><span class="w">            </span><span class="m">1</span>
-----------------------
----<span class="o">=================</span>----
Total<span class="w"> </span>number<span class="w"> </span>of<span class="w"> </span>reports:<span class="w"> </span><span class="m">1</span>
----<span class="o">=================</span>----
</pre></div>
</div>
<p>Or we can use <cite>CodeChecker parse -e html</cite> to export the results into HTML format:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>CodeChecker<span class="w"> </span>parse<span class="w"> </span>-e<span class="w"> </span>html<span class="w"> </span>-o<span class="w"> </span>html_out<span class="w"> </span>reports
$<span class="w"> </span>firefox<span class="w"> </span>html_out/index.html
</pre></div>
</div>
</section>
<section id="id5">
<h3><a class="toc-backref" href="#id14" role="doc-backlink"><span class="section-number">2.6.3.3. </span>Automated CTU Analysis with scan-build-py (don’t do it)</a><a class="headerlink" href="#id5" title="Link to this heading">¶</a></h3>
<p>We actively develop CTU with CodeChecker as the driver for feature, <cite>scan-build-py</cite> is not actively developed for CTU.
<cite>scan-build-py</cite> has various errors and issues, expect it to work only with the very basic projects only.</p>
<p>Currently On-demand analysis is not supported with <cite>scan-build-py</cite>.</p>
</section>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="FilingBugs.html"><span class="section-number">2.5. </span>Filing Bugs and Feature Requests</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="TaintAnalysisConfiguration.html"><span class="section-number">2.7. </span>Taint Analysis Configuration</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
    &#169; Copyright 2007-2025, The Clang Team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>