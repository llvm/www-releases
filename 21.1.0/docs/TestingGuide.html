
<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>LLVM Testing Infrastructure Guide &#8212; LLVM 21.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="_static/llvm-theme.css?v=96924833" />
    <script src="_static/documentation_options.js?v=c54a4614"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="test-suite Guide" href="TestSuiteGuide.html" />
    <link rel="prev" title="System Library" href="SystemLibrary.html" />
<style type="text/css">
  table.right { float: right; margin-left: 20px; }
  table.right td { border: 1px solid #ccc; }
</style>

  </head><body>
<div class="logo">
  <a href="index.html">
    <img src="_static/logo.png"
         alt="LLVM Logo" width="250" height="88"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="TestSuiteGuide.html" title="test-suite Guide"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="SystemLibrary.html" title="System Library"
             accesskey="P">previous</a> |</li>
  <li><a href="https://llvm.org/">LLVM Home</a>&nbsp;|&nbsp;</li>
  <li><a href="index.html">Documentation</a>&raquo;</li>

          <li class="nav-item nav-item-1"><a href="Reference.html" accesskey="U">Reference</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">LLVM Testing Infrastructure Guide</a></li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">

<h3>Documentation</h3>

<ul class="want-points">
    <li><a href="https://llvm.org/docs/GettingStartedTutorials.html">Getting Started/Tutorials</a></li>
    <li><a href="https://llvm.org/docs/UserGuides.html">User Guides</a></li>
    <li><a href="https://llvm.org/docs/Reference.html">Reference</a></li>
</ul>

<h3>Getting Involved</h3>

<ul class="want-points">
    <li><a href="https://llvm.org/docs/Contributing.html">Contributing to LLVM</a></li>
    <li><a href="https://llvm.org/docs/HowToSubmitABug.html">Submitting Bug Reports</a></li>
    <li><a href="https://llvm.org/docs/GettingInvolved.html#mailing-lists">Mailing Lists</a></li>
    <li><a href="https://llvm.org/docs/GettingInvolved.html#discord">Discord</a></li>
    <li><a href="https://llvm.org/docs/GettingInvolved.html#meetups-and-social-events">Meetups and Social Events</a></li>
</ul>

<h3>Additional Links</h3>

<ul class="want-points">
    <li><a href="https://llvm.org/docs/FAQ.html">FAQ</a></li>
    <li><a href="https://llvm.org/docs/Lexicon.html">Glossary</a></li>
    <li><a href="https://llvm.org/pubs">Publications</a></li>
    <li><a href="https://github.com/llvm/llvm-project/">Github Repository</a></li>
</ul>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/TestingGuide.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="llvm-testing-infrastructure-guide">
<h1>LLVM Testing Infrastructure Guide<a class="headerlink" href="#llvm-testing-infrastructure-guide" title="Link to this heading">¶</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id3">Overview</a></p></li>
<li><p><a class="reference internal" href="#requirements" id="id4">Requirements</a></p></li>
<li><p><a class="reference internal" href="#llvm-testing-infrastructure-organization" id="id5">LLVM Testing Infrastructure Organization</a></p>
<ul>
<li><p><a class="reference internal" href="#unit-tests" id="id6">Unit tests</a></p></li>
<li><p><a class="reference internal" href="#regression-tests" id="id7">Regression tests</a></p></li>
<li><p><a class="reference internal" href="#testing-analysis" id="id8">Testing Analysis</a></p></li>
<li><p><a class="reference internal" href="#test-suite" id="id9"><code class="docutils literal notranslate"><span class="pre">test-suite</span></code></a></p></li>
<li><p><a class="reference internal" href="#debugging-information-tests" id="id10">Debugging Information tests</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#quick-start" id="id11">Quick start</a></p>
<ul>
<li><p><a class="reference internal" href="#unit-and-regression-tests" id="id12">Unit and Regression tests</a></p></li>
<li><p><a class="reference internal" href="#id2" id="id13">Debugging Information tests</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#regression-test-structure" id="id14">Regression test structure</a></p>
<ul>
<li><p><a class="reference internal" href="#writing-new-regression-tests" id="id15">Writing new regression tests</a></p></li>
<li><p><a class="reference internal" href="#generating-assertions-in-regression-tests" id="id16">Generating assertions in regression tests</a></p></li>
<li><p><a class="reference internal" href="#precommit-workflow-for-tests" id="id17">Precommit workflow for tests</a></p></li>
<li><p><a class="reference internal" href="#best-practices-for-regression-tests" id="id18">Best practices for regression tests</a></p></li>
<li><p><a class="reference internal" href="#extra-files" id="id19">Extra files</a></p></li>
<li><p><a class="reference internal" href="#elaborated-tests" id="id20">Elaborated tests</a></p></li>
<li><p><a class="reference internal" href="#fragile-tests" id="id21">Fragile tests</a></p></li>
<li><p><a class="reference internal" href="#platform-specific-tests" id="id22">Platform-Specific Tests</a></p></li>
<li><p><a class="reference internal" href="#constraining-test-execution" id="id23">Constraining test execution</a></p></li>
<li><p><a class="reference internal" href="#tips-for-writing-constraints" id="id24">Tips for writing constraints</a></p></li>
<li><p><a class="reference internal" href="#substitutions" id="id25">Substitutions</a></p></li>
<li><p><a class="reference internal" href="#options" id="id26">Options</a></p></li>
<li><p><a class="reference internal" href="#other-features" id="id27">Other Features</a></p></li>
</ul>
</li>
</ul>
</nav>
<div class="toctree-wrapper compound">
</div>
<section id="overview">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Overview</a><a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>This document is the reference manual for the LLVM testing
infrastructure. It documents the structure of the LLVM testing
infrastructure, the tools needed to use it, and how to add and run
tests.</p>
</section>
<section id="requirements">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Requirements</a><a class="headerlink" href="#requirements" title="Link to this heading">¶</a></h2>
<p>In order to use the LLVM testing infrastructure, you will need all of the
software required to build LLVM, as well as <a class="reference external" href="http://python.org">Python</a> 3.8 or
later.</p>
</section>
<section id="llvm-testing-infrastructure-organization">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">LLVM Testing Infrastructure Organization</a><a class="headerlink" href="#llvm-testing-infrastructure-organization" title="Link to this heading">¶</a></h2>
<p>The LLVM testing infrastructure contains three major categories of tests:
unit tests, regression tests and whole programs. The unit tests and regression
tests are contained inside the LLVM repository itself under <code class="docutils literal notranslate"><span class="pre">llvm/unittests</span></code>
and <code class="docutils literal notranslate"><span class="pre">llvm/test</span></code> respectively and are expected to always pass – they should be
run before every commit.</p>
<p>The whole programs tests are referred to as the “LLVM test suite” (or
“test-suite”) and are in the <code class="docutils literal notranslate"><span class="pre">test-suite</span></code>
<a class="reference external" href="https://github.com/llvm/llvm-test-suite.git">repository on GitHub</a>.
For historical reasons, these tests are also referred to as the “nightly
tests” in places, which is less ambiguous than “test-suite” and remains
in use although we run them much more often than nightly.</p>
<section id="unit-tests">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">Unit tests</a><a class="headerlink" href="#unit-tests" title="Link to this heading">¶</a></h3>
<p>Unit tests are written using <a class="reference external" href="https://github.com/google/googletest/blob/master/docs/primer.md">Google Test</a>
and <a class="reference external" href="https://github.com/google/googletest/blob/master/docs/gmock_for_dummies.md">Google Mock</a>
and are located in the <code class="docutils literal notranslate"><span class="pre">llvm/unittests</span></code> directory.
In general unit tests are reserved for targeting the support library and other
generic data structure, we prefer relying on regression tests for testing
transformations and analysis on the IR.</p>
</section>
<section id="regression-tests">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">Regression tests</a><a class="headerlink" href="#regression-tests" title="Link to this heading">¶</a></h3>
<p>The regression tests are small pieces of code that test a specific
feature of LLVM or trigger a specific bug in LLVM. The language they are
written in depends on the part of LLVM being tested. These tests are driven by
the <a class="reference internal" href="CommandGuide/lit.html"><span class="doc">Lit</span></a> testing tool (which is part of LLVM), and
are located in the <code class="docutils literal notranslate"><span class="pre">llvm/test</span></code> directory.</p>
<p>Typically when a bug is found in LLVM, a regression test containing just
enough code to reproduce the problem should be written and placed
somewhere underneath this directory. For example, it can be a small
piece of LLVM IR distilled from an actual application or benchmark.</p>
</section>
<section id="testing-analysis">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">Testing Analysis</a><a class="headerlink" href="#testing-analysis" title="Link to this heading">¶</a></h3>
<p>An analysis is a pass that infer properties on some part of the IR and not
transforming it. They are tested in general using the same infrastructure as the
regression tests, by creating a separate “Printer” pass to consume the analysis
result and print it on the standard output in a textual format suitable for
FileCheck.
See <a class="reference external" href="https://github.com/llvm/llvm-project/blob/main/llvm/test/Analysis/BranchProbabilityInfo/loop.ll">llvm/test/Analysis/BranchProbabilityInfo/loop.ll</a>
for an example of such test.</p>
</section>
<section id="test-suite">
<h3><a class="toc-backref" href="#id9" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">test-suite</span></code></a><a class="headerlink" href="#test-suite" title="Link to this heading">¶</a></h3>
<p>The test suite contains whole programs, which are pieces of code which
can be compiled and linked into a stand-alone program that can be
executed. These programs are generally written in high level languages
such as C or C++.</p>
<p>These programs are compiled using a user specified compiler and set of
flags, and then executed to capture the program output and timing
information. The output of these programs is compared to a reference
output to ensure that the program is being compiled correctly.</p>
<p>In addition to compiling and executing programs, whole program tests
serve as a way of benchmarking LLVM performance, both in terms of the
efficiency of the programs generated as well as the speed with which
LLVM compiles, optimizes, and generates code.</p>
<p>The test-suite is located in the <code class="docutils literal notranslate"><span class="pre">test-suite</span></code>
<a class="reference external" href="https://github.com/llvm/llvm-test-suite.git">repository on GitHub</a>.</p>
<p>See the <a class="reference internal" href="TestSuiteGuide.html"><span class="doc">test-suite Guide</span></a> for details.</p>
</section>
<section id="debugging-information-tests">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">Debugging Information tests</a><a class="headerlink" href="#debugging-information-tests" title="Link to this heading">¶</a></h3>
<p>The test suite contains tests to check quality of debugging information.
The test are written in C based languages or in LLVM assembly language.</p>
<p>These tests are compiled and run under a debugger. The debugger output
is checked to validate of debugging information. See README.txt in the
test suite for more information. This test suite is located in the
<code class="docutils literal notranslate"><span class="pre">cross-project-tests/debuginfo-tests</span></code> directory.</p>
</section>
</section>
<section id="quick-start">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">Quick start</a><a class="headerlink" href="#quick-start" title="Link to this heading">¶</a></h2>
<p>The tests are located in two separate repositories. The unit and
regression tests are in the main “llvm”/ directory under the directories
<code class="docutils literal notranslate"><span class="pre">llvm/unittests</span></code> and <code class="docutils literal notranslate"><span class="pre">llvm/test</span></code> (so you get these tests for free with the
main LLVM tree). Use <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">check-all</span></code> to run the unit and regression tests
after building LLVM.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">test-suite</span></code> module contains more comprehensive tests including whole C
and C++ programs. See the <a class="reference internal" href="TestSuiteGuide.html"><span class="doc">test-suite Guide</span></a> for details.</p>
<section id="unit-and-regression-tests">
<h3><a class="toc-backref" href="#id12" role="doc-backlink">Unit and Regression tests</a><a class="headerlink" href="#unit-and-regression-tests" title="Link to this heading">¶</a></h3>
<p>To run all of the LLVM unit tests use the check-llvm-unit target:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>%<span class="w"> </span>make<span class="w"> </span>check-llvm-unit
</pre></div>
</div>
<p>To run all of the LLVM regression tests use the check-llvm target:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>%<span class="w"> </span>make<span class="w"> </span>check-llvm
</pre></div>
</div>
<p>In order to get reasonable testing performance, build LLVM and subprojects
in release mode, i.e.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>%<span class="w"> </span>cmake<span class="w"> </span>-DCMAKE_BUILD_TYPE<span class="o">=</span><span class="s2">&quot;Release&quot;</span><span class="w"> </span>-DLLVM_ENABLE_ASSERTIONS<span class="o">=</span>On
</pre></div>
</div>
<p>If you have <a class="reference external" href="https://clang.llvm.org/">Clang</a> checked out and built, you
can run the LLVM and Clang tests simultaneously using:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>%<span class="w"> </span>make<span class="w"> </span>check-all
</pre></div>
</div>
<p>To run the tests with Valgrind (Memcheck by default), use the <code class="docutils literal notranslate"><span class="pre">LIT_ARGS</span></code> make
variable to pass the required options to lit. For example, you can use:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>%<span class="w"> </span>make<span class="w"> </span>check<span class="w"> </span><span class="nv">LIT_ARGS</span><span class="o">=</span><span class="s2">&quot;-v --vg --vg-leak&quot;</span>
</pre></div>
</div>
<p>to enable testing with valgrind and with leak checking enabled.</p>
<p>To run individual tests or subsets of tests, you can use the <code class="docutils literal notranslate"><span class="pre">llvm-lit</span></code>
script which is built as part of LLVM. For example, to run the
<code class="docutils literal notranslate"><span class="pre">Integer/BitPacked.ll</span></code> test by itself you can run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>%<span class="w"> </span>llvm-lit<span class="w"> </span>&lt;path<span class="w"> </span>to<span class="w"> </span>llvm-project&gt;/llvm/test/Integer/BitPacked.ll
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The test files are in the <code class="docutils literal notranslate"><span class="pre">llvm-project</span></code> directory, not the directory you
are building LLVM in.</p>
</div>
<p>Or you can run a whole folder of tests. To run all of the ARM CodeGen tests:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>%<span class="w"> </span>llvm-lit<span class="w"> </span>&lt;path<span class="w"> </span>to<span class="w"> </span>llvm-project&gt;/llvm/test/CodeGen/ARM
</pre></div>
</div>
<p>The regression tests will use the Python psutil module only if installed in a
<strong>non-user</strong> location. Under Linux, install with sudo or within a virtual
environment. Under Windows, install Python for all users and then run
<code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">psutil</span></code> in an elevated command prompt.</p>
<p>For more information on using the <strong class="program">lit</strong> tool, see <code class="docutils literal notranslate"><span class="pre">llvm-lit</span> <span class="pre">--help</span></code>
or the <a class="reference internal" href="CommandGuide/lit.html"><span class="doc">lit man page</span></a>.</p>
</section>
<section id="id2">
<h3><a class="toc-backref" href="#id13" role="doc-backlink">Debugging Information tests</a><a class="headerlink" href="#id2" title="Link to this heading">¶</a></h3>
<p>To run debugging information tests simply add the <code class="docutils literal notranslate"><span class="pre">cross-project-tests</span></code>
project to your <code class="docutils literal notranslate"><span class="pre">LLVM_ENABLE_PROJECTS</span></code> define on the cmake
command-line.</p>
</section>
</section>
<section id="regression-test-structure">
<h2><a class="toc-backref" href="#id14" role="doc-backlink">Regression test structure</a><a class="headerlink" href="#regression-test-structure" title="Link to this heading">¶</a></h2>
<p>The LLVM regression tests are driven by <strong class="program">lit</strong> and are located in the
<code class="docutils literal notranslate"><span class="pre">llvm/test</span></code> directory.</p>
<p>This directory contains a large array of small tests that exercise
various features of LLVM and to ensure that regressions do not occur.
The directory is broken into several sub-directories, each focused on a
particular area of LLVM.</p>
<section id="writing-new-regression-tests">
<h3><a class="toc-backref" href="#id15" role="doc-backlink">Writing new regression tests</a><a class="headerlink" href="#writing-new-regression-tests" title="Link to this heading">¶</a></h3>
<p>The regression test structure is very simple, but does require some
information to be set. This information is gathered via <code class="docutils literal notranslate"><span class="pre">cmake</span></code>
and is written to a file, <code class="docutils literal notranslate"><span class="pre">test/lit.site.cfg.py</span></code> in the build directory.
The <code class="docutils literal notranslate"><span class="pre">llvm/test</span></code> Makefile does this work for you.</p>
<p>In order for the regression tests to work, each directory of tests must
have a <code class="docutils literal notranslate"><span class="pre">lit.local.cfg</span></code> file. <strong class="program">lit</strong> looks for this file to determine
how to run the tests. This file is just Python code and thus is very
flexible, but we’ve standardized it for the LLVM regression tests. If
you’re adding a directory of tests, just copy <code class="docutils literal notranslate"><span class="pre">lit.local.cfg</span></code> from
another directory to get running. The standard <code class="docutils literal notranslate"><span class="pre">lit.local.cfg</span></code> simply
specifies which files to look in for tests. Any directory that contains
only directories does not need the <code class="docutils literal notranslate"><span class="pre">lit.local.cfg</span></code> file. Read the <a class="reference internal" href="CommandGuide/lit.html"><span class="doc">Lit
documentation</span></a> for more information.</p>
<p>Each test file must contain lines starting with “RUN:” that tell <strong class="program">lit</strong>
how to run it. If there are no RUN lines, <strong class="program">lit</strong> will issue an error
while running a test.</p>
<p>RUN lines are specified in the comments of the test program using the
keyword <code class="docutils literal notranslate"><span class="pre">RUN</span></code> followed by a colon, and lastly the command (pipeline)
to execute. Together, these lines form the “script” that <strong class="program">lit</strong>
executes to run the test case. The syntax of the RUN lines is similar to a
shell’s syntax for pipelines including I/O redirection and variable
substitution. However, even though these lines may <em>look</em> like a shell
script, they are not. RUN lines are interpreted by <strong class="program">lit</strong>.
Consequently, the syntax differs from shell in a few ways. You can specify
as many RUN lines as needed.</p>
<p><strong class="program">lit</strong> performs substitution on each RUN line to replace LLVM tool names
with the full paths to the executable built for each tool (in
<code class="docutils literal notranslate"><span class="pre">$(LLVM_OBJ_ROOT)/bin</span></code>). This ensures that <strong class="program">lit</strong> does
not invoke any stray LLVM tools in the user’s path during testing.</p>
<p>Each RUN line is executed on its own, distinct from other lines unless
its last character is <code class="docutils literal notranslate"><span class="pre">\</span></code>. This continuation character causes the RUN
line to be concatenated with the next one. In this way you can build up
long pipelines of commands without making huge line lengths. The lines
ending in <code class="docutils literal notranslate"><span class="pre">\</span></code> are concatenated until a RUN line that doesn’t end in
<code class="docutils literal notranslate"><span class="pre">\</span></code> is found. This concatenated set of RUN lines then constitutes one
execution. <strong class="program">lit</strong> will substitute variables and arrange for the pipeline
to be executed. If any process in the pipeline fails, the entire line (and
test case) fails too.</p>
<p>Below is an example of legal RUN lines in a <code class="docutils literal notranslate"><span class="pre">.ll</span></code> file:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">; RUN: llvm-as &lt; %s | llvm-dis &gt; %t1</span>
<span class="c">; RUN: llvm-dis &lt; %s.bc-13 &gt; %t2</span>
<span class="c">; RUN: diff %t1 %t2</span>
</pre></div>
</div>
<p>As with a Unix shell, the RUN lines permit pipelines and I/O
redirection to be used.</p>
<p>There are some quoting rules that you must pay attention to when writing
your RUN lines. In general nothing needs to be quoted. <strong class="program">lit</strong> won’t
strip off any quote characters so they will get passed to the invoked program.
To avoid this use curly braces to tell <strong class="program">lit</strong> that it should treat
everything enclosed as one value.</p>
<p>In general, you should strive to keep your RUN lines as simple as possible,
using them only to run tools that generate textual output you can then examine.
The recommended way to examine output to figure out if the test passes is using
the <a class="reference internal" href="CommandGuide/FileCheck.html"><span class="doc">FileCheck tool</span></a>. <em>[The usage of grep in RUN
lines is deprecated - please do not send or commit patches that use it.]</em></p>
<p>Put related tests into a single file rather than having a separate file per
test. Check if there are files already covering your feature and consider
adding your code there instead of creating a new file.</p>
</section>
<section id="generating-assertions-in-regression-tests">
<h3><a class="toc-backref" href="#id16" role="doc-backlink">Generating assertions in regression tests</a><a class="headerlink" href="#generating-assertions-in-regression-tests" title="Link to this heading">¶</a></h3>
<p>Some regression test cases are very large and complex to write/update by hand.
In that case to reduce the human work we can use the scripts available in
llvm/utils/ to generate the assertions.</p>
<p>For example to generate assertions in an <strong class="program">llc</strong>-based test, after
adding one or more RUN lines use:</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>%<span class="w"> </span>llvm/utils/update_llc_test_checks.py<span class="w"> </span>--llc-binary<span class="w"> </span>build/bin/llc<span class="w"> </span>test.ll
</pre></div>
</div>
</div></blockquote>
<p>This will generate FileCheck assertions, and insert a <code class="docutils literal notranslate"><span class="pre">NOTE:</span></code> line at the
top to indicate that assertions were automatically generated.</p>
<p>If you want to update assertions in an existing test case, pass the <cite>-u</cite> option
which first checks the <code class="docutils literal notranslate"><span class="pre">NOTE:</span></code> line exists and matches the script name.</p>
<p>Sometimes a test absolutely depends on hand-written assertions and should not
have assertions automatically generated. In that case, add the text <code class="docutils literal notranslate"><span class="pre">NOTE:</span> <span class="pre">Do</span>
<span class="pre">not</span> <span class="pre">autogenerate</span></code> to the first line, and the scripts will skip that test. It
is a good idea to explain why generated assertions will not work for the test
so future developers will understand what is going on.</p>
<p>These are the most common scripts and their purposes/applications in generating
assertions:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>update_analyze_test_checks.py
opt -passes=&#39;print&lt;cost-model&gt;&#39;

update_cc_test_checks.py
C/C++, or clang/clang++ (IR checks)

update_llc_test_checks.py
llc (assembly checks)

update_mca_test_checks.py
llvm-mca

update_mir_test_checks.py
llc (MIR checks)

update_test_checks.py
opt
</pre></div>
</div>
</section>
<section id="precommit-workflow-for-tests">
<h3><a class="toc-backref" href="#id17" role="doc-backlink">Precommit workflow for tests</a><a class="headerlink" href="#precommit-workflow-for-tests" title="Link to this heading">¶</a></h3>
<p>If the test does not crash, assert, or infinite loop, commit the test with
baseline check-lines first. That is, the test will show a miscompile or
missing optimization. Add a “TODO” or “FIXME” comment to indicate that
something is expected to change in a test.</p>
<p>A follow-up patch with code changes to the compiler will then show check-line
differences to the tests, so it is easier to see the effect of the patch.
Remove TODO/FIXME comments added in the previous step if a problem is solved.</p>
<p>Baseline tests (no-functional-change or NFC patch) may be pushed to main
without pre-commit review if you have commit access.</p>
</section>
<section id="best-practices-for-regression-tests">
<h3><a class="toc-backref" href="#id18" role="doc-backlink">Best practices for regression tests</a><a class="headerlink" href="#best-practices-for-regression-tests" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Use auto-generated check lines (produced by the scripts mentioned above)
whenever feasible.</p></li>
<li><p>Include comments about what is tested/expected in a particular test. If there
are relevant issues in the bug tracker, add references to those bug reports
(for example, “See PR999 for more details”).</p></li>
<li><p>Avoid undefined behavior and poison/undef values unless necessary. For
example, do not use patterns like <code class="docutils literal notranslate"><span class="pre">br</span> <span class="pre">i1</span> <span class="pre">undef</span></code>, which are likely to break
as a result of future optimizations.</p></li>
<li><p>Minimize tests by removing unnecessary instructions, metadata, attributes,
etc. Tools like <code class="docutils literal notranslate"><span class="pre">llvm-reduce</span></code> can help automate this.</p></li>
<li><p>Outside PhaseOrdering tests, only run a minimal set of passes. For example,
prefer <code class="docutils literal notranslate"><span class="pre">opt</span> <span class="pre">-S</span> <span class="pre">-passes=instcombine</span></code> over <code class="docutils literal notranslate"><span class="pre">opt</span> <span class="pre">-S</span> <span class="pre">-O3</span></code>.</p></li>
<li><p>Avoid unnamed instructions/blocks (such as <code class="docutils literal notranslate"><span class="pre">%0</span></code> or <code class="docutils literal notranslate"><span class="pre">1:</span></code>), because they may
require renumbering on future test modifications. These can be removed by
running the test through <code class="docutils literal notranslate"><span class="pre">opt</span> <span class="pre">-S</span> <span class="pre">-passes=instnamer</span></code>.</p></li>
<li><p>Try to give values (including variables, blocks and functions) meaningful
names, and avoid retaining complex names generated by the optimization
pipeline (such as <code class="docutils literal notranslate"><span class="pre">%foo.0.0.0.0.0.0</span></code>).</p></li>
</ul>
</section>
<section id="extra-files">
<h3><a class="toc-backref" href="#id19" role="doc-backlink">Extra files</a><a class="headerlink" href="#extra-files" title="Link to this heading">¶</a></h3>
<p>If your test requires extra files besides the file containing the <code class="docutils literal notranslate"><span class="pre">RUN:</span></code> lines
and the extra files are small, consider specifying them in the same file and
using <code class="docutils literal notranslate"><span class="pre">split-file</span></code> to extract them. For example,</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">; RUN: split-file %s %t</span>
<span class="c">; RUN: llvm-link -S %t/a.ll %t/b.ll | FileCheck %s</span>

<span class="c">; CHECK: ...</span>

<span class="c">;--- a.ll</span>
<span class="p">...</span>
<span class="c">;--- b.ll</span>
<span class="p">...</span>
</pre></div>
</div>
<p>The parts are separated by the regex <code class="docutils literal notranslate"><span class="pre">^(.|//)---</span> <span class="pre">&lt;part&gt;</span></code>.</p>
<p>If you want to test relative line numbers like <code class="docutils literal notranslate"><span class="pre">[[#&#64;LINE+1]]</span></code>, specify
<code class="docutils literal notranslate"><span class="pre">--leading-lines</span></code> to add leading empty lines to preserve line numbers.</p>
<p>If the extra files are large, the idiomatic place to put them is in a subdirectory <code class="docutils literal notranslate"><span class="pre">Inputs</span></code>.
You can then refer to the extra files as <code class="docutils literal notranslate"><span class="pre">%S/Inputs/foo.bar</span></code>.</p>
<p>For example, consider <code class="docutils literal notranslate"><span class="pre">test/Linker/ident.ll</span></code>. The directory structure is
as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test</span><span class="o">/</span>
  <span class="n">Linker</span><span class="o">/</span>
    <span class="n">ident</span><span class="o">.</span><span class="n">ll</span>
    <span class="n">Inputs</span><span class="o">/</span>
      <span class="n">ident</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">ll</span>
      <span class="n">ident</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">ll</span>
</pre></div>
</div>
<p>For convenience, these are the contents:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">;;;;; ident.ll:</span>

<span class="c">; RUN: llvm-link %S/Inputs/ident.a.ll %S/Inputs/ident.b.ll -S | FileCheck %s</span>

<span class="c">; Verify that multiple input llvm.ident metadata are linked together.</span>

<span class="c">; CHECK-DAG: !llvm.ident = !{!0, !1, !2}</span>
<span class="c">; CHECK-DAG: &quot;Compiler V1&quot;</span>
<span class="c">; CHECK-DAG: &quot;Compiler V2&quot;</span>
<span class="c">; CHECK-DAG: &quot;Compiler V3&quot;</span>

<span class="c">;;;;; Inputs/ident.a.ll:</span>

<span class="nv">!llvm.ident</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">!{</span><span class="nv nv-Anonymous">!0</span><span class="p">,</span><span class="w"> </span><span class="nv nv-Anonymous">!1</span><span class="p">}</span>
<span class="nv nv-Anonymous">!0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">metadata</span><span class="w"> </span><span class="p">!{</span><span class="k">metadata</span><span class="w"> </span><span class="nv">!&quot;Compiler V1&quot;</span><span class="p">}</span>
<span class="nv nv-Anonymous">!1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">metadata</span><span class="w"> </span><span class="p">!{</span><span class="k">metadata</span><span class="w"> </span><span class="nv">!&quot;Compiler V2&quot;</span><span class="p">}</span>

<span class="c">;;;;; Inputs/ident.b.ll:</span>

<span class="nv">!llvm.ident</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">!{</span><span class="nv nv-Anonymous">!0</span><span class="p">}</span>
<span class="nv nv-Anonymous">!0</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="k">metadata</span><span class="w"> </span><span class="p">!{</span><span class="k">metadata</span><span class="w"> </span><span class="nv">!&quot;Compiler V3&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>For symmetry reasons, <code class="docutils literal notranslate"><span class="pre">ident.ll</span></code> is just a dummy file that doesn’t
actually participate in the test besides holding the <code class="docutils literal notranslate"><span class="pre">RUN:</span></code> lines.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Some existing tests use <code class="docutils literal notranslate"><span class="pre">RUN:</span> <span class="pre">true</span></code> in extra files instead of just
putting the extra files in an <code class="docutils literal notranslate"><span class="pre">Inputs/</span></code> directory. This pattern is
deprecated.</p>
</div>
</section>
<section id="elaborated-tests">
<h3><a class="toc-backref" href="#id20" role="doc-backlink">Elaborated tests</a><a class="headerlink" href="#elaborated-tests" title="Link to this heading">¶</a></h3>
<p>Generally, IR and assembly test files benefit from being cleaned to remove
unnecessary details. However, for tests requiring elaborate IR or assembly
files where cleanup is less practical (e.g., large amount of debug information
output from Clang), you can include generation instructions within
<code class="docutils literal notranslate"><span class="pre">split-file</span></code> part called <code class="docutils literal notranslate"><span class="pre">gen</span></code>. Then, run
<code class="docutils literal notranslate"><span class="pre">llvm/utils/update_test_body.py</span></code> on the test file to generate the needed
content.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>; RUN: rm -rf %t &amp;&amp; split-file %s %t &amp;&amp; cd %t
; RUN: opt -S a.ll ... | FileCheck %s

; CHECK: hello

;--- a.cc
int va;
;--- gen
clang --target=x86_64-linux -S -emit-llvm -g a.cc -o -

;--- a.ll
# content generated by the script &#39;gen&#39;
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PATH</span><span class="o">=</span>/path/to/clang_build/bin:<span class="nv">$PATH</span><span class="w"> </span>llvm/utils/update_test_body.py<span class="w"> </span>path/to/test.ll
</pre></div>
</div>
<p>The script will prepare extra files with <code class="docutils literal notranslate"><span class="pre">split-file</span></code>, invoke <code class="docutils literal notranslate"><span class="pre">gen</span></code>, and
then rewrite the part after <code class="docutils literal notranslate"><span class="pre">gen</span></code> with its stdout.</p>
<p>For convenience, if the test needs one single assembly file, you can also wrap
<code class="docutils literal notranslate"><span class="pre">gen</span></code> and its required files with <code class="docutils literal notranslate"><span class="pre">.ifdef</span></code> and <code class="docutils literal notranslate"><span class="pre">.endif</span></code>. Then you can
skip <code class="docutils literal notranslate"><span class="pre">split-file</span></code> in RUN lines.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># RUN: llvm-mc -filetype=obj -triple=x86_64 %s -o a.o
# RUN: ... | FileCheck %s

# CHECK: hello

.ifdef GEN
#--- a.cc
int va;
#--- gen
clang --target=x86_64-linux -S -g a.cc -o -
.endif
# content generated by the script &#39;gen&#39;
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Consider specifying an explicit target triple to avoid differences when
regeneration is needed on another machine.</p>
<p><code class="docutils literal notranslate"><span class="pre">gen</span></code> is invoked with <code class="docutils literal notranslate"><span class="pre">PWD</span></code> set to <code class="docutils literal notranslate"><span class="pre">/proc/self/cwd</span></code>. Clang commands
don’t need <code class="docutils literal notranslate"><span class="pre">-fdebug-compilation-dir=</span></code> since its default value is <code class="docutils literal notranslate"><span class="pre">PWD</span></code>.</p>
<p>Check prefixes should be placed before <code class="docutils literal notranslate"><span class="pre">.endif</span></code> since the part after
<code class="docutils literal notranslate"><span class="pre">.endif</span></code> is replaced.</p>
</div>
<p>If the test body contains multiple files, you can print <code class="docutils literal notranslate"><span class="pre">---</span></code> separators and
utilize <code class="docutils literal notranslate"><span class="pre">split-file</span></code> in <code class="docutils literal notranslate"><span class="pre">RUN</span></code> lines.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># RUN: rm -rf %t &amp;&amp; split-file %s %t &amp;&amp; cd %t
...

#--- a.cc
int va;
#--- b.cc
int vb;
#--- gen
clang --target=x86_64-linux -S -O1 -g a.cc -o -
echo &#39;#--- b.s&#39;
clang --target=x86_64-linux -S -O1 -g b.cc -o -
#--- a.s
</pre></div>
</div>
</section>
<section id="fragile-tests">
<h3><a class="toc-backref" href="#id21" role="doc-backlink">Fragile tests</a><a class="headerlink" href="#fragile-tests" title="Link to this heading">¶</a></h3>
<p>It is easy to write a fragile test that would fail spuriously if the tool being
tested outputs a full path to the input file.  For example, <strong class="program">opt</strong> by
default outputs a <code class="docutils literal notranslate"><span class="pre">ModuleID</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>example.ll
<span class="go">define i32 @main() nounwind {</span>
<span class="go">    ret i32 0</span>
<span class="go">}</span>

<span class="gp">$ </span>opt<span class="w"> </span>-S<span class="w"> </span>/path/to/example.ll
<span class="go">; ModuleID = &#39;/path/to/example.ll&#39;</span>

<span class="go">define i32 @main() nounwind {</span>
<span class="go">    ret i32 0</span>
<span class="go">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ModuleID</span></code> can unexpectedly match against <code class="docutils literal notranslate"><span class="pre">CHECK</span></code> lines.  For example:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">; RUN: opt -S %s | FileCheck</span>

<span class="k">define</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="vg">@main</span><span class="p">()</span><span class="w"> </span><span class="k">nounwind</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c">; CHECK-NOT: load</span>
<span class="w">    </span><span class="k">ret</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="m">0</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This test will fail if placed into a <code class="docutils literal notranslate"><span class="pre">download</span></code> directory.</p>
<p>To make your tests robust, always use <code class="docutils literal notranslate"><span class="pre">opt</span> <span class="pre">...</span> <span class="pre">&lt;</span> <span class="pre">%s</span></code> in the RUN line.
<strong class="program">opt</strong> does not output a <code class="docutils literal notranslate"><span class="pre">ModuleID</span></code> when input comes from stdin.</p>
</section>
<section id="platform-specific-tests">
<h3><a class="toc-backref" href="#id22" role="doc-backlink">Platform-Specific Tests</a><a class="headerlink" href="#platform-specific-tests" title="Link to this heading">¶</a></h3>
<p>Whenever adding tests that require the knowledge of a specific platform,
either related to code generated, specific output or back-end features,
you must make sure to isolate the features, so that buildbots that
run on different architectures (and don’t even compile all back-ends),
don’t fail.</p>
<p>The first problem is to check for target-specific output, for example sizes
of structures, paths and architecture names, for example:</p>
<ul class="simple">
<li><p>Tests containing Windows paths will fail on Linux and vice-versa.</p></li>
<li><p>Tests that check for <code class="docutils literal notranslate"><span class="pre">x86_64</span></code> somewhere in the text will fail anywhere else.</p></li>
<li><p>Tests where the debug information calculates the size of types and structures.</p></li>
</ul>
<p>Also, if the test rely on any behaviour that is coded in any back-end, it must
go in its own directory. So, for instance, code generator tests for ARM go
into <code class="docutils literal notranslate"><span class="pre">test/CodeGen/ARM</span></code> and so on. Those directories contain a special
<code class="docutils literal notranslate"><span class="pre">lit</span></code> configuration file that ensure all tests in that directory will
only run if a specific back-end is compiled and available.</p>
<p>For instance, on <code class="docutils literal notranslate"><span class="pre">test/CodeGen/ARM</span></code>, the <code class="docutils literal notranslate"><span class="pre">lit.local.cfg</span></code> is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="o">.</span><span class="n">suffixes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.ll&#39;</span><span class="p">,</span> <span class="s1">&#39;.c&#39;</span><span class="p">,</span> <span class="s1">&#39;.cpp&#39;</span><span class="p">,</span> <span class="s1">&#39;.test&#39;</span><span class="p">]</span>
<span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;ARM&#39;</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
  <span class="n">config</span><span class="o">.</span><span class="n">unsupported</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>Other platform-specific tests are those that depend on a specific feature
of a specific sub-architecture, for example only to Intel chips that support <code class="docutils literal notranslate"><span class="pre">AVX2</span></code>.</p>
<p>For instance, <code class="docutils literal notranslate"><span class="pre">test/CodeGen/X86/psubus.ll</span></code> tests three sub-architecture
variants:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">; RUN: llc -mcpu=core2 &lt; %s | FileCheck %s -check-prefix=SSE2</span>
<span class="c">; RUN: llc -mcpu=corei7-avx &lt; %s | FileCheck %s -check-prefix=AVX1</span>
<span class="c">; RUN: llc -mcpu=core-avx2 &lt; %s | FileCheck %s -check-prefix=AVX2</span>
</pre></div>
</div>
<p>And the checks are different:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">; SSE2: @test1</span>
<span class="c">; SSE2: psubusw LCPI0_0(%rip), %xmm0</span>
<span class="c">; AVX1: @test1</span>
<span class="c">; AVX1: vpsubusw LCPI0_0(%rip), %xmm0, %xmm0</span>
<span class="c">; AVX2: @test1</span>
<span class="c">; AVX2: vpsubusw LCPI0_0(%rip), %xmm0, %xmm0</span>
</pre></div>
</div>
<p>So, if you’re testing for a behaviour that you know is platform-specific or
depends on special features of sub-architectures, you must add the specific
triple, test with the specific FileCheck and put it into the specific
directory that will filter out all other architectures.</p>
</section>
<section id="constraining-test-execution">
<h3><a class="toc-backref" href="#id23" role="doc-backlink">Constraining test execution</a><a class="headerlink" href="#constraining-test-execution" title="Link to this heading">¶</a></h3>
<p>Some tests can be run only in specific configurations, such as
with debug builds or on particular platforms. Use <code class="docutils literal notranslate"><span class="pre">REQUIRES</span></code>
and <code class="docutils literal notranslate"><span class="pre">UNSUPPORTED</span></code> to control when the test is enabled.</p>
<p>Some tests are expected to fail. For example, there may be a known bug
that the test detect. Use <code class="docutils literal notranslate"><span class="pre">XFAIL</span></code> to mark a test as an expected failure.
An <code class="docutils literal notranslate"><span class="pre">XFAIL</span></code> test will be successful if its execution fails, and
will be a failure if its execution succeeds.</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">; This test will be only enabled in the build with asserts.</span>
<span class="c">; REQUIRES: asserts</span>
<span class="c">; This test is disabled when running on Linux.</span>
<span class="c">; UNSUPPORTED: system-linux</span>
<span class="c">; This test is expected to fail when targeting PowerPC.</span>
<span class="c">; XFAIL: target=powerpc{{.*}}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">REQUIRES</span></code> and <code class="docutils literal notranslate"><span class="pre">UNSUPPORTED</span></code> and <code class="docutils literal notranslate"><span class="pre">XFAIL</span></code> all accept a comma-separated
list of boolean expressions. The values in each expression may be:</p>
<ul class="simple">
<li><p>Features added to <code class="docutils literal notranslate"><span class="pre">config.available_features</span></code> by configuration files such as <code class="docutils literal notranslate"><span class="pre">lit.cfg</span></code>.
String comparison of features is case-sensitive. Furthermore, a boolean expression can
contain any Python regular expression enclosed in <code class="docutils literal notranslate"><span class="pre">{{</span> <span class="pre">}}</span></code>, in which case the boolean
expression is satisfied if any feature matches the regular expression. Regular
expressions can appear inside an identifier, so for example <code class="docutils literal notranslate"><span class="pre">he{{l+}}o</span></code> would match
<code class="docutils literal notranslate"><span class="pre">helo</span></code>, <code class="docutils literal notranslate"><span class="pre">hello</span></code>, <code class="docutils literal notranslate"><span class="pre">helllo</span></code>, and so on.</p></li>
<li><p>The default target triple, preceded by the string <code class="docutils literal notranslate"><span class="pre">target=</span></code> (for example,
<code class="docutils literal notranslate"><span class="pre">target=x86_64-pc-windows-msvc</span></code>). Typically regular expressions are used
to match parts of the triple (for example, <code class="docutils literal notranslate"><span class="pre">target={{.*}}-windows{{.*}}</span></code>
to match any Windows target triple).</p></li>
</ul>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">REQUIRES</span></code> enables the test if all expressions are true.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">UNSUPPORTED</span></code> disables the test if any expression is true.</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">XFAIL</span></code> expects the test to fail if any expression is true.</div>
</div>
<p>Use, <code class="docutils literal notranslate"><span class="pre">XFAIL:</span> <span class="pre">*</span></code> if the test is expected to fail everywhere. Similarly, use
<code class="docutils literal notranslate"><span class="pre">UNSUPPORTED:</span> <span class="pre">target={{.*}}</span></code> to disable the test everywhere.</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">; This test is disabled when running on Windows,</span>
<span class="c">; and is disabled when targeting Linux, except for Android Linux.</span>
<span class="c">; UNSUPPORTED: system-windows, target={{.*linux.*}} &amp;&amp; !target={{.*android.*}}</span>
<span class="c">; This test is expected to fail when targeting PowerPC or running on Darwin.</span>
<span class="c">; XFAIL: target=powerpc{{.*}}, system-darwin</span>
</pre></div>
</div>
</section>
<section id="tips-for-writing-constraints">
<h3><a class="toc-backref" href="#id24" role="doc-backlink">Tips for writing constraints</a><a class="headerlink" href="#tips-for-writing-constraints" title="Link to this heading">¶</a></h3>
<p><strong>``REQUIRES`` and ``UNSUPPORTED``</strong></p>
<p>These are logical inverses. In principle, <code class="docutils literal notranslate"><span class="pre">UNSUPPORTED</span></code> isn’t absolutely
necessary (the logical negation could be used with <code class="docutils literal notranslate"><span class="pre">REQUIRES</span></code> to get
exactly the same effect), but it can make these clauses easier to read and
understand. Generally, people use <code class="docutils literal notranslate"><span class="pre">REQUIRES</span></code> to state things that the test
depends on to operate correctly, and <code class="docutils literal notranslate"><span class="pre">UNSUPPORTED</span></code> to exclude cases where
the test is expected never to work.</p>
<p><strong>``UNSUPPORTED`` and ``XFAIL``</strong></p>
<p>Both of these indicate that the test isn’t expected to work; however, they
have different effects. <code class="docutils literal notranslate"><span class="pre">UNSUPPORTED</span></code> causes the test to be skipped;
this saves execution time, but then you’ll never know whether the test
actually would start working. Conversely, <code class="docutils literal notranslate"><span class="pre">XFAIL</span></code> actually runs the test
but expects a failure output, taking extra execution time but alerting you
if/when the test begins to behave correctly (an XPASS test result). You
need to decide which is more appropriate in each case.</p>
<p><strong>Using ``target=…``</strong></p>
<p>Checking the target triple can be tricky; it’s easy to mis-specify. For
example, <code class="docutils literal notranslate"><span class="pre">target=mips{{.*}}</span></code> will match not only mips, but also mipsel,
mips64, and mips64el. <code class="docutils literal notranslate"><span class="pre">target={{.*}}-linux-gnu</span></code> will match
x86_64-unknown-linux-gnu, but not armv8l-unknown-linux-gnueabihf.
Prefer to use hyphens to delimit triple components (<code class="docutils literal notranslate"><span class="pre">target=mips-{{.*}}</span></code>)
and it’s generally a good idea to use a trailing wildcard to allow for
unexpected suffixes.</p>
<p>Also, it’s generally better to write regular expressions that use entire
triple components, than to do something clever to shorten them. For
example, to match both freebsd and netbsd in an expression, you could write
<code class="docutils literal notranslate"><span class="pre">target={{.*(free|net)bsd.*}}</span></code> and that would work. However, it would
prevent a <code class="docutils literal notranslate"><span class="pre">grep</span> <span class="pre">freebsd</span></code> from finding this test. Better to use:
<code class="docutils literal notranslate"><span class="pre">target={{.+-freebsd.*}}</span> <span class="pre">||</span> <span class="pre">target={{.+-netbsd.*}}</span></code></p>
</section>
<section id="substitutions">
<h3><a class="toc-backref" href="#id25" role="doc-backlink">Substitutions</a><a class="headerlink" href="#substitutions" title="Link to this heading">¶</a></h3>
<p>Besides replacing LLVM tool names the following substitutions are performed in
RUN lines:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">%%</span></code></dt><dd><p>Replaced by a single <code class="docutils literal notranslate"><span class="pre">%</span></code>. This allows escaping other substitutions.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%s</span></code></dt><dd><p>File path to the test case’s source. This is suitable for passing on the
command line as the input to an LLVM tool.</p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">/home/user/llvm/test/MC/ELF/foo_test.s</span></code></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%S</span></code></dt><dd><p>Directory path to the test case’s source.</p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">/home/user/llvm/test/MC/ELF</span></code></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%t</span></code></dt><dd><p>File path to a temporary file name that could be used for this test case.
The file name won’t conflict with other test cases. You can append to it
if you need multiple temporaries. This is useful as the destination of
some redirected output.</p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">/home/user/llvm.build/test/MC/ELF/Output/foo_test.s.tmp</span></code></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%T</span></code></dt><dd><p>Directory of <code class="docutils literal notranslate"><span class="pre">%t</span></code>. Deprecated. Shouldn’t be used, because it can be easily
misused and cause race conditions between tests.</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">rm</span> <span class="pre">-rf</span> <span class="pre">%t</span> <span class="pre">&amp;&amp;</span> <span class="pre">mkdir</span> <span class="pre">%t</span></code> instead if a temporary directory is necessary.</p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">/home/user/llvm.build/test/MC/ELF/Output</span></code></p>
</dd>
</dl>
<p><code class="docutils literal notranslate"><span class="pre">%{pathsep}</span></code></p>
<blockquote>
<div><p>Expands to the path separator, i.e. <code class="docutils literal notranslate"><span class="pre">:</span></code> (or <code class="docutils literal notranslate"><span class="pre">;</span></code> on Windows).</p>
</div></blockquote>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">%{fs-src-root}</span></code></dt><dd><p>Expands to the root component of file system paths for the source directory,
i.e. <code class="docutils literal notranslate"><span class="pre">/</span></code> on Unix systems or <code class="docutils literal notranslate"><span class="pre">C:\</span></code> (or another drive) on Windows.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%{fs-tmp-root}</span></code></dt><dd><p>Expands to the root component of file system paths for the test’s temporary
directory, i.e. <code class="docutils literal notranslate"><span class="pre">/</span></code> on Unix systems or <code class="docutils literal notranslate"><span class="pre">C:\</span></code> (or another drive) on
Windows.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%{fs-sep}</span></code></dt><dd><p>Expands to the file system separator, i.e. <code class="docutils literal notranslate"><span class="pre">/</span></code> or <code class="docutils literal notranslate"><span class="pre">\</span></code> on Windows.</p>
</dd>
</dl>
<p><code class="docutils literal notranslate"><span class="pre">%/s,</span> <span class="pre">%/S,</span> <span class="pre">%/t,</span> <span class="pre">%/T</span></code></p>
<blockquote>
<div><p>Act like the corresponding substitution above but replace any <code class="docutils literal notranslate"><span class="pre">\</span></code>
character with a <code class="docutils literal notranslate"><span class="pre">/</span></code>. This is useful to normalize path separators.</p>
<blockquote>
<div><p>Example: <code class="docutils literal notranslate"><span class="pre">%s:</span>&#160; <span class="pre">C:\Desktop</span> <span class="pre">Files/foo_test.s.tmp</span></code></p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">%/s:</span> <span class="pre">C:/Desktop</span> <span class="pre">Files/foo_test.s.tmp</span></code></p>
</div></blockquote>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">%{s:real},</span> <span class="pre">%{S:real},</span> <span class="pre">%{t:real},</span> <span class="pre">%{T:real}</span></code>
<code class="docutils literal notranslate"><span class="pre">%{/s:real},</span> <span class="pre">%{/S:real},</span> <span class="pre">%{/t:real},</span> <span class="pre">%{/T:real}</span></code></p>
<blockquote>
<div><p>Act like the corresponding substitution, including with <code class="docutils literal notranslate"><span class="pre">/</span></code>, but use
the real path by expanding all symbolic links and substitute drives.</p>
<blockquote>
<div><p>Example: <code class="docutils literal notranslate"><span class="pre">%s:</span>&#160; <span class="pre">S:\foo_test.s.tmp</span></code></p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">%{/s:real}:</span> <span class="pre">C:/SDrive/foo_test.s.tmp</span></code></p>
</div></blockquote>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">%:s,</span> <span class="pre">%:S,</span> <span class="pre">%:t,</span> <span class="pre">%:T</span></code></p>
<blockquote>
<div><p>Act like the corresponding substitution above but remove colons at
the beginning of Windows paths. This is useful to allow concatenation
of absolute paths on Windows to produce a legal path.</p>
<blockquote>
<div><p>Example: <code class="docutils literal notranslate"><span class="pre">%s:</span>&#160; <span class="pre">C:\Desktop</span> <span class="pre">Files\foo_test.s.tmp</span></code></p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">%:s:</span> <span class="pre">C\Desktop</span> <span class="pre">Files\foo_test.s.tmp</span></code></p>
</div></blockquote>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">%errc_&lt;ERRCODE&gt;</span></code></p>
<blockquote>
<div><p>Some error messages may be substituted to allow different spellings
based on the host platform.</p>
<blockquote>
<div><p>The following error codes are currently supported:
ENOENT, EISDIR, EINVAL, EACCES.</p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">Linux</span> <span class="pre">%errc_ENOENT:</span> <span class="pre">No</span> <span class="pre">such</span> <span class="pre">file</span> <span class="pre">or</span> <span class="pre">directory</span></code></p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">Windows</span> <span class="pre">%errc_ENOENT:</span> <span class="pre">no</span> <span class="pre">such</span> <span class="pre">file</span> <span class="pre">or</span> <span class="pre">directory</span></code></p>
</div></blockquote>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">%if</span> <span class="pre">feature</span> <span class="pre">%{&lt;if</span> <span class="pre">branch&gt;%}</span> <span class="pre">%else</span> <span class="pre">%{&lt;else</span> <span class="pre">branch&gt;%}</span></code></p>
<blockquote>
<div><p>Conditional substitution: if <code class="docutils literal notranslate"><span class="pre">feature</span></code> is available it expands to
<code class="docutils literal notranslate"><span class="pre">&lt;if</span> <span class="pre">branch&gt;</span></code>, otherwise it expands to <code class="docutils literal notranslate"><span class="pre">&lt;else</span> <span class="pre">branch&gt;</span></code>.
<code class="docutils literal notranslate"><span class="pre">%else</span> <span class="pre">%{&lt;else</span> <span class="pre">branch&gt;%}</span></code> is optional and treated like <code class="docutils literal notranslate"><span class="pre">%else</span> <span class="pre">%{%}</span></code>
if not present.</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">%(line)</span></code>, <code class="docutils literal notranslate"><span class="pre">%(line+&lt;number&gt;)</span></code>, <code class="docutils literal notranslate"><span class="pre">%(line-&lt;number&gt;)</span></code></p>
<blockquote>
<div><p>The number of the line where this substitution is used, with an
optional integer offset.  These expand only if they appear
immediately in <code class="docutils literal notranslate"><span class="pre">RUN:</span></code>, <code class="docutils literal notranslate"><span class="pre">DEFINE:</span></code>, and <code class="docutils literal notranslate"><span class="pre">REDEFINE:</span></code> directives.
Occurrences in substitutions defined elsewhere are never expanded.
For example, this can be used in tests with multiple RUN lines,
which reference the test file’s line numbers.</p>
</div></blockquote>
<p><strong>LLVM-specific substitutions:</strong></p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">%shlibext</span></code></dt><dd><p>The suffix for the host platforms shared library files. This includes the
period as the first character.</p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">.so</span></code> (Linux), <code class="docutils literal notranslate"><span class="pre">.dylib</span></code> (macOS), <code class="docutils literal notranslate"><span class="pre">.dll</span></code> (Windows)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%exeext</span></code></dt><dd><p>The suffix for the host platforms executable files. This includes the
period as the first character.</p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">.exe</span></code> (Windows), empty on Linux.</p>
</dd>
</dl>
<p><strong>Clang-specific substitutions:</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">%clang</span></code></dt><dd><p>Invokes the Clang driver.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%clang_cpp</span></code></dt><dd><p>Invokes the Clang driver for C++.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%clang_cl</span></code></dt><dd><p>Invokes the CL-compatible Clang driver.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%clangxx</span></code></dt><dd><p>Invokes the G++-compatible Clang driver.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%clang_cc1</span></code></dt><dd><p>Invokes the Clang frontend.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">%itanium_abi_triple</span></code>, <code class="docutils literal notranslate"><span class="pre">%ms_abi_triple</span></code></dt><dd><p>These substitutions can be used to get the current target triple adjusted to
the desired ABI. For example, if the test suite is running with the
<code class="docutils literal notranslate"><span class="pre">i686-pc-win32</span></code> target, <code class="docutils literal notranslate"><span class="pre">%itanium_abi_triple</span></code> will expand to
<code class="docutils literal notranslate"><span class="pre">i686-pc-mingw32</span></code>. This allows a test to run with a specific ABI without
constraining it to a specific triple.</p>
</dd>
</dl>
<p><strong>FileCheck-specific substitutions:</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">%ProtectFileCheckOutput</span></code></dt><dd><p>This should precede a <code class="docutils literal notranslate"><span class="pre">FileCheck</span></code> call if and only if the call’s textual
output affects test results.  It’s usually easy to tell: just look for
redirection or piping of the <code class="docutils literal notranslate"><span class="pre">FileCheck</span></code> call’s stdout or stderr.</p>
</dd>
</dl>
<p id="test-specific-substitutions"><strong>Test-specific substitutions:</strong></p>
<p>Additional substitutions can be defined as follows:</p>
<ul class="simple">
<li><p>Lit configuration files (e.g., <code class="docutils literal notranslate"><span class="pre">lit.cfg</span></code> or <code class="docutils literal notranslate"><span class="pre">lit.local.cfg</span></code>) can define
substitutions for all tests in a test directory.  They do so by extending the
substitution list, <code class="docutils literal notranslate"><span class="pre">config.substitutions</span></code>.  Each item in the list is a tuple
consisting of a pattern and its replacement, which lit applies as plain text
(even if it contains sequences that python’s <code class="docutils literal notranslate"><span class="pre">re.sub</span></code> considers to be
escape sequences).</p></li>
<li><p>To define substitutions within a single test file, lit supports the
<code class="docutils literal notranslate"><span class="pre">DEFINE:</span></code> and <code class="docutils literal notranslate"><span class="pre">REDEFINE:</span></code> directives, described in detail below.  So that
they have no effect on other test files, these directives modify a copy of the
substitution list that is produced by lit configuration files.</p></li>
</ul>
<p>For example, the following directives can be inserted into a test file to define
<code class="docutils literal notranslate"><span class="pre">%{cflags}</span></code> and <code class="docutils literal notranslate"><span class="pre">%{fcflags}</span></code> substitutions with empty initial values, which
serve as the parameters of another newly defined <code class="docutils literal notranslate"><span class="pre">%{check}</span></code> substitution:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">; DEFINE: %{cflags} =</span>
<span class="c">; DEFINE: %{fcflags} =</span>

<span class="c">; DEFINE: %{check} =                                                  \</span>
<span class="c">; DEFINE:   %clang_cc1 -verify -fopenmp -fopenmp-version=51 %{cflags} \</span>
<span class="c">; DEFINE:              -emit-llvm -o - %s |                           \</span>
<span class="c">; DEFINE:     FileCheck %{fcflags} %s</span>
</pre></div>
</div>
<p>Alternatively, the above substitutions can be defined in a lit configuration
file to be shared with other test files.  Either way, the test file can then
specify directives like the following to redefine the parameter substitutions as
desired before each use of <code class="docutils literal notranslate"><span class="pre">%{check}</span></code> in a <code class="docutils literal notranslate"><span class="pre">RUN:</span></code> line:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">; REDEFINE: %{cflags} = -triple x86_64-apple-darwin10.6.0 -fopenmp-simd</span>
<span class="c">; REDEFINE: %{fcflags} = -check-prefix=SIMD</span>
<span class="c">; RUN: %{check}</span>

<span class="c">; REDEFINE: %{cflags} = -triple x86_64-unknown-linux-gnu -fopenmp-simd</span>
<span class="c">; REDEFINE: %{fcflags} = -check-prefix=SIMD</span>
<span class="c">; RUN: %{check}</span>

<span class="c">; REDEFINE: %{cflags} = -triple x86_64-apple-darwin10.6.0</span>
<span class="c">; REDEFINE: %{fcflags} = -check-prefix=NO-SIMD</span>
<span class="c">; RUN: %{check}</span>

<span class="c">; REDEFINE: %{cflags} = -triple x86_64-unknown-linux-gnu</span>
<span class="c">; REDEFINE: %{fcflags} = -check-prefix=NO-SIMD</span>
<span class="c">; RUN: %{check}</span>
</pre></div>
</div>
<p>Besides providing initial values, the initial <code class="docutils literal notranslate"><span class="pre">DEFINE:</span></code> directives for the
parameter substitutions in the above example serve a second purpose: they
establish the substitution order so that both <code class="docutils literal notranslate"><span class="pre">%{check}</span></code> and its parameters
expand as desired.  There’s a simple way to remember the required definition
order in a test file: define a substitution before any substitution that might
refer to it.</p>
<p>In general, substitution expansion behaves as follows:</p>
<ul class="simple">
<li><p>Upon arriving at each <code class="docutils literal notranslate"><span class="pre">RUN:</span></code> line, lit expands all substitutions in that
<code class="docutils literal notranslate"><span class="pre">RUN:</span></code> line using their current values from the substitution list.  No
substitution expansion is performed immediately at <code class="docutils literal notranslate"><span class="pre">DEFINE:</span></code> and
<code class="docutils literal notranslate"><span class="pre">REDEFINE:</span></code> directives except <code class="docutils literal notranslate"><span class="pre">%(line)</span></code>, <code class="docutils literal notranslate"><span class="pre">%(line+&lt;number&gt;)</span></code>, and
<code class="docutils literal notranslate"><span class="pre">%(line-&lt;number&gt;)</span></code>.</p></li>
<li><p>When expanding substitutions in a <code class="docutils literal notranslate"><span class="pre">RUN:</span></code> line, lit makes only one pass
through the substitution list by default.  In this case, a substitution must
have been inserted earlier in the substitution list than any substitution
appearing in its value in order for the latter to expand.  (For greater
flexibility, you can enable multiple passes through the substitution list by
setting <a class="reference internal" href="#recursiveexpansionlimit">recursiveExpansionLimit</a> in a lit configuration file.)</p></li>
<li><p>While lit configuration files can insert anywhere in the substitution list,
the insertion behavior of the <code class="docutils literal notranslate"><span class="pre">DEFINE:</span></code> and <code class="docutils literal notranslate"><span class="pre">REDEFINE:</span></code> directives is
specified below and is designed specifically for the use case presented in the
example above.</p></li>
<li><p>Defining a substitution in terms of itself, whether directly or via other
substitutions, should be avoided.  It usually produces an infinitely recursive
definition that cannot be fully expanded.  It does <em>not</em> define the
substitution in terms of its previous value, even when using <code class="docutils literal notranslate"><span class="pre">REDEFINE:</span></code>.</p></li>
</ul>
<p>The relationship between the <code class="docutils literal notranslate"><span class="pre">DEFINE:</span></code> and <code class="docutils literal notranslate"><span class="pre">REDEFINE:</span></code> directive is
analogous to the relationship between a variable declaration and variable
assignment in many programming languages:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">DEFINE:</span> <span class="pre">%{name}</span> <span class="pre">=</span> <span class="pre">value</span></code></p>
<blockquote>
<div><p>This directive assigns the specified value to a new substitution whose
pattern is <code class="docutils literal notranslate"><span class="pre">%{name}</span></code>, or it reports an error if there is already a
substitution whose pattern contains <code class="docutils literal notranslate"><span class="pre">%{name}</span></code> because that could produce
confusing expansions (e.g., a lit configuration file might define a
substitution with the pattern <code class="docutils literal notranslate"><span class="pre">%{name}\[0\]</span></code>).  The new substitution is
inserted at the start of the substitution list so that it will expand first.
Thus, its value can contain any substitution previously defined, whether in
the same test file or in a lit configuration file, and both will expand.</p>
</div></blockquote>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">REDEFINE:</span> <span class="pre">%{name}</span> <span class="pre">=</span> <span class="pre">value</span></code></p>
<blockquote>
<div><p>This directive assigns the specified value to an existing substitution whose
pattern is <code class="docutils literal notranslate"><span class="pre">%{name}</span></code>, or it reports an error if there are no substitutions
with that pattern or if there are multiple substitutions whose patterns
contain <code class="docutils literal notranslate"><span class="pre">%{name}</span></code>.  The substitution’s current position in the substitution
list does not change so that expansion order relative to other existing
substitutions is preserved.</p>
</div></blockquote>
</li>
</ul>
<p>The following properties apply to both the <code class="docutils literal notranslate"><span class="pre">DEFINE:</span></code> and <code class="docutils literal notranslate"><span class="pre">REDEFINE:</span></code>
directives:</p>
<ul>
<li><p><strong>Substitution name</strong>: In the directive, whitespace immediately before or
after <code class="docutils literal notranslate"><span class="pre">%{name}</span></code> is optional and discarded.  <code class="docutils literal notranslate"><span class="pre">%{name}</span></code> must start with
<code class="docutils literal notranslate"><span class="pre">%{</span></code>, it must end with <code class="docutils literal notranslate"><span class="pre">}</span></code>, and the rest must start with a letter or
underscore and contain only alphanumeric characters, hyphens, underscores, and
colons.  This syntax has a few advantages:</p>
<blockquote>
<div><ul class="simple">
<li><p>It is impossible for <code class="docutils literal notranslate"><span class="pre">%{name}</span></code> to contain sequences that are special in
python’s <code class="docutils literal notranslate"><span class="pre">re.sub</span></code> patterns.  Otherwise, attempting to specify
<code class="docutils literal notranslate"><span class="pre">%{name}</span></code> as a substitution pattern in a lit configuration file could
produce confusing expansions.</p></li>
<li><p>The braces help avoid the possibility that another substitution’s pattern
will match part of <code class="docutils literal notranslate"><span class="pre">%{name}</span></code> or vice-versa, producing confusing
expansions.  However, the patterns of substitutions defined by lit
configuration files and by lit itself are not restricted to this form, so
overlaps are still theoretically possible.</p></li>
</ul>
</div></blockquote>
</li>
<li><p><strong>Substitution value</strong>: The value includes all text from the first
non-whitespace character after <code class="docutils literal notranslate"><span class="pre">=</span></code> to the last non-whitespace character.  If
there is no non-whitespace character after <code class="docutils literal notranslate"><span class="pre">=</span></code>, the value is the empty
string.  Escape sequences that can appear in python <code class="docutils literal notranslate"><span class="pre">re.sub</span></code> replacement
strings are treated as plain text in the value.</p></li>
<li><p><strong>Line continuations</strong>: If the last non-whitespace character on the line after
<code class="docutils literal notranslate"><span class="pre">:</span></code> is <code class="docutils literal notranslate"><span class="pre">\</span></code>, then the next directive must use the same directive keyword
(e.g., <code class="docutils literal notranslate"><span class="pre">DEFINE:</span></code>) , and it is an error if there is no additional directive.
That directive serves as a continuation.  That is, before following the rules
above to parse the text after <code class="docutils literal notranslate"><span class="pre">:</span></code> in either directive, lit joins that text
together to form a single directive, replaces the <code class="docutils literal notranslate"><span class="pre">\</span></code> with a single space,
and removes any other whitespace that is now adjacent to that space.  A
continuation can be continued in the same manner.  A continuation containing
only whitespace after its <code class="docutils literal notranslate"><span class="pre">:</span></code> is an error.</p></li>
</ul>
<p id="recursiveexpansionlimit"><strong>recursiveExpansionLimit:</strong></p>
<p>As described in the previous section, when expanding substitutions in a <code class="docutils literal notranslate"><span class="pre">RUN:</span></code>
line, lit makes only one pass through the substitution list by default.  Thus,
if substitutions are not defined in the proper order, some will remain in the
<code class="docutils literal notranslate"><span class="pre">RUN:</span></code> line unexpanded.  For example, the following directives refer to
<code class="docutils literal notranslate"><span class="pre">%{inner}</span></code> within <code class="docutils literal notranslate"><span class="pre">%{outer}</span></code> but do not define <code class="docutils literal notranslate"><span class="pre">%{inner}</span></code> until after
<code class="docutils literal notranslate"><span class="pre">%{outer}</span></code>:</p>
<div class="highlight-llvm notranslate"><div class="highlight"><pre><span></span><span class="c">; By default, this definition order does not enable full expansion.</span>

<span class="c">; DEFINE: %{outer} = %{inner}</span>
<span class="c">; DEFINE: %{inner} = expanded</span>

<span class="c">; RUN: echo &#39;%{outer}&#39;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">DEFINE:</span></code> inserts substitutions at the start of the substitution list, so
<code class="docutils literal notranslate"><span class="pre">%{inner}</span></code> expands first but has no effect because the original <code class="docutils literal notranslate"><span class="pre">RUN:</span></code> line
does not contain <code class="docutils literal notranslate"><span class="pre">%{inner}</span></code>.  Next, <code class="docutils literal notranslate"><span class="pre">%{outer}</span></code> expands, and the output of
the <code class="docutils literal notranslate"><span class="pre">echo</span></code> command becomes:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>%<span class="o">{</span>inner<span class="o">}</span>
</pre></div>
</div>
<p>Of course, one way to fix this simple case is to reverse the definitions of
<code class="docutils literal notranslate"><span class="pre">%{outer}</span></code> and <code class="docutils literal notranslate"><span class="pre">%{inner}</span></code>.  However, if a test has a complex set of
substitutions that can all reference each other, there might not exist a
sufficient substitution order.</p>
<p>To address such use cases, lit configuration files support
<code class="docutils literal notranslate"><span class="pre">config.recursiveExpansionLimit</span></code>, which can be set to a non-negative integer
to specify the maximum number of passes through the substitution list.  Thus, in
the above example, setting the limit to 2 would cause lit to make a second pass
that expands <code class="docutils literal notranslate"><span class="pre">%{inner}</span></code> in the <code class="docutils literal notranslate"><span class="pre">RUN:</span></code> line, and the output from the <code class="docutils literal notranslate"><span class="pre">echo</span></code>
command when then be:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>expanded
</pre></div>
</div>
<p>To improve performance, lit will stop making passes when it notices the <code class="docutils literal notranslate"><span class="pre">RUN:</span></code>
line has stopped changing.  In the above example, setting the limit higher than
2 is thus harmless.</p>
<p>To facilitate debugging, after reaching the limit, lit will make one extra pass
and report an error if the <code class="docutils literal notranslate"><span class="pre">RUN:</span></code> line changes again.  In the above example,
setting the limit to 1 will thus cause lit to report an error instead of
producing incorrect output.</p>
</section>
<section id="options">
<h3><a class="toc-backref" href="#id26" role="doc-backlink">Options</a><a class="headerlink" href="#options" title="Link to this heading">¶</a></h3>
<p>The llvm lit configuration allows to customize some things with user options:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">llc</span></code>, <code class="docutils literal notranslate"><span class="pre">opt</span></code>, …</dt><dd><p>Substitute the respective llvm tool name with a custom command line. This
allows to specify custom paths and default arguments for these tools.
Example:</p>
<p>% llvm-lit “-Dllc=llc -verify-machineinstrs”</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">run_long_tests</span></code></dt><dd><p>Enable the execution of long running tests.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">llvm_site_config</span></code></dt><dd><p>Load the specified lit configuration instead of the default one.</p>
</dd>
</dl>
</section>
<section id="other-features">
<h3><a class="toc-backref" href="#id27" role="doc-backlink">Other Features</a><a class="headerlink" href="#other-features" title="Link to this heading">¶</a></h3>
<p>To make RUN line writing easier, there are several helper programs. These
helpers are in the PATH when running tests, so you can just call them using
their name. For example:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">not</span></code></dt><dd><p>This program runs its arguments and then inverts the result code from it.
Zero result codes become 1. Non-zero result codes become 0.</p>
</dd>
</dl>
<p>To make the output more useful, <strong class="program">lit</strong> will scan
the lines of the test case for ones that contain a pattern that matches
<code class="docutils literal notranslate"><span class="pre">PR[0-9]+</span></code>. This is the syntax for specifying a PR (Problem Report) number
that is related to the test case. The number after “PR” specifies the
LLVM Bugzilla number. When a PR number is specified, it will be used in
the pass/fail reporting. This is useful to quickly get some context when
a test fails.</p>
<p>Finally, any line that contains “END.” will cause the special
interpretation of lines to terminate. This is generally done right after
the last RUN: line. This has two side effects:</p>
<ol class="loweralpha simple">
<li><p>it prevents special interpretation of lines that are part of the test
program, not the instructions to the test case, and</p></li>
<li><p>it speeds things up for really big test cases by avoiding
interpretation of the remainder of the file.</p></li>
</ol>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="TestSuiteGuide.html" title="test-suite Guide"
             >next</a> |</li>
        <li class="right" >
          <a href="SystemLibrary.html" title="System Library"
             >previous</a> |</li>
  <li><a href="https://llvm.org/">LLVM Home</a>&nbsp;|&nbsp;</li>
  <li><a href="index.html">Documentation</a>&raquo;</li>

          <li class="nav-item nav-item-1"><a href="Reference.html" >Reference</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">LLVM Testing Infrastructure Guide</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2003-2025, LLVM Project.
      Last updated on 2025-08-26.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>