
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>LLVM Coding Standards &#8212; LLVM 18.1.2 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="_static/llvm-theme.css?v=be84393e" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js?v=2f6c9c8e"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Bisecting LLVM code" href="GitBisecting.html" />
    <link rel="prev" title="LLVM Bug Life Cycle" href="BugLifeCycle.html" />
<style type="text/css">
  table.right { float: right; margin-left: 20px; }
  table.right td { border: 1px solid #ccc; }
</style>

  </head><body>
<div class="logo">
  <a href="index.html">
    <img src="_static/logo.png"
         alt="LLVM Logo" width="250" height="88"/></a>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="GitBisecting.html" title="Bisecting LLVM code"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="BugLifeCycle.html" title="LLVM Bug Life Cycle"
             accesskey="P">previous</a> |</li>
  <li><a href="https://llvm.org/">LLVM Home</a>&nbsp;|&nbsp;</li>
  <li><a href="index.html">Documentation</a>&raquo;</li>

          <li class="nav-item nav-item-1"><a href="GettingInvolved.html" accesskey="U">Getting Involved</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">LLVM Coding Standards</a></li> 
      </ul>
    </div>

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">

<h3>Documentation</h3>

<ul class="want-points">
    <li><a href="https://llvm.org/docs/GettingStartedTutorials.html">Getting Started/Tutorials</a></li>
    <li><a href="https://llvm.org/docs/UserGuides.html">User Guides</a></li>
    <li><a href="https://llvm.org/docs/Reference.html">Reference</a></li>
</ul>

<h3>Getting Involved</h3>

<ul class="want-points">
    <li><a href="https://llvm.org/docs/Contributing.html">Contributing to LLVM</a></li>
    <li><a href="https://llvm.org/docs/HowToSubmitABug.html">Submitting Bug Reports</a></li>
    <li><a href="https://llvm.org/docs/GettingInvolved.html#mailing-lists">Mailing Lists</a></li>
    <li><a href="https://llvm.org/docs/GettingInvolved.html#irc">IRC</a></li>
    <li><a href="https://llvm.org/docs/GettingInvolved.html#meetups-and-social-events">Meetups and Social Events</a></li>
</ul>

<h3>Additional Links</h3>

<ul class="want-points">
    <li><a href="https://llvm.org/docs/FAQ.html">FAQ</a></li>
    <li><a href="https://llvm.org/docs/Lexicon.html">Glossary</a></li>
    <li><a href="https://llvm.org/pubs">Publications</a></li>
    <li><a href="https://github.com/llvm/llvm-project/">Github Repository</a></li>
</ul>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/CodingStandards.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="llvm-coding-standards">
<h1>LLVM Coding Standards<a class="headerlink" href="#llvm-coding-standards" title="Permalink to this heading">¶</a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id1">Introduction</a></p></li>
<li><p><a class="reference internal" href="#languages-libraries-and-standards" id="id2">Languages, Libraries, and Standards</a></p>
<ul>
<li><p><a class="reference internal" href="#c-standard-versions" id="id3">C++ Standard Versions</a></p></li>
<li><p><a class="reference internal" href="#c-standard-library" id="id4">C++ Standard Library</a></p></li>
<li><p><a class="reference internal" href="#python-version-and-source-code-formatting" id="id5">Python version and Source Code Formatting</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#mechanical-source-issues" id="id6">Mechanical Source Issues</a></p>
<ul>
<li><p><a class="reference internal" href="#source-code-formatting" id="id7">Source Code Formatting</a></p>
<ul>
<li><p><a class="reference internal" href="#commenting" id="id8">Commenting</a></p>
<ul>
<li><p><a class="reference internal" href="#file-headers" id="id9">File Headers</a></p></li>
<li><p><a class="reference internal" href="#header-guard" id="id10">Header Guard</a></p></li>
<li><p><a class="reference internal" href="#class-overviews" id="id11">Class overviews</a></p></li>
<li><p><a class="reference internal" href="#method-information" id="id12">Method information</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#comment-formatting" id="id13">Comment Formatting</a></p></li>
<li><p><a class="reference internal" href="#doxygen-use-in-documentation-comments" id="id14">Doxygen Use in Documentation Comments</a></p></li>
<li><p><a class="reference internal" href="#error-and-warning-messages" id="id15">Error and Warning Messages</a></p></li>
<li><p><a class="reference internal" href="#include-style" id="id16"><code class="docutils literal notranslate"><span class="pre">#include</span></code> Style</a></p></li>
<li><p><a class="reference internal" href="#source-code-width" id="id17">Source Code Width</a></p></li>
<li><p><a class="reference internal" href="#whitespace" id="id18">Whitespace</a></p>
<ul>
<li><p><a class="reference internal" href="#format-lambdas-like-blocks-of-code" id="id19">Format Lambdas Like Blocks Of Code</a></p></li>
<li><p><a class="reference internal" href="#braced-initializer-lists" id="id20">Braced Initializer Lists</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#language-and-compiler-issues" id="id21">Language and Compiler Issues</a></p>
<ul>
<li><p><a class="reference internal" href="#treat-compiler-warnings-like-errors" id="id22">Treat Compiler Warnings Like Errors</a></p></li>
<li><p><a class="reference internal" href="#write-portable-code" id="id23">Write Portable Code</a></p></li>
<li><p><a class="reference internal" href="#do-not-use-rtti-or-exceptions" id="id24">Do not use RTTI or Exceptions</a></p></li>
<li><p><a class="reference internal" href="#prefer-c-style-casts" id="id25">Prefer C++-style casts</a></p></li>
<li><p><a class="reference internal" href="#do-not-use-static-constructors" id="id26">Do not use Static Constructors</a></p></li>
<li><p><a class="reference internal" href="#use-of-class-and-struct-keywords" id="id27">Use of <code class="docutils literal notranslate"><span class="pre">class</span></code> and <code class="docutils literal notranslate"><span class="pre">struct</span></code> Keywords</a></p></li>
<li><p><a class="reference internal" href="#do-not-use-braced-initializer-lists-to-call-a-constructor" id="id28">Do not use Braced Initializer Lists to Call a Constructor</a></p></li>
<li><p><a class="reference internal" href="#use-auto-type-deduction-to-make-code-more-readable" id="id29">Use <code class="docutils literal notranslate"><span class="pre">auto</span></code> Type Deduction to Make Code More Readable</a></p></li>
<li><p><a class="reference internal" href="#beware-unnecessary-copies-with-auto" id="id30">Beware unnecessary copies with <code class="docutils literal notranslate"><span class="pre">auto</span></code></a></p></li>
<li><p><a class="reference internal" href="#beware-of-non-determinism-due-to-ordering-of-pointers" id="id31">Beware of non-determinism due to ordering of pointers</a></p></li>
<li><p><a class="reference internal" href="#beware-of-non-deterministic-sorting-order-of-equal-elements" id="id32">Beware of non-deterministic sorting order of equal elements</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#style-issues" id="id33">Style Issues</a></p>
<ul>
<li><p><a class="reference internal" href="#the-high-level-issues" id="id34">The High-Level Issues</a></p>
<ul>
<li><p><a class="reference internal" href="#self-contained-headers" id="id35">Self-contained Headers</a></p></li>
<li><p><a class="reference internal" href="#library-layering" id="id36">Library Layering</a></p></li>
<li><p><a class="reference internal" href="#include-as-little-as-possible" id="id37"><code class="docutils literal notranslate"><span class="pre">#include</span></code> as Little as Possible</a></p></li>
<li><p><a class="reference internal" href="#keep-internal-headers-private" id="id38">Keep “Internal” Headers Private</a></p></li>
<li><p><a class="reference internal" href="#use-namespace-qualifiers-to-implement-previously-declared-functions" id="id39">Use Namespace Qualifiers to Implement Previously Declared Functions</a></p></li>
<li><p><a class="reference internal" href="#use-early-exits-and-continue-to-simplify-code" id="id40">Use Early Exits and <code class="docutils literal notranslate"><span class="pre">continue</span></code> to Simplify Code</a></p></li>
<li><p><a class="reference internal" href="#don-t-use-else-after-a-return" id="id41">Don’t use <code class="docutils literal notranslate"><span class="pre">else</span></code> after a <code class="docutils literal notranslate"><span class="pre">return</span></code></a></p></li>
<li><p><a class="reference internal" href="#turn-predicate-loops-into-predicate-functions" id="id42">Turn Predicate Loops into Predicate Functions</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#the-low-level-issues" id="id43">The Low-Level Issues</a></p>
<ul>
<li><p><a class="reference internal" href="#name-types-functions-variables-and-enumerators-properly" id="id44">Name Types, Functions, Variables, and Enumerators Properly</a></p></li>
<li><p><a class="reference internal" href="#assert-liberally" id="id45">Assert Liberally</a></p></li>
<li><p><a class="reference internal" href="#do-not-use-using-namespace-std" id="id46">Do Not Use <code class="docutils literal notranslate"><span class="pre">using</span> <span class="pre">namespace</span> <span class="pre">std</span></code></a></p></li>
<li><p><a class="reference internal" href="#provide-a-virtual-method-anchor-for-classes-in-headers" id="id47">Provide a Virtual Method Anchor for Classes in Headers</a></p></li>
<li><p><a class="reference internal" href="#don-t-use-default-labels-in-fully-covered-switches-over-enumerations" id="id48">Don’t use default labels in fully covered switches over enumerations</a></p></li>
<li><p><a class="reference internal" href="#use-range-based-for-loops-wherever-possible" id="id49">Use range-based <code class="docutils literal notranslate"><span class="pre">for</span></code> loops wherever possible</a></p></li>
<li><p><a class="reference internal" href="#don-t-evaluate-end-every-time-through-a-loop" id="id50">Don’t evaluate <code class="docutils literal notranslate"><span class="pre">end()</span></code> every time through a loop</a></p></li>
<li><p><a class="reference internal" href="#include-iostream-is-forbidden" id="id51"><code class="docutils literal notranslate"><span class="pre">#include</span> <span class="pre">&lt;iostream&gt;</span></code> is Forbidden</a></p></li>
<li><p><a class="reference internal" href="#use-raw-ostream" id="id52">Use <code class="docutils literal notranslate"><span class="pre">raw_ostream</span></code></a></p></li>
<li><p><a class="reference internal" href="#avoid-std-endl" id="id53">Avoid <code class="docutils literal notranslate"><span class="pre">std::endl</span></code></a></p></li>
<li><p><a class="reference internal" href="#don-t-use-inline-when-defining-a-function-in-a-class-definition" id="id54">Don’t use <code class="docutils literal notranslate"><span class="pre">inline</span></code> when defining a function in a class definition</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#microscopic-details" id="id55">Microscopic Details</a></p>
<ul>
<li><p><a class="reference internal" href="#spaces-before-parentheses" id="id56">Spaces Before Parentheses</a></p></li>
<li><p><a class="reference internal" href="#prefer-preincrement" id="id57">Prefer Preincrement</a></p></li>
<li><p><a class="reference internal" href="#namespace-indentation" id="id58">Namespace Indentation</a></p></li>
<li><p><a class="reference internal" href="#anonymous-namespaces" id="id59">Anonymous Namespaces</a></p></li>
<li><p><a class="reference internal" href="#don-t-use-braces-on-simple-single-statement-bodies-of-if-else-loop-statements" id="id60">Don’t Use Braces on Simple Single-Statement Bodies of if/else/loop Statements</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#see-also" id="id61">See Also</a></p></li>
</ul>
</nav>
<section id="introduction">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this heading">¶</a></h2>
<p>This document describes coding standards that are used in the LLVM project.
Although no coding standards should be regarded as absolute requirements to be
followed in all instances, coding standards are
particularly important for large-scale code bases that follow a library-based
design (like LLVM).</p>
<p>While this document may provide guidance for some mechanical formatting issues,
whitespace, or other “microscopic details”, these are not fixed standards.
Always follow the golden rule:</p>
<blockquote id="golden-rule">
<div><p><strong>If you are extending, enhancing, or bug fixing already implemented code,
use the style that is already being used so that the source is uniform and
easy to follow.</strong></p>
</div></blockquote>
<p>Note that some code bases (e.g. <code class="docutils literal notranslate"><span class="pre">libc++</span></code>) have special reasons to deviate
from the coding standards.  For example, in the case of <code class="docutils literal notranslate"><span class="pre">libc++</span></code>, this is
because the naming and other conventions are dictated by the C++ standard.</p>
<p>There are some conventions that are not uniformly followed in the code base
(e.g. the naming convention).  This is because they are relatively new, and a
lot of code was written before they were put in place.  Our long term goal is
for the entire codebase to follow the convention, but we explicitly <em>do not</em>
want patches that do large-scale reformatting of existing code.  On the other
hand, it is reasonable to rename the methods of a class if you’re about to
change it in some other way.  Please commit such changes separately to
make code review easier.</p>
<p>The ultimate goal of these guidelines is to increase the readability and
maintainability of our common source base.</p>
</section>
<section id="languages-libraries-and-standards">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Languages, Libraries, and Standards</a><a class="headerlink" href="#languages-libraries-and-standards" title="Permalink to this heading">¶</a></h2>
<p>Most source code in LLVM and other LLVM projects using these coding standards
is C++ code. There are some places where C code is used either due to
environment restrictions, historical restrictions, or due to third-party source
code imported into the tree. Generally, our preference is for standards
conforming, modern, and portable C++ code as the implementation language of
choice.</p>
<p>For automation, build-systems and utility scripts Python is preferred and
is widely used in the LLVM repository already.</p>
<section id="c-standard-versions">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">C++ Standard Versions</a><a class="headerlink" href="#c-standard-versions" title="Permalink to this heading">¶</a></h3>
<p>Unless otherwise documented, LLVM subprojects are written using standard C++17
code and avoid unnecessary vendor-specific extensions.</p>
<p>Nevertheless, we restrict ourselves to features which are available in the
major toolchains supported as host compilers (see <a class="reference internal" href="GettingStarted.html"><span class="doc">Getting Started with the LLVM System</span></a> page,
section <cite>Software</cite>).</p>
<p>Each toolchain provides a good reference for what it accepts:</p>
<ul class="simple">
<li><p>Clang: <a class="reference external" href="https://clang.llvm.org/cxx_status.html">https://clang.llvm.org/cxx_status.html</a></p>
<ul>
<li><p>libc++: <a class="reference external" href="https://libcxx.llvm.org/Status/Cxx17.html">https://libcxx.llvm.org/Status/Cxx17.html</a></p></li>
</ul>
</li>
<li><p>GCC: <a class="reference external" href="https://gcc.gnu.org/projects/cxx-status.html#cxx17">https://gcc.gnu.org/projects/cxx-status.html#cxx17</a></p>
<ul>
<li><p>libstdc++: <a class="reference external" href="https://gcc.gnu.org/onlinedocs/libstdc++/manual/status.html#status.iso.2017">https://gcc.gnu.org/onlinedocs/libstdc++/manual/status.html#status.iso.2017</a></p></li>
</ul>
</li>
<li><p>MSVC: <a class="reference external" href="https://msdn.microsoft.com/en-us/library/hh567368.aspx">https://msdn.microsoft.com/en-us/library/hh567368.aspx</a></p></li>
</ul>
</section>
<section id="c-standard-library">
<h3><a class="toc-backref" href="#id4" role="doc-backlink">C++ Standard Library</a><a class="headerlink" href="#c-standard-library" title="Permalink to this heading">¶</a></h3>
<p>Instead of implementing custom data structures, we encourage the use of C++
standard library facilities or LLVM support libraries whenever they are
available for a particular task. LLVM and related projects emphasize and rely
on the standard library facilities and the LLVM support libraries as much as
possible.</p>
<p>LLVM support libraries (for example, <a class="reference external" href="https://github.com/llvm/llvm-project/tree/main/llvm/include/llvm/ADT">ADT</a>)
implement specialized data structures or functionality missing in the standard
library. Such libraries are usually implemented in the <code class="docutils literal notranslate"><span class="pre">llvm</span></code> namespace and
follow the expected standard interface, when there is one.</p>
<p>When both C++ and the LLVM support libraries provide similar functionality, and
there isn’t a specific reason to favor the C++ implementation, it is generally
preferable to use the LLVM library. For example, <code class="docutils literal notranslate"><span class="pre">llvm::DenseMap</span></code> should
almost always be used instead of <code class="docutils literal notranslate"><span class="pre">std::map</span></code> or <code class="docutils literal notranslate"><span class="pre">std::unordered_map</span></code>, and
<code class="docutils literal notranslate"><span class="pre">llvm::SmallVector</span></code> should usually be used instead of <code class="docutils literal notranslate"><span class="pre">std::vector</span></code>.</p>
<p>We explicitly avoid some standard facilities, like the I/O streams, and instead
use LLVM’s streams library (<a class="reference internal" href="#raw-ostream">raw_ostream</a>). More detailed information on these
subjects is available in the <a class="reference internal" href="ProgrammersManual.html"><span class="doc">LLVM Programmer’s Manual</span></a>.</p>
<p>For more information about LLVM’s data structures and the tradeoffs they make,
please consult <a class="reference external" href="https://llvm.org/docs/ProgrammersManual.html#picking-the-right-data-structure-for-a-task">that section of the programmer’s manual</a>.</p>
</section>
<section id="python-version-and-source-code-formatting">
<h3><a class="toc-backref" href="#id5" role="doc-backlink">Python version and Source Code Formatting</a><a class="headerlink" href="#python-version-and-source-code-formatting" title="Permalink to this heading">¶</a></h3>
<p>The current minimum version of Python required is documented in the <a class="reference internal" href="GettingStarted.html"><span class="doc">Getting Started with the LLVM System</span></a>
section. Python code in the LLVM repository should only use language features
available in this version of Python.</p>
<p>The Python code within the LLVM repository should adhere to the formatting guidelines
outlined in <a class="reference external" href="https://peps.python.org/pep-0008/">PEP 8</a>.</p>
<p>For consistency and to limit churn, code should be automatically formatted with
the <a class="reference external" href="https://github.com/psf/black">black</a> utility, which is PEP 8 compliant.
Use its default rules. For example, avoid specifying <code class="docutils literal notranslate"><span class="pre">--line-length</span></code> even
though it does not default to 80. The default rules can change between major
versions of black. In order to avoid unnecessary churn in the formatting rules,
we currently use black version 23.x in LLVM.</p>
<p>When contributing a patch unrelated to formatting, you should format only the
Python code that the patch modifies. For this purpose, use the <a class="reference external" href="https://pypi.org/project/darker/">darker</a> utility, which runs default black rules
over only the modified Python code. Doing so should ensure the patch will pass
the Python format checks in LLVM’s pre-commit CI, which also uses darker. When
contributing a patch specifically for reformatting Python files, use black,
which currently only supports formatting entire files.</p>
<p>Here are some quick examples, but see the black and darker documentation for
details:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span><span class="nv">black</span><span class="o">==</span><span class="s1">&#39;23.*&#39;</span><span class="w"> </span>darker<span class="w"> </span><span class="c1"># install black 23.x and darker</span>
$<span class="w"> </span>darker<span class="w"> </span>test.py<span class="w">                   </span><span class="c1"># format uncommitted changes</span>
$<span class="w"> </span>darker<span class="w"> </span>-r<span class="w"> </span>HEAD^<span class="w"> </span>test.py<span class="w">          </span><span class="c1"># also format changes from last commit</span>
$<span class="w"> </span>black<span class="w"> </span>test.py<span class="w">                    </span><span class="c1"># format entire file</span>
</pre></div>
</div>
<p>Instead of individual file names, you can specify directories to
darker, and it will find the changed files. However, if a directory is
large, like a clone of the LLVM repository, darker can be painfully
slow. In that case, you might wish to use git to list changed files.
For example:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>darker<span class="w"> </span>-r<span class="w"> </span>HEAD^<span class="w"> </span><span class="k">$(</span>git<span class="w"> </span>diff<span class="w"> </span>--name-only<span class="w"> </span>--diff-filter<span class="o">=</span>d<span class="w"> </span>HEAD^<span class="k">)</span>
</pre></div>
</div>
</section>
</section>
<section id="mechanical-source-issues">
<h2><a class="toc-backref" href="#id6" role="doc-backlink">Mechanical Source Issues</a><a class="headerlink" href="#mechanical-source-issues" title="Permalink to this heading">¶</a></h2>
<section id="source-code-formatting">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">Source Code Formatting</a><a class="headerlink" href="#source-code-formatting" title="Permalink to this heading">¶</a></h3>
<section id="commenting">
<h4><a class="toc-backref" href="#id8" role="doc-backlink">Commenting</a><a class="headerlink" href="#commenting" title="Permalink to this heading">¶</a></h4>
<p>Comments are important for readability and maintainability. When writing comments,
write them as English prose, using proper capitalization, punctuation, etc.
Aim to describe what the code is trying to do and why, not <em>how</em> it does it at
a micro level. Here are a few important things to document:</p>
<section id="file-headers">
<span id="header-file-comment"></span><h5><a class="toc-backref" href="#id9" role="doc-backlink">File Headers</a><a class="headerlink" href="#file-headers" title="Permalink to this heading">¶</a></h5>
<p>Every source file should have a header on it that describes the basic purpose of
the file. The standard header looks like this:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">//===-- llvm/Instruction.h - Instruction class definition -------*- C++ -*-===//</span>
<span class="c1">//</span>
<span class="c1">// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.</span>
<span class="c1">// See https://llvm.org/LICENSE.txt for license information.</span>
<span class="c1">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">///</span>
<span class="c1">/// \file</span>
<span class="c1">/// This file contains the declaration of the Instruction class, which is the</span>
<span class="c1">/// base class for all of the VM instructions.</span>
<span class="c1">///</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
</pre></div>
</div>
<p>A few things to note about this particular format: The “<code class="docutils literal notranslate"><span class="pre">-*-</span> <span class="pre">C++</span> <span class="pre">-*-</span></code>” string
on the first line is there to tell Emacs that the source file is a C++ file, not
a C file (Emacs assumes <code class="docutils literal notranslate"><span class="pre">.h</span></code> files are C files by default).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This tag is not necessary in <code class="docutils literal notranslate"><span class="pre">.cpp</span></code> files.  The name of the file is also
on the first line, along with a very short description of the purpose of the
file.</p>
</div>
<p>The next section in the file is a concise note that defines the license that the
file is released under.  This makes it perfectly clear what terms the source
code can be distributed under and should not be modified in any way.</p>
<p>The main body is a <a class="reference external" href="http://www.doxygen.nl/">Doxygen</a> comment (identified by
the <code class="docutils literal notranslate"><span class="pre">///</span></code> comment marker instead of the usual <code class="docutils literal notranslate"><span class="pre">//</span></code>) describing the purpose
of the file.  The first sentence (or a passage beginning with <code class="docutils literal notranslate"><span class="pre">\brief</span></code>) is
used as an abstract.  Any additional information should be separated by a blank
line.  If an algorithm is based on a paper or is described in another source,
provide a reference.</p>
</section>
<section id="header-guard">
<h5><a class="toc-backref" href="#id10" role="doc-backlink">Header Guard</a><a class="headerlink" href="#header-guard" title="Permalink to this heading">¶</a></h5>
<p>The header file’s guard should be the all-caps path that a user of this header
would #include, using ‘_’ instead of path separator and extension marker.
For example, the header file
<code class="docutils literal notranslate"><span class="pre">llvm/include/llvm/Analysis/Utils/Local.h</span></code> would be <code class="docutils literal notranslate"><span class="pre">#include</span></code>-ed as
<code class="docutils literal notranslate"><span class="pre">#include</span> <span class="pre">&quot;llvm/Analysis/Utils/Local.h&quot;</span></code>, so its guard is
<code class="docutils literal notranslate"><span class="pre">LLVM_ANALYSIS_UTILS_LOCAL_H</span></code>.</p>
</section>
<section id="class-overviews">
<h5><a class="toc-backref" href="#id11" role="doc-backlink">Class overviews</a><a class="headerlink" href="#class-overviews" title="Permalink to this heading">¶</a></h5>
<p>Classes are a fundamental part of an object-oriented design.  As such, a
class definition should have a comment block that explains what the class is
used for and how it works.  Every non-trivial class is expected to have a
<code class="docutils literal notranslate"><span class="pre">doxygen</span></code> comment block.</p>
</section>
<section id="method-information">
<h5><a class="toc-backref" href="#id12" role="doc-backlink">Method information</a><a class="headerlink" href="#method-information" title="Permalink to this heading">¶</a></h5>
<p>Methods and global functions should also be documented.  A quick note about
what it does and a description of the edge cases is all that is necessary here.
The reader should be able to understand how to use interfaces without reading
the code itself.</p>
<p>Good things to talk about here are what happens when something unexpected
happens, for instance, does the method return null?</p>
</section>
</section>
<section id="comment-formatting">
<h4><a class="toc-backref" href="#id13" role="doc-backlink">Comment Formatting</a><a class="headerlink" href="#comment-formatting" title="Permalink to this heading">¶</a></h4>
<p>In general, prefer C++-style comments (<code class="docutils literal notranslate"><span class="pre">//</span></code> for normal comments, <code class="docutils literal notranslate"><span class="pre">///</span></code> for
<code class="docutils literal notranslate"><span class="pre">doxygen</span></code> documentation comments).  There are a few cases when it is
useful to use C-style (<code class="docutils literal notranslate"><span class="pre">/*</span> <span class="pre">*/</span></code>) comments however:</p>
<ol class="arabic">
<li><p>When writing C code to be compatible with C89.</p></li>
<li><p>When writing a header file that may be <code class="docutils literal notranslate"><span class="pre">#include</span></code>d by a C source file.</p></li>
<li><p>When writing a source file that is used by a tool that only accepts C-style
comments.</p></li>
<li><p>When documenting the significance of constants used as actual parameters in
a call. This is most helpful for <code class="docutils literal notranslate"><span class="pre">bool</span></code> parameters, or passing <code class="docutils literal notranslate"><span class="pre">0</span></code> or
<code class="docutils literal notranslate"><span class="pre">nullptr</span></code>. The comment should contain the parameter name, which ought to be
meaningful. For example, it’s not clear what the parameter means in this call:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">Object</span><span class="p">.</span><span class="n">emitName</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span>
</pre></div>
</div>
<p>An in-line C-style comment makes the intent obvious:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">Object</span><span class="p">.</span><span class="n">emitName</span><span class="p">(</span><span class="cm">/*Prefix=*/</span><span class="k">nullptr</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ol>
<p>Commenting out large blocks of code is discouraged, but if you really have to do
this (for documentation purposes or as a suggestion for debug printing), use
<code class="docutils literal notranslate"><span class="pre">#if</span> <span class="pre">0</span></code> and <code class="docutils literal notranslate"><span class="pre">#endif</span></code>. These nest properly and are better behaved in general
than C style comments.</p>
</section>
<section id="doxygen-use-in-documentation-comments">
<h4><a class="toc-backref" href="#id14" role="doc-backlink">Doxygen Use in Documentation Comments</a><a class="headerlink" href="#doxygen-use-in-documentation-comments" title="Permalink to this heading">¶</a></h4>
<p>Use the <code class="docutils literal notranslate"><span class="pre">\file</span></code> command to turn the standard file header into a file-level
comment.</p>
<p>Include descriptive paragraphs for all public interfaces (public classes,
member and non-member functions).  Avoid restating the information that can
be inferred from the API name.  The first sentence (or a paragraph beginning
with <code class="docutils literal notranslate"><span class="pre">\brief</span></code>) is used as an abstract. Try to use a single sentence as the
<code class="docutils literal notranslate"><span class="pre">\brief</span></code> adds visual clutter.  Put detailed discussion into separate
paragraphs.</p>
<p>To refer to parameter names inside a paragraph, use the <code class="docutils literal notranslate"><span class="pre">\p</span> <span class="pre">name</span></code> command.
Don’t use the <code class="docutils literal notranslate"><span class="pre">\arg</span> <span class="pre">name</span></code> command since it starts a new paragraph that
contains documentation for the parameter.</p>
<p>Wrap non-inline code examples in <code class="docutils literal notranslate"><span class="pre">\code</span> <span class="pre">...</span> <span class="pre">\endcode</span></code>.</p>
<p>To document a function parameter, start a new paragraph with the
<code class="docutils literal notranslate"><span class="pre">\param</span> <span class="pre">name</span></code> command.  If the parameter is used as an out or an in/out
parameter, use the <code class="docutils literal notranslate"><span class="pre">\param</span> <span class="pre">[out]</span> <span class="pre">name</span></code> or <code class="docutils literal notranslate"><span class="pre">\param</span> <span class="pre">[in,out]</span> <span class="pre">name</span></code> command,
respectively.</p>
<p>To describe function return value, start a new paragraph with the <code class="docutils literal notranslate"><span class="pre">\returns</span></code>
command.</p>
<p>A minimal documentation comment:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">/// Sets the xyzzy property to \p Baz.</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">setXyzzy</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">Baz</span><span class="p">);</span>
</pre></div>
</div>
<p>A documentation comment that uses all Doxygen features in a preferred way:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">/// Does foo and bar.</span>
<span class="c1">///</span>
<span class="c1">/// Does not do foo the usual way if \p Baz is true.</span>
<span class="c1">///</span>
<span class="c1">/// Typical usage:</span>
<span class="c1">/// \code</span>
<span class="c1">///   fooBar(false, &quot;quux&quot;, Res);</span>
<span class="c1">/// \endcode</span>
<span class="c1">///</span>
<span class="c1">/// \param Quux kind of foo to do.</span>
<span class="c1">/// \param [out] Result filled with bar sequence on foo success.</span>
<span class="c1">///</span>
<span class="c1">/// \returns true on success.</span>
<span class="kt">bool</span><span class="w"> </span><span class="nf">fooBar</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">Baz</span><span class="p">,</span><span class="w"> </span><span class="n">StringRef</span><span class="w"> </span><span class="n">Quux</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Result</span><span class="p">);</span>
</pre></div>
</div>
<p>Don’t duplicate the documentation comment in the header file and in the
implementation file.  Put the documentation comments for public APIs into the
header file.  Documentation comments for private APIs can go to the
implementation file.  In any case, implementation files can include additional
comments (not necessarily in Doxygen markup) to explain implementation details
as needed.</p>
<p>Don’t duplicate function or class name at the beginning of the comment.
For humans it is obvious which function or class is being documented;
automatic documentation processing tools are smart enough to bind the comment
to the correct declaration.</p>
<p>Avoid:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Example.h:</span>

<span class="c1">// example - Does something important.</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">example</span><span class="p">();</span>

<span class="c1">// Example.cpp:</span>

<span class="c1">// example - Does something important.</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">example</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
<p>Preferred:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Example.h:</span>

<span class="c1">/// Does something important.</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">example</span><span class="p">();</span>

<span class="c1">// Example.cpp:</span>

<span class="c1">/// Builds a B-tree in order to do foo.  See paper by...</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">example</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="error-and-warning-messages">
<h4><a class="toc-backref" href="#id15" role="doc-backlink">Error and Warning Messages</a><a class="headerlink" href="#error-and-warning-messages" title="Permalink to this heading">¶</a></h4>
<p>Clear diagnostic messages are important to help users identify and fix issues in
their inputs. Use succinct but correct English prose that gives the user the
context needed to understand what went wrong. Also, to match error message
styles commonly produced by other tools, start the first sentence with a
lower-case letter, and finish the last sentence without a period, if it would
end in one otherwise. Sentences which end with different punctuation, such as
“did you forget ‘;’?”, should still do so.</p>
<p>For example this is a good error message:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>error: file.o: section header 3 is corrupt. Size is 10 when it should be 20
</pre></div>
</div>
<p>This is a bad message, since it does not provide useful information and uses the
wrong style:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>error: file.o: Corrupt section header.
</pre></div>
</div>
<p>As with other coding standards, individual projects, such as the Clang Static
Analyzer, may have preexisting styles that do not conform to this. If a
different formatting scheme is used consistently throughout the project, use
that style instead. Otherwise, this standard applies to all LLVM tools,
including clang, clang-tidy, and so on.</p>
<p>If the tool or project does not have existing functions to emit warnings or
errors, use the error and warning handlers provided in <code class="docutils literal notranslate"><span class="pre">Support/WithColor.h</span></code>
to ensure they are printed in the appropriate style, rather than printing to
stderr directly.</p>
<p>When using <code class="docutils literal notranslate"><span class="pre">report_fatal_error</span></code>, follow the same standards for the message as
regular error messages. Assertion messages and <code class="docutils literal notranslate"><span class="pre">llvm_unreachable</span></code> calls do not
necessarily need to follow these same styles as they are automatically
formatted, and thus these guidelines may not be suitable.</p>
</section>
<section id="include-style">
<h4><a class="toc-backref" href="#id16" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">#include</span></code> Style</a><a class="headerlink" href="#include-style" title="Permalink to this heading">¶</a></h4>
<p>Immediately after the <a class="reference internal" href="#header-file-comment">header file comment</a> (and include guards if working on a
header file), the <a class="reference internal" href="#minimal-list-of-includes">minimal list of #includes</a> required by the file should be
listed.  We prefer these <code class="docutils literal notranslate"><span class="pre">#include</span></code>s to be listed in this order:</p>
<span id="main-module-header"></span><ol class="arabic simple" id="local-private-headers">
<li><p>Main Module Header</p></li>
<li><p>Local/Private Headers</p></li>
<li><p>LLVM project/subproject headers (<code class="docutils literal notranslate"><span class="pre">clang/...</span></code>, <code class="docutils literal notranslate"><span class="pre">lldb/...</span></code>, <code class="docutils literal notranslate"><span class="pre">llvm/...</span></code>, etc)</p></li>
<li><p>System <code class="docutils literal notranslate"><span class="pre">#include</span></code>s</p></li>
</ol>
<p>and each category should be sorted lexicographically by the full path.</p>
<p>The <a class="reference internal" href="#main-module-header">Main Module Header</a> file applies to <code class="docutils literal notranslate"><span class="pre">.cpp</span></code> files which implement an
interface defined by a <code class="docutils literal notranslate"><span class="pre">.h</span></code> file.  This <code class="docutils literal notranslate"><span class="pre">#include</span></code> should always be included
<strong>first</strong> regardless of where it lives on the file system.  By including a
header file first in the <code class="docutils literal notranslate"><span class="pre">.cpp</span></code> files that implement the interfaces, we ensure
that the header does not have any hidden dependencies which are not explicitly
<code class="docutils literal notranslate"><span class="pre">#include</span></code>d in the header, but should be. It is also a form of documentation
in the <code class="docutils literal notranslate"><span class="pre">.cpp</span></code> file to indicate where the interfaces it implements are defined.</p>
<p>LLVM project and subproject headers should be grouped from most specific to least
specific, for the same reasons described above.  For example, LLDB depends on
both clang and LLVM, and clang depends on LLVM.  So an LLDB source file should
include <code class="docutils literal notranslate"><span class="pre">lldb</span></code> headers first, followed by <code class="docutils literal notranslate"><span class="pre">clang</span></code> headers, followed by
<code class="docutils literal notranslate"><span class="pre">llvm</span></code> headers, to reduce the possibility (for example) of an LLDB header
accidentally picking up a missing include due to the previous inclusion of that
header in the main source file or some earlier header file.  clang should
similarly include its own headers before including llvm headers.  This rule
applies to all LLVM subprojects.</p>
</section>
<section id="source-code-width">
<span id="fit-into-80-columns"></span><h4><a class="toc-backref" href="#id17" role="doc-backlink">Source Code Width</a><a class="headerlink" href="#source-code-width" title="Permalink to this heading">¶</a></h4>
<p>Write your code to fit within 80 columns.</p>
<p>There must be some limit to the width of the code in
order to allow developers to have multiple files side-by-side in
windows on a modest display.  If you are going to pick a width limit, it is
somewhat arbitrary but you might as well pick something standard.  Going with 90
columns (for example) instead of 80 columns wouldn’t add any significant value
and would be detrimental to printing out code.  Also many other projects have
standardized on 80 columns, so some people have already configured their editors
for it (vs something else, like 90 columns).</p>
</section>
<section id="whitespace">
<h4><a class="toc-backref" href="#id18" role="doc-backlink">Whitespace</a><a class="headerlink" href="#whitespace" title="Permalink to this heading">¶</a></h4>
<p>In all cases, prefer spaces to tabs in source files.  People have different
preferred indentation levels, and different styles of indentation that they
like; this is fine.  What isn’t fine is that different editors/viewers expand
tabs out to different tab stops.  This can cause your code to look completely
unreadable, and it is not worth dealing with.</p>
<p>As always, follow the <a class="reference internal" href="#golden-rule">Golden Rule</a> above: follow the style of existing code
if you are modifying and extending it.</p>
<p>Do not add trailing whitespace.  Some common editors will automatically remove
trailing whitespace when saving a file which causes unrelated changes to appear
in diffs and commits.</p>
<section id="format-lambdas-like-blocks-of-code">
<h5><a class="toc-backref" href="#id19" role="doc-backlink">Format Lambdas Like Blocks Of Code</a><a class="headerlink" href="#format-lambdas-like-blocks-of-code" title="Permalink to this heading">¶</a></h5>
<p>When formatting a multi-line lambda, format it like a block of code. If there
is only one multi-line lambda in a statement, and there are no expressions
lexically after it in the statement, drop the indent to the standard two space
indent for a block of code, as if it were an if-block opened by the preceding
part of the statement:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span><span class="n">foo</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">Foo</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">Foo</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">blah</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">blah</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">baz</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">baz</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">bam</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">bam</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>To take best advantage of this formatting, if you are designing an API which
accepts a continuation or single callable argument (be it a function object, or
a <code class="docutils literal notranslate"><span class="pre">std::function</span></code>), it should be the last argument if at all possible.</p>
<p>If there are multiple multi-line lambdas in a statement, or additional
parameters after the lambda, indent the block two spaces from the indent of the
<code class="docutils literal notranslate"><span class="pre">[]</span></code>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">dyn_switch</span><span class="p">(</span><span class="n">V</span><span class="o">-&gt;</span><span class="n">stripPointerCasts</span><span class="p">(),</span>
<span class="w">           </span><span class="p">[]</span><span class="w"> </span><span class="p">(</span><span class="n">PHINode</span><span class="w"> </span><span class="o">*</span><span class="n">PN</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="c1">// process phis...</span>
<span class="w">           </span><span class="p">},</span>
<span class="w">           </span><span class="p">[]</span><span class="w"> </span><span class="p">(</span><span class="n">SelectInst</span><span class="w"> </span><span class="o">*</span><span class="n">SI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="c1">// process selects...</span>
<span class="w">           </span><span class="p">},</span>
<span class="w">           </span><span class="p">[]</span><span class="w"> </span><span class="p">(</span><span class="n">LoadInst</span><span class="w"> </span><span class="o">*</span><span class="n">LI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="c1">// process loads...</span>
<span class="w">           </span><span class="p">},</span>
<span class="w">           </span><span class="p">[]</span><span class="w"> </span><span class="p">(</span><span class="n">AllocaInst</span><span class="w"> </span><span class="o">*</span><span class="n">AI</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="c1">// process allocas...</span>
<span class="w">           </span><span class="p">});</span>
</pre></div>
</div>
</section>
<section id="braced-initializer-lists">
<h5><a class="toc-backref" href="#id20" role="doc-backlink">Braced Initializer Lists</a><a class="headerlink" href="#braced-initializer-lists" title="Permalink to this heading">¶</a></h5>
<p>Starting from C++11, there are significantly more uses of braced lists to
perform initialization. For example, they can be used to construct aggregate
temporaries in expressions. They now have a natural way of ending up nested
within each other and within function calls in order to build up aggregates
(such as option structs) from local variables.</p>
<p>The historically common formatting of braced initialization of aggregate
variables does not mix cleanly with deep nesting, general expression contexts,
function arguments, and lambdas. We suggest new code use a simple rule for
formatting braced initialization lists: act as-if the braces were parentheses
in a function call. The formatting rules exactly match those already well
understood for formatting nested function calls. Examples:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">foo</span><span class="p">({</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">});</span>

<span class="n">llvm</span><span class="o">::</span><span class="n">Constant</span><span class="w"> </span><span class="o">*</span><span class="n">Mask</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">getLLVMContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">getLLVMContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span>
<span class="w">    </span><span class="n">llvm</span><span class="o">::</span><span class="n">ConstantInt</span><span class="o">::</span><span class="n">get</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">Type</span><span class="o">::</span><span class="n">getInt32Ty</span><span class="p">(</span><span class="n">getLLVMContext</span><span class="p">()),</span><span class="w"> </span><span class="mi">2</span><span class="p">)};</span>
</pre></div>
</div>
<p>This formatting scheme also makes it particularly easy to get predictable,
consistent, and automatic formatting with tools like <a class="reference external" href="https://clang.llvm.org/docs/ClangFormat.html">Clang Format</a>.</p>
</section>
</section>
</section>
<section id="language-and-compiler-issues">
<h3><a class="toc-backref" href="#id21" role="doc-backlink">Language and Compiler Issues</a><a class="headerlink" href="#language-and-compiler-issues" title="Permalink to this heading">¶</a></h3>
<section id="treat-compiler-warnings-like-errors">
<h4><a class="toc-backref" href="#id22" role="doc-backlink">Treat Compiler Warnings Like Errors</a><a class="headerlink" href="#treat-compiler-warnings-like-errors" title="Permalink to this heading">¶</a></h4>
<p>Compiler warnings are often useful and help improve the code.  Those that are
not useful, can be often suppressed with a small code change. For example, an
assignment in the <code class="docutils literal notranslate"><span class="pre">if</span></code> condition is often a typo:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getValue</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Several compilers will print a warning for the code above. It can be suppressed
by adding parentheses:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getValue</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="write-portable-code">
<h4><a class="toc-backref" href="#id23" role="doc-backlink">Write Portable Code</a><a class="headerlink" href="#write-portable-code" title="Permalink to this heading">¶</a></h4>
<p>In almost all cases, it is possible to write completely portable code.  When
you need to rely on non-portable code, put it behind a well-defined and
well-documented interface.</p>
</section>
<section id="do-not-use-rtti-or-exceptions">
<h4><a class="toc-backref" href="#id24" role="doc-backlink">Do not use RTTI or Exceptions</a><a class="headerlink" href="#do-not-use-rtti-or-exceptions" title="Permalink to this heading">¶</a></h4>
<p>In an effort to reduce code and executable size, LLVM does not use exceptions
or RTTI (<a class="reference external" href="https://en.wikipedia.org/wiki/Run-time_type_information">runtime type information</a>, for example,
<code class="docutils literal notranslate"><span class="pre">dynamic_cast&lt;&gt;</span></code>).</p>
<p>That said, LLVM does make extensive use of a hand-rolled form of RTTI that use
templates like <a class="reference internal" href="ProgrammersManual.html#isa"><span class="std std-ref">isa&lt;&gt;, cast&lt;&gt;, and dyn_cast&lt;&gt;</span></a>.
This form of RTTI is opt-in and can be
<a class="reference internal" href="HowToSetUpLLVMStyleRTTI.html"><span class="doc">added to any class</span></a>.</p>
</section>
<section id="prefer-c-style-casts">
<h4><a class="toc-backref" href="#id25" role="doc-backlink">Prefer C++-style casts</a><a class="headerlink" href="#prefer-c-style-casts" title="Permalink to this heading">¶</a></h4>
<p>When casting, use <code class="docutils literal notranslate"><span class="pre">static_cast</span></code>, <code class="docutils literal notranslate"><span class="pre">reinterpret_cast</span></code>, and <code class="docutils literal notranslate"><span class="pre">const_cast</span></code>,
rather than C-style casts. There are two exceptions to this:</p>
<ul class="simple">
<li><p>When casting to <code class="docutils literal notranslate"><span class="pre">void</span></code> to suppress warnings about unused variables (as an
alternative to <code class="docutils literal notranslate"><span class="pre">[[maybe_unused]]</span></code>). Prefer C-style casts in this instance.</p></li>
<li><p>When casting between integral types (including enums that are not strongly-
typed), functional-style casts are permitted as an alternative to
<code class="docutils literal notranslate"><span class="pre">static_cast</span></code>.</p></li>
</ul>
</section>
<section id="do-not-use-static-constructors">
<span id="static-constructor"></span><h4><a class="toc-backref" href="#id26" role="doc-backlink">Do not use Static Constructors</a><a class="headerlink" href="#do-not-use-static-constructors" title="Permalink to this heading">¶</a></h4>
<p>Static constructors and destructors (e.g., global variables whose types have a
constructor or destructor) should not be added to the code base, and should be
removed wherever possible.</p>
<p>Globals in different source files are initialized in <a class="reference external" href="https://yosefk.com/c++fqa/ctors.html#fqa-10.12">arbitrary order</a>, making the code more
difficult to reason about.</p>
<p>Static constructors have negative impact on launch time of programs that use
LLVM as a library. We would really like for there to be zero cost for linking
in an additional LLVM target or other library into an application, but static
constructors undermine this goal.</p>
</section>
<section id="use-of-class-and-struct-keywords">
<h4><a class="toc-backref" href="#id27" role="doc-backlink">Use of <code class="docutils literal notranslate"><span class="pre">class</span></code> and <code class="docutils literal notranslate"><span class="pre">struct</span></code> Keywords</a><a class="headerlink" href="#use-of-class-and-struct-keywords" title="Permalink to this heading">¶</a></h4>
<p>In C++, the <code class="docutils literal notranslate"><span class="pre">class</span></code> and <code class="docutils literal notranslate"><span class="pre">struct</span></code> keywords can be used almost
interchangeably. The only difference is when they are used to declare a class:
<code class="docutils literal notranslate"><span class="pre">class</span></code> makes all members private by default while <code class="docutils literal notranslate"><span class="pre">struct</span></code> makes all
members public by default.</p>
<ul class="simple">
<li><p>All declarations and definitions of a given <code class="docutils literal notranslate"><span class="pre">class</span></code> or <code class="docutils literal notranslate"><span class="pre">struct</span></code> must use
the same keyword.  For example:</p></li>
</ul>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Avoid if `Example` is defined as a struct.</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Example</span><span class="p">;</span>

<span class="c1">// OK.</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">Example</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">Example</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">};</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">struct</span></code> should be used when <em>all</em> members are declared public.</p></li>
</ul>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Avoid using `struct` here, use `class` instead.</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">Foo</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">Data</span><span class="p">;</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">Foo</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Data</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">getData</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">Data</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">setData</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">D</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">D</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="p">};</span>

<span class="c1">// OK to use `struct`: all members are public.</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">Bar</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">Data</span><span class="p">;</span>
<span class="w">  </span><span class="n">Bar</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Data</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="do-not-use-braced-initializer-lists-to-call-a-constructor">
<h4><a class="toc-backref" href="#id28" role="doc-backlink">Do not use Braced Initializer Lists to Call a Constructor</a><a class="headerlink" href="#do-not-use-braced-initializer-lists-to-call-a-constructor" title="Permalink to this heading">¶</a></h4>
<p>Starting from C++11 there is a “generalized initialization syntax” which allows
calling constructors using braced initializer lists. Do not use these to call
constructors with non-trivial logic or if you care that you’re calling some
<em>particular</em> constructor. Those should look like function calls using
parentheses rather than like aggregate initialization. Similarly, if you need
to explicitly name the type and call its constructor to create a temporary,
don’t use a braced initializer list. Instead, use a braced initializer list
(without any type for temporaries) when doing aggregate initialization or
something notionally equivalent. Examples:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Foo</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="c1">// Construct a Foo by reading data from the disk in the whizbang format, ...</span>
<span class="w">  </span><span class="n">Foo</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">filename</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Construct a Foo by looking up the Nth element of some global data ...</span>
<span class="w">  </span><span class="n">Foo</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">N</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// ...</span>
<span class="p">};</span>

<span class="c1">// The Foo constructor call is reading a file, don&#39;t use braces to call it.</span>
<span class="n">std</span><span class="o">::</span><span class="n">fill</span><span class="p">(</span><span class="n">foo</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="n">Foo</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">));</span>

<span class="c1">// The pair is being constructed like an aggregate, use braces.</span>
<span class="n">bar_map</span><span class="p">.</span><span class="n">insert</span><span class="p">({</span><span class="n">my_key</span><span class="p">,</span><span class="w"> </span><span class="n">my_value</span><span class="p">});</span>
</pre></div>
</div>
<p>If you use a braced initializer list when initializing a variable, use an equals before the open curly brace:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="n">data</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">};</span>
</pre></div>
</div>
</section>
<section id="use-auto-type-deduction-to-make-code-more-readable">
<h4><a class="toc-backref" href="#id29" role="doc-backlink">Use <code class="docutils literal notranslate"><span class="pre">auto</span></code> Type Deduction to Make Code More Readable</a><a class="headerlink" href="#use-auto-type-deduction-to-make-code-more-readable" title="Permalink to this heading">¶</a></h4>
<p>Some are advocating a policy of “almost always <code class="docutils literal notranslate"><span class="pre">auto</span></code>” in C++11, however LLVM
uses a more moderate stance. Use <code class="docutils literal notranslate"><span class="pre">auto</span></code> if and only if it makes the code more
readable or easier to maintain. Don’t “almost always” use <code class="docutils literal notranslate"><span class="pre">auto</span></code>, but do use
<code class="docutils literal notranslate"><span class="pre">auto</span></code> with initializers like <code class="docutils literal notranslate"><span class="pre">cast&lt;Foo&gt;(...)</span></code> or other places where the
type is already obvious from the context. Another time when <code class="docutils literal notranslate"><span class="pre">auto</span></code> works well
for these purposes is when the type would have been abstracted away anyways,
often behind a container’s typedef such as <code class="docutils literal notranslate"><span class="pre">std::vector&lt;T&gt;::iterator</span></code>.</p>
<p>Similarly, C++14 adds generic lambda expressions where parameter types can be
<code class="docutils literal notranslate"><span class="pre">auto</span></code>. Use these where you would have used a template.</p>
</section>
<section id="beware-unnecessary-copies-with-auto">
<h4><a class="toc-backref" href="#id30" role="doc-backlink">Beware unnecessary copies with <code class="docutils literal notranslate"><span class="pre">auto</span></code></a><a class="headerlink" href="#beware-unnecessary-copies-with-auto" title="Permalink to this heading">¶</a></h4>
<p>The convenience of <code class="docutils literal notranslate"><span class="pre">auto</span></code> makes it easy to forget that its default behavior
is a copy.  Particularly in range-based <code class="docutils literal notranslate"><span class="pre">for</span></code> loops, careless copies are
expensive.</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">auto</span> <span class="pre">&amp;</span></code> for values and <code class="docutils literal notranslate"><span class="pre">auto</span> <span class="pre">*</span></code> for pointers unless you need to make a
copy.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Typically there&#39;s no reason to copy.</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Val</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Container</span><span class="p">)</span><span class="w"> </span><span class="n">observe</span><span class="p">(</span><span class="n">Val</span><span class="p">);</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Val</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Container</span><span class="p">)</span><span class="w"> </span><span class="n">Val</span><span class="p">.</span><span class="n">change</span><span class="p">();</span>

<span class="c1">// Remove the reference if you really want a new copy.</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">Val</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Container</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">Val</span><span class="p">.</span><span class="n">change</span><span class="p">();</span><span class="w"> </span><span class="n">saveSomewhere</span><span class="p">(</span><span class="n">Val</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="c1">// Copy pointers, but make it clear that they&#39;re pointers.</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">Ptr</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Container</span><span class="p">)</span><span class="w"> </span><span class="n">observe</span><span class="p">(</span><span class="o">*</span><span class="n">Ptr</span><span class="p">);</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">Ptr</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Container</span><span class="p">)</span><span class="w"> </span><span class="n">Ptr</span><span class="o">-&gt;</span><span class="n">change</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="beware-of-non-determinism-due-to-ordering-of-pointers">
<h4><a class="toc-backref" href="#id31" role="doc-backlink">Beware of non-determinism due to ordering of pointers</a><a class="headerlink" href="#beware-of-non-determinism-due-to-ordering-of-pointers" title="Permalink to this heading">¶</a></h4>
<p>In general, there is no relative ordering among pointers. As a result,
when unordered containers like sets and maps are used with pointer keys
the iteration order is undefined. Hence, iterating such containers may
result in non-deterministic code generation. While the generated code
might work correctly, non-determinism can make it harder to reproduce bugs and
debug the compiler.</p>
<p>In case an ordered result is expected, remember to
sort an unordered container before iteration. Or use ordered containers
like <code class="docutils literal notranslate"><span class="pre">vector</span></code>/<code class="docutils literal notranslate"><span class="pre">MapVector</span></code>/<code class="docutils literal notranslate"><span class="pre">SetVector</span></code> if you want to iterate pointer
keys.</p>
</section>
<section id="beware-of-non-deterministic-sorting-order-of-equal-elements">
<h4><a class="toc-backref" href="#id32" role="doc-backlink">Beware of non-deterministic sorting order of equal elements</a><a class="headerlink" href="#beware-of-non-deterministic-sorting-order-of-equal-elements" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">std::sort</span></code> uses a non-stable sorting algorithm in which the order of equal
elements is not guaranteed to be preserved. Thus using <code class="docutils literal notranslate"><span class="pre">std::sort</span></code> for a
container having equal elements may result in non-deterministic behavior.
To uncover such instances of non-determinism, LLVM has introduced a new
llvm::sort wrapper function. For an EXPENSIVE_CHECKS build this will randomly
shuffle the container before sorting. Default to using <code class="docutils literal notranslate"><span class="pre">llvm::sort</span></code> instead
of <code class="docutils literal notranslate"><span class="pre">std::sort</span></code>.</p>
</section>
</section>
</section>
<section id="style-issues">
<h2><a class="toc-backref" href="#id33" role="doc-backlink">Style Issues</a><a class="headerlink" href="#style-issues" title="Permalink to this heading">¶</a></h2>
<section id="the-high-level-issues">
<h3><a class="toc-backref" href="#id34" role="doc-backlink">The High-Level Issues</a><a class="headerlink" href="#the-high-level-issues" title="Permalink to this heading">¶</a></h3>
<section id="self-contained-headers">
<h4><a class="toc-backref" href="#id35" role="doc-backlink">Self-contained Headers</a><a class="headerlink" href="#self-contained-headers" title="Permalink to this heading">¶</a></h4>
<p>Header files should be self-contained (compile on their own) and end in <code class="docutils literal notranslate"><span class="pre">.h</span></code>.
Non-header files that are meant for inclusion should end in <code class="docutils literal notranslate"><span class="pre">.inc</span></code> and be
used sparingly.</p>
<p>All header files should be self-contained. Users and refactoring tools should
not have to adhere to special conditions to include the header. Specifically, a
header should have header guards and include all other headers it needs.</p>
<p>There are rare cases where a file designed to be included is not
self-contained. These are typically intended to be included at unusual
locations, such as the middle of another file. They might not use header
guards, and might not include their prerequisites. Name such files with the
.inc extension. Use sparingly, and prefer self-contained headers when possible.</p>
<p>In general, a header should be implemented by one or more <code class="docutils literal notranslate"><span class="pre">.cpp</span></code> files.  Each
of these <code class="docutils literal notranslate"><span class="pre">.cpp</span></code> files should include the header that defines their interface
first.  This ensures that all of the dependences of the header have been
properly added to the header itself, and are not implicit.  System headers
should be included after user headers for a translation unit.</p>
</section>
<section id="library-layering">
<h4><a class="toc-backref" href="#id36" role="doc-backlink">Library Layering</a><a class="headerlink" href="#library-layering" title="Permalink to this heading">¶</a></h4>
<p>A directory of header files (for example <code class="docutils literal notranslate"><span class="pre">include/llvm/Foo</span></code>) defines a
library (<code class="docutils literal notranslate"><span class="pre">Foo</span></code>). One library (both
its headers and implementation) should only use things from the libraries
listed in its dependencies.</p>
<p>Some of this constraint can be enforced by classic Unix linkers (Mac &amp; Windows
linkers, as well as lld, do not enforce this constraint). A Unix linker
searches left to right through the libraries specified on its command line and
never revisits a library. In this way, no circular dependencies between
libraries can exist.</p>
<p>This doesn’t fully enforce all inter-library dependencies, and importantly
doesn’t enforce header file circular dependencies created by inline functions.
A good way to answer the “is this layered correctly” would be to consider
whether a Unix linker would succeed at linking the program if all inline
functions were defined out-of-line. (&amp; for all valid orderings of dependencies
- since linking resolution is linear, it’s possible that some implicit
dependencies can sneak through: A depends on B and C, so valid orderings are
“C B A” or “B C A”, in both cases the explicit dependencies come before their
use. But in the first case, B could still link successfully if it implicitly
depended on C, or the opposite in the second case)</p>
</section>
<section id="include-as-little-as-possible">
<span id="minimal-list-of-includes"></span><h4><a class="toc-backref" href="#id37" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">#include</span></code> as Little as Possible</a><a class="headerlink" href="#include-as-little-as-possible" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">#include</span></code> hurts compile time performance.  Don’t do it unless you have to,
especially in header files.</p>
<p>But wait! Sometimes you need to have the definition of a class to use it, or to
inherit from it.  In these cases go ahead and <code class="docutils literal notranslate"><span class="pre">#include</span></code> that header file.  Be
aware however that there are many cases where you don’t need to have the full
definition of a class.  If you are using a pointer or reference to a class, you
don’t need the header file.  If you are simply returning a class instance from a
prototyped function or method, you don’t need it.  In fact, for most cases, you
simply don’t need the definition of a class. And not <code class="docutils literal notranslate"><span class="pre">#include</span></code>ing speeds up
compilation.</p>
<p>It is easy to try to go too overboard on this recommendation, however.  You
<strong>must</strong> include all of the header files that you are using — you can include
them either directly or indirectly through another header file.  To make sure
that you don’t accidentally forget to include a header file in your module
header, make sure to include your module header <strong>first</strong> in the implementation
file (as mentioned above).  This way there won’t be any hidden dependencies that
you’ll find out about later.</p>
</section>
<section id="keep-internal-headers-private">
<h4><a class="toc-backref" href="#id38" role="doc-backlink">Keep “Internal” Headers Private</a><a class="headerlink" href="#keep-internal-headers-private" title="Permalink to this heading">¶</a></h4>
<p>Many modules have a complex implementation that causes them to use more than one
implementation (<code class="docutils literal notranslate"><span class="pre">.cpp</span></code>) file.  It is often tempting to put the internal
communication interface (helper classes, extra functions, etc) in the public
module header file.  Don’t do this!</p>
<p>If you really need to do something like this, put a private header file in the
same directory as the source files, and include it locally.  This ensures that
your private interface remains private and undisturbed by outsiders.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It’s okay to put extra implementation methods in a public class itself. Just
make them private (or protected) and all is well.</p>
</div>
</section>
<section id="use-namespace-qualifiers-to-implement-previously-declared-functions">
<h4><a class="toc-backref" href="#id39" role="doc-backlink">Use Namespace Qualifiers to Implement Previously Declared Functions</a><a class="headerlink" href="#use-namespace-qualifiers-to-implement-previously-declared-functions" title="Permalink to this heading">¶</a></h4>
<p>When providing an out of line implementation of a function in a source file, do
not open namespace blocks in the source file. Instead, use namespace qualifiers
to help ensure that your definition matches an existing declaration. Do this:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Foo.h</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">llvm</span><span class="w"> </span><span class="p">{</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Foo.cpp</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Foo.h&quot;</span>
<span class="k">using</span><span class="w"> </span><span class="k">namespace</span><span class="w"> </span><span class="nn">llvm</span><span class="p">;</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">llvm::foo</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Doing this helps to avoid bugs where the definition does not match the
declaration from the header. For example, the following C++ code defines a new
overload of <code class="docutils literal notranslate"><span class="pre">llvm::foo</span></code> instead of providing a definition for the existing
function declared in the header:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Foo.cpp</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;Foo.h&quot;</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">llvm</span><span class="w"> </span><span class="p">{</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Mismatch between &quot;const char *&quot; and &quot;char *&quot;</span>
<span class="p">}</span>
<span class="p">}</span><span class="w"> </span><span class="c1">// namespace llvm</span>
</pre></div>
</div>
<p>This error will not be caught until the build is nearly complete, when the
linker fails to find a definition for any uses of the original function.  If the
function were instead defined with a namespace qualifier, the error would have
been caught immediately when the definition was compiled.</p>
<p>Class method implementations must already name the class and new overloads
cannot be introduced out of line, so this recommendation does not apply to them.</p>
</section>
<section id="use-early-exits-and-continue-to-simplify-code">
<span id="early-exits"></span><h4><a class="toc-backref" href="#id40" role="doc-backlink">Use Early Exits and <code class="docutils literal notranslate"><span class="pre">continue</span></code> to Simplify Code</a><a class="headerlink" href="#use-early-exits-and-continue-to-simplify-code" title="Permalink to this heading">¶</a></h4>
<p>When reading code, keep in mind how much state and how many previous decisions
have to be remembered by the reader to understand a block of code.  Aim to
reduce indentation where possible when it doesn’t make it more difficult to
understand the code.  One great way to do this is by making use of early exits
and the <code class="docutils literal notranslate"><span class="pre">continue</span></code> keyword in long loops. Consider this code that does not
use an early exit:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="nf">doSomething</span><span class="p">(</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">I</span><span class="o">-&gt;</span><span class="n">isTerminator</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="n">I</span><span class="o">-&gt;</span><span class="n">hasOneUse</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">doOtherThing</span><span class="p">(</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">...</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="p">....</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This code has several problems if the body of the <code class="docutils literal notranslate"><span class="pre">'if'</span></code> is large.  When
you’re looking at the top of the function, it isn’t immediately clear that this
<em>only</em> does interesting things with non-terminator instructions, and only
applies to things with the other predicates.  Second, it is relatively difficult
to describe (in comments) why these predicates are important because the <code class="docutils literal notranslate"><span class="pre">if</span></code>
statement makes it difficult to lay out the comments.  Third, when you’re deep
within the body of the code, it is indented an extra level.  Finally, when
reading the top of the function, it isn’t clear what the result is if the
predicate isn’t true; you have to read to the end of the function to know that
it returns null.</p>
<p>It is much preferred to format the code like this:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="nf">doSomething</span><span class="p">(</span><span class="n">Instruction</span><span class="w"> </span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Terminators never need &#39;something&#39; done to them because ...</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">I</span><span class="o">-&gt;</span><span class="n">isTerminator</span><span class="p">())</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// We conservatively avoid transforming instructions with multiple uses</span>
<span class="w">  </span><span class="c1">// because goats like cheese.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">I</span><span class="o">-&gt;</span><span class="n">hasOneUse</span><span class="p">())</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// This is really just here for example.</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">doOtherThing</span><span class="p">(</span><span class="n">I</span><span class="p">))</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="p">...</span><span class="w"> </span><span class="n">some</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">code</span><span class="w"> </span><span class="p">....</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This fixes these problems.  A similar problem frequently happens in <code class="docutils literal notranslate"><span class="pre">for</span></code>
loops.  A silly example is something like this:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Instruction</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">BB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">BO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">BinaryOperator</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">LHS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BO</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">RHS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BO</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">LHS</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">RHS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="p">...</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When you have very, very small loops, this sort of structure is fine. But if it
exceeds more than 10-15 lines, it becomes difficult for people to read and
understand at a glance. The problem with this sort of code is that it gets very
nested very quickly. Meaning that the reader of the code has to keep a lot of
context in their brain to remember what is going immediately on in the loop,
because they don’t know if/when the <code class="docutils literal notranslate"><span class="pre">if</span></code> conditions will have <code class="docutils literal notranslate"><span class="pre">else</span></code>s etc.
It is strongly preferred to structure the loop like this:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Instruction</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">BB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">BO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">BinaryOperator</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">I</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">BO</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>

<span class="w">  </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">LHS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BO</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="n">RHS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BO</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">LHS</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">RHS</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>

<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This has all the benefits of using early exits for functions: it reduces nesting
of the loop, it makes it easier to describe why the conditions are true, and it
makes it obvious to the reader that there is no <code class="docutils literal notranslate"><span class="pre">else</span></code> coming up that they
have to push context into their brain for.  If a loop is large, this can be a
big understandability win.</p>
</section>
<section id="don-t-use-else-after-a-return">
<h4><a class="toc-backref" href="#id41" role="doc-backlink">Don’t use <code class="docutils literal notranslate"><span class="pre">else</span></code> after a <code class="docutils literal notranslate"><span class="pre">return</span></code></a><a class="headerlink" href="#don-t-use-else-after-a-return" title="Permalink to this heading">¶</a></h4>
<p>For similar reasons as above (reduction of indentation and easier reading), please
do not use <code class="docutils literal notranslate"><span class="pre">'else'</span></code> or <code class="docutils literal notranslate"><span class="pre">'else</span> <span class="pre">if'</span></code> after something that interrupts control
flow — like <code class="docutils literal notranslate"><span class="pre">return</span></code>, <code class="docutils literal notranslate"><span class="pre">break</span></code>, <code class="docutils literal notranslate"><span class="pre">continue</span></code>, <code class="docutils literal notranslate"><span class="pre">goto</span></code>, etc. For example:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;J&#39;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Signed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="n">getsigjmp_bufType</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Type</span><span class="p">.</span><span class="n">isNull</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">Error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ASTContext</span><span class="o">::</span><span class="n">GE_Missing_sigjmp_buf</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">QualType</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="c1">// Unnecessary.</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="n">getjmp_bufType</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Type</span><span class="p">.</span><span class="n">isNull</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">Error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ASTContext</span><span class="o">::</span><span class="n">GE_Missing_jmp_buf</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">QualType</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">break</span><span class="p">;</span><span class="w"> </span><span class="c1">// Unnecessary.</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It is better to write it like this:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;J&#39;</span><span class="p">:</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Signed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="n">getsigjmp_bufType</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Type</span><span class="p">.</span><span class="n">isNull</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">Error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ASTContext</span><span class="o">::</span><span class="n">GE_Missing_sigjmp_buf</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">QualType</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="n">getjmp_bufType</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Type</span><span class="p">.</span><span class="n">isNull</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">Error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ASTContext</span><span class="o">::</span><span class="n">GE_Missing_jmp_buf</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">QualType</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">break</span><span class="p">;</span>
</pre></div>
</div>
<p>Or better yet (in this case) as:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;J&#39;</span><span class="p">:</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Signed</span><span class="p">)</span>
<span class="w">    </span><span class="n">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="n">getsigjmp_bufType</span><span class="p">();</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="n">Type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="n">getjmp_bufType</span><span class="p">();</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Type</span><span class="p">.</span><span class="n">isNull</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Signed</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ASTContext</span><span class="o">::</span><span class="n">GE_Missing_sigjmp_buf</span><span class="w"> </span><span class="o">:</span>
<span class="w">                     </span><span class="n">ASTContext</span><span class="o">::</span><span class="n">GE_Missing_jmp_buf</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">QualType</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">break</span><span class="p">;</span>
</pre></div>
</div>
<p>The idea is to reduce indentation and the amount of code you have to keep track
of when reading the code.</p>
<p>Note: this advice does not apply to a <code class="docutils literal notranslate"><span class="pre">constexpr</span> <span class="pre">if</span></code> statement. The
substatement of the <code class="docutils literal notranslate"><span class="pre">else</span></code> clause may be a discarded statement, so removing
the <code class="docutils literal notranslate"><span class="pre">else</span></code> can cause unexpected template instantiations. Thus, the following
example is correct:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="k">static</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">VarTempl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="kt">int</span><span class="w"> </span><span class="n">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="k">constexpr</span><span class="w"> </span><span class="p">(</span><span class="n">VarTempl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="k">static_assert</span><span class="p">(</span><span class="o">!</span><span class="n">VarTempl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="turn-predicate-loops-into-predicate-functions">
<h4><a class="toc-backref" href="#id42" role="doc-backlink">Turn Predicate Loops into Predicate Functions</a><a class="headerlink" href="#turn-predicate-loops-into-predicate-functions" title="Permalink to this heading">¶</a></h4>
<p>It is very common to write small loops that just compute a boolean value.  There
are a number of ways that people commonly write these, but an example of this
sort of thing is:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">bool</span><span class="w"> </span><span class="n">FoundFoo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BarList</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">E</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">I</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">BarList</span><span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">isFoo</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">FoundFoo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="k">break</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FoundFoo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Instead of this sort of loop, we prefer to use a predicate function (which may
be <a class="reference internal" href="#static">static</a>) that uses <a class="reference internal" href="#early-exits">early exits</a>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">/// \returns true if the specified list has an element that is a foo.</span>
<span class="k">static</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nf">containsFoo</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Bar</span><span class="o">*&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">List</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">List</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">E</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">I</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">I</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">isFoo</span><span class="p">())</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">...</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">containsFoo</span><span class="p">(</span><span class="n">BarList</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>There are many reasons for doing this: it reduces indentation and factors out
code which can often be shared by other code that checks for the same predicate.
More importantly, it <em>forces you to pick a name</em> for the function, and forces
you to write a comment for it.  In this silly example, this doesn’t add much
value.  However, if the condition is complex, this can make it a lot easier for
the reader to understand the code that queries for this predicate.  Instead of
being faced with the in-line details of how we check to see if the BarList
contains a foo, we can trust the function name and continue reading with better
locality.</p>
</section>
</section>
<section id="the-low-level-issues">
<h3><a class="toc-backref" href="#id43" role="doc-backlink">The Low-Level Issues</a><a class="headerlink" href="#the-low-level-issues" title="Permalink to this heading">¶</a></h3>
<section id="name-types-functions-variables-and-enumerators-properly">
<h4><a class="toc-backref" href="#id44" role="doc-backlink">Name Types, Functions, Variables, and Enumerators Properly</a><a class="headerlink" href="#name-types-functions-variables-and-enumerators-properly" title="Permalink to this heading">¶</a></h4>
<p>Poorly-chosen names can mislead the reader and cause bugs. We cannot stress
enough how important it is to use <em>descriptive</em> names.  Pick names that match
the semantics and role of the underlying entities, within reason.  Avoid
abbreviations unless they are well known.  After picking a good name, make sure
to use consistent capitalization for the name, as inconsistency requires clients
to either memorize the APIs or to look it up to find the exact spelling.</p>
<p>In general, names should be in camel case (e.g. <code class="docutils literal notranslate"><span class="pre">TextFileReader</span></code> and
<code class="docutils literal notranslate"><span class="pre">isLValue()</span></code>).  Different kinds of declarations have different rules:</p>
<ul>
<li><p><strong>Type names</strong> (including classes, structs, enums, typedefs, etc) should be
nouns and start with an upper-case letter (e.g. <code class="docutils literal notranslate"><span class="pre">TextFileReader</span></code>).</p></li>
<li><p><strong>Variable names</strong> should be nouns (as they represent state).  The name should
be camel case, and start with an upper case letter (e.g. <code class="docutils literal notranslate"><span class="pre">Leader</span></code> or
<code class="docutils literal notranslate"><span class="pre">Boats</span></code>).</p></li>
<li><p><strong>Function names</strong> should be verb phrases (as they represent actions), and
command-like function should be imperative.  The name should be camel case,
and start with a lower case letter (e.g. <code class="docutils literal notranslate"><span class="pre">openFile()</span></code> or <code class="docutils literal notranslate"><span class="pre">isFoo()</span></code>).</p></li>
<li><p><strong>Enum declarations</strong> (e.g. <code class="docutils literal notranslate"><span class="pre">enum</span> <span class="pre">Foo</span> <span class="pre">{...}</span></code>) are types, so they should
follow the naming conventions for types.  A common use for enums is as a
discriminator for a union, or an indicator of a subclass.  When an enum is
used for something like this, it should have a <code class="docutils literal notranslate"><span class="pre">Kind</span></code> suffix
(e.g. <code class="docutils literal notranslate"><span class="pre">ValueKind</span></code>).</p></li>
<li><p><strong>Enumerators</strong> (e.g. <code class="docutils literal notranslate"><span class="pre">enum</span> <span class="pre">{</span> <span class="pre">Foo,</span> <span class="pre">Bar</span> <span class="pre">}</span></code>) and <strong>public member variables</strong>
should start with an upper-case letter, just like types.  Unless the
enumerators are defined in their own small namespace or inside a class,
enumerators should have a prefix corresponding to the enum declaration name.
For example, <code class="docutils literal notranslate"><span class="pre">enum</span> <span class="pre">ValueKind</span> <span class="pre">{</span> <span class="pre">...</span> <span class="pre">};</span></code> may contain enumerators like
<code class="docutils literal notranslate"><span class="pre">VK_Argument</span></code>, <code class="docutils literal notranslate"><span class="pre">VK_BasicBlock</span></code>, etc.  Enumerators that are just
convenience constants are exempt from the requirement for a prefix.  For
instance:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">MaxSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span>
<span class="w">  </span><span class="n">Density</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span>
<span class="p">};</span>
</pre></div>
</div>
</li>
</ul>
<p>As an exception, classes that mimic STL classes can have member names in STL’s
style of lower-case words separated by underscores (e.g. <code class="docutils literal notranslate"><span class="pre">begin()</span></code>,
<code class="docutils literal notranslate"><span class="pre">push_back()</span></code>, and <code class="docutils literal notranslate"><span class="pre">empty()</span></code>). Classes that provide multiple
iterators should add a singular prefix to <code class="docutils literal notranslate"><span class="pre">begin()</span></code> and <code class="docutils literal notranslate"><span class="pre">end()</span></code>
(e.g. <code class="docutils literal notranslate"><span class="pre">global_begin()</span></code> and <code class="docutils literal notranslate"><span class="pre">use_begin()</span></code>).</p>
<p>Here are some examples:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">VehicleMaker</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="w">  </span><span class="n">Factory</span><span class="o">&lt;</span><span class="n">Tire</span><span class="o">&gt;</span><span class="w"> </span><span class="n">F</span><span class="p">;</span><span class="w">            </span><span class="c1">// Avoid: a non-descriptive abbreviation.</span>
<span class="w">  </span><span class="n">Factory</span><span class="o">&lt;</span><span class="n">Tire</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Factory</span><span class="p">;</span><span class="w">      </span><span class="c1">// Better: more descriptive.</span>
<span class="w">  </span><span class="n">Factory</span><span class="o">&lt;</span><span class="n">Tire</span><span class="o">&gt;</span><span class="w"> </span><span class="n">TireFactory</span><span class="p">;</span><span class="w">  </span><span class="c1">// Even better: if VehicleMaker has more than one</span>
<span class="w">                              </span><span class="c1">// kind of factories.</span>
<span class="p">};</span>

<span class="n">Vehicle</span><span class="w"> </span><span class="nf">makeVehicle</span><span class="p">(</span><span class="n">VehicleType</span><span class="w"> </span><span class="n">Type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">VehicleMaker</span><span class="w"> </span><span class="n">M</span><span class="p">;</span><span class="w">                         </span><span class="c1">// Might be OK if scope is small.</span>
<span class="w">  </span><span class="n">Tire</span><span class="w"> </span><span class="n">Tmp1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="p">.</span><span class="n">makeTire</span><span class="p">();</span><span class="w">               </span><span class="c1">// Avoid: &#39;Tmp1&#39; provides no information.</span>
<span class="w">  </span><span class="n">Light</span><span class="w"> </span><span class="n">Headlight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="p">.</span><span class="n">makeLight</span><span class="p">(</span><span class="s">&quot;head&quot;</span><span class="p">);</span><span class="w">  </span><span class="c1">// Good: descriptive.</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="assert-liberally">
<h4><a class="toc-backref" href="#id45" role="doc-backlink">Assert Liberally</a><a class="headerlink" href="#assert-liberally" title="Permalink to this heading">¶</a></h4>
<p>Use the “<code class="docutils literal notranslate"><span class="pre">assert</span></code>” macro to its fullest.  Check all of your preconditions and
assumptions, you never know when a bug (not necessarily even yours) might be
caught early by an assertion, which reduces debugging time dramatically.  The
“<code class="docutils literal notranslate"><span class="pre">&lt;cassert&gt;</span></code>” header file is probably already included by the header files you
are using, so it doesn’t cost anything to use it.</p>
<p>To further assist with debugging, make sure to put some kind of error message in
the assertion statement, which is printed if the assertion is tripped. This
helps the poor debugger make sense of why an assertion is being made and
enforced, and hopefully what to do about it.  Here is one complete example:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kr">inline</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">*</span><span class="nf">getOperand</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">I</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">Operands</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;getOperand() out of range!&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">Operands</span><span class="p">[</span><span class="n">I</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here are more examples:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">assert</span><span class="p">(</span><span class="n">Ty</span><span class="o">-&gt;</span><span class="n">isPointerType</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;Can&#39;t allocate a non-pointer type!&quot;</span><span class="p">);</span>

<span class="n">assert</span><span class="p">((</span><span class="n">Opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Shl</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">Opcode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Shr</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;ShiftInst Opcode invalid!&quot;</span><span class="p">);</span>

<span class="n">assert</span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">getNumSuccessors</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;Successor # out of range!&quot;</span><span class="p">);</span>

<span class="n">assert</span><span class="p">(</span><span class="n">V1</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">V2</span><span class="p">.</span><span class="n">getType</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;Constant types must be identical!&quot;</span><span class="p">);</span>

<span class="n">assert</span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">PHINode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Succ</span><span class="o">-&gt;</span><span class="n">front</span><span class="p">())</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;Only works on PHId BBs!&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>You get the idea.</p>
<p>In the past, asserts were used to indicate a piece of code that should not be
reached.  These were typically of the form:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">assert</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;Invalid radix for integer literal&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>This has a few issues, the main one being that some compilers might not
understand the assertion, or warn about a missing return in builds where
assertions are compiled out.</p>
<p>Today, we have something much better: <code class="docutils literal notranslate"><span class="pre">llvm_unreachable</span></code>:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;Invalid radix for integer literal&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>When assertions are enabled, this will print the message if it’s ever reached
and then exit the program. When assertions are disabled (i.e. in release
builds), <code class="docutils literal notranslate"><span class="pre">llvm_unreachable</span></code> becomes a hint to compilers to skip generating
code for this branch. If the compiler does not support this, it will fall back
to the “abort” implementation.</p>
<p>Use <code class="docutils literal notranslate"><span class="pre">llvm_unreachable</span></code> to mark a specific point in code that should never be
reached. This is especially desirable for addressing warnings about unreachable
branches, etc., but can be used whenever reaching a particular code path is
unconditionally a bug (not originating from user input; see below) of some kind.
Use of <code class="docutils literal notranslate"><span class="pre">assert</span></code> should always include a testable predicate (as opposed to
<code class="docutils literal notranslate"><span class="pre">assert(false)</span></code>).</p>
<p>If the error condition can be triggered by user input then the
recoverable error mechanism described in <a class="reference internal" href="ProgrammersManual.html"><span class="doc">LLVM Programmer’s Manual</span></a> should be
used instead. In cases where this is not practical, <code class="docutils literal notranslate"><span class="pre">report_fatal_error</span></code> may
be used.</p>
<p>Another issue is that values used only by assertions will produce an “unused
value” warning when assertions are disabled.  For example, this code will warn:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">unsigned</span><span class="w"> </span><span class="n">Size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">V</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="n">assert</span><span class="p">(</span><span class="n">Size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;Vector smaller than it should be&quot;</span><span class="p">);</span>

<span class="kt">bool</span><span class="w"> </span><span class="n">NewToSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Myset</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Value</span><span class="p">);</span>
<span class="n">assert</span><span class="p">(</span><span class="n">NewToSet</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;The value shouldn&#39;t be in the set yet&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>These are two interesting different cases. In the first case, the call to
<code class="docutils literal notranslate"><span class="pre">V.size()</span></code> is only useful for the assert, and we don’t want it executed when
assertions are disabled.  Code like this should move the call into the assert
itself.  In the second case, the side effects of the call must happen whether
the assert is enabled or not.  In this case, the value should be cast to void to
disable the warning.  To be specific, it is preferred to write the code like
this:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">assert</span><span class="p">(</span><span class="n">V</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;Vector smaller than it should be&quot;</span><span class="p">);</span>

<span class="kt">bool</span><span class="w"> </span><span class="n">NewToSet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Myset</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Value</span><span class="p">);</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">NewToSet</span><span class="p">;</span>
<span class="n">assert</span><span class="p">(</span><span class="n">NewToSet</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;The value shouldn&#39;t be in the set yet&quot;</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="do-not-use-using-namespace-std">
<h4><a class="toc-backref" href="#id46" role="doc-backlink">Do Not Use <code class="docutils literal notranslate"><span class="pre">using</span> <span class="pre">namespace</span> <span class="pre">std</span></code></a><a class="headerlink" href="#do-not-use-using-namespace-std" title="Permalink to this heading">¶</a></h4>
<p>In LLVM, we prefer to explicitly prefix all identifiers from the standard
namespace with an “<code class="docutils literal notranslate"><span class="pre">std::</span></code>” prefix, rather than rely on “<code class="docutils literal notranslate"><span class="pre">using</span> <span class="pre">namespace</span>
<span class="pre">std;</span></code>”.</p>
<p>In header files, adding a <code class="docutils literal notranslate"><span class="pre">'using</span> <span class="pre">namespace</span> <span class="pre">XXX'</span></code> directive pollutes the
namespace of any source file that <code class="docutils literal notranslate"><span class="pre">#include</span></code>s the header, creating
maintenance issues.</p>
<p>In implementation files (e.g. <code class="docutils literal notranslate"><span class="pre">.cpp</span></code> files), the rule is more of a stylistic
rule, but is still important.  Basically, using explicit namespace prefixes
makes the code <strong>clearer</strong>, because it is immediately obvious what facilities
are being used and where they are coming from. And <strong>more portable</strong>, because
namespace clashes cannot occur between LLVM code and other namespaces.  The
portability rule is important because different standard library implementations
expose different symbols (potentially ones they shouldn’t), and future revisions
to the C++ standard will add more symbols to the <code class="docutils literal notranslate"><span class="pre">std</span></code> namespace.  As such, we
never use <code class="docutils literal notranslate"><span class="pre">'using</span> <span class="pre">namespace</span> <span class="pre">std;'</span></code> in LLVM.</p>
<p>The exception to the general rule (i.e. it’s not an exception for the <code class="docutils literal notranslate"><span class="pre">std</span></code>
namespace) is for implementation files.  For example, all of the code in the
LLVM project implements code that lives in the ‘llvm’ namespace.  As such, it is
ok, and actually clearer, for the <code class="docutils literal notranslate"><span class="pre">.cpp</span></code> files to have a <code class="docutils literal notranslate"><span class="pre">'using</span> <span class="pre">namespace</span>
<span class="pre">llvm;'</span></code> directive at the top, after the <code class="docutils literal notranslate"><span class="pre">#include</span></code>s.  This reduces
indentation in the body of the file for source editors that indent based on
braces, and keeps the conceptual context cleaner.  The general form of this rule
is that any <code class="docutils literal notranslate"><span class="pre">.cpp</span></code> file that implements code in any namespace may use that
namespace (and its parents’), but should not use any others.</p>
</section>
<section id="provide-a-virtual-method-anchor-for-classes-in-headers">
<h4><a class="toc-backref" href="#id47" role="doc-backlink">Provide a Virtual Method Anchor for Classes in Headers</a><a class="headerlink" href="#provide-a-virtual-method-anchor-for-classes-in-headers" title="Permalink to this heading">¶</a></h4>
<p>If a class is defined in a header file and has a vtable (either it has virtual
methods or it derives from classes with virtual methods), it must always have at
least one out-of-line virtual method in the class.  Without this, the compiler
will copy the vtable and RTTI into every <code class="docutils literal notranslate"><span class="pre">.o</span></code> file that <code class="docutils literal notranslate"><span class="pre">#include</span></code>s the
header, bloating <code class="docutils literal notranslate"><span class="pre">.o</span></code> file sizes and increasing link times.</p>
</section>
<section id="don-t-use-default-labels-in-fully-covered-switches-over-enumerations">
<h4><a class="toc-backref" href="#id48" role="doc-backlink">Don’t use default labels in fully covered switches over enumerations</a><a class="headerlink" href="#don-t-use-default-labels-in-fully-covered-switches-over-enumerations" title="Permalink to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">-Wswitch</span></code> warns if a switch, without a default label, over an enumeration
does not cover every enumeration value. If you write a default label on a fully
covered switch over an enumeration then the <code class="docutils literal notranslate"><span class="pre">-Wswitch</span></code> warning won’t fire
when new elements are added to that enumeration. To help avoid adding these
kinds of defaults, Clang has the warning <code class="docutils literal notranslate"><span class="pre">-Wcovered-switch-default</span></code> which is
off by default but turned on when building LLVM with a version of Clang that
supports the warning.</p>
<p>A knock-on effect of this stylistic requirement is that when building LLVM with
GCC you may get warnings related to “control may reach end of non-void function”
if you return from each case of a covered switch-over-enum because GCC assumes
that the enum expression may take any representable value, not just those of
individual enumerators. To suppress this warning, use <code class="docutils literal notranslate"><span class="pre">llvm_unreachable</span></code> after
the switch.</p>
</section>
<section id="use-range-based-for-loops-wherever-possible">
<h4><a class="toc-backref" href="#id49" role="doc-backlink">Use range-based <code class="docutils literal notranslate"><span class="pre">for</span></code> loops wherever possible</a><a class="headerlink" href="#use-range-based-for-loops-wherever-possible" title="Permalink to this heading">¶</a></h4>
<p>The introduction of range-based <code class="docutils literal notranslate"><span class="pre">for</span></code> loops in C++11 means that explicit
manipulation of iterators is rarely necessary. We use range-based <code class="docutils literal notranslate"><span class="pre">for</span></code>
loops wherever possible for all newly added code. For example:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">BB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Instruction</span><span class="w"> </span><span class="o">&amp;</span><span class="n">I</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">BB</span><span class="p">)</span>
<span class="w">  </span><span class="p">...</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="p">...</span>
</pre></div>
</div>
<p>Usage of <code class="docutils literal notranslate"><span class="pre">std::for_each()</span></code>/<code class="docutils literal notranslate"><span class="pre">llvm::for_each()</span></code> functions is discouraged,
unless the callable object already exists.</p>
</section>
<section id="don-t-evaluate-end-every-time-through-a-loop">
<h4><a class="toc-backref" href="#id50" role="doc-backlink">Don’t evaluate <code class="docutils literal notranslate"><span class="pre">end()</span></code> every time through a loop</a><a class="headerlink" href="#don-t-evaluate-end-every-time-through-a-loop" title="Permalink to this heading">¶</a></h4>
<p>In cases where range-based <code class="docutils literal notranslate"><span class="pre">for</span></code> loops can’t be used and it is necessary
to write an explicit iterator-based loop, pay close attention to whether
<code class="docutils literal notranslate"><span class="pre">end()</span></code> is re-evaluated on each loop iteration. One common mistake is to
write a loop in this style:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">BB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BB</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">();</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">BB</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">I</span><span class="p">)</span>
<span class="w">  </span><span class="p">...</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="p">...</span>
</pre></div>
</div>
<p>The problem with this construct is that it evaluates “<code class="docutils literal notranslate"><span class="pre">BB-&gt;end()</span></code>” every time
through the loop.  Instead of writing the loop like this, we strongly prefer
loops to be written so that they evaluate it once before the loop starts.  A
convenient way to do this is like so:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">BasicBlock</span><span class="w"> </span><span class="o">*</span><span class="n">BB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BB</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BB</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">();</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">E</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">I</span><span class="p">)</span>
<span class="w">  </span><span class="p">...</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="p">...</span>
</pre></div>
</div>
<p>The observant may quickly point out that these two loops may have different
semantics: if the container (a basic block in this case) is being mutated, then
“<code class="docutils literal notranslate"><span class="pre">BB-&gt;end()</span></code>” may change its value every time through the loop and the second
loop may not in fact be correct.  If you actually do depend on this behavior,
please write the loop in the first form and add a comment indicating that you
did it intentionally.</p>
<p>Why do we prefer the second form (when correct)?  Writing the loop in the first
form has two problems. First it may be less efficient than evaluating it at the
start of the loop.  In this case, the cost is probably minor — a few extra
loads every time through the loop.  However, if the base expression is more
complex, then the cost can rise quickly.  I’ve seen loops where the end
expression was actually something like: “<code class="docutils literal notranslate"><span class="pre">SomeMap[X]-&gt;end()</span></code>” and map lookups
really aren’t cheap.  By writing it in the second form consistently, you
eliminate the issue entirely and don’t even have to think about it.</p>
<p>The second (even bigger) issue is that writing the loop in the first form hints
to the reader that the loop is mutating the container (a fact that a comment
would handily confirm!).  If you write the loop in the second form, it is
immediately obvious without even looking at the body of the loop that the
container isn’t being modified, which makes it easier to read the code and
understand what it does.</p>
<p>While the second form of the loop is a few extra keystrokes, we do strongly
prefer it.</p>
</section>
<section id="include-iostream-is-forbidden">
<h4><a class="toc-backref" href="#id51" role="doc-backlink"><code class="docutils literal notranslate"><span class="pre">#include</span> <span class="pre">&lt;iostream&gt;</span></code> is Forbidden</a><a class="headerlink" href="#include-iostream-is-forbidden" title="Permalink to this heading">¶</a></h4>
<p>The use of <code class="docutils literal notranslate"><span class="pre">#include</span> <span class="pre">&lt;iostream&gt;</span></code> in library files is hereby <strong>forbidden</strong>,
because many common implementations transparently inject a <a class="reference internal" href="#static-constructor">static constructor</a>
into every translation unit that includes it.</p>
<p>Note that using the other stream headers (<code class="docutils literal notranslate"><span class="pre">&lt;sstream&gt;</span></code> for example) is not
problematic in this regard — just <code class="docutils literal notranslate"><span class="pre">&lt;iostream&gt;</span></code>. However, <code class="docutils literal notranslate"><span class="pre">raw_ostream</span></code>
provides various APIs that are better performing for almost every use than
<code class="docutils literal notranslate"><span class="pre">std::ostream</span></code> style APIs.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>New code should always use <a class="reference internal" href="#raw-ostream">raw_ostream</a> for writing, or the
<code class="docutils literal notranslate"><span class="pre">llvm::MemoryBuffer</span></code> API for reading files.</p>
</div>
</section>
<section id="use-raw-ostream">
<span id="raw-ostream"></span><h4><a class="toc-backref" href="#id52" role="doc-backlink">Use <code class="docutils literal notranslate"><span class="pre">raw_ostream</span></code></a><a class="headerlink" href="#use-raw-ostream" title="Permalink to this heading">¶</a></h4>
<p>LLVM includes a lightweight, simple, and efficient stream implementation in
<code class="docutils literal notranslate"><span class="pre">llvm/Support/raw_ostream.h</span></code>, which provides all of the common features of
<code class="docutils literal notranslate"><span class="pre">std::ostream</span></code>.  All new code should use <code class="docutils literal notranslate"><span class="pre">raw_ostream</span></code> instead of
<code class="docutils literal notranslate"><span class="pre">ostream</span></code>.</p>
<p>Unlike <code class="docutils literal notranslate"><span class="pre">std::ostream</span></code>, <code class="docutils literal notranslate"><span class="pre">raw_ostream</span></code> is not a template and can be forward
declared as <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">raw_ostream</span></code>.  Public headers should generally not include
the <code class="docutils literal notranslate"><span class="pre">raw_ostream</span></code> header, but use forward declarations and constant references
to <code class="docutils literal notranslate"><span class="pre">raw_ostream</span></code> instances.</p>
</section>
<section id="avoid-std-endl">
<h4><a class="toc-backref" href="#id53" role="doc-backlink">Avoid <code class="docutils literal notranslate"><span class="pre">std::endl</span></code></a><a class="headerlink" href="#avoid-std-endl" title="Permalink to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">std::endl</span></code> modifier, when used with <code class="docutils literal notranslate"><span class="pre">iostreams</span></code> outputs a newline to
the output stream specified.  In addition to doing this, however, it also
flushes the output stream.  In other words, these are equivalent:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="sc">&#39;\n&#39;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">flush</span><span class="p">;</span>
</pre></div>
</div>
<p>Most of the time, you probably have no reason to flush the output stream, so
it’s better to use a literal <code class="docutils literal notranslate"><span class="pre">'\n'</span></code>.</p>
</section>
<section id="don-t-use-inline-when-defining-a-function-in-a-class-definition">
<h4><a class="toc-backref" href="#id54" role="doc-backlink">Don’t use <code class="docutils literal notranslate"><span class="pre">inline</span></code> when defining a function in a class definition</a><a class="headerlink" href="#don-t-use-inline-when-defining-a-function-in-a-class-definition" title="Permalink to this heading">¶</a></h4>
<p>A member function defined in a class definition is implicitly inline, so don’t
put the <code class="docutils literal notranslate"><span class="pre">inline</span></code> keyword in this case.</p>
<p>Don’t:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Foo</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">bar</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Do:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Foo</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">bar</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
</section>
<section id="microscopic-details">
<h3><a class="toc-backref" href="#id55" role="doc-backlink">Microscopic Details</a><a class="headerlink" href="#microscopic-details" title="Permalink to this heading">¶</a></h3>
<p>This section describes preferred low-level formatting guidelines along with
reasoning on why we prefer them.</p>
<section id="spaces-before-parentheses">
<h4><a class="toc-backref" href="#id56" role="doc-backlink">Spaces Before Parentheses</a><a class="headerlink" href="#spaces-before-parentheses" title="Permalink to this heading">¶</a></h4>
<p>Put a space before an open parenthesis only in control flow statements, but not
in normal function call expressions and function-like macros.  For example:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="w"> </span><span class="p">...</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">I</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">I</span><span class="p">)</span><span class="w"> </span><span class="p">...</span>
<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">LLVMRocks</span><span class="p">)</span><span class="w"> </span><span class="p">...</span>

<span class="n">somefunc</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>
<span class="n">assert</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s">&quot;laws of math are failing me&quot;</span><span class="p">);</span>

<span class="n">A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">foo</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span><span class="w"> </span><span class="mi">92</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">bar</span><span class="p">(</span><span class="n">X</span><span class="p">);</span>
</pre></div>
</div>
<p>The reason for doing this is not completely arbitrary.  This style makes control
flow operators stand out more, and makes expressions flow better.</p>
</section>
<section id="prefer-preincrement">
<h4><a class="toc-backref" href="#id57" role="doc-backlink">Prefer Preincrement</a><a class="headerlink" href="#prefer-preincrement" title="Permalink to this heading">¶</a></h4>
<p>Hard fast rule: Preincrement (<code class="docutils literal notranslate"><span class="pre">++X</span></code>) may be no slower than postincrement
(<code class="docutils literal notranslate"><span class="pre">X++</span></code>) and could very well be a lot faster than it.  Use preincrementation
whenever possible.</p>
<p>The semantics of postincrement include making a copy of the value being
incremented, returning it, and then preincrementing the “work value”.  For
primitive types, this isn’t a big deal. But for iterators, it can be a huge
issue (for example, some iterators contains stack and set objects in them…
copying an iterator could invoke the copy ctor’s of these as well).  In general,
get in the habit of always using preincrement, and you won’t have a problem.</p>
</section>
<section id="namespace-indentation">
<h4><a class="toc-backref" href="#id58" role="doc-backlink">Namespace Indentation</a><a class="headerlink" href="#namespace-indentation" title="Permalink to this heading">¶</a></h4>
<p>In general, we strive to reduce indentation wherever possible.  This is useful
because we want code to <a class="reference internal" href="#fit-into-80-columns">fit into 80 columns</a> without excessive wrapping, but
also because it makes it easier to understand the code. To facilitate this and
avoid some insanely deep nesting on occasion, don’t indent namespaces. If it
helps readability, feel free to add a comment indicating what namespace is
being closed by a <code class="docutils literal notranslate"><span class="pre">}</span></code>.  For example:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="nn">llvm</span><span class="w"> </span><span class="p">{</span>
<span class="k">namespace</span><span class="w"> </span><span class="nn">knowledge</span><span class="w"> </span><span class="p">{</span>

<span class="c1">/// This class represents things that Smith can have an intimate</span>
<span class="c1">/// understanding of and contains the data associated with it.</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Grokable</span><span class="w"> </span><span class="p">{</span>
<span class="p">...</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="k">explicit</span><span class="w"> </span><span class="n">Grokable</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">Grokable</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">  </span><span class="p">...</span>

<span class="p">};</span>

<span class="p">}</span><span class="w"> </span><span class="c1">// namespace knowledge</span>
<span class="p">}</span><span class="w"> </span><span class="c1">// namespace llvm</span>
</pre></div>
</div>
<p>Feel free to skip the closing comment when the namespace being closed is
obvious for any reason. For example, the outer-most namespace in a header file
is rarely a source of confusion. But namespaces both anonymous and named in
source files that are being closed half way through the file probably could use
clarification.</p>
</section>
<section id="anonymous-namespaces">
<span id="static"></span><h4><a class="toc-backref" href="#id59" role="doc-backlink">Anonymous Namespaces</a><a class="headerlink" href="#anonymous-namespaces" title="Permalink to this heading">¶</a></h4>
<p>After talking about namespaces in general, you may be wondering about anonymous
namespaces in particular.  Anonymous namespaces are a great language feature
that tells the C++ compiler that the contents of the namespace are only visible
within the current translation unit, allowing more aggressive optimization and
eliminating the possibility of symbol name collisions.  Anonymous namespaces are
to C++ as “static” is to C functions and global variables.  While “<code class="docutils literal notranslate"><span class="pre">static</span></code>”
is available in C++, anonymous namespaces are more general: they can make entire
classes private to a file.</p>
<p>The problem with anonymous namespaces is that they naturally want to encourage
indentation of their body, and they reduce locality of reference: if you see a
random function definition in a C++ file, it is easy to see if it is marked
static, but seeing if it is in an anonymous namespace requires scanning a big
chunk of the file.</p>
<p>Because of this, we have a simple guideline: make anonymous namespaces as small
as possible, and only use them for class declarations.  For example:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="p">{</span>
<span class="k">class</span><span class="w"> </span><span class="nc">StringSort</span><span class="w"> </span><span class="p">{</span>
<span class="p">...</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">StringSort</span><span class="p">(...)</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">RHS</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>
<span class="p">};</span>
<span class="p">}</span><span class="w"> </span><span class="c1">// namespace</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">runHelper</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>

<span class="kt">bool</span><span class="w"> </span><span class="n">StringSort</span><span class="o">::</span><span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">RHS</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Avoid putting declarations other than classes into anonymous namespaces:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">namespace</span><span class="w"> </span><span class="p">{</span>

<span class="c1">// ... many declarations ...</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">runHelper</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span>
<span class="p">}</span>

<span class="c1">// ... many declarations ...</span>

<span class="p">}</span><span class="w"> </span><span class="c1">// namespace</span>
</pre></div>
</div>
<p>When you are looking at “<code class="docutils literal notranslate"><span class="pre">runHelper</span></code>” in the middle of a large C++ file,
you have no immediate way to tell if this function is local to the file.  In
contrast, when the function is marked static, you don’t need to cross-reference
faraway places in the file to tell that the function is local.</p>
</section>
<section id="don-t-use-braces-on-simple-single-statement-bodies-of-if-else-loop-statements">
<h4><a class="toc-backref" href="#id60" role="doc-backlink">Don’t Use Braces on Simple Single-Statement Bodies of if/else/loop Statements</a><a class="headerlink" href="#don-t-use-braces-on-simple-single-statement-bodies-of-if-else-loop-statements" title="Permalink to this heading">¶</a></h4>
<p>When writing the body of an <code class="docutils literal notranslate"><span class="pre">if</span></code>, <code class="docutils literal notranslate"><span class="pre">else</span></code>, or for/while loop statement, we
prefer to omit the braces to avoid unnecessary line noise. However, braces
should be used in cases where the omission of braces harm the readability and
maintainability of the code.</p>
<p>We consider that readability is harmed when omitting the brace in the presence
of a single statement that is accompanied by a comment (assuming the comment
can’t be hoisted above the <code class="docutils literal notranslate"><span class="pre">if</span></code> or loop statement, see below).</p>
<p>Similarly, braces should be used when a single-statement body is complex enough
that it becomes difficult to see where the block containing the following
statement began. An <code class="docutils literal notranslate"><span class="pre">if</span></code>/<code class="docutils literal notranslate"><span class="pre">else</span></code> chain or a loop is considered a single
statement for this rule, and this rule applies recursively.</p>
<p>This list is not exhaustive. For example, readability is also harmed if an
<code class="docutils literal notranslate"><span class="pre">if</span></code>/<code class="docutils literal notranslate"><span class="pre">else</span></code> chain does not use braced bodies for either all or none of its
members, or has complex conditionals, deep nesting, etc. The examples below
intend to provide some guidelines.</p>
<p>Maintainability is harmed if the body of an <code class="docutils literal notranslate"><span class="pre">if</span></code> ends with a (directly or
indirectly) nested <code class="docutils literal notranslate"><span class="pre">if</span></code> statement with no <code class="docutils literal notranslate"><span class="pre">else</span></code>. Braces on the outer <code class="docutils literal notranslate"><span class="pre">if</span></code>
would help to avoid running into a “dangling else” situation.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Omit the braces since the body is simple and clearly associated with the</span>
<span class="c1">// `if`.</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">FunctionDecl</span><span class="o">&gt;</span><span class="p">(</span><span class="n">D</span><span class="p">))</span>
<span class="w">  </span><span class="n">handleFunctionDecl</span><span class="p">(</span><span class="n">D</span><span class="p">);</span>
<span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">VarDecl</span><span class="o">&gt;</span><span class="p">(</span><span class="n">D</span><span class="p">))</span>
<span class="w">  </span><span class="n">handleVarDecl</span><span class="p">(</span><span class="n">D</span><span class="p">);</span>

<span class="c1">// Here we document the condition itself and not the body.</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">VarDecl</span><span class="o">&gt;</span><span class="p">(</span><span class="n">D</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// It is necessary that we explain the situation with this surprisingly long</span>
<span class="w">  </span><span class="c1">// comment, so it would be unclear without the braces whether the following</span>
<span class="w">  </span><span class="c1">// statement is in the scope of the `if`.</span>
<span class="w">  </span><span class="c1">// Because the condition is documented, we can&#39;t really hoist this</span>
<span class="w">  </span><span class="c1">// comment that applies to the body above the `if`.</span>
<span class="w">  </span><span class="n">handleOtherDecl</span><span class="p">(</span><span class="n">D</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Use braces on the outer `if` to avoid a potential dangling `else`</span>
<span class="c1">// situation.</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">VarDecl</span><span class="o">&gt;</span><span class="p">(</span><span class="n">D</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shouldProcessAttr</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
<span class="w">    </span><span class="n">handleAttr</span><span class="p">(</span><span class="n">A</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Use braces for the `if` block to keep it uniform with the `else` block.</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">FunctionDecl</span><span class="o">&gt;</span><span class="p">(</span><span class="n">D</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">handleFunctionDecl</span><span class="p">(</span><span class="n">D</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// In this `else` case, it is necessary that we explain the situation with</span>
<span class="w">  </span><span class="c1">// this surprisingly long comment, so it would be unclear without the braces</span>
<span class="w">  </span><span class="c1">// whether the following statement is in the scope of the `if`.</span>
<span class="w">  </span><span class="n">handleOtherDecl</span><span class="p">(</span><span class="n">D</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// This should also omit braces.  The `for` loop contains only a single</span>
<span class="c1">// statement, so it shouldn&#39;t have braces.  The `if` also only contains a</span>
<span class="c1">// single simple statement (the `for` loop), so it also should omit braces.</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">FunctionDecl</span><span class="o">&gt;</span><span class="p">(</span><span class="n">D</span><span class="p">))</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">A</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">D</span><span class="p">.</span><span class="n">attrs</span><span class="p">())</span>
<span class="w">    </span><span class="n">handleAttr</span><span class="p">(</span><span class="n">A</span><span class="p">);</span>

<span class="c1">// Use braces for a `do-while` loop and its enclosing statement.</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Tok</span><span class="o">-&gt;</span><span class="n">is</span><span class="p">(</span><span class="n">tok</span><span class="o">::</span><span class="n">l_brace</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Tok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tok</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">Tok</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Use braces for the outer `if` since the nested `for` is braced.</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">FunctionDecl</span><span class="o">&gt;</span><span class="p">(</span><span class="n">D</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">A</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">D</span><span class="p">.</span><span class="n">attrs</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// In this `for` loop body, it is necessary that we explain the situation</span>
<span class="w">    </span><span class="c1">// with this surprisingly long comment, forcing braces on the `for` block.</span>
<span class="w">    </span><span class="n">handleAttr</span><span class="p">(</span><span class="n">A</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Use braces on the outer block because there are more than two levels of</span>
<span class="c1">// nesting.</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isa</span><span class="o">&lt;</span><span class="n">FunctionDecl</span><span class="o">&gt;</span><span class="p">(</span><span class="n">D</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">A</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">D</span><span class="p">.</span><span class="n">attrs</span><span class="p">())</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">llvm</span><span class="o">::</span><span class="n">seq</span><span class="o">&lt;</span><span class="kt">ssize_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">count</span><span class="p">))</span>
<span class="w">      </span><span class="n">handleAttrOnDecl</span><span class="p">(</span><span class="n">D</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Use braces on the outer block because of a nested `if`; otherwise the</span>
<span class="c1">// compiler would warn: `add explicit braces to avoid dangling else`</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="w"> </span><span class="o">*</span><span class="n">D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">FunctionDecl</span><span class="o">&gt;</span><span class="p">(</span><span class="n">D</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">shouldProcess</span><span class="p">(</span><span class="n">D</span><span class="p">))</span>
<span class="w">    </span><span class="n">handleVarDecl</span><span class="p">(</span><span class="n">D</span><span class="p">);</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="n">markAsIgnored</span><span class="p">(</span><span class="n">D</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="see-also">
<h2><a class="toc-backref" href="#id61" role="doc-backlink">See Also</a><a class="headerlink" href="#see-also" title="Permalink to this heading">¶</a></h2>
<p>A lot of these comments and recommendations have been culled from other sources.
Two particularly important books for our work are:</p>
<ol class="arabic simple">
<li><p><a class="reference external" href="https://www.amazon.com/Effective-Specific-Addison-Wesley-Professional-Computing/dp/0321334876">Effective C++</a>
by Scott Meyers.  Also interesting and useful are “More Effective C++” and
“Effective STL” by the same author.</p></li>
<li><p><a class="reference external" href="https://www.amazon.com/Large-Scale-Software-Design-John-Lakos/dp/0201633620">Large-Scale C++ Software Design</a>
by John Lakos</p></li>
</ol>
<p>If you get some free time, and you haven’t read them: do so, you might learn
something.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="GitBisecting.html" title="Bisecting LLVM code"
             >next</a> |</li>
        <li class="right" >
          <a href="BugLifeCycle.html" title="LLVM Bug Life Cycle"
             >previous</a> |</li>
  <li><a href="https://llvm.org/">LLVM Home</a>&nbsp;|&nbsp;</li>
  <li><a href="index.html">Documentation</a>&raquo;</li>

          <li class="nav-item nav-item-1"><a href="GettingInvolved.html" >Getting Involved</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">LLVM Coding Standards</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2003-2024, LLVM Project.
      Last updated on 2024-03-22.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.1.2.
    </div>
  </body>
</html>